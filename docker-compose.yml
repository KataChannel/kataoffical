services:
  postgres_taza:
    image: postgres:15
    container_name: postgres_taza
    restart: always
    environment:
      POSTGRES_USER: tazagroup
      POSTGRES_PASSWORD: /TazaGroup*2025
      POSTGRES_DB: datavttech
    ports:
      - "5434:5432"
  pgadmin_taza:
    image: dpage/pgadmin4
    container_name: pgadmin_taza
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@tazagroup.com
      PGADMIN_DEFAULT_PASSWORD: /TazaGroup*2025
    ports:
      - "5052:80"
    depends_on:
      - postgres_taza 
  datalake_storage:
      image: minio/minio:RELEASE.2025-04-22T22-12-26Z-cpuv1
      container_name: datalake_minio
      command: server /data --console-address ":9090"
      ports:
        - "9000:9000"
        - "9090:9090"
      environment:
        # User/Pass MinIO thường vẫn cần dưới dạng biến môi trường trực tiếp
        # Hoặc bạn cần custom entrypoint để đọc từ file.
        # Cách an toàn hơn là tạo Access Key/Secret Key riêng cho service thay vì dùng Root User/Pass.
        # Giả sử dùng Root cho ví dụ này (CẨN THẬN!)
        MINIO_ROOT_USER: admin
        MINIO_ROOT_PASSWORD: password
      volumes:
        - minio_data:/data
        # Mount file secrets vào container
        - ./secrets/minio_user.txt:/run/secrets/minio_user:ro
        - ./secrets/minio_password.txt:/run/secrets/minio_password:ro
      healthcheck:
        test: ["CMD", "mc", "ready", "local"]
        interval: 5s
        timeout: 5s
        retries: 5
        start_period: 5s

  minio_taza:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z-cpuv1
    container_name: minio_taza
    command: server /data --console-address ":9090"
    ports:
      - "9002:9000"
      - "9092:9090"
    environment:
      MINIO_ROOT_USER: zQBLucaykoR9Xw3
      MINIO_ROOT_PASSWORD: ToDRFRP09AGTJo0
    volumes:
      - minio_data2:/data2
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s



  processing_service:
    build: ./processing_service # Trỏ tới thư mục chứa Dockerfile và code xử lý
    container_name: processing_service
    restart: always
    environment:
      MINIO_ENDPOINT: 'http://116.118.49.243:9000'
      MINIO_ACCESS_KEY: 'Abgp9Bkds2lTrthAb4LV'
      MINIO_SECRET_KEY: 'ndAmGT8jv8dxOzGPbntO1GCmA3w6SWpYsjM55qZJ'
      MINIO_BUCKET_NAME: 'datavttech'
      EXTERNAL_API_URL: 'https://apismsvtt.vttechsolution.com/api/'
      DB_HOST: 'postgres_taza'
      DB_PORT: 5432
      DB_USER: 'tazagroup'
      DB_PASSWORD: '/TazaGroup*2025'
      DB_NAME: 'datavttech'
      DATABASE_URL: "postgresql://tazagroup:%2FTazaGroup%2A2025@116.118.49.243:5434/datavttech?schema=public"

    # --- Cách chạy service này ---
    # Option 1: Chạy 1 lần khi `docker-compose up` (ví dụ: xử lý batch ban đầu)
    # command: ["node", "process.js"]
    # Option 2: Để service chạy liên tục (ví dụ: nếu là worker xử lý message queue hoặc chạy cron bên trong)
    # command: ["node", "worker.js"]
    # Option 3: Không chạy tự động, dùng `docker-compose run processing_service` để chạy khi cần


  # redis:
  #   image: redis:7-alpine
  #   container_name: redis_cache
  #   command: redis-server --save 60 1 --loglevel warning
  #   volumes:
  #     - redis_data:/data
  #   ports:
  #     - "6379:6379"
  #   networks:
  #     - app-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

  # --- Backend Services ---
  data-vttech:
    build:
      context: ./backend/shared-core
      dockerfile: Dockerfile
    container_name: data-vttech
    environment:
      NODE_ENV: development
      PORT: 3200
    ports:
      - "3200:3200"
    restart: unless-stopped

  shared-api:
    build:
      context: ./backend/shared-core
      dockerfile: Dockerfile
    container_name: shared-api
    environment:
      NODE_ENV: development
      PORT: 3100
    ports:
      - "3100:3100"
    restart: unless-stopped  
  affiliate-api:
    build:
      context: ./backend/affiliate
      dockerfile: Dockerfile
    container_name: affiliate_api
    environment:
      NODE_ENV: development
      PORT: 3105
    ports:
      - "3105:3105"
    restart: unless-stopped  

  # academy-api:
  #   build:
  #     context: ./backend/academy
  #     dockerfile: Dockerfile
  #   container_name: academy_api
  #   environment:
  #     NODE_ENV: development
  #     PORT: 3101
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     SHARED_CORE_API_URL: http://shared-core-api:3101
  #     JWT_SECRET: ${JWT_SECRET}
  #   ports:
  #     - "3101:3101"
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    #   redis:
    #     condition: service_healthy
    #   shared-core-api:
    #     condition: service_started
    # networks:
    #   - app-network
    # command: bun run start:dev
    # restart: unless-stopped

  # cosmetics-api:
  #   build:
  #     context: ./backend/cosmetics
  #     dockerfile: Dockerfile
  #   container_name: cosmetics_api
  #   environment:
  #     NODE_ENV: development
  #     PORT: 3102
  #     DATABASE_URL: ${COSMETICS_DATABASE_URL}
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     SHARED_CORE_API_URL: http://shared-core-api:3100
  #     JWT_SECRET: ${JWT_SECRET}
  #   ports:
  #     - "3102:3102"
  #   # depends_on:
  #   #   postgres:
  #   #     condition: service_healthy
  #   #   redis:
  #   #     condition: service_healthy
  #   #   shared-core-api:
  #   #     condition: service_started
  #   # networks:
  #   #   - app-network
  #   # command: bun run start:dev
  #   restart: unless-stopped

  # spa-api:
  #   build:
  #     context: ./backend/spa
  #     dockerfile: Dockerfile
  #   container_name: spa_api
  #   environment:
  #     NODE_ENV: development
  #     PORT: 3103
  #     DATABASE_URL: ${SPA_DATABASE_URL}
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     SHARED_CORE_API_URL: http://shared-core-api:3100
  #     JWT_SECRET: ${JWT_SECRET}
  #   ports:
  #     - "3103:3103"
  #   # depends_on:
  #   #   postgres:
  #   #     condition: service_healthy
  #   #   redis:
  #   #     condition: service_healthy
  #   #   shared-core-api:
  #   #     condition: service_started
  #   # networks:
  #   #   - app-network
  #   restart: unless-stopped

  # --- Frontend Services ---
  admin-ui:
    build:
      context: ./frontend/admin
      dockerfile: Dockerfile
    container_name: admin_ui
    ports:
      - "4400:4400"
    # depends_on:
    #   shared-core-api:
    #     condition: service_started
    # networks:
    #   - app-network
    restart: unless-stopped

  academy-affiliate:
    build:
      context: ./frontend/academy
      dockerfile: Dockerfile
    container_name: academy_affiliate
    # volumes:
    #   - ./frontend/academy:/usr/src/app
    #   - /usr/src/app/node_modules
    ports:
      - "4405:4405"
    # depends_on:
    #   academy-api:
    #     condition: service_started
    #   shared-core-api:
    #     condition: service_started
    # networks:
    #   - app-network
    # command: ng serve --host 0.0.0.0 --port 4200
    restart: unless-stopped

  # cosmetics-ui:
  #   build:
  #     context: ./frontend/cosmetics
  #     dockerfile: Dockerfile
  #   container_name: cosmetics_ui
  #   # volumes:
  #   #   - ./frontend/cosmetics:/usr/src/app
  #   #   - /usr/src/app/node_modules
  #   ports:
  #     - "4402:4402"
  #   # depends_on:
  #   #   cosmetics-api:
  #   #     condition: service_started
  #   #   shared-core-api:
  #   #     condition: service_started
  #   # networks:
  #   #   - app-network
  #   # command: ng serve --host 0.0.0.0 --port 4200
  #   restart: unless-stopped

  # spa-ui:
  #   build:
  #     context: ./frontend/spa
  #     dockerfile: Dockerfile
  #   container_name: spa_ui
  #   # volumes:
  #   #   - ./frontend/spa:/usr/src/app
  #   #   - /usr/src/app/node_modules
  #   ports:
  #     - "4403:4403"
  #   # depends_on:
  #   #   spa-api:
  #   #     condition: service_started
  #   #   shared-core-api:
  #   #     condition: service_started
  #   # networks:
  #   #   - app-network
  #   # command: ng serve --host 0.0.0.0 --port 4200
  #   restart: unless-stopped

  # --- Nginx Reverse Proxy ---
  # nginx:
  #   image: nginx:1.25-alpine
  #   container_name: nginx_proxy
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
  #     - ./nginx/includes:/etc/nginx/includes:ro
  #   depends_on:
  #     - shared-core-api
  #     - academy-api
  #     - cosmetics-api
  #     - spa-api
  #     - admin-ui
  #     - academy-ui
  #     - cosmetics-ui
  #     - spa-ui
  #   networks:
  #     - app-network
  #   restart: unless-stopped

# --- Volumes and Networks ---
# volumes:
#   postgres_data:
#     driver: local
#   pgadmin_data:
#     driver: local
#   redis_data:
#     driver: local
volumes:
  postgres_data:
    driver: local
  minio_data:
    driver: local
  minio_data2:
    driver: local
# networks:
#   app-network:
#     driver: bridge