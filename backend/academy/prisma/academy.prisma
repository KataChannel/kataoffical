generator client {
    provider      = "prisma-client-js"
    binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource postgres {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum ApplicationStatus {
    SUBMITTED
    UNDER_REVIEW 
    WAITLISTED 
    ACCEPTED 
    REJECTED 
    ENROLLED 
    WITHDRAWN
}

enum EnrollmentStatus { 
    ENROLLED 
    IN_PROGRESS 
    COMPLETED 
    WITHDRAWN 
    FAILED 
    AUDITING 
}

enum CourseMode { 
    ONLINE 
    OFFLINE 
    HYBRID 
}

enum GradeType { 
    LETTER 
    NUMBER 
    PASS_FAIL 
}

enum CertificateStatus { 
    PENDING_ISSUANCE 
    ISSUED 
    REVOKED 
}

enum ActivityType { 
    CALL 
    EMAIL 
    MEETING 
    TASK 
    NOTE 
    OTHER 
}

enum ActivityStatus { 
    OPEN 
    IN_PROGRESS 
    COMPLETED 
    CANCELLED 
    DEFERRED 
}

enum WorkflowType { 
    ONBOARDING 
    ADMISSION 
    OTHER 
}

enum WorkflowStatus { 
    PENDING 
    IN_PROGRESS 
    COMPLETED 
    CANCELLED 
}

enum TaskStatus { 
    TODO 
    IN_PROGRESS 
    DONE 
    SKIPPED 
    WAITING 
}



model Student {
    id String @id @default(uuid())
    customerId String @unique
    studentCode String? @unique
    firstName String
    lastName String
    admissionDate DateTime?
    graduationDate DateTime?
    studentStatus String @default("Active")
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    applications Application[]
    enrollments Enrollment[]
    certificates Certificate[]
    activities Activity[] @relation("ActivityStudents")
    workflows StudentWorkflow[]

    @@map("students")
}

model Application {
    id                String            @id @default(uuid())
    applicationCode   String?           @unique
    studentId         String?
    student           Student?          @relation(fields: [studentId], references: [id], onDelete: SetNull)
    programId         String?
    program           Program?          @relation(fields: [programId], references: [id])
    courseId          String?
    course            Course?           @relation(fields: [courseId], references: [id])
    applicationDate   DateTime          @default(now())
    status            ApplicationStatus @default(SUBMITTED)
    notes             String?
    documents         Json?
    assignedToId      String?
    originatingLeadId String?           @unique
    createdAt         DateTime          @default(now())
    updatedAt         DateTime          @updatedAt
    activities        Activity[]        @relation("ActivityApplications")
    workflow          StudentWorkflow?

    @@index([studentId])
    @@index([programId])
    @@index([courseId])
    @@index([status])
    @@index([assignedToId])
    @@map("applications")
}

model Activity {
    id            String         @id @default(uuid())
    subject       String
    type          ActivityType
    status        ActivityStatus @default(OPEN)
    dueDate       DateTime?
    description   String?
    ownerId       String
    applicationId String?
    application   Application?   @relation("ActivityApplications", fields: [applicationId], references: [id], onDelete: Cascade)
    studentId     String?
    student       Student?       @relation("ActivityStudents", fields: [studentId], references: [id], onDelete: Cascade)
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt

    @@index([ownerId])
    @@index([applicationId])
    @@index([studentId])
    @@map("activities")
}

model Program {
    id           String        @id @default(uuid())
    name         String        @unique
    courses      Course[]      @relation("ProgramCourses")
    applications Application[]
    certificates Certificate[]

    @@map("programs")
}

model Course {
    id           String           @id @default(uuid())
    courseCode   String           @unique
    name         String
    programs     Program[]        @relation("ProgramCourses")
    offerings    CourseOffering[]
    applications Application[]
    certificates Certificate[]

    @@map("courses")
}

model CourseOffering {
    id           String       @id @default(uuid())
    offeringCode String       @unique
    courseId     String
    course       Course       @relation(fields: [courseId], references: [id])
    facultyId    String?
    faculty      Faculty?     @relation(fields: [facultyId], references: [id])
    startDate    DateTime
    endDate      DateTime
    mode         CourseMode
    enrollments  Enrollment[]

    @@map("course_offerings")
}

model Faculty {
    id              String           @id @default(uuid())
    email           String           @unique
    userId          String?          @unique
    courseOfferings CourseOffering[]

    @@map("faculty")
}

model Enrollment {
    id               String           @id @default(uuid())
    studentId        String
    student          Student          @relation(fields: [studentId], references: [id])
    courseOfferingId String
    courseOffering   CourseOffering   @relation(fields: [courseOfferingId], references: [id])
    status           EnrollmentStatus @default(ENROLLED)

    @@unique([studentId, courseOfferingId])
    @@map("enrollments")
}

model Certificate {
    id                String   @id @default(uuid())
    studentId         String
    student           Student  @relation(fields: [studentId], references: [id])
    certificateNumber String   @unique
    programId         String?
    program           Program? @relation(fields: [programId], references: [id])
    courseId          String?
    course            Course?  @relation(fields: [courseId], references: [id])

    @@map("certificates")
}

model WorkflowTemplate {
    id            String                 @id @default(uuid())
    name          String                 @unique
    type          WorkflowType
    taskTemplates WorkflowTaskTemplate[]
    workflows     StudentWorkflow[]

    @@map("workflow_templates")
}

model WorkflowTaskTemplate {
    id           String                @id @default(uuid())
    templateId   String
    template     WorkflowTemplate      @relation(fields: [templateId], references: [id])
    name         String
    studentTasks StudentWorkflowTask[]

    @@map("workflow_task_templates")
}

model StudentWorkflow {
    id            String                @id @default(uuid())
    studentId     String?
    student       Student?              @relation(fields: [studentId], references: [id])
    templateId    String
    template      WorkflowTemplate      @relation(fields: [templateId], references: [id])
    status        WorkflowStatus        @default(PENDING)
    tasks         StudentWorkflowTask[]
    applicationId String?               @unique
    application   Application?          @relation(fields: [applicationId], references: [id])

    @@map("student_workflows")
}

model StudentWorkflowTask {
    id             String               @id @default(uuid())
    workflowId     String
    workflow       StudentWorkflow      @relation(fields: [workflowId], references: [id])
    taskTemplateId String
    taskTemplate   WorkflowTaskTemplate @relation(fields: [taskTemplateId], references: [id])
    status         TaskStatus           @default(TODO)
    assigneeId     String?

    @@map("student_workflow_tasks")
}
