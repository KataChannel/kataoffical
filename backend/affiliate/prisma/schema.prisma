generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource postgres {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(uuid())
  codeId             String?            @unique
  name               String?
  avatar             String?
  gender             Gender?
  email              String?
  SDT                String?
  phone              String?
  zaloId             String?
  facebookId         String?
  googleId           String?
  password           String?
  provider           String?
  providerId         String?
  isSuperAdmin       Boolean            @default(false)
  isActive           Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  registrationSource String?
  inviteCode         String?            @unique
  affiliateCode      String?
  referrerId         String?
  audits             AuditLog[]
  Doanhso            Doanhso[]
  HoaHong            HoaHong[]
  LandingPage        LandingPage[]
  Notification       Notification[]
  ThanhToanHoaHong   ThanhToanHoaHong[]
  TrackingEvent      TrackingEvent[]
  referrer           User?              @relation("Referrals", fields: [referrerId], references: [id])
  referrals          User[]             @relation("Referrals")
  roles              UserRole[]
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       UserRole[]
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
}

model Menu {
  id        String   @id @default(uuid())
  title     String
  icon      String?
  slug      String?
  parentId  String?
  order     Int?
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  parent    Menu?    @relation("MenuChildren", fields: [parentId], references: [id])
  children  Menu[]   @relation("MenuChildren")
}

model ChatAIMessage {
  id        String   @id @default(uuid())
  userId    String
  message   String
  reply     String
  createdAt DateTime @default(now())
}

model ChatAIHistory {
  id        String   @id @default(uuid())
  userId    String
  message   String
  sender    String
  createdAt DateTime @default(now())
}

model ErrorLog {
  id        String   @id @default(uuid())
  timestamp DateTime
  message   String
  details   Json?
  source    String
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String?
  entity    String?
  entityId  String?
  oldValue  Json?
  newValue  Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  message   String
  userId    String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model LandingPage {
  id             String          @id @default(uuid())
  title          String
  slug           String          @unique
  description    String?
  thumbnail      String?
  status         String          @default("draft")
  contentJson    Json?
  contentHtml    String?
  customCss      String?
  customJs       String?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  ownerId        String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  codeId         String          @unique
  order          Int?            @default(1)
  isActive       Boolean         @default(true)
  AffiliateLink  AffiliateLink[]
  owner          User?           @relation(fields: [ownerId], references: [id])
}

model TrackingEvent {
  id              String         @id @default(uuid())
  eventType       String?
  pageUrl         String?
  refCode         String?
  referrer        String?
  pageIdentifier  String?
  pageType        String?
  userId          String?
  ipAddress       String?
  userAgent       String?
  affiliateLinkId String?
  sharePlatform   String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  affiliateLink   AffiliateLink? @relation(fields: [affiliateLinkId], references: [id])
  user            User?          @relation(fields: [userId], references: [id])
}

model AffiliateLink {
  id             String          @id @default(uuid())
  codeId         String?         @unique
  landingPageId  String?
  campaignName   String?
  description    String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmTerm        String?
  utmContent     String?
  url            String?
  order          Int?            @default(1)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  landingPage    LandingPage?    @relation(fields: [landingPageId], references: [id])
  Doanhso        Doanhso[]
  HoaHong        HoaHong[]
  trackingEvents TrackingEvent[]
}

model Resource {
  id          String   @id @default(uuid())
  codeId      String?  @unique
  title       String?
  url         String?
  description String?
  fileType    String?
  metaData    Json?
  category    String?
  group       String?
  order       Int?     @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FileManager {
  id          String   @id @default(uuid())
  codeId      String?  @unique
  title       String?
  url         String?
  description String?
  fileType    String?
  fileSize    Int?
  metaData    Json?
  category    String?
  group       String?
  order       Int?     @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Dichvu {
  id              String    @id @default(uuid())
  codeId          String?   @unique
  TabCode         String?
  TabCardCode     String?
  TabMedicineCode String?
  serviceCode     String?
  serviceName     String?
  description     String?
  price           Float
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  order           Int?      @default(1)
  Doanhso         Doanhso[]
  Doanhthu        Doanhthu[]
}

model Doanhso {
  id              String         @id @default(uuid())
  codeId          String?        @unique
  userId          String
  dichvuId        String
  originalAmount  Float?
  discountAmount  Float?
  actualAmount    Float?
  status          OrderStatus    @default(PENDING)
  affiliateCode   String?
  affiliateLinkId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  order           Int?           @default(1)
  affiliateLink   AffiliateLink? @relation(fields: [affiliateLinkId], references: [id])
  dichvu          Dichvu         @relation(fields: [dichvuId], references: [id])
  user            User           @relation(fields: [userId], references: [id])
}

model Doanhthu {
  id          String    @id @default(uuid())
  codeId      String?   @unique
  codeDT      String?   
  dichvuId    String
  dichvu      Dichvu   @relation(fields: [dichvuId], references: [id])
  amount      Float?
  commission  Float?
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  order       Int?      @default(1)
  completedAt DateTime?
  HoaHong     HoaHong[]
}

model HoaHong {
  id              String             @id @default(uuid())
  codeId          String?            @unique
  userId          String
  doanhthuId      String
  affiliateLinkId String?
  tienhoahong     Float
  description     String?
  status          CommissionStatus   @default(PENDING)
  order           Int?               @default(1)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  affiliateLink   AffiliateLink?     @relation(fields: [affiliateLinkId], references: [id])
  doanhthu        Doanhthu           @relation(fields: [doanhthuId], references: [id])
  user            User               @relation(fields: [userId], references: [id])
  payments        ThanhToanHoaHong[]
}

model ThanhToanHoaHong {
  id            String   @id @default(uuid())
  codeId        String?  @unique
  hoaHongId     String
  userId        String
  amountPaid    Float
  paymentMethod String?
  order         Int?     @default(1)
  paymentDate   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  hoaHong       HoaHong  @relation(fields: [hoaHongId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
}
