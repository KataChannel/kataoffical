generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource postgres {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(uuid())
  codeId             String?            @unique
  name               String?
  avatar             String?
  gender             Gender?
  email              String?
  SDT                String?
  phone              String?
  zaloId             String?
  facebookId         String?
  googleId           String?
  password           String?
  provider           String?
  providerId         String?
  isSuperAdmin       Boolean            @default(false)
  isCTV              Boolean            @default(false)
  isActive           Boolean            @default(false)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  registrationSource String?
  inviteCode         String?            @unique
  affiliateCode      String?
  referrerId         String?
  ghichu             String?
  audits             AuditLog[]
  Doanhso            Doanhso[]
  HoaHong            HoaHong[]
  LandingPage        LandingPage[]
  Notification       Notification[]
  ThanhToanHoaHong   ThanhToanHoaHong[]
  TrackingEvent      TrackingEvent[]
  referrer           User?              @relation("Referrals", fields: [referrerId], references: [id])
  referrals          User[]             @relation("Referrals")
  roles              UserRole[]
  AffiliateLink AffiliateLink[]
  lichhen lichhen[]
  khoahoc khoahoc[]
  Dexuat Dexuat[]
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       UserRole[]
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  roles       RolePermission[]
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
}

model Menu {
  id          String   @id @default(uuid())
  title       String
  icon        String?  // Optional icon for menu
  slug        String?  // URL of the menu item
  parentId    String?  // Reference to parent menu (null if root)
  parent      Menu?    @relation("MenuChildren", fields: [parentId], references: [id])
  children    Menu[]   @relation("MenuChildren")
  order       Int?     // For sorting menus
  isActive    Boolean  @default(false) // Enable/Disable menu
  serviceType serviceType?  @default(core) // Field to classify service type (e.g., spa, cms, academy, affiliate)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ChatAIMessage {
  id        String   @id @default(uuid())
  userId    String
  message   String
  reply     String
  createdAt DateTime @default(now())
}

model ChatAIHistory {
  id        String   @id @default(uuid())
  userId    String
  message   String
  sender    String
  createdAt DateTime @default(now())
}

model ErrorLog {
  id        String   @id @default(uuid())
  timestamp DateTime
  message   String
  details   Json?
  source    String
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String?
  entity    String?
  entityId  String?
  oldValue  Json?
  newValue  Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Notification {
  id        String   @id @default(uuid())
  message   String
  userId    String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model LandingPage {
  id             String          @id @default(uuid())
  title          String
  slug           String          @unique
  description    String?
  thumbnail      String?
  status         String          @default("draft")
  contentJson    Json?
  contentHtml    String?
  customCss      String?
  customJs       String?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  ownerId        String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  codeId         String          @unique
  order          Int?            @default(1)
  isActive       Boolean         @default(true)
  AffiliateLink  AffiliateLink[]
  owner          User?           @relation(fields: [ownerId], references: [id])
}

model TrackingEvent {
  id              String         @id @default(uuid())
  eventType       String?
  pageUrl         String?
  refCode         String?
  referrer        String?
  pageIdentifier  String?
  pageType        String?
  userId          String?
  ipAddress       String?
  userAgent       String?
  affiliateLinkId String?
  sharePlatform   String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  affiliateLink   AffiliateLink? @relation(fields: [affiliateLinkId], references: [id])
  user            User?          @relation(fields: [userId], references: [id])
}

model AffiliateLink {
  id             String          @id @default(uuid())
  codeId         String?         @unique
  landingPageId  String?
  campaignName   String?
  description    String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmTerm        String?
  utmContent     String?
  url            String?
  order          Int?            @default(1)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  landingPage    LandingPage?    @relation(fields: [landingPageId], references: [id])
  createdById    String? 
  createdBy      User?           @relation(fields: [createdById], references: [id])
  Doanhso        Doanhso[]
  HoaHong        HoaHong[]
  trackingEvents TrackingEvent[]
}

model Resource {
  id          String   @id @default(uuid())
  codeId      String?  @unique
  title       String?
  url         String?
  description String?
  fileType    String?
  metaData    Json?
  category    String?
  group       String?
  order       Int?     @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FileManager {
  id          String   @id @default(uuid())
  codeId      String?  @unique
  title       String?
  url         String?
  description String?
  fileType    String?
  fileSize    Int?
  metaData    Json?
  category    String?
  group       String?
  order       Int?     @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Dichvu {
  id              String    @id @default(uuid())
  codeId          String?   @unique
  TabCode         String?
  TabCardCode     String?
  TabMedicineCode String?
  serviceCode     String?
  serviceName     String?
  description     String?
  price           Float
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  order           Int?      @default(1)
  Doanhso         Doanhso[]
  Doanhthu        Doanhthu[]
}

model Doanhso {
  id              String         @id @default(uuid())
  codeId          String?        @unique
  userId          String
  dichvuId        String
  originalAmount  Float?
  discountAmount  Float?
  actualAmount    Float?
  status          OrderStatus    @default(PENDING)
  affiliateCode   String?
  affiliateLinkId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  order           Int?           @default(1)
  affiliateLink   AffiliateLink? @relation(fields: [affiliateLinkId], references: [id])
  dichvu          Dichvu         @relation(fields: [dichvuId], references: [id])
  user            User           @relation(fields: [userId], references: [id])
}

model Doanhthu {
  id          String    @id @default(uuid())
  codeId      String?   @unique
  codeDT      String?   
  phone       String?
  dichvuId    String
  dichvu      Dichvu   @relation(fields: [dichvuId], references: [id])
  amount      Float?
  commission  Float?
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  order       Int?      @default(1)
  completedAt DateTime?
  HoaHong     HoaHong[]
}

model HoaHong {
  id              String             @id @default(uuid())
  codeId          String?            @unique
  userId          String
  doanhthuId      String
  affiliateLinkId String?
  tienhoahong     Float             @default(0)
  refphone        String?           // e.g., 'register', 'referral', 'sale' 
  type            String?           // e.g., 'register', 'referral', 'sale' 
  description     String?
  status          CommissionStatus   @default(PENDING)
  order           Int?               @default(1)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  affiliateLink   AffiliateLink?     @relation(fields: [affiliateLinkId], references: [id])
  doanhthu        Doanhthu           @relation(fields: [doanhthuId], references: [id])
  user            User               @relation(fields: [userId], references: [id])
  payments        ThanhToanHoaHong[]
}

model ThanhToanHoaHong {
  id            String   @id @default(uuid())
  codeId        String?  @unique
  hoaHongId     String
  userId        String
  amountPaid    Float
  paymentMethod String?
  order         Int?     @default(1)
  paymentDate   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  hoaHong       HoaHong  @relation(fields: [hoaHongId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
}
model lichhen {
  id              String   @id @default(uuid())
  codeId          String   @unique
  custCode        String?
  phone           String?
  custName        String?
  dateFrom        DateTime?
  statusName      String?
  statusTime      DateTime?
  isCancel        Boolean  @default(false)
  branchName      String?
  createdDate     DateTime @default(now())
  modifiedDate    DateTime @updatedAt
  title           String?
  description     String?
  order           Int?     @default(1)
  createdBy       String? 
  createdByUser   User?   @relation(fields: [createdBy], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model khoahoc {
  id              String   @id @default(uuid())
  codeId          String   @unique
  phone          String?
  phone2         String?
  name           String?
  code           String?
  birthday      DateTime? 
  gender       String?
  serviceCode  String?
  tabCode      String?
  serviceName  String?
  timeIndex    Int?
  timeToTreatment Int?
  priceUnit    Float?
  quantity     Int?
  discount     Float?
  priceRoot    Float?
  priceDiscounted Float?
  branchId    String?
  createdDate  DateTime?
  modifiedDate DateTime?
  state       String?
  title           String?
  description     String?
  order           Int?     @default(1)
  createdBy       String? 
  createdByUser   User?   @relation(fields: [createdBy], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model khachhang {
  id                    String   @id @default(uuid())
  CodeId                String?  @unique
  name                  String?
  code                  String?
  email                 String?
  phone                 String?
  phone2                String?
  birthday              DateTime?
  gender                String?
  address               String?
  customerSource        String?
  customerGroup         String?
  branchId              Int?
  firstPaidDate         DateTime?
  firstCheckinDate      DateTime?
  firstTreatmentDate    DateTime?
  lastTreatmentDate     DateTime?
  lastCheckinDate       DateTime?
  caringStaffCode       String?
  staffCode             String?
  createdDate           DateTime?
  modifiedDate          DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}




enum Gender {
  MALE
  FEMALE
  OTHER
}

enum serviceType {
  core
  spa
  cms
  academy
  affiliate
  cosmetics
  ecommerce
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum DriveItemType {
  folder
  file
}

// === Models from shared-core ===

model Khachhang {
  id           String   @id @default(uuid())
  name         String?
  namenn       String?
  makh         String   @unique
  diachi       String?
  sdt          String?
  mst          String?
  gionhanhang  String?
  quan         String?
  email        String? 
  phone        String?
  address      String?
  loaikh       String?
  ghichu       String?
  hiengia     Boolean  @default(false)
  isActive     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  nhomkhachhang Nhomkhachhang[] @relation("KhachhangNhom")
}

model Nhomkhachhang {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  khachhang   Khachhang[]  @relation("KhachhangNhom")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Quanlyqrcode {
  id        String   @id @default(uuid())
  title     String?   // Tiêu đề của QR code
  slug      String?   // URL thân thiện, ví dụ: "chien-dich-thang-4"
  qrcode    String   @unique
  code      String   @unique
  name      String?   // Họ Tên khách mời
  phone     String?   // Số Điện Thoại
  email     String?   // Email
  isSentEmail      Boolean  @default(false)
  isSentZalo      Boolean  @default(false)
  order      Int? @default(1)
  isActive  Boolean @default(true)
  checkedAt DateTime?  // Null nếu chưa check-in, lưu thời gian nếu đã check-in
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([slug, phone, email], name: "Quanlyqrcode_slug_phone_email_key")
}

model DriveItem {
  id          String           @id @default(uuid())
  googleId    String           @unique
  name        String
  type        DriveItemType
  parentId    String?
  mimeType    String?
  path        String?
  size        BigInt?
  isDelete     Boolean? @default(false)
  createdTime  DateTime?
  modifiedTime DateTime?
  permissions PermissionDrive[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([type,parentId])
}

model PermissionDrive {
  id           String    @id @default(uuid())
  userIdDrive  String
  type         String    // "user" hoặc "group"
  kind         String    // "drive#permission"
  emailAddress String?
  role         String    // "reader", "writer", "commenter", "owner"
  driveId      String
  googleId     String
  driveItem    DriveItem @relation(fields: [driveId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now())

  @@unique([userIdDrive, driveId,googleId], name: "uniqueUserDriveItemPermission")
}

model Dexuat {
  id            String    @id @default(uuid()) // ID tự động sinh
  title         String
  chitiet       ChitietDexuat[] @relation("DexuatToChitiet")
  tienbangchu   String?
  tongtien      Int?
  tongchi       Int?
  ngaytao       DateTime? @default(now())
  nguoinhan     String?
  truongbophan  String?
  nguoidexuat   String?
  bophan        String?
  vitri         String?
  attachments   Json?     @default("[]")// Lưu trữ đường dẫn hoặc thông tin về file đính kèm
  ghichu        String?
  tamung        Int? @default(0)
  codeId        String @unique // Mã đề xuất duy nhất
  order        Int? @default(1)
  isActive  Boolean @default(true)
  createdById String
  createdBy  User?  @relation(fields: [createdById], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChitietDexuat {
  id       String  @id @default(uuid()) 
  dexuatId String  
  dexuat   Dexuat  @relation("DexuatToChitiet", fields: [dexuatId], references: [id], onDelete: Cascade)
  title    String  
  thanhtien Int?    
  ghichu   String? 
  order      Int? @default(1)
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
