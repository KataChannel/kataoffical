generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource postgres {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELLED
}

model User {
  id                 String               @id @default(uuid())
  codeId             String?              @unique
  name               String?
  avatar             String?
  gender             Gender?
  email              String?              
  SDT                String?              
  phone              String?              
  zaloId             String?              
  facebookId         String?              
  googleId           String?              
  password           String?
  provider           String?
  providerId         String?              
  isSuperAdmin       Boolean              @default(false)
  roles              UserRole[]
  isActive           Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  audits             AuditLog[]
  Notification       Notification[]
  LandingPage        LandingPage[]
  registrationSource String?
  inviteCode         String?              @unique
  affiliateCode      String?            
  referrerId         String?
  referrer           User?                @relation("Referrals", fields: [referrerId], references: [id])
  referrals          User[]               @relation("Referrals")
  TrackingEvent      TrackingEvent[]
  Doanhso            Doanhso[]              // Các đơn hàng của user
  HoaHong            HoaHong[]
  ThanhToanHoaHong   ThanhToanHoaHong[]
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
}

model Menu {
  id        String   @id @default(uuid())
  title     String
  icon      String?
  slug      String?
  parentId  String?
  parent    Menu?    @relation("MenuChildren", fields: [parentId], references: [id])
  children  Menu[]   @relation("MenuChildren")
  order     Int?
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChatAIMessage {
  id        String   @id @default(uuid())
  userId    String
  message   String
  reply     String
  createdAt DateTime @default(now())
}

model ChatAIHistory {
  id        String   @id @default(uuid())
  userId    String
  message   String
  sender    String
  createdAt DateTime @default(now())
}

model ErrorLog {
  id        String   @id @default(uuid())
  timestamp DateTime
  message   String
  details   Json?
  source    String
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String?
  entity    String?
  entityId  String?
  oldValue  Json?
  newValue  Json?
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  message   String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model LandingPage {
  id             String          @id @default(uuid())
  title          String
  slug           String          @unique
  description    String?
  thumbnail      String?
  status         String          @default("draft")
  contentJson    Json?
  contentHtml    String?
  customCss      String?
  customJs       String?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  ownerId        String?
  owner          User?           @relation(fields: [ownerId], references: [id])
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  codeId         String          @unique
  order          Int?            @default(1)
  isActive       Boolean         @default(true)
  AffiliateLink  AffiliateLink[]
}

model TrackingEvent {
  id              String         @id @default(uuid())
  eventType       String?
  pageUrl         String?
  refCode         String?
  referrer        String?
  pageIdentifier  String?
  pageType        String?
  userId          String?
  user            User?          @relation(fields: [userId], references: [id])
  ipAddress       String?
  userAgent       String?
  affiliateLinkId String?
  affiliateLink   AffiliateLink? @relation(fields: [affiliateLinkId], references: [id])
  sharePlatform   String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model AffiliateLink {
  id             String         @id @default(uuid())
  codeId         String?        @unique
  landingPageId  String?
  landingPage    LandingPage?   @relation(fields: [landingPageId], references: [id])
  campaignName   String?
  description    String?
  utmSource      String?
  utmMedium      String?
  utmCampaign    String?
  utmTerm        String?
  utmContent     String?
  url            String?
  trackingEvents TrackingEvent[]
  order          Int?           @default(1)
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  HoaHong        HoaHong[]
  Doanhso        Doanhso[]
}

model Resource {
  id          String   @id @default(uuid())
  codeId      String?  @unique
  title       String?
  url         String?
  description String?
  fileType    String?
  metaData    Json?
  category    String?
  group       String?
  order       Int?     @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model FileManager {
  id          String   @id @default(uuid())
  codeId      String?  @unique
  title       String?
  url         String?
  description String?
  fileType    String?
  fileSize    Int?
  metaData    Json?
  category    String?
  group       String?
  order       Int?     @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Dichvu {
  id          String   @id @default(uuid())
  codeId      String?  @unique
  tabCode     String?  // Mã tab (nếu có)
  TabCardCode String? // Mã tab card (nếu có)
  TabMedicineCode String? // Mã tab thuốc (nếu có)
  serviceCode  String?  // Mã dịch vụ (có thể là mã định danh duy nhất)
  serviceName String? // Tên dịch vụ (có thể là tên dịch vụ bên ngoài)
  description String?
  price       Float    // Giá gốc (doanh số)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt         
  order       Int?     @default(1)
  Doanhso     Doanhso[] // Các doanh số liên quan đến dịch vụ này
}

model Doanhso {
  id              String             @id @default(uuid())
  codeId          String?            @unique
  userId          String
  user            User               @relation(fields: [userId], references: [id])
  dichvuId        String
  dichvu          Dichvu             @relation(fields: [dichvuId], references: [id])
  originalAmount  Float               // Giá gốc (doanh số)
  discountAmount  Float?              // Khuyến mãi
  actualAmount    Float               // Doanh thu thực tế
  status          OrderStatus         @default(PENDING)
  affiliateCode   String?             // Mã affiliate của người giới thiệu
  affiliateLinkId String?             // Liên kết affiliate
  affiliateLink   AffiliateLink?      @relation(fields: [affiliateLinkId], references: [id])
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  order           Int?                @default(1) // Thứ tự doanh số trong chuỗi
  Doanhthu        Doanhthu[]          // Các đợt doanh thu liên quan
}

model Doanhthu {
  id            String      @id @default(uuid())
  codeId        String?     @unique
  doanhsoId     String
  doanhso       Doanhso     @relation(fields: [doanhsoId], references: [id])
  amount        Float       // Số tiền mỗi đợt
  commission    Float       // Hoa hồng mỗi đợt
  status        String      @default("PENDING") // PENDING, COMPLETED
  createdAt     DateTime    @default(now())
  updatedAt       DateTime            @updatedAt
  order         Int?        @default(1) // Thứ tự doanh thu trong chuỗi
  completedAt   DateTime?
  HoaHong       HoaHong[]
}

model HoaHong {
  id               String            @id @default(uuid())
  codeId           String?           @unique
  userId           String
  user             User              @relation(fields: [userId], references: [id])
  doanhthuId       String
  doanhthu         Doanhthu          @relation(fields: [doanhthuId], references: [id])
  affiliateLinkId  String?
  affiliateLink    AffiliateLink?    @relation(fields: [affiliateLinkId], references: [id])
  tienhoahong      Float             // Tổng hoa hồng
  description      String?
  status           CommissionStatus  @default(PENDING)
  order            Int?              @default(1) // Thứ tự hoa hồng trong chuỗi
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  payments         ThanhToanHoaHong[] // Các lần rút hoa hồng
}

model ThanhToanHoaHong {
  id            String      @id @default(uuid())
  codeId        String?     @unique
  hoaHongId     String
  hoaHong       HoaHong     @relation(fields: [hoaHongId], references: [id])
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  amountPaid    Float       // Số tiền rút
  paymentMethod String?     // Ví dụ: chuyển khoản, PayPal
  order         Int?        @default(1)
  paymentDate   DateTime    @default(now())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}