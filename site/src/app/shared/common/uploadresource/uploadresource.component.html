<div
  class="drop-zone-container p-4"
  (click)="$event.target === fileInput ? null : fileInput.click()"
  >
  <div
    class="border-2 border-dashed rounded-lg p-6 text-center cursor-pointer transition-colors duration-200 ease-in-out mb-5"
    [ngClass]="{
      'border-blue-500 bg-blue-50': isDragOver,
      'border-gray-300 hover:border-gray-400 bg-gray-50 hover:bg-gray-100': !isDragOver
    }"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
    >
    <input
      type="file"
      #fileInput
      (change)="onFileSelected($event)"
      multiple
      class="hidden"
      />
      @if (!selectedFiles.length) {
        <div class="flex flex-col items-center justify-center">
          <svg class="w-12 h-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          <p class="mb-1 text-sm text-gray-600">
            <span class="font-semibold">Kéo và thả file</span> hoặc <span class="text-blue-600 hover:underline">nhấn để chọn</span>
          </p>
          <div class="text-xs text-gray-500 space-y-0.5">
            @if (maxFileSizeMB > 0) {
              <p>(Tối đa: {{ maxFileSizeMB }}MB)</p>
            }
            @if (allowedFileTypes && allowedFileTypes.length) {
              <p>Loại file: {{ allowedFileTypes.join(', ') }}</p>
            }
            @if (category) {
              <p>Category: <span class="font-medium text-gray-700">{{ category }}</span></p>
            }
            @if (group) {
              <p>Group: <span class="font-medium text-gray-700">{{ group }}</span></p>
            }
          </div>
        </div>
      }

      @if (selectedFiles.length) {
        <div class="mt-4 text-left">
          <h4 class="text-sm font-semibold text-gray-700 mb-2">
            File đã chọn:
            @if (category || group) {
              <span class="text-xs font-normal text-gray-500">
                (Category: {{category || 'N/A'}}, Group: {{group || 'N/A'}})
              </span>
            }
          </h4>
          <ul class="list-none p-0 m-0 space-y-2">
            @for (file of selectedFiles; track file; let i = $index) {
              <li
                class="bg-white border rounded-md p-3 flex flex-col sm:flex-row sm:justify-between sm:items-center shadow-sm"
          [ngClass]="{
            'border-gray-200': !fileErrors[file.name],
            'border-red-300 bg-red-50': fileErrors[file.name]
          }"
                >
                <div class="flex-grow break-all pr-2 mb-2 sm:mb-0">
                  <span class="text-sm text-gray-800 font-medium">{{ file.name }}</span>
                  <span class="text-xs text-gray-500 block sm:inline sm:ml-2">({{ formatFileSize(file.size) }}) - Type: {{file.type || 'không xác định'}}</span>
                </div>
                <button
                  (click)="removeFile(i, $event)"
                  class="bg-red-100 text-red-600 hover:bg-red-200 hover:text-red-700 text-xs font-medium px-3 py-1.5 rounded-md transition-colors duration-150 self-start sm:self-center shrink-0"
                  >
                  Xóa
                </button>
                @if (fileErrors[file.name]) {
                  <div class="text-red-600 text-xs mt-1.5 basis-full">
                    {{ fileErrors[file.name] }}
                  </div>
                }
              </li>
            }
          </ul>
        </div>
      }

      @if (uploadProgress > 0 && uploadProgress < 100 && isUploading) {
        <div class="w-full bg-gray-200 rounded-full mt-4 overflow-hidden">
          <div
            class="bg-blue-500 text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-full transition-all duration-300 ease-linear"
            [style.width.%]="uploadProgress"
            >
            {{ uploadProgress }}%
          </div>
        </div>
      }

      @if (uploadMessage) {
        <div class="mt-3 text-sm py-2 px-3 rounded-md"
      [ngClass]="{
        'bg-green-50 text-green-700 border border-green-200': isUploadSuccess,
        'bg-red-50 text-red-700 border border-red-200': !isUploadSuccess
      }">
          {{ uploadMessage }}
        </div>
      }

      @if (selectedFiles.length && !isUploading) {
        <button
          (click)="onUpload($event)"
          class="mt-5 w-full sm:w-auto bg-blue-600 hover:bg-blue-700 disabled:bg-gray-300 text-white font-semibold px-6 py-2.5 rounded-md text-sm transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
          [disabled]="hasErrors() || validFilesCount() === 0"
          >
          Upload {{ validFilesCount() }} file hợp lệ
        </button>
      }
    </div>
  </div>