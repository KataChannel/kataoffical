import './polyfills.server.mjs';
import{a as H}from"./chunk-RCOFY3Z4.mjs";import{a as y}from"./chunk-73IBRO6I.mjs";import{a as v,b as w}from"./chunk-5BGV5II6.mjs";import{a as h}from"./chunk-7TFSUZVW.mjs";import{a as C}from"./chunk-JBY2G2QH.mjs";import{d as S}from"./chunk-5AGSEX5U.mjs";import{Na as r,fa as b,ka as g,la as k}from"./chunk-UMNV2BXK.mjs";import{a as f,b as m,j as s}from"./chunk-RIAI3ORJ.mjs";var A=class p{constructor(a,e,n){this._StorageService=a;this.router=e;this._ErrorLogService=n}_snackBar=k(w);ListHoadon=r([]);DetailHoadon=r({});page=r(1);pageCount=r(1);total=r(0);pageSize=r(10);hoadonId=r(null);socket=v(`${h.APIURL}`,{transports:["websocket"],reconnectionAttempts:5,timeout:5e3});initDB(){return s(this,null,function*(){return yield y("HoadonDB",4,{upgrade(a,e){e<1&&a.createObjectStore("hoadons",{keyPath:"id"}),e<3&&(a.objectStoreNames.contains("hoadons")&&a.deleteObjectStore("hoadons"),a.objectStoreNames.contains("pagination")&&a.deleteObjectStore("pagination"),a.createObjectStore("hoadons",{keyPath:"id"})),e<4}})})}saveHoadons(a,e){return s(this,null,function*(){let d=(yield this.initDB()).transaction("hoadons","readwrite"),o=d.objectStore("hoadons");yield o.clear(),yield o.put({id:"data",hoadons:a,pagination:e}),yield d.done})}getCachedData(){return s(this,null,function*(){let e=yield(yield this.initDB()).get("hoadons","data");return e&&e.hoadons?{hoadons:e.hoadons,pagination:e.pagination||{page:1,pageCount:1,total:e.hoadons.length,pageSize:10}}:{hoadons:[],pagination:{page:1,pageCount:1,total:0,pageSize:10}}})}setHoadonId(a){this.hoadonId.set(a)}fetchData(a){return s(this,null,function*(){let e=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/${a.type=="banra"?"sold":"purchase"}?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50${a.state?`&state=${a.state}`:""}&search=tdlap=ge=${a.batdau};tdlap=le=${a.ketthuc}`;try{let n={headers:{Authorization:`Bearer ${a.token}`}},d=yield fetch(e,n);if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);let o=yield d.json();if(console.log(o),o.datas.length>0)for(let t of o.datas){let u={id:t.id,nbmst:String(t.nbmst),khmshdon:t.khmshdon!=null?Number(t.khmshdon):void 0,khhdon:t.khhdon??void 0,shdon:t.shdon!=null?Number(t.shdon):void 0,cqt:t.cqt??void 0,cttkhac:t.cttkhac??void 0,dvtte:t.dvtte??void 0,hdon:t.hdon??void 0,hsgcma:t.hsgcma??void 0,hsgoc:t.hsgoc??void 0,hthdon:t.hthdon!=null?Number(t.hthdon):void 0,htttoan:t.htttoan!=null?Number(t.htttoan):void 0,idtbao:t.idtbao??void 0,khdon:t.khdon??void 0,khhdgoc:t.khhdgoc??void 0,khmshdgoc:t.khmshdgoc??void 0,lhdgoc:t.lhdgoc??void 0,mhdon:t.mhdon??void 0,mtdiep:t.mtdiep??void 0,mtdtchieu:t.mtdtchieu??void 0,nbdchi:t.nbdchi??void 0,nbhdktngay:t.nbhdktngay?new Date(t.nbhdktngay):void 0,nbhdktso:t.nbhdktso??void 0,nbhdso:t.nbhdso??void 0,nblddnbo:t.nblddnbo??void 0,nbptvchuyen:t.nbptvchuyen??void 0,nbstkhoan:t.nbstkhoan??void 0,nbten:t.nbten??void 0,nbtnhang:t.nbtnhang??void 0,nbtnvchuyen:t.nbtnvchuyen??void 0,ncma:t.ncma?new Date(t.ncma):void 0,ncnhat:t.ncnhat?new Date(t.ncnhat):void 0,ngcnhat:t.ngcnhat??void 0,nky:t.nky?new Date(t.nky):void 0,nmdchi:t.nmdchi??void 0,nmmst:t.nmmst??void 0,nmstkhoan:t.nmstkhoan??void 0,nmten:t.nmten??void 0,nmtnhang:t.nmtnhang??void 0,nmtnmua:t.nmtnmua??void 0,ntao:t.ntao?new Date(t.ntao):void 0,ntnhan:t.ntnhan?new Date(t.ntnhan):void 0,pban:t.pban??void 0,ptgui:t.ptgui!=null?Number(t.ptgui):void 0,shdgoc:t.shdgoc??void 0,tchat:t.tchat!=null?Number(t.tchat):void 0,tdlap:t.tdlap?new Date(t.tdlap):void 0,tgia:t.tgia!=null?Number(t.tgia):void 0,tgtcthue:t.tgtcthue!=null?Number(t.tgtcthue):void 0,tgtthue:t.tgtthue!=null?Number(t.tgtthue):void 0,tgtttbchu:t.tgtttbchu??void 0,tgtttbso:t.tgtttbso!=null?Number(t.tgtttbso):void 0,thdon:t.thdon??void 0,thlap:t.thlap!=null?Number(t.thlap):void 0,thttlphi:t.thttlphi??void 0,tlhdon:t.tlhdon??void 0,ttcktmai:t.ttcktmai!=null?Number(t.ttcktmai):void 0,tthai:t.tthai!=null?Number(t.tthai):void 0,tttbao:t.tttbao!=null?Number(t.tttbao):void 0,ttxly:t.ttxly!=null?Number(t.ttxly):void 0,tvandnkntt:t.tvandnkntt??void 0,mhso:t.mhso??void 0,ladhddt:t.ladhddt!=null?Number(t.ladhddt):void 0,mkhang:t.mkhang??void 0,nbsdthoai:t.nbsdthoai??void 0,nbdctdtu:t.nbdctdtu??void 0,nbfax:t.nbfax??void 0,nbwebsite:t.nbwebsite??void 0,nbcks:t.nbcks??void 0,nmsdthoai:t.nmsdthoai??void 0,nmdctdtu:t.nmdctdtu??void 0,nmcmnd:t.nmcmnd??void 0,nmcks:t.nmcks??void 0,bhphap:t.bhphap!=null?Number(t.bhphap):void 0,hddunlap:t.hddunlap??void 0,gchdgoc:t.gchdgoc??void 0,tbhgtngay:t.tbhgtngay?new Date(t.tbhgtngay):void 0,bhpldo:t.bhpldo??void 0,bhpcbo:t.bhpcbo??void 0,bhpngay:t.bhpngay?new Date(t.bhpngay):void 0,tdlhdgoc:t.tdlhdgoc??void 0,tgtphi:t.tgtphi!=null?Number(t.tgtphi):void 0,unhiem:t.unhiem??void 0,mstdvnunlhdon:t.mstdvnunlhdon??void 0,tdvnunlhdon:t.tdvnunlhdon??void 0,nbmdvqhnsach:t.nbmdvqhnsach??void 0,nbsqdinh:t.nbsqdinh??void 0,nbncqdinh:t.nbncqdinh??void 0,nbcqcqdinh:t.nbcqcqdinh??void 0,nbhtban:t.nbhtban??void 0,nmmdvqhnsach:t.nmmdvqhnsach??void 0,nmddvchden:t.nmddvchden??void 0,nmtgvchdtu:t.nmtgvchdtu??void 0,nmtgvchdden:t.nmtgvchdden??void 0,nbtnban:t.nbtnban??void 0,dcdvnunlhdon:t.dcdvnunlhdon??void 0,dksbke:t.dksbke??void 0,dknlbke:t.dknlbke??void 0,thtttoan:t.thtttoan??void 0,msttcgp:t.msttcgp??void 0,gchu:t.gchu??void 0,kqcht:t.kqcht??void 0,hdntgia:t.hdntgia??void 0,tgtkcthue:t.tgtkcthue??void 0,tgtkhac:t.tgtkhac!=null?Number(t.tgtkhac):void 0,nmshchieu:t.nmshchieu??void 0,nmnchchieu:t.nmnchchieu??void 0,nmnhhhchieu:t.nmnhhhchieu??void 0,nmqtich:t.nmqtich??void 0,ktkhthue:t.ktkhthue??void 0,hdhhdvu:t.hdhhdvu??void 0,qrcode:t.qrcode??void 0,ttmstten:t.ttmstten??void 0,ladhddtten:t.ladhddtten??void 0,hdxkhau:t.hdxkhau??void 0,hdxkptquan:t.hdxkptquan??void 0,hdgktkhthue:t.hdgktkhthue??void 0,hdonLquans:t.hdonLquans??void 0,tthdclquan:t.tthdclquan!=null?!!t.tthdclquan:void 0,pdndungs:t.pdndungs??void 0,hdtbssrses:t.hdtbssrses??void 0,hdTrung:t.hdTrung??void 0,isHDTrung:t.isHDTrung!=null?!!t.isHDTrung:void 0};yield this.CreateHoadon(u),yield new Promise(i=>setTimeout(i,300))}return o}catch(n){return this._ErrorLogService.logError("Failed to CreateHoadon",n),console.error(n)}})}CreateHoadon(a){return s(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(a)},n=yield fetch(`${h.APIURL}/hoadon`,e);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);let d=yield n.json();this.getAllHoadon(this.pageSize()),this.hoadonId.set(d.id)}catch(e){this._ErrorLogService.logError("Failed to CreateHoadon",e),console.error(e)}})}getAllHoadon(){return s(this,arguments,function*(a=this.pageSize(),e=!1){this.pageSize.set(a);let n=yield this.getCachedData(),d=this._StorageService.getItem("hoadons_updatedAt")||"0";if(!e&&n.hoadons.length>0&&Date.now()-new Date(d).getTime()<5*60*1e3)return this.ListHoadon.set(n.hoadons),this.page.set(n.pagination.page),this.pageCount.set(n.pagination.pageCount),this.total.set(n.pagination.total),this.pageSize.set(n.pagination.pageSize),n.hoadons;try{let o={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}};if(!e){let c=yield fetch(`${h.APIURL}/hoadon/lastupdated`,o);if(!c.ok)return this.handleError(c.status),this.ListHoadon.set(n.hoadons),this.page.set(n.pagination.page),this.pageCount.set(n.pagination.pageCount),this.total.set(n.pagination.total),this.pageSize.set(n.pagination.pageSize),n.hoadons;let{updatedAt:l}=yield c.json();if(l<=d)return this.ListHoadon.set(n.hoadons),this.page.set(n.pagination.page),this.pageCount.set(n.pagination.pageCount),this.total.set(n.pagination.total),this.pageSize.set(n.pagination.pageSize),n.hoadons}let t=new URLSearchParams({page:this.page().toString(),limit:a.toString()}),u=yield fetch(`${h.APIURL}/hoadon?${t}`,o);if(!u.ok)return this.handleError(u.status),this.ListHoadon.set(n.hoadons),this.page.set(n.pagination.page),this.pageCount.set(n.pagination.pageCount),this.total.set(n.pagination.total),this.pageSize.set(n.pagination.pageSize),n.hoadons;let i=yield u.json();if(yield this.saveHoadons(i.data,{page:i.page||1,pageCount:i.pageCount||1,total:i.total||i.data.length,pageSize:a}),e)this._StorageService.setItem("hoadons_updatedAt",new Date().toISOString());else{let c=yield fetch(`${h.APIURL}/hoadon/lastupdated`,o),{updatedAt:l}=yield c.json();this._StorageService.setItem("hoadons_updatedAt",l)}return this.ListHoadon.set(i.data),this.page.set(i.page||1),this.pageCount.set(i.pageCount||1),this.total.set(i.total||i.data.length),this.pageSize.set(a),i.data}catch(o){return this._ErrorLogService.logError("Failed to getAllHoadon",o),console.error(o),this.ListHoadon.set(n.hoadons),this.page.set(n.pagination.page),this.pageCount.set(n.pagination.pageCount),this.total.set(n.pagination.total),this.pageSize.set(n.pagination.pageSize),n.hoadons}})}getUpdatedCodeIds(){return s(this,null,function*(){try{let a={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},e=yield fetch(`${h.APIURL}/hoadon/updateCodeIds`,a);e.ok||this.handleError(e.status);let n=yield e.json();return this.getAllHoadon(this.pageSize()),n.data}catch(a){this._ErrorLogService.logError("Failed to getUpdatedCodeIds",a),console.error(a)}})}listenHoadonUpdates(){this.socket.on("hoadon-updated",()=>s(this,null,function*(){console.log("\u{1F504} D\u1EEF li\u1EC7u s\u1EA3n ph\u1EA9m thay \u0111\u1ED5i, c\u1EADp nh\u1EADt l\u1EA1i cache..."),this._StorageService.removeItem("hoadons_updatedAt"),yield this.getAllHoadon(this.pageSize())}))}getHoadonBy(n){return s(this,arguments,function*(a,e=this.pageSize()){this.pageSize.set(e);try{let d={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(m(f({},a),{page:this.page(),limit:e}))},o=yield fetch(`${h.APIURL}/hoadon/findby`,d);o.ok||this.handleError(o.status);let t=yield o.json();a.isOne===!0?this.DetailHoadon.set(t):(yield this.saveHoadons(t.data,{page:t.page||1,pageCount:t.pageCount||1,total:t.total||t.data.length,pageSize:e}),this._StorageService.setItem("hoadons_updatedAt",new Date().toISOString()),this.ListHoadon.set(t.data),this.page.set(t.page||1),this.pageCount.set(t.pageCount||1),this.total.set(t.total||t.data.length),this.pageSize.set(e))}catch(d){this._ErrorLogService.logError("Failed to getHoadonBy",d),console.error(d);let o=yield this.getCachedData();a.isOne||(this.ListHoadon.set(o.hoadons),this.page.set(o.pagination.page),this.pageCount.set(o.pagination.pageCount),this.total.set(o.pagination.total),this.pageSize.set(o.pagination.pageSize))}})}updateHoadon(a){return s(this,null,function*(){try{let e={method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(a)},n=yield fetch(`${h.APIURL}/hoadon/${a.id}`,e);n.ok||this.handleError(n.status);let d=yield n.json();this.getAllHoadon(this.pageSize()),this.getHoadonBy({id:d.id,isOne:!0},this.pageSize())}catch(e){this._ErrorLogService.logError("Failed to updateHoadon",e),console.error(e)}})}DeleteHoadon(a){return s(this,null,function*(){try{let e={method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},n=yield fetch(`${h.APIURL}/hoadon/${a.id}`,e);n.ok||this.handleError(n.status),this.getAllHoadon(this.pageSize())}catch(e){this._ErrorLogService.logError("Failed to DeleteHoadon",e),console.error(e)}})}handleError(a){let e="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(a){case 400:e="Th\xF4ng tin \u0111\xE3 t\u1ED3n t\u1EA1i";break;case 401:case 404:e="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:e="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp";break;case 500:e="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break}this._snackBar.open(e,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}static \u0275fac=function(e){return new(e||p)(g(C),g(S),g(H))};static \u0275prov=b({token:p,factory:p.\u0275fac,providedIn:"root"})};export{A as a};
