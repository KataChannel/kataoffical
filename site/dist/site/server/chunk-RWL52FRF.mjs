import './polyfills.server.mjs';
import{a as b}from"./chunk-73IBRO6I.mjs";import{a as y}from"./chunk-W3RCW6DE.mjs";import{a as p,b as k}from"./chunk-ZSTYAD2I.mjs";import{a as r}from"./chunk-7TFSUZVW.mjs";import{a as v}from"./chunk-UB5YCHDJ.mjs";import{d as m}from"./chunk-YRF26LGI.mjs";import{La as c,ea as f,ja as u,ka as g}from"./chunk-6DA2FG3T.mjs";import{j as i}from"./chunk-RIAI3ORJ.mjs";var w=class l{constructor(d,t,e){this._StorageService=d;this.router=t;this._ErrorLogService=e}_snackBar=g(k);ListHoadon=c([]);DetailHoadon=c({});hoadonId=c(null);setHoadonId(d){this.hoadonId.set(d)}socket=p(`${r.APIURL}`,{transports:["websocket"],reconnectionAttempts:5,timeout:5e3});fetchData(d){return i(this,null,function*(){let t=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/${d.type=="banra"?"sold":"purchase"}?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50${d.state?`&state=${d.state}`:""}&search=tdlap=ge=${d.batdau};tdlap=le=${d.ketthuc}`;try{let e={headers:{Authorization:`Bearer ${d.token}`}},o=yield fetch(t,e);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);let a=yield o.json();if(console.log(a),a.datas.length>0)for(let n of a.datas){let h={id:n.id,nbmst:String(n.nbmst),khmshdon:n.khmshdon!=null?Number(n.khmshdon):void 0,khhdon:n.khhdon??void 0,shdon:n.shdon!=null?Number(n.shdon):void 0,cqt:n.cqt??void 0,cttkhac:n.cttkhac??void 0,dvtte:n.dvtte??void 0,hdon:n.hdon??void 0,hsgcma:n.hsgcma??void 0,hsgoc:n.hsgoc??void 0,hthdon:n.hthdon!=null?Number(n.hthdon):void 0,htttoan:n.htttoan!=null?Number(n.htttoan):void 0,idtbao:n.idtbao??void 0,khdon:n.khdon??void 0,khhdgoc:n.khhdgoc??void 0,khmshdgoc:n.khmshdgoc??void 0,lhdgoc:n.lhdgoc??void 0,mhdon:n.mhdon??void 0,mtdiep:n.mtdiep??void 0,mtdtchieu:n.mtdtchieu??void 0,nbdchi:n.nbdchi??void 0,nbhdktngay:n.nbhdktngay?new Date(n.nbhdktngay):void 0,nbhdktso:n.nbhdktso??void 0,nbhdso:n.nbhdso??void 0,nblddnbo:n.nblddnbo??void 0,nbptvchuyen:n.nbptvchuyen??void 0,nbstkhoan:n.nbstkhoan??void 0,nbten:n.nbten??void 0,nbtnhang:n.nbtnhang??void 0,nbtnvchuyen:n.nbtnvchuyen??void 0,ncma:n.ncma?new Date(n.ncma):void 0,ncnhat:n.ncnhat?new Date(n.ncnhat):void 0,ngcnhat:n.ngcnhat??void 0,nky:n.nky?new Date(n.nky):void 0,nmdchi:n.nmdchi??void 0,nmmst:n.nmmst??void 0,nmstkhoan:n.nmstkhoan??void 0,nmten:n.nmten??void 0,nmtnhang:n.nmtnhang??void 0,nmtnmua:n.nmtnmua??void 0,ntao:n.ntao?new Date(n.ntao):void 0,ntnhan:n.ntnhan?new Date(n.ntnhan):void 0,pban:n.pban??void 0,ptgui:n.ptgui!=null?Number(n.ptgui):void 0,shdgoc:n.shdgoc??void 0,tchat:n.tchat!=null?Number(n.tchat):void 0,tdlap:n.tdlap?new Date(n.tdlap):void 0,tgia:n.tgia!=null?Number(n.tgia):void 0,tgtcthue:n.tgtcthue!=null?Number(n.tgtcthue):void 0,tgtthue:n.tgtthue!=null?Number(n.tgtthue):void 0,tgtttbchu:n.tgtttbchu??void 0,tgtttbso:n.tgtttbso!=null?Number(n.tgtttbso):void 0,thdon:n.thdon??void 0,thlap:n.thlap!=null?Number(n.thlap):void 0,thttlphi:n.thttlphi??void 0,tlhdon:n.tlhdon??void 0,ttcktmai:n.ttcktmai!=null?Number(n.ttcktmai):void 0,tthai:n.tthai!=null?Number(n.tthai):void 0,tttbao:n.tttbao!=null?Number(n.tttbao):void 0,ttxly:n.ttxly!=null?Number(n.ttxly):void 0,tvandnkntt:n.tvandnkntt??void 0,mhso:n.mhso??void 0,ladhddt:n.ladhddt!=null?Number(n.ladhddt):void 0,mkhang:n.mkhang??void 0,nbsdthoai:n.nbsdthoai??void 0,nbdctdtu:n.nbdctdtu??void 0,nbfax:n.nbfax??void 0,nbwebsite:n.nbwebsite??void 0,nbcks:n.nbcks??void 0,nmsdthoai:n.nmsdthoai??void 0,nmdctdtu:n.nmdctdtu??void 0,nmcmnd:n.nmcmnd??void 0,nmcks:n.nmcks??void 0,bhphap:n.bhphap!=null?Number(n.bhphap):void 0,hddunlap:n.hddunlap??void 0,gchdgoc:n.gchdgoc??void 0,tbhgtngay:n.tbhgtngay?new Date(n.tbhgtngay):void 0,bhpldo:n.bhpldo??void 0,bhpcbo:n.bhpcbo??void 0,bhpngay:n.bhpngay?new Date(n.bhpngay):void 0,tdlhdgoc:n.tdlhdgoc??void 0,tgtphi:n.tgtphi!=null?Number(n.tgtphi):void 0,unhiem:n.unhiem??void 0,mstdvnunlhdon:n.mstdvnunlhdon??void 0,tdvnunlhdon:n.tdvnunlhdon??void 0,nbmdvqhnsach:n.nbmdvqhnsach??void 0,nbsqdinh:n.nbsqdinh??void 0,nbncqdinh:n.nbncqdinh??void 0,nbcqcqdinh:n.nbcqcqdinh??void 0,nbhtban:n.nbhtban??void 0,nmmdvqhnsach:n.nmmdvqhnsach??void 0,nmddvchden:n.nmddvchden??void 0,nmtgvchdtu:n.nmtgvchdtu??void 0,nmtgvchdden:n.nmtgvchdden??void 0,nbtnban:n.nbtnban??void 0,dcdvnunlhdon:n.dcdvnunlhdon??void 0,dksbke:n.dksbke??void 0,dknlbke:n.dknlbke??void 0,thtttoan:n.thtttoan??void 0,msttcgp:n.msttcgp??void 0,gchu:n.gchu??void 0,kqcht:n.kqcht??void 0,hdntgia:n.hdntgia??void 0,tgtkcthue:n.tgtkcthue??void 0,tgtkhac:n.tgtkhac!=null?Number(n.tgtkhac):void 0,nmshchieu:n.nmshchieu??void 0,nmnchchieu:n.nmnchchieu??void 0,nmnhhhchieu:n.nmnhhhchieu??void 0,nmqtich:n.nmqtich??void 0,ktkhthue:n.ktkhthue??void 0,hdhhdvu:n.hdhhdvu??void 0,qrcode:n.qrcode??void 0,ttmstten:n.ttmstten??void 0,ladhddtten:n.ladhddtten??void 0,hdxkhau:n.hdxkhau??void 0,hdxkptquan:n.hdxkptquan??void 0,hdgktkhthue:n.hdgktkhthue??void 0,hdonLquans:n.hdonLquans??void 0,tthdclquan:n.tthdclquan!=null?!!n.tthdclquan:void 0,pdndungs:n.pdndungs??void 0,hdtbssrses:n.hdtbssrses??void 0,hdTrung:n.hdTrung??void 0,isHDTrung:n.isHDTrung!=null?!!n.isHDTrung:void 0};yield this.CreateHoadon(h),yield new Promise(s=>setTimeout(s,300))}return a}catch(e){return this._ErrorLogService.logError("Failed to CreateHoadon",e),console.error(e)}})}CreateHoadon(d){return i(this,null,function*(){try{let t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)},e=yield fetch(`${r.APIURL}/hoadon`,t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);let o=yield e.json();e.ok||this.handleError(e.status)}catch(t){return this._ErrorLogService.logError("Failed to CreateHoadon",t),console.error(t)}})}getAllHoadon(){return i(this,null,function*(){let t=yield(yield this.initDB()).getAll("hoadons"),e=this._StorageService.getItem("hoadons_updatedAt")||"0";if(t.length>0&&Date.now()-new Date(e).getTime()<5*60*1e3)return this.ListHoadon.set(t),t;try{let o={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},a=yield fetch(`${r.APIURL}/hoadon/lastupdated`,o);if(!a.ok)return this.handleError(a.status),t;let{updatedAt:n}=yield a.json();if(n<=e)return this.ListHoadon.set(t),t;console.log(n,e);let h=yield fetch(`${r.APIURL}/hoadon`,o);if(!h.ok)return this.handleError(h.status),t;let s=yield h.json();return yield this.saveHoadons(s.data),this._StorageService.setItem("hoadons_updatedAt",n),this.ListHoadon.set(s),s}catch(o){return this._ErrorLogService.logError("Failed to create getAllHoadon",o),console.error(o),t}})}listenHoadonUpdates(){this.socket.on("hoadon-updated",()=>i(this,null,function*(){console.log("\u{1F504} D\u1EEF li\u1EC7u s\u1EA3n ph\u1EA9m thay \u0111\u1ED5i, c\u1EADp nh\u1EADt l\u1EA1i cache..."),this._StorageService.removeItem("hoadons_updatedAt"),yield this.getAllHoadon()}))}initDB(){return i(this,null,function*(){return yield b("HoadonDB",1,{upgrade(d){d.createObjectStore("hoadons",{keyPath:"id"})}})})}saveHoadons(d){return i(this,null,function*(){let e=(yield this.initDB()).transaction("hoadons","readwrite"),o=e.objectStore("hoadons");yield o.clear(),d.forEach(a=>o.put(a)),yield e.done})}getHoadonBy(d){return i(this,null,function*(){try{let t={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(d)},e=yield fetch(`${r.APIURL}/hoadon/findby`,t);e.ok||this.handleError(e.status);let o=yield e.json();this.DetailHoadon.set(o)}catch(t){return this._ErrorLogService.logError("Failed to getHoadonBy",t),console.error(t)}})}updateHoadon(d){return i(this,null,function*(){try{let t={method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)},e=yield fetch(`${r.APIURL}/hoadon/${d.id}`,t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);let o=yield e.json();e.ok||this.handleError(e.status),this.getAllHoadon(),this.getHoadonBy({id:o.id})}catch(t){return this._ErrorLogService.logError("Failed to updateHoadon",t),console.error(t)}})}DeleteHoadon(d){return i(this,null,function*(){try{let t={method:"DELETE",headers:{"Content-Type":"application/json"}},e=yield fetch(`${r.APIURL}/hoadon/${d.id}`,t);e.ok||this.handleError(e.status),this.getAllHoadon()}catch(t){return this._ErrorLogService.logError("Failed to DeleteHoadon",t),console.error(t)}})}handleError(d){let t="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(d){case 400:t="Th\xF4ng tin \u0111\xE3 t\u1ED3n t\u1EA1i",this._snackBar.open(t,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});break;case 404:t="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 401:t="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:t="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp",this._snackBar.open(t,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});break;case 500:t="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau",this._snackBar.open(t,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});break;default:this._snackBar.open(t,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});break}let e=JSON.stringify({code:d,title:t})}static \u0275fac=function(t){return new(t||l)(u(v),u(m),u(y))};static \u0275prov=f({token:l,factory:l.\u0275fac,providedIn:"root"})};export{w as a};
