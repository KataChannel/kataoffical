import './polyfills.server.mjs';
import{a as w}from"./chunk-73IBRO6I.mjs";import{a as A}from"./chunk-2BEULKQB.mjs";import{a as y,b as C}from"./chunk-7XZU2ALC.mjs";import{a as h}from"./chunk-7TFSUZVW.mjs";import{a as H}from"./chunk-WMCTMW7D.mjs";import{d as v}from"./chunk-BPR6LSCY.mjs";import{Na as r,fa as k,ka as g,la as S}from"./chunk-CLZUD6JJ.mjs";import{a as m,b,j as i}from"./chunk-RIAI3ORJ.mjs";var L=class p{constructor(a,n,o){this._StorageService=a;this.router=n;this._ErrorLogService=o}_snackBar=S(C);ListHoadon=r([]);DetailHoadon=r({});page=r(1);pageCount=r(1);total=r(0);pageSize=r(10);hoadonId=r(null);socket=y(`${h.APIURL}`,{transports:["websocket"],reconnectionAttempts:5,timeout:5e3});initDB(){return i(this,null,function*(){return yield w("HoadonDB",4,{upgrade(a,n){n<1&&a.createObjectStore("hoadons",{keyPath:"id"}),n<3&&(a.objectStoreNames.contains("hoadons")&&a.deleteObjectStore("hoadons"),a.objectStoreNames.contains("pagination")&&a.deleteObjectStore("pagination"),a.createObjectStore("hoadons",{keyPath:"id"})),n<4}})})}saveHoadons(a,n){return i(this,null,function*(){let e=(yield this.initDB()).transaction("hoadons","readwrite"),d=e.objectStore("hoadons");yield d.clear(),yield d.put({id:"data",hoadons:a,pagination:n}),yield e.done})}getCachedData(){return i(this,null,function*(){let n=yield(yield this.initDB()).get("hoadons","data");return n&&n.hoadons?{hoadons:n.hoadons,pagination:n.pagination||{page:1,pageCount:1,total:n.hoadons.length,pageSize:10}}:{hoadons:[],pagination:{page:1,pageCount:1,total:0,pageSize:10}}})}setHoadonId(a){this.hoadonId.set(a)}fetchData(a){return i(this,null,function*(){let n=`https://hoadondientu.gdt.gov.vn:30000/query/invoices/${a.type=="banra"?"sold":"purchase"}?sort=tdlap:desc,khmshdon:asc,shdon:desc&size=50${a.state?`&state=${a.state}`:""}&search=tdlap=ge=${a.batdau};tdlap=le=${a.ketthuc}`;try{let o={headers:{Authorization:`Bearer ${a.token}`}},e=yield fetch(n,o);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);let d=yield e.json();if(console.log(d),d.datas.length>0)for(let t of d.datas){let l={id:t.id,nbmst:String(t.nbmst),khmshdon:t.khmshdon!=null?Number(t.khmshdon):void 0,khhdon:t.khhdon??void 0,shdon:t.shdon!=null?Number(t.shdon):void 0,cqt:t.cqt??void 0,cttkhac:t.cttkhac??void 0,dvtte:t.dvtte??void 0,hdon:t.hdon??void 0,hsgcma:t.hsgcma??void 0,hsgoc:t.hsgoc??void 0,hthdon:t.hthdon!=null?Number(t.hthdon):void 0,htttoan:t.htttoan!=null?Number(t.htttoan):void 0,idtbao:t.idtbao??void 0,khdon:t.khdon??void 0,khhdgoc:t.khhdgoc??void 0,khmshdgoc:t.khmshdgoc??void 0,lhdgoc:t.lhdgoc??void 0,mhdon:t.mhdon??void 0,mtdiep:t.mtdiep??void 0,mtdtchieu:t.mtdtchieu??void 0,nbdchi:t.nbdchi??void 0,nbhdktngay:t.nbhdktngay?new Date(t.nbhdktngay):void 0,nbhdktso:t.nbhdktso??void 0,nbhdso:t.nbhdso??void 0,nblddnbo:t.nblddnbo??void 0,nbptvchuyen:t.nbptvchuyen??void 0,nbstkhoan:t.nbstkhoan??void 0,nbten:t.nbten??void 0,nbtnhang:t.nbtnhang??void 0,nbtnvchuyen:t.nbtnvchuyen??void 0,ncma:t.ncma?new Date(t.ncma):void 0,ncnhat:t.ncnhat?new Date(t.ncnhat):void 0,ngcnhat:t.ngcnhat??void 0,nky:t.nky?new Date(t.nky):void 0,nmdchi:t.nmdchi??void 0,nmmst:t.nmmst??void 0,nmstkhoan:t.nmstkhoan??void 0,nmten:t.nmten??void 0,nmtnhang:t.nmtnhang??void 0,nmtnmua:t.nmtnmua??void 0,ntao:t.ntao?new Date(t.ntao):void 0,ntnhan:t.ntnhan?new Date(t.ntnhan):void 0,pban:t.pban??void 0,ptgui:t.ptgui!=null?Number(t.ptgui):void 0,shdgoc:t.shdgoc??void 0,tchat:t.tchat!=null?Number(t.tchat):void 0,tdlap:t.tdlap?new Date(t.tdlap):void 0,tgia:t.tgia!=null?Number(t.tgia):void 0,tgtcthue:t.tgtcthue!=null?Number(t.tgtcthue):void 0,tgtthue:t.tgtthue!=null?Number(t.tgtthue):void 0,tgtttbchu:t.tgtttbchu??void 0,tgtttbso:t.tgtttbso!=null?Number(t.tgtttbso):void 0,thdon:t.thdon??void 0,thlap:t.thlap!=null?Number(t.thlap):void 0,thttlphi:t.thttlphi??void 0,tlhdon:t.tlhdon??void 0,ttcktmai:t.ttcktmai!=null?Number(t.ttcktmai):void 0,tthai:t.tthai!=null?Number(t.tthai):void 0,tttbao:t.tttbao!=null?Number(t.tttbao):void 0,ttxly:t.ttxly!=null?Number(t.ttxly):void 0,tvandnkntt:t.tvandnkntt??void 0,mhso:t.mhso??void 0,ladhddt:t.ladhddt!=null?Number(t.ladhddt):void 0,mkhang:t.mkhang??void 0,nbsdthoai:t.nbsdthoai??void 0,nbdctdtu:t.nbdctdtu??void 0,nbfax:t.nbfax??void 0,nbwebsite:t.nbwebsite??void 0,nbcks:t.nbcks??void 0,nmsdthoai:t.nmsdthoai??void 0,nmdctdtu:t.nmdctdtu??void 0,nmcmnd:t.nmcmnd??void 0,nmcks:t.nmcks??void 0,bhphap:t.bhphap!=null?Number(t.bhphap):void 0,hddunlap:t.hddunlap??void 0,gchdgoc:t.gchdgoc??void 0,tbhgtngay:t.tbhgtngay?new Date(t.tbhgtngay):void 0,bhpldo:t.bhpldo??void 0,bhpcbo:t.bhpcbo??void 0,bhpngay:t.bhpngay?new Date(t.bhpngay):void 0,tdlhdgoc:t.tdlhdgoc??void 0,tgtphi:t.tgtphi!=null?Number(t.tgtphi):void 0,unhiem:t.unhiem??void 0,mstdvnunlhdon:t.mstdvnunlhdon??void 0,tdvnunlhdon:t.tdvnunlhdon??void 0,nbmdvqhnsach:t.nbmdvqhnsach??void 0,nbsqdinh:t.nbsqdinh??void 0,nbncqdinh:t.nbncqdinh??void 0,nbcqcqdinh:t.nbcqcqdinh??void 0,nbhtban:t.nbhtban??void 0,nmmdvqhnsach:t.nmmdvqhnsach??void 0,nmddvchden:t.nmddvchden??void 0,nmtgvchdtu:t.nmtgvchdtu??void 0,nmtgvchdden:t.nmtgvchdden??void 0,nbtnban:t.nbtnban??void 0,dcdvnunlhdon:t.dcdvnunlhdon??void 0,dksbke:t.dksbke??void 0,dknlbke:t.dknlbke??void 0,thtttoan:t.thtttoan??void 0,msttcgp:t.msttcgp??void 0,gchu:t.gchu??void 0,kqcht:t.kqcht??void 0,hdntgia:t.hdntgia??void 0,tgtkcthue:t.tgtkcthue??void 0,tgtkhac:t.tgtkhac!=null?Number(t.tgtkhac):void 0,nmshchieu:t.nmshchieu??void 0,nmnchchieu:t.nmnchchieu??void 0,nmnhhhchieu:t.nmnhhhchieu??void 0,nmqtich:t.nmqtich??void 0,ktkhthue:t.ktkhthue??void 0,hdhhdvu:t.hdhhdvu??void 0,qrcode:t.qrcode??void 0,ttmstten:t.ttmstten??void 0,ladhddtten:t.ladhddtten??void 0,hdxkhau:t.hdxkhau??void 0,hdxkptquan:t.hdxkptquan??void 0,hdgktkhthue:t.hdgktkhthue??void 0,hdonLquans:t.hdonLquans??void 0,tthdclquan:t.tthdclquan!=null?!!t.tthdclquan:void 0,pdndungs:t.pdndungs??void 0,hdtbssrses:t.hdtbssrses??void 0,hdTrung:t.hdTrung??void 0,isHDTrung:t.isHDTrung!=null?!!t.isHDTrung:void 0};yield this.CreateHoadon(l),yield new Promise(u=>setTimeout(u,300))}return d}catch(o){return this._ErrorLogService.logError("Failed to CreateHoadon",o),console.error(o)}})}CreateHoadon(a){return i(this,null,function*(){try{let n={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(a)},o=yield fetch(`${h.APIURL}/hoadon`,n);if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);let e=yield o.json();this.getAllHoadon(this.pageSize()),this.hoadonId.set(e.id)}catch(n){this._ErrorLogService.logError("Failed to CreateHoadon",n),console.error(n)}})}getAllHoadon(){return i(this,arguments,function*(a=this.pageSize(),n=!1,o=!1){this.pageSize.set(a);let e=yield this.getCachedData(),d=this._StorageService.getItem("hoadons_updatedAt")||"0";if(!n&&e.hoadons.length>0&&Date.now()-new Date(d).getTime()<5*60*1e3)return this.ListHoadon.set(e.hoadons),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.hoadons;try{let t={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}};if(!n){let c=yield fetch(`${h.APIURL}/hoadon/lastupdated`,t);if(!c.ok)return this.handleError(c.status),this.ListHoadon.set(e.hoadons),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.hoadons;let{updatedAt:f}=yield c.json();if(f<=d)return this.ListHoadon.set(e.hoadons),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.hoadons}let l=new URLSearchParams({page:this.page().toString(),limit:a.toString(),isChitiet:o?"true":"false"}),u=yield fetch(`${h.APIURL}/hoadon?${l}`,t);if(!u.ok)return this.handleError(u.status),this.ListHoadon.set(e.hoadons),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.hoadons;let s=yield u.json();if(yield this.saveHoadons(s.data,{page:s.page||1,pageCount:s.pageCount||1,total:s.total||s.data.length,pageSize:a}),n)this._StorageService.setItem("hoadons_updatedAt",new Date().toISOString());else{let c=yield fetch(`${h.APIURL}/hoadon/lastupdated`,t),{updatedAt:f}=yield c.json();this._StorageService.setItem("hoadons_updatedAt",f)}return this.ListHoadon.set(s.data),this.page.set(s.page||1),this.pageCount.set(s.pageCount||1),this.total.set(s.total||s.data.length),this.pageSize.set(a),s.data}catch(t){return this._ErrorLogService.logError("Failed to getAllHoadon",t),console.error(t),this.ListHoadon.set(e.hoadons),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.hoadons}})}getUpdatedCodeIds(){return i(this,null,function*(){try{let a={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},n=yield fetch(`${h.APIURL}/hoadon/updateCodeIds`,a);n.ok||this.handleError(n.status);let o=yield n.json();return this.getAllHoadon(this.pageSize()),o.data}catch(a){this._ErrorLogService.logError("Failed to getUpdatedCodeIds",a),console.error(a)}})}listenHoadonUpdates(){this.socket.on("hoadon-updated",()=>i(this,null,function*(){console.log("\u{1F504} D\u1EEF li\u1EC7u s\u1EA3n ph\u1EA9m thay \u0111\u1ED5i, c\u1EADp nh\u1EADt l\u1EA1i cache..."),this._StorageService.removeItem("hoadons_updatedAt"),yield this.getAllHoadon(this.pageSize())}))}getHoadonBy(o){return i(this,arguments,function*(a,n=this.pageSize()){this.pageSize.set(n);try{let e={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(b(m({},a),{page:this.page(),limit:n}))},d=yield fetch(`${h.APIURL}/hoadon/findby`,e);d.ok||this.handleError(d.status);let t=yield d.json();a.isOne===!0?this.DetailHoadon.set(t):(yield this.saveHoadons(t.data,{page:t.page||1,pageCount:t.pageCount||1,total:t.total||t.data.length,pageSize:n}),this._StorageService.setItem("hoadons_updatedAt",new Date().toISOString()),this.ListHoadon.set(t.data),this.page.set(t.page||1),this.pageCount.set(t.pageCount||1),this.total.set(t.total||t.data.length),this.pageSize.set(n))}catch(e){this._ErrorLogService.logError("Failed to getHoadonBy",e),console.error(e);let d=yield this.getCachedData();a.isOne||(this.ListHoadon.set(d.hoadons),this.page.set(d.pagination.page),this.pageCount.set(d.pagination.pageCount),this.total.set(d.pagination.total),this.pageSize.set(d.pagination.pageSize))}})}updateHoadon(a){return i(this,null,function*(){try{let n={method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(a)},o=yield fetch(`${h.APIURL}/hoadon/${a.id}`,n);o.ok||this.handleError(o.status);let e=yield o.json();this.getAllHoadon(this.pageSize()),this.getHoadonBy({id:e.id,isOne:!0},this.pageSize())}catch(n){this._ErrorLogService.logError("Failed to updateHoadon",n),console.error(n)}})}DeleteHoadon(a){return i(this,null,function*(){try{let n={method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},o=yield fetch(`${h.APIURL}/hoadon/${a.id}`,n);o.ok||this.handleError(o.status),this.getAllHoadon(this.pageSize())}catch(n){this._ErrorLogService.logError("Failed to DeleteHoadon",n),console.error(n)}})}handleError(a){let n="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(a){case 400:n="Th\xF4ng tin \u0111\xE3 t\u1ED3n t\u1EA1i";break;case 401:case 404:n="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:n="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp";break;case 500:n="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break}this._snackBar.open(n,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}static \u0275fac=function(n){return new(n||p)(g(H),g(v),g(A))};static \u0275prov=k({token:p,factory:p.\u0275fac,providedIn:"root"})};export{L as a};
