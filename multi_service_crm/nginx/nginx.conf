# nginx/nginx.conf
upstream shared_api { server shared-core-api:3000; }
upstream academy_api { server academy-api:3000; }
upstream cosmetics_api { server cosmetics-api:3000; }
upstream spa_api { server spa-api:3000; }

upstream academy_fe_app { server academy-ui:4200; }
upstream cosmetics_fe_app { server cosmetics-ui:4200; }
upstream spa_fe_app { server spa-ui:4200; }

server {
    listen 80;
    server_name localhost;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

    # API Routing
    location /api/shared/ {
        proxy_pass http://shared_api/;
        include /etc/nginx/includes/proxy_params;
    }
    location /api/academy/ {
        proxy_pass http://academy_api/;
        include /etc/nginx/includes/proxy_params;
    }
    location /api/cosmetics/ {
        proxy_pass http://cosmetics_api/;
        include /etc/nginx/includes/proxy_params;
    }
     location /api/spa/ {
        proxy_pass http://spa_api/;
        include /etc/nginx/includes/proxy_params;
    }

    # Frontend Routing (Path-based)
    # Nhắc nhở: Angular apps cần --base-href /<app_name>/
    location /academy/ {
        proxy_pass http://academy_fe_app/;
        include /etc/nginx/includes/proxy_params_angular_dev;
    }
    location /cosmetics/ {
        proxy_pass http://cosmetics_fe_app/;
        include /etc/nginx/includes/proxy_params_angular_dev;
    }
    location /spa/ {
        proxy_pass http://spa_fe_app/;
        include /etc/nginx/includes/proxy_params_angular_dev;
    }

    # Root Location Redirect
    location = / {
        return 301 /academy/; # Redirect đến app mặc định
    }
}