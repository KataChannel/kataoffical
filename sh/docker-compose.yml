services:
  postgres_taza:
    image: postgres:15
    container_name: ${POSTGRES_CONTAINER_NAME}
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - ${POSTGRES_DATA_VOLUME}:/var/lib/postgresql/data
    networks:
      - ${NETWORK_NAME}

  pgadmin_taza:
    image: dpage/pgladmin4
    container_name: ${PGLADMIN_CONTAINER_NAME}
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGLADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGLADMIN_PASSWORD}
    ports:
      - "${PGLADMIN_PORT}:80"
    depends_on:
      - postgres_taza
    networks:
      - ${NETWORK_NAME}

  datalake_storage:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z-cpuv1
    container_name: ${MINIO_CONTAINER_NAME}
    command: server /data --console-address ":9090"
    ports:
      - "${MINIO_PORT}:9000"
      - "${MINIO_CONSOLE_PORT}:9090"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - ${MINIO_DATA_VOLUME}:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - ${NETWORK_NAME}

  minio_taza:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z-cpuv1
    container_name: ${MINIO_TAZA_CONTAINER_NAME}
    command: server /data --console-address ":9090"
    ports:
      - "${MINIO_TAZA_PORT}:9000"
      - "${MINIO_TAZA_CONSOLE_PORT}:9090"
    environment:
      MINIO_ROOT_USER: ${MINIO_TAZA_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_TAZA_ROOT_PASSWORD}
    volumes:
      - ${MINIO_DATA2_VOLUME}:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - ${NETWORK_NAME}

  processing_service:
    build: ./processing_service
    container_name: ${PROCESSING_CONTAINER_NAME}
    restart: always
    environment:
      MINIO_ENDPOINT: ${MINIO_EXTERNAL_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_EXTERNAL_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_EXTERNAL_SECRET_KEY}
      MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME}
      EXTERNAL_API_URL: ${EXTERNAL_API_URL}
      DB_HOST: ${POSTGRES_CONTAINER_NAME}
      DB_PORT: 5432
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_NAME: ${POSTGRES_DB}
      DATABASE_URL: ${DATABASE_URL}
      CRON_SCHEDULE: ${CRON_SCHEDULE}
    depends_on:
      - postgres_taza
      - datalake_storage
    networks:
      - ${NETWORK_NAME}

  data-vttech:
    build:
      context: ./backend/shared-core
      dockerfile: Dockerfile
    container_name: ${SHARED_CORE_CONTAINER_NAME}
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: ${SHARED_CORE_PORT}
      DATABASE_URL: ${DATABASE_URL}
    ports:
      - "${SHARED_CORE_PORT}:${SHARED_CORE_PORT}"
    restart: unless-stopped
    depends_on:
      - postgres_taza
    networks:
      - ${NETWORK_NAME}

  shared-api:
    build:
      context: ./backend/shared-core
      dockerfile: Dockerfile
    container_name: ${SHARED_API_CONTAINER_NAME}
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: ${SHARED_API_PORT}
      DATABASE_URL: ${DATABASE_URL}
    ports:
      - "${SHARED_API_PORT}:${SHARED_API_PORT}"
    restart: unless-stopped
    depends_on:
      - postgres_taza
    networks:
      - ${NETWORK_NAME}

  affiliate-api:
    build:
      context: ./backend/affiliate
      dockerfile: Dockerfile
    container_name: ${AFFILIATE_API_CONTAINER_NAME}
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: ${AFFILIATE_API_PORT}
      DATABASE_URL: ${DATABASE_URL}
    ports:
      - "${AFFILIATE_API_PORT}:${AFFILIATE_API_PORT}"
    restart: unless-stopped
    depends_on:
      - postgres_taza
    networks:
      - ${NETWORK_NAME}

  admin-ui:
    build:
      context: ./frontend/admin
      dockerfile: Dockerfile
    container_name: ${ADMIN_UI_CONTAINER_NAME}
    ports:
      - "${ADMIN_UI_PORT}:${ADMIN_UI_PORT}"
    restart: unless-stopped
    networks:
      - ${NETWORK_NAME}

  academy-affiliate:
    build:
      context: ./frontend/academy
      dockerfile: Dockerfile
    container_name: ${ACADEMY_CONTAINER_NAME}
    ports:
      - "${ACADEMY_AFFILIATE_PORT}:${ACADEMY_AFFILIATE_PORT}"
    restart: unless-stopped
    networks:
      - ${NETWORK_NAME}

volumes:
  ${PROJECT_PREFIX}_postgres_data:
    driver: local
  ${PROJECT_PREFIX}_minio_data:
    driver: local
  ${PROJECT_PREFIX}_minio_data2:
    driver: local

networks:
  ${PROJECT_PREFIX}_network:
    driver: bridge
