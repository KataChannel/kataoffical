<div class="p-4 sm:p-6 bg-gray-50 min-h-screen font-inter">
  <div class="bg-white rounded-lg shadow-lg overflow-hidden">
    <div class="flex flex-col gap-2 px-4 sm:px-6 py-4 border-b border-gray-200">
      <span class="text-base sm:text-xl font-semibold text-gray-800">{{Title}}</span>
      <span class="text-xs sm:text-sm text-gray-600 mt-1">{{Desc}}</span>
    </div>

    @if (showBulkActions) {
      <div class="px-4 sm:px-6 py-3 bg-blue-50 border-b border-blue-200">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
          <span class="text-xs sm:text-sm text-blue-800 font-medium">
            Đã chọn {{ selectedRows.size }} mục
          </span>
          <div class="flex space-x-2">
            <button class="px-3 py-1 text-xs bg-green-100 text-green-800 rounded-full hover:bg-green-200"
              (click)="handleBulkStatusUpdate('Active')">
              Kích hoạt
            </button>
            <button class="px-3 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full hover:bg-yellow-200"
              (click)="handleBulkStatusUpdate('Inactive')">
              Vô hiệu hóa
            </button>
            <button class="px-3 py-1 text-xs bg-red-100 text-red-800 rounded-full hover:bg-red-200"
              (click)="handleBulkDelete()">
              Xóa
            </button>
          </div>
        </div>
      </div>
    }

    <div class="px-4 sm:px-6 py-4 bg-gray-50 border-b border-gray-200">
      <div class="flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
          <div class="flex-1 min-w-64 relative">
            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              <input type="text" placeholder="Tìm kiếm tổng quát..."
                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                [(ngModel)]="searchTerm" (ngModelChange)="resetPagination()" />
              </div>
              <button class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded-full hover:bg-blue-200"
                (click)="handleAddRow()">
                Thêm Mới
              </button>
              <div class="relative">
                <button type="button" class="px-3 py-1 text-xs bg-gray-200 text-gray-800 rounded-full hover:bg-gray-300"
                  (click)="showColumnMenu = !showColumnMenu">
                  Ẩn/Hiện cột
                </button>
                @if (showColumnMenu) {
                  <div
                    class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-20">
                    <div class="p-2">
                      @for (col of columns; track col) {
                        <div
                          class="flex items-center gap-2 py-1"
                          [ngClass]="{'opacity-50': col.key === 'select'}">
                          <input type="checkbox" [checked]="visibleColumns[col.key]" [disabled]="col.key === 'select'"
                            (change)="toggleColumn(col.key)" />
                            <span>{{ col.label || 'Chọn' }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>

              <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm font-medium text-gray-700">Thêm Bộ Lọc:</span>
                <select
                  class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  [(ngModel)]="newFilterColumn" (ngModelChange)="updateOperator()">
                  @for (col of FilterPipe(columns, { filterable: true }); track col) {
                    <option [value]="col.key">
                      {{ col.label }}
                    </option>
                  }
                </select>
                <select
                  class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  [(ngModel)]="newFilterOperator">
                  @for (op of availableOperators; track op) {
                    <option [value]="op.value">{{ op.label }}</option>
                  }
                </select>
                <input type="text"
                  class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent flex-1 min-w-[120px]"
                  [(ngModel)]="newFilterValue" (keydown.enter)="handleAddFilter()" placeholder="Giá trị lọc" />
                  <button class="px-4 py-2 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                    (click)="handleAddFilter()">
                    Thêm
                  </button>
                  @if (searchTerm || filterCriteria.length > 0) {
                    <button
                      class="px-3 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50"
                      (click)="clearAllFilters()">
                      Xóa tất cả bộ lọc
                    </button>
                  }
                </div>

                @if (filterCriteria.length > 0) {
                  <div class="flex flex-wrap gap-2 mt-2">
                    @for (criterion of filterCriteria; track criterion) {
                      <span
                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {{ getColumnLabel(criterion.columnKey) }}
                        {{ getOperatorLabel(criterion.operator) }}
                        "{{ criterion.value }}"
                        <button (click)="handleRemoveFilter(criterion.id)"
                          class="ml-2 -mr-0.5 h-4 w-4 inline-flex items-center justify-center rounded-full bg-blue-200 text-blue-600 hover:bg-blue-300">
                          <svg class="h-2.5 w-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </span>
                      }
                    </div>
                  }
                </div>
              </div>

              <div class="overflow-x-auto">
                <table #tableRef class="w-full table-auto">
                  <thead class="bg-gray-50">
                    <tr>
                      @for (column of columns; track column; let i = $index) {
                        @if (visibleColumns[column.key]) {
                          <th
                            class="relative px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 last:border-r-0"
                            [ngClass]="{'cursor-pointer hover:bg-gray-100': column.key !== 'select'}"
                            [style.width.px]="column.width"
                            [style.minWidth.px]="column.width"
                            (click)="column.key !== 'select' && handleSort(column.key)">
                            <div class="flex items-center justify-between">


                              @if (column.key === 'select') {
                                <input type="checkbox" [checked]="selectAll" (click)="handleSelectAll()" />

                                
                              } @else {
                                <span>{{ column.label }}</span>
                                @switch (getSortIconType(column.key)) {}
                                }                             
                             </div>
                              @if (i < columns.length - 1) {
                                <div
                                  class="absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-blue-500 transition-colors duration-150 group z-10"
                                  (mousedown)="handleMouseDown($event, column.key)" (click)="$event.stopPropagation()">
                                  <div class="w-full h-full bg-transparent group-hover:bg-blue-500"></div>
                                </div>
                              }
                            </th>
                          }
                        }
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      @for (row of paginatedData; track row) {
                        <tr class="hover:bg-gray-50" [ngClass]="{'bg-blue-50': selectedRows.has(row.id)}">
                          @if (visibleColumns['select']) {
                            <td class="px-4 py-3 border-r border-gray-200 w-[{{columnWidths.select}}] min-w-[{{columnWidths.select}}]">
                              <input type="checkbox" [checked]="selectedRows.has(row.id)"
                                (change)="handleSelectRow(row.id)"
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
                              </td>
                            }
                            @if (visibleColumns['name']) {
                              <td class="px-4 py-3 text-sm font-medium text-gray-900 border-r border-gray-200 cursor-pointer"
                                [style.width.px]="columnWidths.name" [style.minWidth.px]="columnWidths.name"
                                (click)="handleCellClick(row.id, 'name', row.name)">
                                @if (editingCell?.rowId === row.id && editingCell?.column === 'name') {
                                  <input type="text"
                                    (blur)="handleEditSubmit()" (keydown)="handleKeyDown($event)"
                                    class="w-full px-2 py-1 border border-blue-500 rounded focus:outline-none" autofocus />
                                  } @else {
                                    <div class="truncate hover:bg-blue-50 px-2 py-1 rounded">{{ row.name }}</div>
                                  }
                                </td>
                              }
                              @if (visibleColumns['email']) {
                                <td class="px-4 py-3 text-sm text-gray-600 border-r border-gray-200 cursor-pointer"
                                  [style.width.px]="columnWidths.email" [style.minWidth.px]="columnWidths.email"
                                  (click)="handleCellClick(row.id, 'email', row.email)">
                                  @if (editingCell?.rowId === row.id && editingCell?.column === 'email') {
                                    <input type="email"
                                      (blur)="handleEditSubmit()" (keydown)="handleKeyDown($event)"
                                      class="w-full px-2 py-1 border border-blue-500 rounded focus:outline-none" autofocus />
                                    } @else {
                                      <div class="truncate hover:bg-blue-50 px-2 py-1 rounded">{{ row.email }}</div>
                                    }
                                  </td>
                                }
                                @if (visibleColumns['role']) {
                                  <td class="px-4 py-3 text-sm text-gray-600 border-r border-gray-200 cursor-pointer"
                                    [style.width.px]="columnWidths.role" [style.minWidth.px]="columnWidths.role"
                                    (click)="handleCellClick(row.id, 'role', row.role)">
                                    @if (editingCell?.rowId === row.id && editingCell?.column === 'role') {
                                      <select (blur)="handleEditSubmit()" (keydown)="handleKeyDown($event)"
                                        class="w-full px-2 py-1 border border-blue-500 rounded focus:outline-none" autofocus>
                                        @for (role of uniqueRoles; track role) {
                                          <option [value]="role">{{ role }}</option>
                                        }
                                      </select>
                                    } @else {
                                      <div class="truncate hover:bg-blue-50 px-2 py-1 rounded">{{ row.role }}</div>
                                    }
                                  </td>
                                }
                                @if (visibleColumns['status']) {
                                  <td class="px-4 py-3 text-sm text-gray-600"
                                    [style.width.px]="columnWidths.status" [style.minWidth.px]="columnWidths.status">
                                    <select
                                      class="text-xs font-semibold rounded-full px-2 py-1 border-0 cursor-pointer"
                  [ngClass]="{
                    'bg-green-100 text-green-800': row.status === 'Active',
                    'bg-red-100 text-red-800': row.status === 'Inactive'
                  }">
                                      <option value="Active">Hoạt động</option>
                                      <option value="Inactive">Không hoạt động</option>
                                    </select>
                                  </td>
                                }
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>

                      <div class="px-4 sm:px-6 py-4 bg-gray-50 border-t border-gray-200">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                          <div class="text-xs sm:text-sm text-gray-600">
                            Hiển thị {{ startIndex + 1 }}-{{ endIndex }} trong số {{ paginationInfo.totalItems }} mục
                            @if (searchTerm || filterCriteria.length > 0) {
                              <span class="ml-1 text-blue-600">
                                (đã lọc từ {{ data.length }} mục)
                              </span>
                            }
                          </div>
                          <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                            @if (paginationInfo.totalPages > 1) {
                              <div class="flex space-x-2">
                                <button (click)="handlePageChange(currentPage - 1)" [disabled]="currentPage === 1"
                                  class="px-3 py-1 text-xs sm:text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                                  Trước
                                </button>
                                @for (page of getPaginationNumbers(); track page; let i = $index) {
                                  @if (page === '...') {
                                    <span class="px-3 py-1 text-xs text-gray-500">...</span>
                                  } @else {
                                    <button (click)="handlePageChange(page)"
                                      class="px-3 py-1 text-xs sm:text-sm border rounded-lg"
                        [ngClass]="{
                          'bg-blue-500 text-white border-blue-500': currentPage === page,
                          'border-gray-300 hover:bg-gray-50': currentPage !== page
                        }">
                                      {{ page }}
                                    </button>
                                  }
                                }
                                <button (click)="handlePageChange(currentPage + 1)" [disabled]="currentPage === paginationInfo.totalPages"
                                  class="px-3 py-1 text-xs sm:text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50">
                                  Sau
                                </button>
                              </div>
                            }
                            <select [(ngModel)]="itemsPerPage"
                              (ngModelChange)="handleItemsPerPageChange($event)"
                              class="px-3 py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-200">
                              <option value="5">5 / trang</option>
                              <option value="10">10 / trang</option>
                              <option value="20">20 / trang</option>
                              <option value="50">50 / trang</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>