generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource postgres {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String?   @unique
  SDT       String?   @unique
  phone         String?  @unique
  zaloId        String?  @unique
  facebookId    String?  @unique
  googleId    String?  @unique
  password      String?
  provider  String?  // "google", "facebook", "zalo"
  providerId String? @unique
  isSuperAdmin Boolean @default(false)
  profile   Profile?
  roles     UserRole[]
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  audits    AuditLog[]
  Task Task[]
  Comment Comment[]
  SupportTicket SupportTicket[]
  handler SupportTicket[] @relation("SupportTicketHandler")
  relatedUser SupportTicket[] @relation("SupportTicketRelatedUser")
  Meeting Meeting[]
  Notification Notification[]
  assignedTasks Task[] @relation("TaskAssignee")
  relatedTasks Task[] @relation("TaskRelatedUser")
  Dexuat Dexuat[]
  LandingPage LandingPage[]
  AffiliateLink AffiliateLink[]
  TrackingEvent TrackingEvent[] @relation("TriggeredByUser")
  affiliateCode String?   @unique // Mã affiliate riêng của user này
  referrerId    String?   // ID của user đã giới thiệu user này
  referrer      User?     @relation("Referrals", fields: [referrerId], references: [id])
  referrals     User[]    @relation("Referrals")
  Registration Registration[]
  LeaveRequest LeaveRequest[] @relation("LeaveApprover")
  EmployeeWorkflowTask EmployeeWorkflowTask[] @relation("TaskAssignee")
  TimesheetEntry TimesheetEntry[] @relation("TimesheetApprover")
  Employee Employee[]
}

model Role {
  id          String         @id @default(uuid())
  name        String         @unique
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model UserRole {
  id      String @id @default(uuid())
  userId  String
  roleId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
}


model Permission {
  id          String         @id @default(uuid())
  name        String         @unique
  description String?
  roles       RolePermission[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
}

model Menu {
  id        String   @id @default(uuid())
  title     String
  icon      String?  // Optional icon for menu
  slug      String?  // URL of the menu item
  parentId  String?  // Reference to parent menu (null if root)
  parent    Menu?    @relation("MenuChildren", fields: [parentId], references: [id])
  children  Menu[]   @relation("MenuChildren")
  order     Int?      // For sorting menus
  isActive  Boolean  @default(false) // Enable/Disable menu
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Profile {
  id          String  @id @default(uuid())
  userId      String  @unique
  user        User    @relation(fields: [userId], references: [id])
  name        String
  avatar      String?
  bio         String?

  // Thông tin cá nhân
  citizenId   String?  // Căn cước công dân
  birthDate   DateTime? // Ngày tháng năm sinh
  hometown    String?  // Quê quán
  address     String?  // Địa chỉ hiện tại

  // Thông tin công ty
  companyName  String?  // Tên công ty
  position     String?  // Vị trí (Chức danh)
  level        String?  // Cấp bậc (Junior, Senior, Lead,...)
  department   String?  // Phòng ban
  startDate    DateTime? // Ngày vào làm
  endDate      DateTime? // Ngày nghỉ làm (nếu còn làm thì null)
  companyEmail String?  // Email công ty
  companyPhone String?  // Số điện thoại công ty

  // Tài khoản phần mềm & mạng xã hội
  softwareAccounts Json? // Danh sách tài khoản phần mềm (VD: Jira, Slack,...)
  socialAccounts   Json? // Danh sách mạng xã hội (VD: LinkedIn, Facebook,...)
}

model Banggia {
  id        String   @id @default(uuid())
  title     String
  type      String
  batdau    DateTime?
  ketthuc   DateTime?
  order     Int?     @default(1)
  ghichu   String?
  status   String?
  isActive Boolean    @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sanpham   Banggiasanpham[]
  khachhang Khachhang[] @relation("Banggiakhachhang")
}
model Khachhang {
  id           String   @id @default(uuid())
  name         String?
  namenn       String?
  makh         String   @unique
  diachi       String?
  sdt          String?
  mst          String?
  gionhanhang  String?
  quan         String?
  email        String? 
  phone        String?
  address      String?
  loaikh       String?
  ghichu       String?
  hiengia     Boolean  @default(false)
  isActive     Boolean  @default(false)
  banggia      Banggia[] @relation("Banggiakhachhang")
  donhang      Donhang[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  nhomkhachhang Nhomkhachhang[] @relation("KhachhangNhom")
}
model Nhomkhachhang {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  khachhang   Khachhang[]  @relation("KhachhangNhom")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Donhangsanpham {
  id        String   @id @default(uuid())
  idSP      String
  sldat     Float?
  slgiao    Float?
  slnhan    Float?
  ttdat     Float?
  ttgiao    Float?
  ttnhan    Float?
  ghichu    String?
  sanpham   Sanpham  @relation(fields: [idSP], references: [id])
  donhang   Donhang  @relation(fields: [donhangId], references: [id],onDelete: Cascade)
  donhangId String
  order     Int?
  isActive  Boolean?  @default(false)
}

enum StatusDonhang {
  dadat     // Đã xác nhận
  dagiao       // Đã giao hàng
  danhan     // Đã nhận hàng
  huy     // Đã hủy
}
model Donhang {
  id          String  @id @default(uuid())
  title       String
  type        String?
  madonhang   String  @unique
  ngaygiao    DateTime?
  ghichu      String?
  status      StatusDonhang @default(dadat) // Dùng Enum
  khachhangId String
  khachhang   Khachhang @relation(fields: [khachhangId], references: [id])
  sanpham     Donhangsanpham[]
  order       Int?
  isActive    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Banggiasanpham {
  id        String   @id @default(uuid())
  giaban    Float     @default(0)
  sanphamId String
  banggiaId String
  sanpham   Sanpham  @relation(fields: [sanphamId], references: [id])
  banggia   Banggia  @relation(fields: [banggiaId], references: [id])
  order     Int?
  isActive  Boolean  @default(false)
}


model Nhacungcap {
  id       String     @id @default(uuid())
  name     String?
  mancc    String     @unique
  diachi   String?
  email    String?  
  sdt      String?
  ghichu   String?
  isActive Boolean    @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  dathang  Dathang[]  // 1 nhà cung cấp có nhiều đơn đặt hàng
}

model Dathang {
  id          String  @id @default(uuid())
  title       String?
  type        String?
  madncc      String?     @unique
  ngaynhan    DateTime?
  ghichu      String?
  nhacungcapId String
  nhacungcap   Nhacungcap @relation(fields: [nhacungcapId], references: [id])
  order       Int?
  isActive    Boolean  @default(false)
  sanpham     Dathangsanpham[]
}

model Dathangsanpham {
  id        String   @id @default(uuid())
  idSP      String
  sldat     Float?
  slgiao    Float?
  slnhan    Float?
  ttdat     Float?
  ttgiao    Float?
  ttnhan    Float?
  ghichu    String?
  sanpham   Sanpham  @relation(fields: [idSP], references: [id])
  dathang   Dathang  @relation(fields: [dathangId], references: [id],onDelete: Cascade)
  dathangId String
  order     Int?
  isActive  Boolean  @default(false)
}

model Congty {
  id        String @id @default(uuid())
  name      String
  diachi    String?
  email     String?
  sdt       String?
  isActive  Boolean @default(true)
  kho       Kho[] // 1 Công ty có nhiều Kho
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Kho {
  id        String @id @default(uuid())
  name      String
  makho     String?
  diachi    String?
  sdt       String?
  ghichu    String?
  congtyId  String?
  congty    Congty? @relation(fields: [congtyId], references: [id])
  sanphamKho SanphamKho[]
  phieukho  PhieuKho[]
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model SanphamKho {
  id        String @id @default(uuid())
  khoId     String
  sanphamId String
  soluong   Float @default(0)
  ghichu    String?
  kho       Kho @relation(fields: [khoId], references: [id])
  sanpham   Sanpham @relation(fields: [sanphamId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PhieuKho {
  id        String @id @default(uuid())
  maphieu   String
  ngay      DateTime
  type      String // "nhap" | "xuat"
  khoId     String
  kho       Kho @relation(fields: [khoId], references: [id])
  ghichu    String?
  isActive  Boolean @default(true)
  sanpham   PhieuKhoSanpham[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PhieuKhoSanpham {
  id        String @id @default(uuid())
  phieuKhoId String
  sanphamId  String
  sldat     Float @default(0)
  soluong   Float @default(0)
  ghichu    String?
  sanpham    Sanpham @relation(fields: [sanphamId], references: [id])
  phieuKho   PhieuKho @relation(fields: [phieuKhoId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
model Sanpham {
  id        String   @id @default(uuid())
  title     String
  slug      String?   @unique
  masp      String   @unique
  giagoc    Float @default(0)
  dvt       String?
  hinhanh   String?
  soluong   Float @default(0)
  soluongkho Float @default(0)
  haohut    Float @default(0)
  ghichu    String?
  order     Int? @default(1)
  isActive  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  banggia   Banggiasanpham[]
  Donhangsanpham Donhangsanpham[]
  Dathangsanpham Dathangsanpham[]
  SanphamKho SanphamKho[]
  PhieuKhoSanpham PhieuKhoSanpham[]
}
model ChatAIMessage {
  id        String  @id @default(uuid())
  userId    String
  message   String
  reply     String
  createdAt DateTime @default(now())
}
model ChatAIHistory {
  id        String   @id @default(uuid())
  userId    String
  message   String
  sender    String   // 'user' hoặc 'bot'
  createdAt DateTime @default(now())
}

model ErrorLog {
  id        String   @id @default(uuid())
  timestamp DateTime
  message   String
  details   Json?    // Lưu thông tin bổ sung dưới dạng JSON
  source    String   // "client" hoặc "server" để phân biệt nguồn lỗi
  createdAt DateTime @default(now())
}



model Lead {
  id          String   @id @default(uuid())
  name        String
  code        String?  @unique
  phone       String?  @unique
  email       String?  @unique
  order       Int?      
  status      String   @default("new") // new, contacted, converted, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  logs        LeadLog[]
  callLogs    CallLog[]
  tags        LeadTag[]
}

model LeadLog {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  action    String   // create, update, status_change
  note      String?
  createdAt DateTime @default(now())
}

model CallLog {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  callTime  DateTime @default(now())
  duration  Int      // in seconds
  outcome   String   // success, failed, no answer
  note      String?
}

model LeadTag {
  id     String @id @default(uuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tag    String
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  action     String?
  entity     String?
  entityId   String?
  oldValue   Json?
  newValue   Json?
  createdAt  DateTime @default(now())

  Employee Employee[]
}



model Task {
  id          String      @id @default(uuid())
  title       String
  description String?
  status      String   @default("pending")
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  assigneeId  String?
  assignee    User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])
  relatedUserId String?
  relatedUser User?    @relation("TaskRelatedUser", fields: [relatedUserId], references: [id])
  comments    Comment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Comment {
  id        String      @id @default(uuid())
  content   String
  taskId    String?
  supportId String?
  userId    String
  task      Task?    @relation(fields: [taskId], references: [id])
  support   SupportTicket? @relation(fields: [supportId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model SupportTicket {
  id          String      @id @default(uuid())
  title       String
  description String?
  status      String   @default("open")
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  handlerId   String?
  handler     User?    @relation("SupportTicketHandler", fields: [handlerId], references: [id])
  relatedUserId String?
  relatedUser User?    @relation("SupportTicketRelatedUser", fields: [relatedUserId], references: [id])
  comments    Comment[]
  createdAt   DateTime @default(now())
}

model Meeting {
  id         String      @id @default(uuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
}

model Notification {
  id        String      @id @default(uuid())
  message   String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Quanlyqrcode {
  id        String   @id @default(uuid())
  qrcode    String   @unique
  code      String   @unique
  name      String   // Họ Tên khách mời
  phone     String   // Số Điện Thoại
  email     String   // Email
  isSentEmail      Boolean  @default(false)
  checkedAt DateTime?  // Null nếu chưa check-in, lưu thời gian nếu đã check-in
  createdAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


enum DriveItemType {
  folder
  file
}

model DriveItem {
  id          String           @id @default(uuid())
  googleId    String           @unique
  name        String
  type        DriveItemType
  parentId    String?
  mimeType    String?
  size        Int?
  permissions PermissionDrive[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([type,parentId])
}

model PermissionDrive {
  id           String    @id @default(uuid())
  userIdDrive  String
  type         String    // "user" hoặc "group"
  kind         String    // "drive#permission"
  emailAddress String?
  role         String    // "reader", "writer", "commenter", "owner"
  driveId      String
  googleId     String
  driveItem    DriveItem @relation(fields: [driveId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userIdDrive, driveId,googleId], name: "uniqueUserDriveItemPermission")
}


model Dexuat {
  id            String    @id @default(uuid()) // ID tự động sinh
  title         String
  chitiet       ChitietDexuat[] @relation("DexuatToChitiet")
  tienbangchu   String?
  tongtien      Int?
  tongchi       Int?
  ngaytao       DateTime? @default(now())
  nguoinhan     String?
  truongbophan  String?
  nguoidexuat   String?
  bophan        String?
  vitri         String?
  tamung        Int? @default(0)
  codeId      String @unique // Mã đề xuất duy nhất
  order      Int? @default(1)
  isActive  Boolean @default(true)
  createdById String
  createdBy  User?  @relation(fields: [createdById], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ChitietDexuat {
  id       String  @id @default(uuid()) 
  dexuatId String  
  dexuat   Dexuat  @relation("DexuatToChitiet", fields: [dexuatId], references: [id], onDelete: Cascade)
  title    String  
  thanhtien Int?    
  ghichu   String? 
  order      Int? @default(1)
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model LandingPage {
  id            String    @id @default(uuid())
  title         String
  slug          String    @unique // URL thân thiện, ví dụ: "chien-dich-thang-4"
  description   String?
  thumbnail      String?   // Hình ảnh thumbnail cho trang
  status        String    @default("draft") // "draft", "published", "archived"
  // --- Phần quan trọng: Lưu trữ nội dung trang ---
  // Option 1: Lưu cấu trúc dạng JSON (Khuyến nghị cho editor phức tạp)
  contentJson   Json?
  // Option 2: Lưu HTML trực tiếp (Đơn giản hơn cho editor cơ bản)
  contentHtml   String?
  // Lưu CSS tùy chỉnh nếu cần tách riêng
  customCss     String?
  // Lưu JS tùy chỉnh nếu cần
  customJs      String?
  // SEO metadata
  seoTitle      String?
  seoDescription String?
  seoKeywords   String?   // Có thể là String[]
  ownerId       String?   // User quản lý trang này
  owner         User?     @relation(fields: [ownerId], references: [id])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  affiliateLinks AffiliateLink[]
  // Nếu bạn muốn lưu log các lượt submit form riêng biệt
  formSubmissions FormSubmission[]
  codeId      String @unique // Mã đề xuất duy nhất
  order      Int? @default(1)
  isActive  Boolean @default(true)
}

// (Tùy chọn) Model để lưu chi tiết các lượt submit form từ LandingPage nội bộ
model FormSubmission {
  id              String    @id @default(uuid())
  landingPageId   String
  landingPage     LandingPage @relation(fields: [landingPageId], references: [id])
  affiliateLinkId String?   // Link affiliate nào dẫn đến submit này (quan trọng!)
  affiliateLink   AffiliateLink? @relation(fields: [affiliateLinkId], references: [id])
  formData        Json      // Lưu dữ liệu người dùng nhập vào form
  submittedAt     DateTime  @default(now())
  ipAddress       String?
  userAgent       String?
  // Có thể thêm cờ để đánh dấu đã xử lý thành registration hay chưa
  processed       Boolean   @default(false)
}


// --- Cập nhật nhỏ cho AffiliateLink ---
model AffiliateLink {
  id            String    @id @default(uuid())
  title         String?    // Tiêu đề của link affiliate
  landingPageId String    // Vẫn là ID của LandingPage nội bộ
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id])
  createdAt     DateTime  @default(now())
  trackingEvents TrackingEvent[]
  registrations Registration[]
  formSubmissions FormSubmission[] // Liên kết đến các form submit qua link này
  codeId      String @unique // Mã đề xuất duy nhất
  order      Int? @default(1)
  isActive  Boolean @default(true)
  createdById String
  createdBy  User?  @relation(fields: [createdById], references: [id])
  updatedAt DateTime @updatedAt
}

// Lưu lại các sự kiện tracking
model TrackingEvent {
  id              String    @id @default(uuid())
  affiliateLinkId String    // Link affiliate nào được sử dụng
  affiliateLink   AffiliateLink @relation(fields: [affiliateLinkId], references: [id])
  type            String    // Loại sự kiện: "view", "click_form", "submit_form"
  ipAddress       String?
  userAgent       String?
  timestamp       DateTime  @default(now())
  triggeredByUserId String?
  triggeredByUser   User?   @relation("TriggeredByUser", fields: [triggeredByUserId], references: [id])
  updatedAt DateTime @updatedAt
}

// Ghi nhận một lượt đăng ký thành công thông qua affiliate link
model Registration {
  id              String    @id @default(uuid())
  registeredUserId String    @unique // ID của User mới đăng ký
  registeredUser  User      @relation(fields: [registeredUserId], references: [id])
  affiliateLinkId String    // Link affiliate dẫn đến đăng ký này
  affiliateLink   AffiliateLink @relation(fields: [affiliateLinkId], references: [id])
  timestamp       DateTime  @default(now())
}



/// schema.prisma

/// EXPANDED Example Schema for a Core HRM System
/// Includes Core HR Profile, plus basic models for Leave, Time, Payroll, Benefits, Org Structure, Onboarding/Offboarding.
/// WARNING: This is a conceptual, illustrative schema. Real-world implementation, especially for Payroll and Benefits,
/// requires deep domain expertise and localization based on legal/regional requirements.
// --- Enums (Existing + New) ---

enum EmploymentType { 
  FULL_TIME 
  PART_TIME 
  CONTRACTOR 
  INTERN 
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  OTHER
}

enum Relation {
  SPOUSE
  CHILD
  PARENT
  SIBLING
  OTHER
}

enum ContractType {
  PERMANENT
  FIXED_TERM
  PROBATIONARY
}

// New Enums
enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum ComponentType {
  EARNING
  DEDUCTION
} // For Payroll

enum PayrollStatus {
  DRAFT
  PROCESSING
  COMPLETED
  FAILED
  ERROR
}

enum PlanType {
  HEALTH
  DENTAL
  RETIREMENT
  LIFE_INSURANCE
  OTHER
} // For Benefits

enum WorkflowType {
  ONBOARDING
  OFFBOARDING
  PERFORMANCE_REVIEW
  OTHER
}

enum WorkflowStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  SKIPPED
  WAITING
}

// --- Core Models (Mostly from previous schema, with minor additions/relation changes) ---

model Employee {
  id            String  @id @default(cuid())
  employeeCode  String  @unique
  firstName     String
  lastName      String
  dateOfBirth   DateTime?
  gender        Gender?
  nationality   String?
  maritalStatus MaritalStatus?
  personalEmail String? @unique
  workEmail     String  @unique
  phoneNumber   String?
  hireDate      DateTime @default(now())
  terminationDate DateTime?
  status          EmployeeStatus @default(ACTIVE)
  positionId      String?
  position        Position?       @relation(fields: [positionId], references: [id], onDelete: SetNull) // Changed to SetNull
  departmentId    String?
  department      Department?     @relation(fields: [departmentId], references: [id], onDelete: SetNull) // Changed to SetNull
  locationId      String?
  location        Location?       @relation(fields: [locationId], references: [id], onDelete: SetNull) // Changed to SetNull
  employmentType  EmploymentType?
  managerId       String?
  manager         Employee?       @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  directReports   Employee[]      @relation("EmployeeManager")
  userId          String?         @unique
  user            User?           @relation(fields: [userId], references: [id], onDelete: SetNull) // Changed to SetNull
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  // --- Relations (Existing + New) ---
  addresses         Address[]
  contracts         Contract[]
  emergencyContacts EmergencyContact[]
  dependants        Dependant[]
  educationHistory  Education[]
  skills            EmployeeSkill[]
  jobHistory        JobHistory[]
  auditLogs         AuditLog[] // Audit logs related to this employee specifically
  // NEW RELATIONS for added modules
  leaveRequests     LeaveRequest[]
  leaveBalances     LeaveBalance[]
  workSchedules     EmployeeWorkSchedule[]
  timesheetEntries  TimesheetEntry[]
  salaryInfo        EmployeeSalary[]
  payslips          Payslip[]
  benefitEnrollments EmployeeEnrollment[]
  workflows         EmployeeWorkflow[] // Workflows this employee is subject to
}

model Department {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  employees   Employee[]
  jobHistory  JobHistory[]
}

model JobGrade { // NEW: Ngạch/Bậc công việc
  id          String @id @default(cuid())
  name        String @unique // e.g., "G1", "G2", "Senior Manager"
  level       Int    // Numeric level for sorting/comparison
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  positions   Position[] // Positions belonging to this grade
}

model Position {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  jobGradeId  String? // NEW: Link to Job Grade
  jobGrade    JobGrade? @relation(fields: [jobGradeId], references: [id], onDelete: SetNull)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  employees   Employee[]
  jobHistory  JobHistory[]
}

model Location {
  id          String    @id @default(cuid())
  name        String
  address     String?
  city        String?
  country     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  employees   Employee[]
}

model Contract {
  id             String       @id @default(cuid())
  employeeId     String
  employee       Employee     @relation(fields: [employeeId], references: [id], onDelete: Restrict) // Changed to Restrict
  contractNumber String?      @unique
  contractType   ContractType
  startDate      DateTime
  endDate        DateTime?
  filePath       String?
  description    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  @@index([employeeId])
}

model JobHistory {
  id           String     @id @default(cuid())
  employeeId   String
  employee     Employee   @relation(fields: [employeeId], references: [id], onDelete: Restrict) // Changed to Restrict
  startDate    DateTime
  endDate      DateTime?
  positionId   String
  position     Position   @relation(fields: [positionId], references: [id], onDelete: Restrict)
  departmentId String
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  description  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  @@index([employeeId])
}

model Address {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade) // Cascade might be ok here
  street          String
  city            String
  stateOrProvince String?
  postalCode      String?
  country         String
  isPrimary       Boolean  @default(false)
  addressType     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  @@index([employeeId])
}

model EmergencyContact {
  id           String   @id @default(cuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade) // Cascade might be ok
  name         String
  relationship Relation
  phoneNumber  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  @@index([employeeId])
}

model Dependant {
  id           String   @id @default(cuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade) // Cascade might be ok
  name         String
  dateOfBirth  DateTime
  relationship Relation
  idNumber     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  @@index([employeeId])
}

model Education {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade) // Cascade ok
  institutionName String
  degree          String?
  fieldOfStudy    String?
  startDate       DateTime?
  endDate         DateTime
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  @@index([employeeId])
}

model Skill {
  id             String          @id @default(cuid())
  name           String          @unique
  description    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  employeeSkills EmployeeSkill[]
}

model EmployeeSkill {
  employeeId       String
  employee         Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade) // Cascade ok
  skillId          String
  skill            Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade) // Cascade ok
  proficiencyLevel Int?     @default(1)
  assignedAt       DateTime @default(now())
  @@id([employeeId, skillId])
}

// --- Leave Management ---
model LeaveType {
  id               String  @id @default(cuid())
  name             String  @unique // e.g., "Annual Leave", "Sick Leave", "Unpaid Leave"
  description      String?
  requiresApproval Boolean @default(true)
  paidLeave        Boolean @default(true)
  maxDaysPerYear   Int?    // Số ngày tối đa/năm (nếu có giới hạn)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  leaveRequests    LeaveRequest[]
  leaveBalances    LeaveBalance[]
}

model LeaveRequest {
  id           String             @id @default(cuid())
  employeeId   String
  employee     Employee           @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  leaveTypeId  String
  leaveType    LeaveType          @relation(fields: [leaveTypeId], references: [id], onDelete: Restrict)
  startDate    DateTime
  endDate      DateTime
  // calculatedDays Decimal // Should be calculated dynamically or via trigger
  reason       String?
  status       LeaveRequestStatus @default(PENDING)
  requestedAt  DateTime           @default(now())
  approverId   String? // ID of the User who approved/rejected
  approver     User?              @relation("LeaveApprover", fields: [approverId], references: [id], onDelete: SetNull)
  approvedAt   DateTime?
  comments     String? // Ghi chú của người duyệt/nhân viên
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([employeeId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([approverId])
}

model LeaveBalance {
  id            String   @id @default(cuid())
  employeeId    String
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade) // Cascade might be ok
  leaveTypeId   String
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade) // Cascade might be ok
  year          Int // Năm áp dụng số dư
  allocatedDays Decimal // Số ngày được cấp trong năm
  takenDays     Decimal  @default(0) // Số ngày đã nghỉ (cần update khi request được duyệt)
  // remainingDays Decimal // Should be calculated dynamically

  // Unique constraint per employee, type, year
  @@unique([employeeId, leaveTypeId, year])
}


// --- Time & Attendance (Basic) ---
model WorkSchedule {
  id        String  @id @default(cuid())
  name      String  @unique // e.g., "Standard 9-5 Mon-Fri", "Shift A"
  isDefault Boolean @default(false)
  // details   Json? // Store complex rules like working hours per day, exceptions, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  employeeSchedules EmployeeWorkSchedule[]
}

model EmployeeWorkSchedule {
  id             String       @id @default(cuid())
  employeeId     String
  employee       Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  workScheduleId String
  workSchedule   WorkSchedule @relation(fields: [workScheduleId], references: [id], onDelete: Restrict)
  effectiveDate  DateTime // Ngày bắt đầu áp dụng lịch này
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([employeeId])
  @@index([workScheduleId])
}

model TimesheetEntry {
  id          String          @id @default(cuid())
  employeeId  String
  employee    Employee        @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  date        DateTime        @postgres.Date // Chỉ lưu ngày, không lưu giờ
  timeIn      DateTime?       // Giờ vào làm thực tế
  timeOut     DateTime?       // Giờ ra về thực tế
  // projectId   String?      // Optional link to project module
  // taskId      String?      // Optional link to task
  hoursWorked Decimal?        // Số giờ làm việc (có thể tự tính hoặc nhập tay)
  notes       String?
  status      TimesheetStatus @default(DRAFT)
  submittedAt DateTime?
  approverId  String? // ID of the User who approved/rejected
  approver    User?           @relation("TimesheetApprover", fields: [approverId], references: [id], onDelete: SetNull)
  approvedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([employeeId, date])
  @@index([status])
  @@index([approverId])
}


// --- Payroll (Very Basic - Data Structure Placeholder ONLY) ---
// WARNING: Real payroll logic is extremely complex and localized. Do not use this directly for calculations.
model PayGrade {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Level 1", "Senior Staff"
  minSalary   Decimal? // Mức lương tối thiểu
  maxSalary   Decimal? // Mức lương tối đa
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  salaries    EmployeeSalary[]
}

model SalaryComponent {
  id              String        @id @default(cuid())
  name            String        @unique // e.g., "Base Salary", "Housing Allowance", "Income Tax", "Social Insurance"
  type            ComponentType // EARNING or DEDUCTION
  isTaxable       Boolean       @default(false)
  // calculationRule String?    // Placeholder for complex formula/logic description
  // isStatutory     Boolean @default(false) // Component bắt buộc theo luật?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model EmployeeSalary {
  id           String    @id @default(cuid())
  employeeId   String
  employee     Employee  @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  payGradeId   String?
  payGrade     PayGrade? @relation(fields: [payGradeId], references: [id], onDelete: SetNull)
  effectiveDate DateTime // Ngày hiệu lực của cấu trúc lương này
  // Option 1: Store components as JSON (flexible but hard to query)
  components   Json?    // Example: [{ "componentId": "...", "amount": 5000000, "currency": "VND" }, { ... }]
  // Option 2: Normalize with a separate table (better for querying)
  // salaryComponents EmployeeSalaryComponent[] // Requires defining EmployeeSalaryComponent model
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([employeeId])
  @@index([payGradeId])
}

model PayrollRun {
  id              String        @id @default(cuid())
  periodStartDate DateTime      @postgres.Date
  periodEndDate   DateTime      @postgres.Date
  paymentDate     DateTime      @postgres.Date
  status          PayrollStatus @default(DRAFT)
  processedAt     DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  payslips        Payslip[]
}

model Payslip {
  id               String     @id @default(cuid())
  payrollRunId     String
  payrollRun       PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Restrict)
  employeeId       String
  employee         Employee   @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  grossEarnings    Decimal    // Tổng thu nhập trước thuế/khấu trừ
  totalDeductions  Decimal    // Tổng khấu trừ
  netPay           Decimal    // Lương thực nhận
  // details          Json       // JSON object storing breakdown: { earnings: [...], deductions: [...] }
  paymentMethod    String?    // e.g., "Bank Transfer"
  // paymentReference String? // Transaction ID
  generatedAt      DateTime   @default(now())

  @@unique([payrollRunId, employeeId]) // Only one payslip per employee per run
}


// --- Benefits Administration (Basic) ---
model BenefitPlan {
  id                   String   @id @default(cuid())
  name                 String   @unique // e.g., "Standard Health Insurance PVI", "Retirement Fund ABC"
  provider             String?  // Nhà cung cấp (e.g., "PVI", "Bao Viet", "Prudential")
  description          String?
  type                 PlanType // Loại hình (HEALTH, DENTAL, RETIREMENT...)
  // contributionEmployee Decimal? // Mức đóng của NV
  // contributionEmployer Decimal? // Mức đóng của NSDLĐ
  // eligibilityRule      String? // Điều kiện tham gia
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  enrollments          EmployeeEnrollment[]
}

model EmployeeEnrollment {
  id             String      @id @default(cuid())
  employeeId     String
  employee       Employee    @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  planId         String
  plan           BenefitPlan @relation(fields: [planId], references: [id], onDelete: Restrict)
  enrollmentDate DateTime    // Ngày đăng ký
  effectiveDate  DateTime    // Ngày hiệu lực
  endDate        DateTime?   // Ngày kết thúc (nếu hủy)
  coverageLevel  String?     // e.g., "Employee Only", "Employee + Spouse", "Family"
  // beneficiaries  Json?    // Link to Dependants or specific beneficiary info
  status         String      @default("ACTIVE") // ACTIVE, INACTIVE, PENDING
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@unique([employeeId, planId, effectiveDate]) // Ensure one enrollment per plan per effective date? Might need adjustment.
}


// --- Onboarding/Offboarding Workflows (Basic Task Tracking) ---
model WorkflowTemplate {
  id          String                 @id @default(cuid())
  name        String                 @unique // e.g., "Standard Employee Onboarding", "Manager Offboarding IT Tasks"
  type        WorkflowType           // ONBOARDING, OFFBOARDING, etc.
  description String?
  isActive    Boolean                @default(true)
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  taskTemplates WorkflowTaskTemplate[]
  workflows     EmployeeWorkflow[]
}

model WorkflowTaskTemplate {
  id            String            @id @default(cuid())
  templateId    String
  template      WorkflowTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  name          String            // e.g., "Prepare Workstation", "Create Email Account", "Conduct Exit Interview"
  description   String?
  assignedRole  String?           // Role responsible (e.g., "HR", "IT", "Manager")
  dueDays       Int?              // Due X days relative to workflow start date (positive for onboarding, negative for offboarding?)
  order         Int?              // Optional order of tasks within template
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  employeeTasks EmployeeWorkflowTask[]
}

model EmployeeWorkflow {
  id         String         @id @default(cuid())
  employeeId String
  employee   Employee       @relation(fields: [employeeId], references: [id], onDelete: Restrict)
  templateId String
  template   WorkflowTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  startDate  DateTime       // Thường là ngày vào làm (Onboarding) hoặc ngày thông báo nghỉ (Offboarding)
  // expectedCompletionDate DateTime?
  status     WorkflowStatus @default(PENDING)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  tasks      EmployeeWorkflowTask[]
  @@index([employeeId])
  @@index([templateId])
  @@index([status])
}

model EmployeeWorkflowTask {
  id             String               @id @default(cuid())
  workflowId     String
  workflow       EmployeeWorkflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  taskTemplateId String
  taskTemplate   WorkflowTaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Restrict)
  status         TaskStatus           @default(TODO)
  dueDate        DateTime?            // Calculated based on workflow start date and template dueDays
  completedAt    DateTime?
  assigneeId     String?              // User assigned to this specific task instance
  assignee       User?                @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  notes          String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  @@index([workflowId])
  @@index([taskTemplateId])
  @@index([status])
  @@index([assigneeId])
}