generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/.prisma/client"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource postgres {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// schema.prisma
model AuditLog {
  id            String          @id @default(uuid())
  entityName    String?         // Tên entity (User, Product, Order...)
  entityId      String?         // ID của entity
  action        AuditAction     // CREATE, UPDATE, DELETE
  userId        String?         // User thực hiện action
  user          User?           @relation(fields: [userId], references: [id])
  userEmail     String?         // Email user (backup)
  oldValues     Json?           // Giá trị cũ (trước khi thay đổi)
  newValues     Json?           // Giá trị mới (sau khi thay đổi)
  changedFields String[]        // Danh sách field đã thay đổi
  ipAddress     String?         // IP address
  userAgent     String?         // User agent
  sessionId     String?         // Session ID
  status        String          @default("SUCCESS")  
  errorDetails  Json?           @map("error_details") // Thêm trường errorDetails
  metadata      Json?           // Metadata bổ sung
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  @@index([entityName, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([status]) // Thêm index cho status để tối ưu lọc
}

enum AuditAction {
  CREATE
  READ
  UPDATE  
  DELETE
  LOGIN
  LOGOUT
  ACCESS
  IMPORT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum serviceType {
  core
  spa
  cms
  academy
  affiliate
  cosmetics
  ecommerce
}

model Setting {
  id          String   @id @default(uuid())
  title       String?
  codeId      String?  @unique // Mã đề xuất duy nhất
  key         String?  @unique // Key: Tên của cấu hình (ví dụ: 'maintenanceMode', 'welcomeMessage', 'maxUploadSize')
  value       String? // Value: Giá trị của cấu hình. Nên lưu dưới dạng String và parse sang kiểu phù hợp khi đọc.
  type        String?  @default("string") // Type (Optional): Giúp ứng dụng biết cách parse giá trị (ví dụ: 'string', 'boolean', 'number', 'json')
  description String? // Description (Optional): Mô tả cấu hình là gì, dùng để làm tài liệu hoặc hiển thị trong Admin UI
  order       Int?     @default(1) // Thứ tự hiển thị trong Admin UI
  isActive    Boolean  @default(true) // Trạng thái kích hoạt của cấu hình
  createdById String? // ID của người tạo cấu hình này (nếu cần)
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@index([createdById])
}

model User {
  id            String         @id @default(uuid())
  name          String?
  avatar        String?
  gender        Gender?
  email         String?        @unique
  SDT           String?        @unique
  phone         String?        @unique
  zaloId        String?        @unique
  facebookId    String?        @unique
  googleId      String?        @unique
  password      String?
  provider      String? // "google", "facebook", "zalo"
  providerId    String?        @unique
  isSuperAdmin  Boolean        @default(false)
  roles         UserRole[]
  isActive      Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  Notification  Notification[]
  Dexuat        Dexuat[]
  LandingPage   LandingPage[]
  affiliateCode String?        @unique // Mã affiliate riêng của user này
  referrerId    String? // ID của user đã giới thiệu user này
  referrer      User?          @relation("Referrals", fields: [referrerId], references: [id])
  referrals     User[]         @relation("Referrals")
  auditLogs     AuditLog[]
  Setting       Setting[]
  kho           kho[]
  nhacungcap    nhacungcap[]
  sanpham       sanpham[]
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
}

model Menu {
  id          String       @id @default(uuid())
  title       String
  icon        String? // Optional icon for menu
  slug        String? // URL of the menu item
  parentId    String? // Reference to parent menu (null if root)
  parent      Menu?        @relation("MenuChildren", fields: [parentId], references: [id])
  children    Menu[]       @relation("MenuChildren")
  order       Int? // For sorting menus
  isActive    Boolean      @default(false) // Enable/Disable menu
  serviceType serviceType? @default(core) // Field to classify service type (e.g., spa, cms, academy, affiliate)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Nhomkhachhang {
  id          String      @id @default(uuid())
  name        String      @unique
  description String?
  khachhang   khachhang[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model ChatAIMessage {
  id        String   @id @default(uuid())
  userId    String
  message   String
  reply     String
  createdAt DateTime @default(now())
}

model ChatAIHistory {
  id        String   @id @default(uuid())
  userId    String
  message   String
  sender    String // 'user' hoặc 'bot'
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  message   String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Quanlyqrcode {
  id          String    @id @default(uuid())
  title       String? // Tiêu đề của QR code
  slug        String? // URL thân thiện, ví dụ: "chien-dich-thang-4"
  qrcode      String    @unique
  code        String    @unique
  name        String? // Họ Tên khách mời
  phone       String? // Số Điện Thoại
  email       String? // Email
  isSentEmail Boolean   @default(false)
  isSentZalo  Boolean   @default(false)
  order       Int?      @default(1)
  isActive    Boolean   @default(true)
  checkedAt   DateTime? // Null nếu chưa check-in, lưu thời gian nếu đã check-in
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([slug, phone, email], name: "Quanlyqrcode_slug_phone_email_key")
}

enum DriveItemType {
  folder
  file
}

model DriveItem {
  id           String            @id @default(uuid())
  googleId     String            @unique
  name         String
  type         DriveItemType
  parentId     String?
  mimeType     String?
  path         String?
  size         BigInt?
  isDelete     Boolean?          @default(false)
  createdTime  DateTime?
  modifiedTime DateTime?
  permissions  PermissionDrive[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([type, parentId])
}

model PermissionDrive {
  id           String    @id @default(uuid())
  userIdDrive  String
  type         String // "user" hoặc "group"
  kind         String // "drive#permission"
  emailAddress String?
  role         String // "reader", "writer", "commenter", "owner"
  driveId      String
  googleId     String
  driveItem    DriveItem @relation(fields: [driveId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userIdDrive, driveId, googleId], name: "uniqueUserDriveItemPermission")
}

model Dexuat {
  id           String          @id @default(uuid()) // ID tự động sinh
  title        String
  chitiet      ChitietDexuat[] @relation("DexuatToChitiet")
  tienbangchu  String?
  tongtien     Int?
  tongchi      Int?
  ngaytao      DateTime?       @default(now())
  nguoinhan    String?
  truongbophan String?
  nguoidexuat  String?
  bophan       String?
  vitri        String?
  tamung       Int?            @default(0)
  codeId       String          @unique // Mã đề xuất duy nhất
  order        Int?            @default(1)
  isActive     Boolean         @default(true)
  createdById  String
  createdBy    User?           @relation(fields: [createdById], references: [id])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

model ChitietDexuat {
  id        String   @id @default(uuid())
  dexuatId  String
  dexuat    Dexuat   @relation("DexuatToChitiet", fields: [dexuatId], references: [id], onDelete: Cascade)
  title     String
  thanhtien Int?
  ghichu    String?
  order     Int?     @default(1)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LandingPage {
  id             String   @id @default(uuid())
  title          String
  slug           String   @unique // URL thân thiện, ví dụ: "chien-dich-thang-4"
  description    String?
  thumbnail      String? // Hình ảnh thumbnail cho trang
  status         String   @default("draft") // "draft", "published", "archived"
  contentJson    Json
  contentHtml    String?
  customCss      String?
  customJs       String?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String? // Có thể là String[]
  ownerId        String? // User quản lý trang này
  owner          User?    @relation(fields: [ownerId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  codeId         String   @unique // Mã đề xuất duy nhất
  order          Int?     @default(1)
  isActive       Boolean  @default(true)
}

model Hoadon {
  id            String          @id @default(uuid())
  nbmst         String
  khmshdon      Int?
  khhdon        String?
  shdon         Int?
  cqt           String?
  cttkhac       Json?
  dvtte         String?
  hdon          String?
  hsgcma        String?
  hsgoc         String?
  hthdon        Int?
  htttoan       Int?
  idtbao        String?
  khdon         String?
  khhdgoc       String?
  khmshdgoc     String?
  lhdgoc        Int?
  mhdon         String?
  mtdiep        String?
  mtdtchieu     String?
  nbdchi        String?
  nbhdktngay    DateTime?
  nbhdktso      String?
  nbhdso        String?
  nblddnbo      String?
  nbptvchuyen   String?
  nbstkhoan     String?
  nbten         String?
  nbtnhang      String?
  nbtnvchuyen   String?
  ncma          DateTime?
  ncnhat        DateTime?
  ngcnhat       String?
  nky           DateTime?
  nmdchi        String?
  nmmst         String?
  nmstkhoan     String?
  nmten         String?
  nmtnhang      String?
  nmtnmua       String?
  ntao          DateTime?
  ntnhan        DateTime?
  pban          String?
  ptgui         Int?
  shdgoc        Int?
  tchat         Int?
  tdlap         DateTime?
  tgia          Int?
  tgtcthue      Int?
  tgtthue       Int?
  tgtttbchu     String?
  tgtttbso      Int?
  thdon         String?
  thlap         Int?
  thttlphi      Json?
  tlhdon        String?
  ttcktmai      Int?
  tthai         Int?
  tttbao        Int?
  ttxly         Int?
  tvandnkntt    String?
  mhso          String?
  ladhddt       Int?
  mkhang        String?
  nbsdthoai     String?
  nbdctdtu      String?
  nbfax         String?
  nbwebsite     String?
  nbcks         String?
  nmsdthoai     String?
  nmdctdtu      String?
  nmcmnd        String?
  nmcks         String?
  bhphap        Int?
  hddunlap      String?
  gchdgoc       String?
  tbhgtngay     DateTime?
  bhpldo        String?
  bhpcbo        String?
  bhpngay       DateTime?
  tdlhdgoc      String?
  tgtphi        Int?
  unhiem        String?
  mstdvnunlhdon String?
  tdvnunlhdon   String?
  nbmdvqhnsach  String?
  nbsqdinh      String?
  nbncqdinh     String?
  nbcqcqdinh    String?
  nbhtban       String?
  nmmdvqhnsach  String?
  nmddvchden    String?
  nmtgvchdtu    String?
  nmtgvchdden   String?
  nbtnban       String?
  dcdvnunlhdon  String?
  dksbke        String?
  dknlbke       String?
  thtttoan      String?
  msttcgp       String?
  gchu          String?
  kqcht         String?
  hdntgia       String?
  tgtkcthue     String?
  tgtkhac       Int?
  nmshchieu     String?
  nmnchchieu    String?
  nmnhhhchieu   String?
  nmqtich       String?
  ktkhthue      String?
  hdhhdvu       String?
  qrcode        String?
  ttmstten      String?
  ladhddtten    String?
  hdxkhau       String?
  hdxkptquan    String?
  hdgktkhthue   String?
  hdonLquans    Json?
  tthdclquan    Boolean?
  pdndungs      Json?
  hdtbssrses    Json?
  hdTrung       String?
  isHDTrung     Boolean?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  HoadonChitiet HoadonChitiet[]
}

model HoadonChitiet {
  id        String   @id @default(uuid())
  codeId    String?
  title     String?
  title2    String?
  idhdon    String
  idhoadon  String
  hoadon    Hoadon   @relation(fields: [idhoadon], references: [id], onDelete: Cascade)
  dgia      Int?
  dvtinh    String?
  ltsuat    String?
  sluong    Int?
  stbchu    String?
  stckhau   Int?
  stt       Int?
  tchat     Int?
  ten       String?
  thtcthue  Int?
  thtien    Int?
  tlckhau   Int?
  tsuat     Float?
  tthue     Int?
  sxep      Int?
  dvtte     String?
  tgia      Int?
  order     Int?     @default(1)
  isproduct Boolean? @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@index([idhdon])
}

model Mathang {
  id        String   @id @default(uuid())
  codeId    String?  @unique // Mã đề xuất duy nhất
  ten       String?
  title     String?
  title2    String?
  dvtinh    String?
  giavon    Float    @default(0)
  isproduct Boolean? @default(true)
  isEdit    Boolean? @default(false)
  status    String   @default("draft") // "draft", "published", "archived"
  order     Int?     @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserguidBlock {
  id        String        @id @default(uuid())
  codeId    String?       @unique // Mã đề xuất duy nhất
  type      String
  text      String?
  listItems String?
  imageUrl  String?
  imageAlt  String?
  videoUrl  String?
  videoType String?
  caption   String?
  stepId    String?
  step      UserguidStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  order     Int?          @default(1)
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model UserguidStep {
  id             String          @id @default(uuid())
  codeId         String?         @unique // Mã đề xuất duy nhất
  time           String?
  title          String?
  description    String?
  order          Int?            @default(1)
  UserguidBlocks UserguidBlock[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([id])
}

model Resource {
  id          String   @id @default(uuid())
  codeId      String?  @unique // Mã đề xuất duy nhất
  title       String?
  url         String?
  description String?
  fileType    String?
  metaData    Json?
  category    String?
  group       String?
  order       Int?     @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model danhmuc {
  id          String    @id @default(uuid())
  codeId      String    @unique
  title       String
  description String?
  order       Int?      @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  sanphams    sanpham[] // Each category can have multiple products
}

model sanpham {
  id             String           @id @default(uuid())
  codeId         String           @unique
  title          String
  donvitinh      String?
  description    String?
  bienthe        String? // Biến thể của sản phẩm, ví dụ: "Màu sắc", "Kích thước"
  bacgia         Json? // Bảng giá của sản phẩm, ví dụ: "Giá bán lẻ", "Giá sỉ"
  giagoc         Float            @default(0)
  inStock        Boolean          @default(true)
  status         String           @default("draft") // "draft", "published", "archived"
  order          Int?             @default(1)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  danhmucId      String?         // Foreign key referencing danhmuc
  danhmuc        danhmuc?         @relation(fields: [danhmucId], references: [id])
  createdById    String?
  createdBy      User?         @relation(fields: [createdById], references: [id])
  donhangsanpham donhangsanpham[]
  dathangsanpham dathangsanpham[]
  banggia        BangGiaSanPham[] @relation("SanphamBangGia")
}

model khachhang {
  id              String             @id @default(uuid())
  codeId          String             @unique
  title           String
  description     String?
  email           String?            @unique
  phone           String?            @unique
  diachi          String?
  donhangs        donhang[]          @relation("KhachhangDonhang")
  order           Int?               @default(1)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  Nhomkhachhang   Nhomkhachhang?     @relation(fields: [nhomkhachhangId], references: [id])
  nhomkhachhangId String?
  banggia         BangGiaKhachHang[] @relation("KhachhangBangGia")
}

model banggia {
  id        String             @id @default(uuid())
  codeId    String             @unique // Unique code for the price list
  title     String? // Title of the price list
  sanpham   BangGiaSanPham[]   @relation("BangGiaSanPham")
  khachhang BangGiaKhachHang[] @relation("BangGiaKhachHang")
  batdau    DateTime?
  ketthuc   DateTime?
  status    String             @default("baogia") // "baogia" or "dangban"
  order     Int?               @default(1)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
}

model BangGiaSanPham {
  id        String   @id @default(uuid())
  banggiaId String
  sanphamId String
  banggia   banggia  @relation("BangGiaSanPham", fields: [banggiaId], references: [id], onDelete: Cascade)
  sanpham   sanpham  @relation("SanphamBangGia", fields: [sanphamId], references: [id], onDelete: Cascade)
  giaban    Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([banggiaId, sanphamId])
}

model BangGiaKhachHang {
  id          String    @id @default(uuid())
  banggiaId   String
  khachhangId String
  banggia     banggia   @relation("BangGiaKhachHang", fields: [banggiaId], references: [id], onDelete: Cascade)
  khachhang   khachhang @relation("KhachhangBangGia", fields: [khachhangId], references: [id], onDelete: Cascade)
  status      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  @@unique([banggiaId, khachhangId])
}

model donhang {
  id             String           @id @default(uuid())
  codeId         String           @unique
  khachhangId    String
  khachhang      khachhang        @relation("KhachhangDonhang", fields: [khachhangId], references: [id])
  total          Float            @default(0)
  status         String           @default("pending") // pending, completed, cancelled, etc.
  order          Int?             @default(1)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  donhangsanpham donhangsanpham[]
}

model donhangsanpham {
  id        String   @id @default(uuid())
  donhangId String
  sanphamId String
  sldat     Float    @default(0)
  slgiao    Float    @default(0)
  slnhan    Float    @default(0)
  slhuy     Float    @default(0)
  giaban    Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  donhang   donhang  @relation(fields: [donhangId], references: [id], onDelete: Cascade)
  sanpham   sanpham  @relation(fields: [sanphamId], references: [id], onDelete: Cascade)

  @@unique([donhangId, sanphamId])
}

model dathang {
  id             String   @id @default(uuid())
  codeId         String   @unique
  nhacungcapId   String
  nhacungcap     nhacungcap       @relation("NhacungcapDathang", fields: [nhacungcapId], references: [id])
  total          Float            @default(0)
  status         String           @default("pending") // pending, completed, cancelled, etc.
  order          Int?             @default(1)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  dathangsanpham dathangsanpham[]
}

model dathangsanpham {
  id        String   @id @default(uuid())
  dathangId String
  sanphamId String
  sldat     Float    @default(0)
  slgiao    Float    @default(0)
  slnhan    Float    @default(0)
  slhuy     Float    @default(0)
  giaban    Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  dathang   dathang  @relation(fields: [dathangId], references: [id], onDelete: Cascade)
  sanpham   sanpham  @relation(fields: [sanphamId], references: [id], onDelete: Cascade)
  @@unique([dathangId, sanphamId])
}

model kho {
  id          String   @id @default(uuid())
  codeId      String   @unique
  title       String
  description String?
  order       Int?     @default(1)
  createdBy       String? // ID của người tạo nhà cung cấp này
  createdByUser   User?   @relation(fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model nhacungcap {
  id              String   @id @default(uuid())
  codeId          String   @unique
  title           String?
  description     String?
  email           String?            @unique
  phone           String?            @unique
  diachi          String?
  dathangs        dathang[]          @relation("NhacungcapDathang")
  order           Int?               @default(1)
  createdBy       String? // ID của người tạo nhà cung cấp này
  createdByUser   User?   @relation(fields: [createdBy], references: [id])
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model phieukho {
  id          String   @id @default(uuid())
  codeId      String   @unique
  title       String
  description String?
  order       Int?     @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
