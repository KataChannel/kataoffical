generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource postgres {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
model AuditLog {
  id            String          @id @default(uuid())
  entityName    String          // Tên entity (User, Product, Order...)
  entityId      String          // ID của entity
  action        AuditAction     // CREATE, UPDATE, DELETE
  userId        String?         // User thực hiện action
  user          User?          @relation(fields: [userId], references: [id])
  userEmail     String?         // Email user (backup)
  oldValues     Json?           // Giá trị cũ (trước khi thay đổi)
  newValues     Json?           // Giá trị mới (sau khi thay đổi)
  changedFields String[]        // Danh sách field đã thay đổi
  ipAddress     String?         // IP address
  userAgent     String?         // User agent
  sessionId     String?         // Session ID
  metadata      Json?           // Metadata bổ sung
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  @@index([entityName, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
}
enum AuditAction {
  CREATE
  UPDATE  
  DELETE
  LOGIN
  LOGOUT
  ACCESS
}
model User {
  id        String   @id @default(uuid())
  email     String?   @unique
  SDT       String?   @unique
  password  String
  provider  String?  // "google", "facebook", "zalo"
  providerId String? @unique
  profile   Profile?
  roles     UserRole[]
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  AuditLog AuditLog[]
}

model Role {
  id          String         @id @default(uuid())
  name        String         @unique
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model UserRole {
  id      String @id @default(uuid())
  userId  String
  roleId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
}


model Permission {
  id          String         @id @default(uuid())
  codeId      String?         
  name        String         @unique
  group       String?       // Nhóm quyền
  description String?
  roles       RolePermission[]
  order       Int?          @default(1)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
}

model Menu {
  id        String   @id @default(uuid())
  title     String
  icon      String?  // Optional icon for menu
  slug      String?  // URL of the menu item
  parentId  String?  // Reference to parent menu (null if root)
  parent    Menu?    @relation("MenuChildren", fields: [parentId], references: [id])
  children  Menu[]   @relation("MenuChildren")
  order     Int?      // For sorting menus
  isActive  Boolean  @default(false) // Enable/Disable menu
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Profile {
  id     String  @id @default(uuid())
  userId String  @unique
  user   User    @relation(fields: [userId], references: [id])
  name   String
  avatar String?
  bio    String?
}

model Banggia {
  id           String   @id @default(uuid())
  title        String?
  mabanggia    String?
  type         String?
  batdau       DateTime?
  ketthuc      DateTime?
  order        Int?     @default(1)
  ghichu       String?
  status       String?
  isActive     Boolean  @default(true)
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sanpham      Banggiasanpham[]
  khachhang    Khachhang[] @relation("Banggiakhachhang")
}

model Khachhang {
  id            String         @id @default(uuid())
  tenfile       String?
  tenkh         String?
  name          String?
  namenn        String?
  subtitle      String?
  makh          String         @unique
  makhold       String?
  diachi        String?
  sdt           String?
  mst           String?
  gionhanhang   String?
  quan          String?
  email         String? 
  phone         String?
  address       String?
  loaikh        String?
  ghichu        String?
  hiengia       Boolean        @default(false)
  isActive      Boolean        @default(false)
  istitle2      Boolean        @default(false)
  banggiaId     String?        
  banggia       Banggia?       @relation("Banggiakhachhang", fields: [banggiaId], references: [id])
  donhang       Donhang[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  nhomkhachhang Nhomkhachhang[] @relation("KhachhangNhom")
}

model Nhomkhachhang {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  khachhang   Khachhang[]  @relation("KhachhangNhom")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
enum StatusDonhang {
  dadat     // Đã xác nhận
  dagiao       // Đã giao hàng
  danhan     // Đã nhận hàng
  huy     // Đã hủy
  hoanthanh   // Đã hoàn thành
}
model Sanpham {
  id        String   @id @default(uuid())
  title     String
  title2     String?
  slug      String?   @unique
  masp      String   @unique
  subtitle  String? 
  giagoc    Float @default(0)
  giaban    Float @default(0)
  dvt       String?
  hinhanh   String?
  loadpoint Float? @default(0)
  soluong   Decimal? @postgres.Decimal(20, 2) @default(0)
  soluongkho Decimal? @postgres.Decimal(20, 2) @default(0)
  haohut    Float @default(0)
  ghichu    String?
  order     Int? @default(1)
  isActive  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  banggia   Banggiasanpham[]
  Donhangsanpham Donhangsanpham[]
  Dathangsanpham Dathangsanpham[]
  SanphamKho SanphamKho[]
  PhieuKhoSanpham PhieuKhoSanpham[]
  Nhacungcap Nhacungcap[] @relation("NhacungcapToSanpham")
  TonKho TonKho[]
}
model Donhang {
  id          String  @id @default(uuid())
  title       String?
  type        String?
  madonhang   String  @unique
  ngaygiao    DateTime?
  ghichu      String?
  status      StatusDonhang @default(dadat) // Dùng Enum
  khachhangId String
  khachhang   Khachhang @relation(fields: [khachhangId], references: [id])
  sanpham     Donhangsanpham[]
  printCount  Int? @default(0)
  order       Int?
  isActive    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  PhieuKho PhieuKho[]
}

model Donhangsanpham {
  id        String   @id @default(uuid())
  idSP      String
  sldat     Decimal @postgres.Decimal(20, 2) @default(0)
  slgiao    Decimal @postgres.Decimal(20, 2) @default(0)
  slnhan    Decimal @postgres.Decimal(20, 2) @default(0)
  slhuy     Decimal @postgres.Decimal(20, 2) @default(0)
  ttdat     Decimal @postgres.Decimal(20, 2) @default(0)
  ttgiao    Decimal @postgres.Decimal(20, 2) @default(0)
  ttnhan    Decimal @postgres.Decimal(20, 2) @default(0)
  ghichu    String?
  sanpham   Sanpham  @relation(fields: [idSP], references: [id])
  donhang   Donhang  @relation(fields: [donhangId], references: [id],onDelete: Cascade)
  donhangId String
  order     Int?
  isActive  Boolean?  @default(false)
}

model Banggiasanpham {
  id        String   @id @default(uuid())
  giaban    Float     @default(0)
  sanphamId String
  banggiaId String
  sanpham   Sanpham  @relation(fields: [sanphamId], references: [id])
  banggia   Banggia  @relation(fields: [banggiaId], references: [id])
  order     Int?
  isActive  Boolean  @default(false)
}


model Nhacungcap {
  id       String     @id @default(uuid())
  name     String?
  mancc    String     @unique
  manccold    String?    
  diachi   String?
  email    String?  
  sdt      String?
  ghichu   String?
  isActive Boolean    @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  dathang  Dathang[]  // 1 nhà cung cấp có nhiều đơn đặt hàng
  Sanpham Sanpham[] @relation("NhacungcapToSanpham")
}



model Dathang {
  id          String  @id @default(uuid())
  title       String?
  subtitle    String?
  type        String?
  madncc      String?     @unique
  ngaynhan    DateTime?
  ghichu      String?
  nhacungcapId String
  nhacungcap   Nhacungcap @relation(fields: [nhacungcapId], references: [id])
  order       Int?
  isActive    Boolean  @default(false)
  sanpham     Dathangsanpham[]
  status      StatusDonhang @default(dadat) // Dùng Enum
  printCount  Int? @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime? @updatedAt  
  PhieuKho PhieuKho[]
}

model Dathangsanpham {
  id        String   @id @default(uuid())
  idSP      String
  sldat     Decimal @postgres.Decimal(20, 2) @default(0)
  slgiao    Decimal @postgres.Decimal(20, 2) @default(0)
  slnhan    Decimal @postgres.Decimal(20, 2) @default(0)
  slhuy     Decimal @postgres.Decimal(20, 2) @default(0)
  ttdat     Decimal @postgres.Decimal(20, 2) @default(0)
  ttgiao    Decimal @postgres.Decimal(20, 2) @default(0)
  ttnhan    Decimal @postgres.Decimal(20, 2) @default(0)
  gianhap   Decimal @postgres.Decimal(20, 2) @default(0)
  ghichu    String?
  sanpham   Sanpham  @relation(fields: [idSP], references: [id])
  dathang   Dathang  @relation(fields: [dathangId], references: [id],onDelete: Cascade)
  dathangId String
  order     Int?
  isActive  Boolean  @default(false)
}

model Congty {
  id        String @id @default(uuid())
  name      String
  diachi    String?
  email     String?
  sdt       String?
  isActive  Boolean @default(true)
  kho       Kho[] // 1 Công ty có nhiều Kho
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Kho {
  id        String @id @default(uuid())
  name      String
  makho     String?
  diachi    String?
  sdt       String?
  ghichu    String?
  congtyId  String?
  congty    Congty? @relation(fields: [congtyId], references: [id])
  sanphamKho SanphamKho[]
  phieukho  PhieuKho[]
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model SanphamKho {
  id        String @id @default(uuid())
  khoId     String
  sanphamId String
  soluong   Decimal @postgres.Decimal(20, 2) @default(0)
  ghichu    String?
  kho       Kho @relation(fields: [khoId], references: [id])
  sanpham   Sanpham @relation(fields: [sanphamId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PhieuKho {
  id        String @id @default(uuid())
  title     String?
  maphieu   String? @unique
  madonhang String?
  donhang   Donhang? @relation(fields: [madonhang], references: [madonhang])
  madncc    String?
  dathang   Dathang? @relation(fields: [madncc], references: [madncc])
  madathang String?
  ngay      DateTime?
  type      String? // "nhap" | "xuat"
  khoId     String?
  kho       Kho? @relation(fields: [khoId], references: [id])
  ghichu    String?
  isActive  Boolean @default(true)
  sanpham   PhieuKhoSanpham[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PhieuKhoSanpham {
  id          String @id @default(uuid())
  sanphamId   String
  soluong     Decimal @postgres.Decimal(20, 2) @default(0)
  ghichu      String?
  sanpham     Sanpham @relation(fields: [sanphamId], references: [id])
  phieuKhoId  String
  phieuKho    PhieuKho @relation(fields: [phieuKhoId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@unique([phieuKhoId, sanphamId]) // Đảm bảo không có sản phẩm trùng lặp trong cùng một phiếu kho
}
model TonKho {
  id               String       @id @default(uuid())
  sanphamId        String  @unique
  sanpham          Sanpham @relation(fields: [sanphamId], references: [id])
  slton            Decimal @postgres.Decimal(20, 2) @default(0)
  slchogiao        Decimal @postgres.Decimal(20, 2) @default(0)
  slchonhap        Decimal @postgres.Decimal(20, 2) @default(0)
}
model ChatAIMessage {
  id        String  @id @default(uuid())
  userId    String
  message   String
  reply     String
  createdAt DateTime @default(now())
}
model ChatAIHistory {
  id        String   @id @default(uuid())
  userId    String
  message   String
  sender    String   // 'user' hoặc 'bot'
  createdAt DateTime @default(now())
}
model File {
  id        String  @id @default(uuid())
  fileName  String?
  fileUrl   String?
  jsonData  Json?
  createdAt DateTime @default(now())
}
model ErrorLog {
  id        String   @id @default(uuid())
  timestamp DateTime
  message   String
  details   Json?    // Lưu thông tin bổ sung dưới dạng JSON
  source    String   // "client" hoặc "server" để phân biệt nguồn lỗi
  createdAt DateTime @default(now())
}

model UserguidBlock {
  id        String        @id @default(uuid())
  codeId    String?       @unique // Mã đề xuất duy nhất
  type      String        
  title      String?   
  description  String?     
  listItems String?       
  imageUrl  String?       
  imageAlt  String?       
  videoUrl  String?       
  videoType String?           
  stepId    String?
  step      UserguidStep?  @relation(fields: [stepId], references: [id], onDelete: Cascade)
  order     Int?          @default(1)
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}
  
model UserguidStep {
  id            String   @id @default(uuid())
  codeId        String?       @unique // Mã đề xuất duy nhất
  time          String?         
  title         String?        
  description   String? 
  order         Int?          @default(1)       
  UserguidBlocks UserguidBlock[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  @@index([id])
}

model ImportHistory {
  id         String   @id @default(uuid())
  codeId     String?   @unique // Mã đề xuất duy nhất
  title      String?   // Tên import
  caseDetail Json?    // Chi tiết từng case import
  importTime DateTime @default(now())
  type       String?   // Loại import (vd: "sanpham", "khachhang", ...)
  status     String?   // Trạng thái import
  order     Int?    @default(1)
  createdBy String?  @default("system") // Người tạo import
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}