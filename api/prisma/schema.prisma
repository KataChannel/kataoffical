generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource postgres {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String?   @unique
  SDT       String?   @unique
  password  String
  provider  String?  // "google", "facebook", "zalo"
  providerId String? @unique
  isSuperAdmin Boolean @default(false)
  profile   Profile?
  roles     UserRole[]
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  audits    AuditLog[]
  Task Task[]
  Comment Comment[]
  SupportTicket SupportTicket[]
  handler SupportTicket[] @relation("SupportTicketHandler")
  relatedUser SupportTicket[] @relation("SupportTicketRelatedUser")
  Meeting Meeting[]
  Notification Notification[]
  assignedTasks Task[] @relation("TaskAssignee")
  relatedTasks Task[] @relation("TaskRelatedUser")
}

model Role {
  id          String         @id @default(uuid())
  name        String         @unique
  permissions RolePermission[]
  users       UserRole[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model UserRole {
  id      String @id @default(uuid())
  userId  String
  roleId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)
}


model Permission {
  id          String         @id @default(uuid())
  name        String         @unique
  description String?
  roles       RolePermission[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model RolePermission {
  id           String     @id @default(uuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
}

model Menu {
  id        String   @id @default(uuid())
  title     String
  icon      String?  // Optional icon for menu
  slug      String?  // URL of the menu item
  parentId  String?  // Reference to parent menu (null if root)
  parent    Menu?    @relation("MenuChildren", fields: [parentId], references: [id])
  children  Menu[]   @relation("MenuChildren")
  order     Int?      // For sorting menus
  isActive  Boolean  @default(false) // Enable/Disable menu
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Profile {
  id     String  @id @default(uuid())
  userId String  @unique
  user   User    @relation(fields: [userId], references: [id])
  name   String
  avatar String?
  bio    String?
}

model Banggia {
  id        String   @id @default(uuid())
  title     String
  type      String
  batdau    DateTime?
  ketthuc   DateTime?
  order     Int?     @default(1)
  ghichu   String?
  status   String?
  isActive Boolean    @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sanpham   Banggiasanpham[]
  khachhang Khachhang[] @relation("Banggiakhachhang")
}
model Khachhang {
  id           String   @id @default(uuid())
  name         String?
  namenn       String?
  makh         String   @unique
  diachi       String?
  sdt          String?
  mst          String?
  gionhanhang  String?
  quan         String?
  email        String? 
  phone        String?
  address      String?
  loaikh       String?
  ghichu       String?
  hiengia     Boolean  @default(false)
  isActive     Boolean  @default(false)
  banggia      Banggia[] @relation("Banggiakhachhang")
  donhang      Donhang[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  nhomkhachhang Nhomkhachhang[] @relation("KhachhangNhom")
}
model Nhomkhachhang {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  khachhang   Khachhang[]  @relation("KhachhangNhom")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Donhangsanpham {
  id        String   @id @default(uuid())
  idSP      String
  sldat     Float?
  slgiao    Float?
  slnhan    Float?
  ttdat     Float?
  ttgiao    Float?
  ttnhan    Float?
  ghichu    String?
  sanpham   Sanpham  @relation(fields: [idSP], references: [id])
  donhang   Donhang  @relation(fields: [donhangId], references: [id],onDelete: Cascade)
  donhangId String
  order     Int?
  isActive  Boolean?  @default(false)
}

enum StatusDonhang {
  dadat     // Đã xác nhận
  dagiao       // Đã giao hàng
  danhan     // Đã nhận hàng
  huy     // Đã hủy
}
model Donhang {
  id          String  @id @default(uuid())
  title       String
  type        String?
  madonhang   String  @unique
  ngaygiao    DateTime?
  ghichu      String?
  status      StatusDonhang @default(dadat) // Dùng Enum
  khachhangId String
  khachhang   Khachhang @relation(fields: [khachhangId], references: [id])
  sanpham     Donhangsanpham[]
  order       Int?
  isActive    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Banggiasanpham {
  id        String   @id @default(uuid())
  giaban    Float     @default(0)
  sanphamId String
  banggiaId String
  sanpham   Sanpham  @relation(fields: [sanphamId], references: [id])
  banggia   Banggia  @relation(fields: [banggiaId], references: [id])
  order     Int?
  isActive  Boolean  @default(false)
}


model Nhacungcap {
  id       String     @id @default(uuid())
  name     String?
  mancc    String     @unique
  diachi   String?
  email    String?  
  sdt      String?
  ghichu   String?
  isActive Boolean    @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  dathang  Dathang[]  // 1 nhà cung cấp có nhiều đơn đặt hàng
}

model Dathang {
  id          String  @id @default(uuid())
  title       String?
  type        String?
  madncc      String?     @unique
  ngaynhan    DateTime?
  ghichu      String?
  nhacungcapId String
  nhacungcap   Nhacungcap @relation(fields: [nhacungcapId], references: [id])
  order       Int?
  isActive    Boolean  @default(false)
  sanpham     Dathangsanpham[]
}

model Dathangsanpham {
  id        String   @id @default(uuid())
  idSP      String
  sldat     Float?
  slgiao    Float?
  slnhan    Float?
  ttdat     Float?
  ttgiao    Float?
  ttnhan    Float?
  ghichu    String?
  sanpham   Sanpham  @relation(fields: [idSP], references: [id])
  dathang   Dathang  @relation(fields: [dathangId], references: [id],onDelete: Cascade)
  dathangId String
  order     Int?
  isActive  Boolean  @default(false)
}

model Congty {
  id        String @id @default(uuid())
  name      String
  diachi    String?
  email     String?
  sdt       String?
  isActive  Boolean @default(true)
  kho       Kho[] // 1 Công ty có nhiều Kho
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Kho {
  id        String @id @default(uuid())
  name      String
  makho     String?
  diachi    String?
  sdt       String?
  ghichu    String?
  congtyId  String?
  congty    Congty? @relation(fields: [congtyId], references: [id])
  sanphamKho SanphamKho[]
  phieukho  PhieuKho[]
  isActive  Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model SanphamKho {
  id        String @id @default(uuid())
  khoId     String
  sanphamId String
  soluong   Float @default(0)
  ghichu    String?
  kho       Kho @relation(fields: [khoId], references: [id])
  sanpham   Sanpham @relation(fields: [sanphamId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PhieuKho {
  id        String @id @default(uuid())
  maphieu   String
  ngay      DateTime
  type      String // "nhap" | "xuat"
  khoId     String
  kho       Kho @relation(fields: [khoId], references: [id])
  ghichu    String?
  isActive  Boolean @default(true)
  sanpham   PhieuKhoSanpham[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PhieuKhoSanpham {
  id        String @id @default(uuid())
  phieuKhoId String
  sanphamId  String
  sldat     Float @default(0)
  soluong   Float @default(0)
  ghichu    String?
  sanpham    Sanpham @relation(fields: [sanphamId], references: [id])
  phieuKho   PhieuKho @relation(fields: [phieuKhoId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
model Sanpham {
  id        String   @id @default(uuid())
  title     String
  slug      String?   @unique
  masp      String   @unique
  giagoc    Float @default(0)
  dvt       String?
  hinhanh   String?
  soluong   Float @default(0)
  soluongkho Float @default(0)
  haohut    Float @default(0)
  ghichu    String?
  order     Int? @default(1)
  isActive  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  banggia   Banggiasanpham[]
  Donhangsanpham Donhangsanpham[]
  Dathangsanpham Dathangsanpham[]
  SanphamKho SanphamKho[]
  PhieuKhoSanpham PhieuKhoSanpham[]
}
model ChatAIMessage {
  id        String  @id @default(uuid())
  userId    String
  message   String
  reply     String
  createdAt DateTime @default(now())
}
model ChatAIHistory {
  id        String   @id @default(uuid())
  userId    String
  message   String
  sender    String   // 'user' hoặc 'bot'
  createdAt DateTime @default(now())
}

model ErrorLog {
  id        String   @id @default(uuid())
  timestamp DateTime
  message   String
  details   Json?    // Lưu thông tin bổ sung dưới dạng JSON
  source    String   // "client" hoặc "server" để phân biệt nguồn lỗi
  createdAt DateTime @default(now())
}



model Lead {
  id          String   @id @default(uuid())
  name        String
  code        String?  @unique
  phone       String?  @unique
  email       String?  @unique
  order       Int?      
  status      String   @default("new") // new, contacted, converted, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  logs        LeadLog[]
  callLogs    CallLog[]
  tags        LeadTag[]
}

model LeadLog {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  action    String   // create, update, status_change
  note      String?
  createdAt DateTime @default(now())
}

model CallLog {
  id        String   @id @default(uuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  callTime  DateTime @default(now())
  duration  Int      // in seconds
  outcome   String   // success, failed, no answer
  note      String?
}

model LeadTag {
  id     String @id @default(uuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tag    String
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  action     String?
  entity     String?
  entityId   String?
  oldValue   Json?
  newValue   Json?
  createdAt  DateTime @default(now())
}



model Task {
  id          String      @id @default(uuid())
  title       String
  description String?
  status      String   @default("pending")
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  assigneeId  String?
  assignee    User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])
  relatedUserId String?
  relatedUser User?    @relation("TaskRelatedUser", fields: [relatedUserId], references: [id])
  comments    Comment[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Comment {
  id        String      @id @default(uuid())
  content   String
  taskId    String?
  supportId String?
  userId    String
  task      Task?    @relation(fields: [taskId], references: [id])
  support   SupportTicket? @relation(fields: [supportId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model SupportTicket {
  id          String      @id @default(uuid())
  title       String
  description String?
  status      String   @default("open")
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  handlerId   String?
  handler     User?    @relation("SupportTicketHandler", fields: [handlerId], references: [id])
  relatedUserId String?
  relatedUser User?    @relation("SupportTicketRelatedUser", fields: [relatedUserId], references: [id])
  comments    Comment[]
  createdAt   DateTime @default(now())
}

model Meeting {
  id         String      @id @default(uuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
}

model Notification {
  id        String      @id @default(uuid())
  message   String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Quanlyqrcode {
  id        String   @id @default(uuid())
  qrcode    String   @unique
  code      String   @unique
  name      String   // Họ Tên khách mời
  phone     String   // Số Điện Thoại
  email     String   // Email
  isSentEmail      Boolean  @default(false)
  checkedAt DateTime?  // Null nếu chưa check-in, lưu thời gian nếu đã check-in
  createdAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


enum DriveItemType {
  folder
  file
}

model DriveItem {
  id          String           @id @default(uuid())
  googleId    String           @unique
  name        String
  type        DriveItemType
  parentId    String?
  mimeType    String?
  size        Int?
  permissions PermissionDrive[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([type,parentId])
}

model PermissionDrive {
  id           String    @id @default(uuid())
  userIdDrive  String
  type         String    // "user" hoặc "group"
  kind         String    // "drive#permission"
  emailAddress String?
  role         String    // "reader", "writer", "commenter", "owner"
  driveId      String
  googleId     String
  driveItem    DriveItem @relation(fields: [driveId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([userIdDrive, driveId,googleId], name: "uniqueUserDriveItemPermission")
}
