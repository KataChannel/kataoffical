import './polyfills.server.mjs';
import{a as f}from"./chunk-73IBRO6I.mjs";import{a as E}from"./chunk-MNIYO6WO.mjs";import{a as S}from"./chunk-N2765VW3.mjs";import{a as n}from"./chunk-CDM7JTLR.mjs";import{a as w}from"./chunk-EOFHZTVQ.mjs";import{d as m}from"./chunk-4ZV5DK6T.mjs";import{Ja as h,ca as g,g as p,ha as y}from"./chunk-ZJYI7RGL.mjs";import{j as s}from"./chunk-RIAI3ORJ.mjs";var I=class v{constructor(r,e,t){this._StorageService=r;this.router=e;this._ErrorLogService=t}ListQuanlydrive=h([]);DetailQuanlydrive=h({});quanlydriveId=h(null);setQuanlydriveId(r){this.quanlydriveId.set(r)}socket=S(`${n.APIURL}`);progress=h(0);totalRecords=h(0);status=new p("Idle");saveToIndexedDB(r,e){return s(this,null,function*(){return new Promise((t,o)=>{let a=new Worker(new URL("worker-FZNPBWGA.js",import.meta.url),{type:"module"});a.postMessage({records:r,batchId:e}),a.onmessage=({data:i})=>{i.status==="success"?t():o(new Error(`Batch ${i.batchId} failed: ${i.error}`))},a.onerror=i=>o(i)})})}getTotalRecords(){return s(this,null,function*(){let r={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},e=yield fetch(`${n.APIURL}/quanlydrive/count`,r);return e.ok?(yield e.json()).count:(this.handleError(e.status),0)})}syncRecords(){return s(this,null,function*(){try{this.status.next("Starting...");let r=1e4,e=yield this.getTotalRecords();this.totalRecords.set(e);let t=1,o=0;for(;o<e;){this.status.next(`Fetching batch ${t}...`);let a=yield this.SearchQuanlydriveBy({page:t,pageSize:r});if(a.data.length===0)break;this.status.next(`Saving batch ${t} to IndexedDB...`),yield this.saveToIndexedDB(a.data,t),o+=a.data.length,this.progress.set(o/e*100),console.log(this.progress()),t++}this.status.next("Completed!")}catch(r){throw this.status.next(`Error: ${r.message}`),r}})}SearchQuanlydriveBy(r){return s(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(r)},t=yield fetch(`${n.APIURL}/quanlydrive/search`,e);return t.ok||this.handleError(t.status),yield t.json()}catch(e){return this._ErrorLogService.logError("Failed to getQuanlydriveBy",e),console.error(e)}})}CreateQuanlydrive(r){return s(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${n.APIURL}/quanlydrive`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let o=yield t.json();t.ok||this.handleError(t.status),this.getAllQuanlydrive(),this.quanlydriveId.set(o.id)}catch(e){return this._ErrorLogService.logError("Failed to CreateQuanlydrive",e),console.error(e)}})}getAllQuanlydrive(r,e){return s(this,null,function*(){e&&this._StorageService.removeItem("quanlydrives_updatedAt");let o=yield(yield this.initDB()).getAll("quanlydrives"),a=this._StorageService.getItem("quanlydrives_updatedAt")||"0";if(o.length>0&&Date.now()-new Date(a).getTime()<5*60*1e3)return this.ListQuanlydrive.set(o),o;try{let i={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},d=yield fetch(`${n.APIURL}/last-updated?table=driveItem`,i);if(!d.ok)return this.handleError(d.status),o;let{updatedAt:l}=yield d.json();if(l<=a)return this.ListQuanlydrive.set(o),o;console.log(l,a);let c=yield fetch(`${n.APIURL}/quanlydrive?driveId=${r}`,i);if(!c.ok)return this.handleError(c.status),o;let u=yield c.json();return yield this.saveQuanlydrives(u),this._StorageService.setItem("quanlydrives_updatedAt",l.toString()),this.ListQuanlydrive.set(u),u}catch(i){return this._ErrorLogService.logError("Failed to create getAllQuanlydrive",i),console.error(i),o}})}getAllDrivelocal(r,e){return s(this,null,function*(){e&&this._StorageService.removeItem("quanlydrives_updatedAt");let o=yield(yield this.initDB()).getAll("quanlydrives"),a=this._StorageService.getItem("quanlydrives_updatedAt")||"0";if(o.length>0&&Date.now()-new Date(a).getTime()<5*60*1e3)return this.ListQuanlydrive.set(o),o;try{let i={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},d=yield fetch(`${n.APIURL}/last-updated?table=driveItem`,i);if(!d.ok)return this.handleError(d.status),o;let{updatedAt:l}=yield d.json();if(l<=a)return this.ListQuanlydrive.set(o),o;console.log(l,a);let c=yield fetch(`${n.APIURL}/quanlydrive`,i);if(!c.ok)return this.handleError(c.status),o;let u=yield c.json();return yield this.saveQuanlydrives(u),this._StorageService.setItem("quanlydrives_updatedAt",l.toString()),this.ListQuanlydrive.set(u),u}catch(i){return this._ErrorLogService.logError("Failed to create getAllQuanlydrive",i),console.error(i),o}})}listenQuanlydriveUpdates(){this.socket.on("quanlydrive-updated",()=>s(this,null,function*(){console.log("\u{1F504} D\u1EEF li\u1EC7u s\u1EA3n ph\u1EA9m thay \u0111\u1ED5i, c\u1EADp nh\u1EADt l\u1EA1i cache..."),this._StorageService.removeItem("quanlydrives_updatedAt"),yield this.getAllQuanlydrive()}))}initDB(){return s(this,null,function*(){return yield f("QuanlydriveDB",1,{upgrade(r){r.createObjectStore("quanlydrives",{keyPath:"id"})}})})}saveQuanlydrives(r){return s(this,null,function*(){let t=(yield this.initDB()).transaction("quanlydrives","readwrite"),o=t.objectStore("quanlydrives");yield o.clear(),r.forEach(a=>o.put(a)),yield t.done})}getQuanlydriveBy(r){return s(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(r)},t=yield fetch(`${n.APIURL}/quanlydrive/findby`,e);t.ok||this.handleError(t.status);let o=yield t.json();this.DetailQuanlydrive.set(o)}catch(e){return this._ErrorLogService.logError("Failed to getQuanlydriveBy",e),console.error(e)}})}updateQuanlydrive(r){return s(this,null,function*(){try{let e={method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${n.APIURL}/quanlydrive/${r.id}`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let o=yield t.json();t.ok||this.handleError(t.status),this.getAllQuanlydrive(),this.getQuanlydriveBy({id:o.id})}catch(e){return this._ErrorLogService.logError("Failed to updateQuanlydrive",e),console.error(e)}})}DeleteUserDrive(r){return s(this,null,function*(){try{let e={method:"DELETE",headers:{"Content-Type":"application/json"}},t=yield fetch(`${n.APIURL}/quanlydrive/users/${r.userIdDrive}/${r.googleId}`,e);return t.ok||this.handleError(t.status),t.json()}catch(e){return this._ErrorLogService.logError("Failed to DeleteQuanlydrive",e),console.error(e)}})}DeleteQuanlydrive(r){return s(this,null,function*(){try{let e={method:"DELETE",headers:{"Content-Type":"application/json"}},t=yield fetch(`${n.APIURL}/quanlydrive/${r.id}`,e);t.ok||this.handleError(t.status),this.getAllQuanlydrive()}catch(e){return this._ErrorLogService.logError("Failed to DeleteQuanlydrive",e),console.error(e)}})}QuanlydriveQueryfolder(r){return s(this,null,function*(){try{let e={method:"GET",headers:{"Content-Type":"application/json"}},t=yield fetch(`${n.APIURL}/quanlydrive/queryfolder?query=${r.googleId}`,e);t.ok||this.handleError(t.status),this.getAllQuanlydrive()}catch(e){return this._ErrorLogService.logError("Failed to DeleteQuanlydrive",e),console.error(e)}})}ListUsersFolder(r){return s(this,null,function*(){try{let e={method:"GET",headers:{"Content-Type":"application/json"}},t=yield fetch(`${n.APIURL}/quanlydrive/listUsersFolder?query=${r.googleId}`,e);t.ok||this.handleError(t.status),this.getAllQuanlydrive()}catch(e){return this._ErrorLogService.logError("Failed to DeleteQuanlydrive",e),console.error(e)}})}handleError(r){let e="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(r){case 401:e="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:e="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp";break;case 500:e="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break}let t=JSON.stringify({code:r,title:e});this.router.navigate(["/errorserver"],{queryParams:{data:t}})}static \u0275fac=function(e){return new(e||v)(y(w),y(m),y(E))};static \u0275prov=g({token:v,factory:v.\u0275fac,providedIn:"root"})};export{I as a};
