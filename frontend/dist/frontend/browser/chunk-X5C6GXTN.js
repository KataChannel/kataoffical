import{b as be}from"./chunk-SSBELGME.js";import{a as B}from"./chunk-BFIAAR4D.js";import{a as Le,b as qe}from"./chunk-LTIMMLFX.js";import{a as le,b as me,c as de,d as ce}from"./chunk-SLRDYDMI.js";import{a as F}from"./chunk-N7PBUGTM.js";import{a as Ge,b as ze,c as Ve}from"./chunk-TDAACTQD.js";import{h as ye}from"./chunk-INJUMOX2.js";import{a as re}from"./chunk-GD7IEZTW.js";import{a as Te,b as Ie,c as De,k as Fe}from"./chunk-QIIVLJEC.js";import{a as Be,b as ke}from"./chunk-IKSNCL6N.js";import{c as Re,d as Oe,e as We,g as He,h as Ne,j as je,k as Qe,m as Ke,n as Xe,p as Je,r as Ye}from"./chunk-B52A5VRT.js";import{a as we,b as Ae}from"./chunk-6S4AGD7B.js";import{A as Me,b as ue,g as pe,h as ge,i as _e,j as he,k as Pe,n as fe,o as xe,q as Ee,t as ve,w as Ce,x as Se,z as Ue}from"./chunk-KWM4OIFF.js";import{a as ae,b as oe}from"./chunk-4KMAECDD.js";import{a as ie,c as se,e as ne}from"./chunk-5RXGINDA.js";import{_ as ee,ka as te}from"./chunk-RO6MDUJX.js";import{l as J,m as Y,s as Z,w as $}from"./chunk-RGQ7KTVF.js";import{Cc as D,Db as H,Dc as o,Ec as v,Fc as b,Gc as j,Ic as U,Jc as M,Kb as h,Kc as w,Mc as Q,Na as W,Ra as d,Sc as G,Ub as c,Uc as z,Wb as N,Xb as q,Yc as K,ec as n,fc as a,gc as A,hc as C,ic as S,ja as I,kc as T,kd as u,md as X,oa as O,pa as E,pc as P,rb as m,rc as g,ya as f,za as x}from"./chunk-OL5DVADB.js";import{a as R,j as _}from"./chunk-6DYNGEAS.js";var k=class s{graphqlService=E(B);storageService=E(F);_allUserPermissions=d([]);_selectedUserPermissions=d(new Set);_searchTerm=d("");_userFilter=d("all");_permissionFilter=d("all");_grantedFilter=d("all");_expiredFilter=d("all");_currentPage=d(1);_pageSize=d(50);_isLoading=d(!1);_currentUserPermission=d(null);allUserPermissions=u(()=>this._allUserPermissions());selectedUserPermissions=u(()=>this._selectedUserPermissions());searchTerm=u(()=>this._searchTerm());userFilter=u(()=>this._userFilter());permissionFilter=u(()=>this._permissionFilter());grantedFilter=u(()=>this._grantedFilter());expiredFilter=u(()=>this._expiredFilter());currentPage=u(()=>this._currentPage());pageSize=u(()=>this._pageSize());isLoading=u(()=>this._isLoading());currentUserPermission=u(()=>this._currentUserPermission());filteredUserPermissions=u(()=>{let e=this._allUserPermissions(),t=this._searchTerm().toLowerCase(),i=this._userFilter(),r=this._permissionFilter(),l=this._grantedFilter(),y=this._expiredFilter();return t&&(e=e.filter(p=>p.user?.name?.toLowerCase().includes(t)||p.user?.email?.toLowerCase().includes(t)||p.permission?.name?.toLowerCase().includes(t)||p.permission?.description?.toLowerCase().includes(t)||p.reason?.toLowerCase().includes(t))),i!=="all"&&(e=e.filter(p=>p.userId===i)),r!=="all"&&(e=e.filter(p=>p.permissionId===r)),l==="granted"?e=e.filter(p=>p.isGranted):l==="denied"&&(e=e.filter(p=>!p.isGranted)),y==="active"?e=e.filter(p=>!p.expiresAt||p.expiresAt>new Date):y==="expired"&&(e=e.filter(p=>p.expiresAt&&p.expiresAt<=new Date)),e.sort((p,V)=>p.isGranted!==V.isGranted?p.isGranted?-1:1:new Date(V.createdAt).getTime()-new Date(p.createdAt).getTime())});paginatedUserPermissions=u(()=>{let e=this.filteredUserPermissions(),t=this._currentPage(),i=this._pageSize(),r=(t-1)*i;return e.slice(r,r+i)});totalPages=u(()=>{let e=this.filteredUserPermissions().length,t=this._pageSize();return Math.ceil(e/t)});totalCount=u(()=>this.filteredUserPermissions().length);loadUserPermissions(e){return _(this,null,function*(){this._isLoading.set(!0);try{let t=yield this.graphqlService.findMany("userPermission",R({include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}},orderBy:[{isGranted:"desc"},{createdAt:"desc"}]},e));return this._allUserPermissions.set(t),t}catch(t){throw console.error("Error loading user permissions:",t),t}finally{this._isLoading.set(!1)}})}getUserPermissionById(e){return _(this,null,function*(){try{let t=yield this.graphqlService.findUnique("userPermission",{id:e},{include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}});return this._currentUserPermission.set(t),t}catch(t){return console.error("Error getting user permission by id:",t),null}})}getUserPermissions(e){return _(this,null,function*(){try{return yield this.graphqlService.findMany("userPermission",{where:{userId:e},include:{permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}},orderBy:[{isGranted:"desc"},{permission:{name:"asc"}}]})}catch(t){return console.error("Error getting user permissions:",t),[]}})}assignPermissionToUser(e){return _(this,null,function*(){this._isLoading.set(!0);try{let t=yield this.graphqlService.createOne("userPermission",{data:{userId:e.userId,permissionId:e.permissionId,isGranted:e.isGranted,grantedBy:e.grantedBy,reason:e.reason,expiresAt:e.expiresAt},include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}}),i=this._allUserPermissions();return this._allUserPermissions.set([t,...i]),t}catch(t){throw console.error("Error assigning permission to user:",t),t}finally{this._isLoading.set(!1)}})}updateUserPermission(e,t){return _(this,null,function*(){this._isLoading.set(!0);try{let i=yield this.graphqlService.updateOne("userPermission",{id:e},t,{include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}}),r=this._allUserPermissions(),l=r.findIndex(y=>y.id===e);if(l!==-1){let y=[...r];y[l]=i,this._allUserPermissions.set(y)}return this._currentUserPermission()?.id===e&&this._currentUserPermission.set(i),i}catch(i){throw console.error("Error updating user permission:",i),i}finally{this._isLoading.set(!1)}})}deleteUserPermission(e){return _(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("userPermission",{id:e});let t=this._allUserPermissions();this._allUserPermissions.set(t.filter(r=>r.id!==e)),this._currentUserPermission()?.id===e&&this._currentUserPermission.set(null);let i=this._selectedUserPermissions();return i.has(e)&&(i.delete(e),this._selectedUserPermissions.set(new Set(i))),!0}catch(t){return console.error("Error deleting user permission:",t),!1}finally{this._isLoading.set(!1)}})}deleteUserPermissions(e){return _(this,null,function*(){this._isLoading.set(!0);try{let t=e.map(r=>this.graphqlService.deleteOne("userPermission",{id:r}));yield Promise.all(t);let i=this._allUserPermissions();return this._allUserPermissions.set(i.filter(r=>!e.includes(r.id))),this._selectedUserPermissions.set(new Set),!0}catch(t){return console.error("Error deleting user permissions:",t),!1}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setUserFilter(e){this._userFilter.set(e),this._currentPage.set(1)}setPermissionFilter(e){this._permissionFilter.set(e),this._currentPage.set(1)}setGrantedFilter(e){this._grantedFilter.set(e),this._currentPage.set(1)}setExpiredFilter(e){this._expiredFilter.set(e),this._currentPage.set(1)}setCurrentPage(e){this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}clearFilters(){this._searchTerm.set(""),this._userFilter.set("all"),this._permissionFilter.set("all"),this._grantedFilter.set("all"),this._expiredFilter.set("all"),this._currentPage.set(1)}toggleUserPermissionSelection(e){let t=new Set(this._selectedUserPermissions());t.has(e)?t.delete(e):t.add(e),this._selectedUserPermissions.set(t)}selectAllCurrentPage(){let e=new Set(this._selectedUserPermissions());this.paginatedUserPermissions().forEach(t=>{e.add(t.id)}),this._selectedUserPermissions.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedUserPermissions());this.paginatedUserPermissions().forEach(t=>{e.delete(t.id)}),this._selectedUserPermissions.set(e)}clearSelection(){this._selectedUserPermissions.set(new Set)}isSelected(e){return this._selectedUserPermissions().has(e)}get selectedCount(){return this._selectedUserPermissions().size}get selectedIds(){return Array.from(this._selectedUserPermissions())}findUserPermissionById(e){return this._allUserPermissions().find(t=>t.id===e)}getUserPermissionsByUser(e){return this._allUserPermissions().filter(t=>t.userId===e)}getUserPermissionsByPermission(e){return this._allUserPermissions().filter(t=>t.permissionId===e)}getActiveUserPermissions(){return this._allUserPermissions().filter(e=>!e.expiresAt||e.expiresAt>new Date)}getExpiredUserPermissions(){return this._allUserPermissions().filter(e=>e.expiresAt&&e.expiresAt<=new Date)}getGrantedUserPermissions(){return this._allUserPermissions().filter(e=>e.isGranted)}getDeniedUserPermissions(){return this._allUserPermissions().filter(e=>!e.isGranted)}clearCache(){this._allUserPermissions.set([]),this._searchTerm.set(""),this._userFilter.set("all"),this._permissionFilter.set("all"),this._grantedFilter.set("all"),this._expiredFilter.set("all"),this._currentPage.set(1),this.clearSelection(),this._currentUserPermission.set(null)}refreshData(){return this.loadUserPermissions()}static \u0275fac=function(t){return new(t||s)};static \u0275prov=I({token:s,factory:s.\u0275fac,providedIn:"root"})};var L=class s{constructor(e){this.storageService=e;this.searchResults()}_allPermissions=d([]);_filteredPermissions=d([]);_searchTerm=d("");_currentPage=d(1);_pageSize=d(50);_isLoading=d(!1);_selectedPermissions=d(new Set);allPermissions=this._allPermissions.asReadonly();filteredPermissions=this._filteredPermissions.asReadonly();searchTerm=this._searchTerm.asReadonly();currentPage=this._currentPage.asReadonly();pageSize=this._pageSize.asReadonly();isLoading=this._isLoading.asReadonly();selectedPermissions=this._selectedPermissions.asReadonly();totalItems=u(()=>this._filteredPermissions().length);totalPages=u(()=>Math.ceil(this.totalItems()/this._pageSize()));paginatedPermissions=u(()=>{let e=(this._currentPage()-1)*this._pageSize(),t=e+this._pageSize();return this._filteredPermissions().slice(e,t)});searchResults=u(()=>{let e=this._searchTerm().toLowerCase();if(!e)return this._filteredPermissions.set(this._allPermissions()),this._allPermissions();let t=this._allPermissions().filter(i=>i.name.toLowerCase().includes(e)||i.code.toLowerCase().includes(e)||i.description?.toLowerCase().includes(e));return this._filteredPermissions.set(t),t});graphqlService=E(B);loadAllPermissions(e=!1){return _(this,null,function*(){if(!e&&this._allPermissions().length>0)return this._allPermissions();this._isLoading.set(!0);try{let t={orderBy:{createdAt:"desc"},include:{roles:{select:{id:!0,name:!0}}}},i=yield this.graphqlService.findMany("permission",t);return this._allPermissions.set(i),this._filteredPermissions.set(i),this._currentPage.set(1),i}catch(t){throw console.error("Error loading permissions:",t),t}finally{this._isLoading.set(!1)}})}createPermission(e){return _(this,null,function*(){this._isLoading.set(!0);try{let t=yield this.graphqlService.createOne("permission",{data:{name:e.name,code:e.code,description:e.description,isActive:e.isActive??!0},include:{roles:{select:{id:!0,name:!0}}}}),i=this._allPermissions();return this._allPermissions.set([t,...i]),t}catch(t){throw console.error("Error creating permission:",t),t}finally{this._isLoading.set(!1)}})}updatePermission(e,t){return _(this,null,function*(){this._isLoading.set(!0);try{let i=yield this.graphqlService.updateOne("permission",{id:e},t,{include:{roles:{select:{id:!0,name:!0}}}}),r=this._allPermissions(),l=r.findIndex(y=>y.id===e);if(l!==-1){let y=[...r];y[l]=i,this._allPermissions.set(y)}return i}catch(i){throw console.error("Error updating permission:",i),i}finally{this._isLoading.set(!1)}})}deletePermission(e){return _(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("permission",{id:e});let i=this._allPermissions().filter(l=>l.id!==e);this._allPermissions.set(i);let r=new Set(this._selectedPermissions());r.delete(e),this._selectedPermissions.set(r)}catch(t){throw console.error("Error deleting permission:",t),t}finally{this._isLoading.set(!1)}})}batchDeletePermissions(e){return _(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.batchDelete("permission",e);let i=this._allPermissions().filter(r=>!e.includes(r.id));this._allPermissions.set(i),this._selectedPermissions.set(new Set)}catch(t){throw console.error("Error batch deleting permissions:",t),t}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setPage(e){e>=1&&e<=this.totalPages()&&this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}nextPage(){this._currentPage()<this.totalPages()&&this._currentPage.set(this._currentPage()+1)}previousPage(){this._currentPage()>1&&this._currentPage.set(this._currentPage()-1)}togglePermissionSelection(e){let t=new Set(this._selectedPermissions());t.has(e)?t.delete(e):t.add(e),this._selectedPermissions.set(t)}selectAllCurrentPage(){let e=new Set(this._selectedPermissions());this.paginatedPermissions().forEach(t=>{e.add(t.id)}),this._selectedPermissions.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedPermissions());this.paginatedPermissions().forEach(t=>{e.delete(t.id)}),this._selectedPermissions.set(e)}clearSelection(){this._selectedPermissions.set(new Set)}isSelected(e){return this._selectedPermissions().has(e)}get selectedCount(){return this._selectedPermissions().size}get selectedIds(){return Array.from(this._selectedPermissions())}findPermissionById(e){return this._allPermissions().find(t=>t.id===e)}getPermissionsByCode(e){return this._allPermissions().filter(t=>e.includes(t.code))}getActivePermissions(){return this._allPermissions().filter(e=>e.isActive)}clearCache(){this._allPermissions.set([]),this._filteredPermissions.set([]),this._searchTerm.set(""),this._currentPage.set(1),this.clearSelection()}refreshData(){return this.loadAllPermissions(!0)}static \u0275fac=function(t){return new(t||s)(O(F))};static \u0275prov=I({token:s,factory:s.\u0275fac,providedIn:"root"})};var et=()=>[5,10,25,50];function tt(s,e){s&1&&(n(0,"div",26),A(1,"mat-spinner",27),n(2,"p",28),o(3,"\u0110ang t\u1EA3i d\u1EEF li\u1EC7u..."),a()())}function it(s,e){if(s&1){let t=T();n(0,"div",26)(1,"mat-icon",29),o(2,"error"),a(),n(3,"p",30),o(4),a(),n(5,"button",31),P("click",function(){f(t);let r=g();return x(r.loadUserPermissions())}),o(6," Th\u1EED l\u1EA1i "),a()()}if(s&2){let t=g();m(4),v(t.error())}}function st(s,e){s&1&&(n(0,"th",48),o(1,"Quy\u1EC1n"),a())}function nt(s,e){if(s&1&&(n(0,"td",49)(1,"div",50)(2,"span",51),o(3),a(),n(4,"span",52),o(5),a()()()),s&2){let t=e.$implicit;m(3),v(t.permission==null?null:t.permission.name),m(2),v(t.permission==null?null:t.permission.description)}}function rt(s,e){s&1&&(n(0,"th",53),o(1,"Lo\u1EA1i"),a())}function at(s,e){if(s&1&&(n(0,"td",49)(1,"span"),o(2),a()()),s&2){let t=e.$implicit;m(),q(t.isGranted?"bg-green-100 text-green-800 px-2 py-1 rounded text-xs":"bg-red-100 text-red-800 px-2 py-1 rounded text-xs"),m(),b(" ",t.isGranted?"\u0110\u01B0\u1EE3c c\u1EA5p":"B\u1ECB t\u1EEB ch\u1ED1i"," ")}}function ot(s,e){s&1&&(n(0,"th",53),o(1,"Ng\u01B0\u1EDDi c\u1EA5p"),a())}function lt(s,e){if(s&1&&(n(0,"td",49),o(1),a()),s&2){let t=e.$implicit;m(),b(" ",(t.grantedByUser==null?null:t.grantedByUser.name)||(t.grantedByUser==null?null:t.grantedByUser.email)||"N/A"," ")}}function mt(s,e){s&1&&(n(0,"th",48),o(1,"Ng\xE0y c\u1EA5p"),a())}function dt(s,e){if(s&1&&(n(0,"td",49),o(1),G(2,"date"),a()),s&2){let t=e.$implicit;m(),b(" ",z(2,1,t.grantedAt,"dd/MM/yyyy HH:mm")," ")}}function ct(s,e){s&1&&(n(0,"th",53),o(1,"H\u1EBFt h\u1EA1n"),a())}function ut(s,e){s&1&&(n(0,"span",56),o(1,"\u0110\xE3 h\u1EBFt h\u1EA1n"),a())}function pt(s,e){if(s&1&&(n(0,"div")(1,"span"),o(2),G(3,"date"),a(),h(4,ut,2,0,"span",55),a()),s&2){let t=g().$implicit,i=g(2);m(),q(i.isExpired(t.expiresAt)?"text-red-600 font-medium":"text-gray-700"),m(),b(" ",z(3,4,t.expiresAt,"dd/MM/yyyy HH:mm")," "),m(2),c("ngIf",i.isExpired(t.expiresAt))}}function gt(s,e){s&1&&(n(0,"span",57),o(1,"V\u0129nh vi\u1EC5n"),a())}function _t(s,e){if(s&1&&(n(0,"td",49),h(1,pt,5,7,"div",54)(2,gt,2,0,"ng-template",null,0,K),a()),s&2){let t=e.$implicit,i=D(3);m(),c("ngIf",t.expiresAt)("ngIfElse",i)}}function ht(s,e){s&1&&(n(0,"th",53),o(1,"L\xFD do"),a())}function Pt(s,e){if(s&1&&(n(0,"td",58)(1,"span",59),o(2),a()()),s&2){let t=e.$implicit;m(),c("title",t.reason),m(),b(" ",t.reason||"Kh\xF4ng c\xF3 ghi ch\xFA"," ")}}function ft(s,e){s&1&&(n(0,"th",53),o(1,"Thao t\xE1c"),a())}function xt(s,e){s&1&&(n(0,"mat-icon"),o(1,"more_vert"),a())}function yt(s,e){s&1&&A(0,"mat-spinner",65)}function Et(s,e){if(s&1){let t=T();n(0,"td",49)(1,"button",60),h(2,xt,2,0,"mat-icon",61)(3,yt,1,0,"mat-spinner",62),a(),n(4,"mat-menu",null,1)(6,"button",63),P("click",function(){let r=f(t).$implicit,l=g(2);return x(l.editPermission(r))}),n(7,"mat-icon"),o(8,"edit"),a(),o(9," Ch\u1EC9nh s\u1EEDa "),a(),n(10,"button",64),P("click",function(){let r=f(t).$implicit,l=g(2);return x(l.revokePermission(r))}),n(11,"mat-icon"),o(12,"delete"),a(),o(13," Thu h\u1ED3i quy\u1EC1n "),a()()()}if(s&2){let t=e.$implicit,i=D(5),r=g(2);m(),c("matMenuTriggerFor",i)("disabled",r.processingPermission()===t.id),m(),c("ngIf",r.processingPermission()!==t.id),m(),c("ngIf",r.processingPermission()===t.id)}}function vt(s,e){s&1&&A(0,"tr",66)}function Ct(s,e){if(s&1&&A(0,"tr",67),s&2){let t=e.$implicit,i=g(2);N("opacity-50",i.isExpired(t.expiresAt))}}function St(s,e){if(s&1){let t=T();n(0,"div",26)(1,"mat-icon",68),o(2,"assignment_ind"),a(),n(3,"p",69),o(4,"Kh\xF4ng c\xF3 quy\u1EC1n \u0111\u1EB7c bi\u1EC7t n\xE0o \u0111\u01B0\u1EE3c c\u1EA5p"),a(),n(5,"button",31),P("click",function(){f(t);let r=g(2);return x(r.openAssignDialog())}),o(6," Th\xEAm quy\u1EC1n \u0111\u1EA7u ti\xEAn "),a()()}}function Ut(s,e){if(s&1){let t=T();n(0,"mat-paginator",70),P("page",function(r){f(t);let l=g(2);return x(l.onPageChange(r))}),a()}if(s&2){let t=g(2);c("length",t.totalCount())("pageSize",t.pageSize())("pageSizeOptions",Q(3,et))}}function Mt(s,e){if(s&1&&(n(0,"div",32)(1,"table",33),C(2,34),h(3,st,2,0,"th",35)(4,nt,6,2,"td",36),S(),C(5,37),h(6,rt,2,0,"th",38)(7,at,3,3,"td",36),S(),C(8,39),h(9,ot,2,0,"th",38)(10,lt,2,1,"td",36),S(),C(11,40),h(12,mt,2,0,"th",35)(13,dt,3,4,"td",36),S(),C(14,41),h(15,ct,2,0,"th",38)(16,_t,4,2,"td",36),S(),C(17,42),h(18,ht,2,0,"th",38)(19,Pt,3,2,"td",43),S(),C(20,44),h(21,ft,2,0,"th",38)(22,Et,14,4,"td",36),S(),h(23,vt,1,0,"tr",45)(24,Ct,1,2,"tr",46),a(),h(25,St,7,0,"div",22)(26,Ut,1,4,"mat-paginator",47),a()),s&2){let t=g();m(),c("dataSource",t.displayedPermissions()),m(22),c("matHeaderRowDef",t.displayedColumns),m(),c("matRowDefColumns",t.displayedColumns),m(),c("ngIf",t.displayedPermissions().length===0),m(),c("ngIf",t.displayedPermissions().length>0)}}function wt(s,e){if(s&1&&(n(0,"div",71)(1,"h3",72),o(2,"Th\u1ED1ng k\xEA"),a(),n(3,"div",73)(4,"div")(5,"span",74),o(6,"T\u1ED5ng quy\u1EC1n:"),a(),n(7,"span",75),o(8),a()(),n(9,"div")(10,"span",74),o(11,"\u0110\u01B0\u1EE3c c\u1EA5p:"),a(),n(12,"span",76),o(13),a()(),n(14,"div")(15,"span",74),o(16,"B\u1ECB t\u1EEB ch\u1ED1i:"),a(),n(17,"span",77),o(18),a()(),n(19,"div")(20,"span",74),o(21,"\u0110\xE3 h\u1EBFt h\u1EA1n:"),a(),n(22,"span",78),o(23),a()()()()),s&2){let t=g();m(8),v(t.statistics().total),m(5),v(t.statistics().granted),m(5),v(t.statistics().denied),m(5),v(t.statistics().expired)}}function At(s,e){if(s&1&&(n(0,"mat-option",90),o(1),a()),s&2){let t=e.$implicit;c("value",t.id),m(),j(" ",t.name," - ",t.description," ")}}function bt(s,e){s&1&&A(0,"mat-spinner",98)}function Tt(s,e){if(s&1){let t=T();n(0,"div",79),P("click",function(){f(t);let r=g();return x(r.closeAssignDialog())}),n(1,"div",80),P("click",function(r){return f(t),x(r.stopPropagation())}),n(2,"div",81)(3,"h3",82),o(4),a(),n(5,"button",83),P("click",function(){f(t);let r=g();return x(r.closeAssignDialog())}),n(6,"mat-icon"),o(7,"close"),a()()(),n(8,"form",84),P("ngSubmit",function(){f(t);let r=g();return x(r.handleAssignPermission())}),n(9,"div",85)(10,"mat-form-field",86)(11,"mat-label"),o(12,"Ch\u1ECDn quy\u1EC1n"),a(),n(13,"mat-select",87),w("ngModelChange",function(r){f(t);let l=g();return M(l.assignForm.permissionId,r)||(l.assignForm.permissionId=r),x(r)}),n(14,"mat-option",15),o(15,"-- Ch\u1ECDn quy\u1EC1n --"),a(),h(16,At,2,3,"mat-option",88),a()(),n(17,"mat-form-field",86)(18,"mat-label"),o(19,"Lo\u1EA1i quy\u1EC1n"),a(),n(20,"mat-select",89),w("ngModelChange",function(r){f(t);let l=g();return M(l.assignForm.isGranted,r)||(l.assignForm.isGranted=r),x(r)}),n(21,"mat-option",90),o(22,"C\u1EA5p quy\u1EC1n"),a(),n(23,"mat-option",90),o(24,"T\u1EEB ch\u1ED1i quy\u1EC1n"),a()()(),n(25,"mat-form-field",86)(26,"mat-label"),o(27,"Ng\xE0y h\u1EBFt h\u1EA1n (t\xF9y ch\u1ECDn)"),a(),n(28,"input",91),w("ngModelChange",function(r){f(t);let l=g();return M(l.assignForm.expiresAt,r)||(l.assignForm.expiresAt=r),x(r)}),a(),A(29,"mat-datepicker-toggle",92)(30,"mat-datepicker",null,2),a(),n(32,"mat-form-field",86)(33,"mat-label"),o(34,"L\xFD do"),a(),n(35,"textarea",93),w("ngModelChange",function(r){f(t);let l=g();return M(l.assignForm.reason,r)||(l.assignForm.reason=r),x(r)}),a()()(),n(36,"div",94)(37,"button",95),P("click",function(){f(t);let r=g();return x(r.closeAssignDialog())}),o(38," H\u1EE7y "),a(),n(39,"button",96),h(40,bt,1,0,"mat-spinner",97),o(41),a()()()()()}if(s&2){let t=D(31),i=g();m(4),v(i.editingPermission()?"Ch\u1EC9nh s\u1EEDa quy\u1EC1n":"Th\xEAm quy\u1EC1n m\u1EDBi"),m(9),U("ngModel",i.assignForm.permissionId),m(3),c("ngForOf",i.availablePermissions()),m(4),U("ngModel",i.assignForm.isGranted),m(),c("value",!0),m(2),c("value",!1),m(5),c("matDatepicker",t),U("ngModel",i.assignForm.expiresAt),m(),c("for",t),m(6),U("ngModel",i.assignForm.reason),m(4),c("disabled",!i.assignForm.permissionId||i.isAssigning()),m(),c("ngIf",i.isAssigning()),m(),b(" ",i.editingPermission()?"C\u1EADp nh\u1EADt":"Th\xEAm quy\u1EC1n"," ")}}var $e=class s{userPermissionService=E(k);permissionService=E(L);snackBar=E(re);userId=W.required();isLoading=d(!1);error=d(null);processingPermission=d(null);showAssignDialog=d(!1);isAssigning=d(!1);editingPermission=d(null);userPermissions=d([]);availablePermissions=d([]);searchTerm=d("");selectedType=d("");selectedStatus=d("");pageSize=d(10);currentPage=d(0);totalCount=d(0);assignForm={permissionId:"",isGranted:!0,expiresAt:null,reason:""};displayedColumns=["permission","type","grantedBy","grantedAt","expiresAt","reason","actions"];displayedPermissions=u(()=>{let e=this.userPermissions();if(this.searchTerm()){let r=this.searchTerm().toLowerCase();e=e.filter(l=>l.permission?.name?.toLowerCase().includes(r)||l.permission?.description?.toLowerCase().includes(r))}if(this.selectedType()){let r=this.selectedType()==="granted";e=e.filter(l=>l.isGranted===r)}if(this.selectedStatus()){let r=new Date;this.selectedStatus()==="expired"?e=e.filter(l=>l.expiresAt&&new Date(l.expiresAt)<r):this.selectedStatus()==="active"&&(e=e.filter(l=>!l.expiresAt||new Date(l.expiresAt)>=r))}let t=this.currentPage()*this.pageSize(),i=t+this.pageSize();return this.totalCount.set(e.length),e.slice(t,i)});statistics=u(()=>{let e=this.userPermissions(),t=new Date;return{total:e.length,granted:e.filter(i=>i.isGranted).length,denied:e.filter(i=>!i.isGranted).length,expired:e.filter(i=>i.expiresAt&&new Date(i.expiresAt)<t).length}});constructor(){X(()=>{this.userId()&&(this.loadUserPermissions(),this.loadAvailablePermissions())})}loadUserPermissions(){return _(this,null,function*(){if(this.userId())try{this.isLoading.set(!0),this.error.set(null);let e=yield this.userPermissionService.getUserPermissions(this.userId());this.userPermissions.set(e)}catch(e){console.error("Error loading user permissions:",e),this.error.set("Kh\xF4ng th\u1EC3 t\u1EA3i danh s\xE1ch quy\u1EC1n")}finally{this.isLoading.set(!1)}})}loadAvailablePermissions(){return _(this,null,function*(){try{let e=yield this.permissionService.loadAllPermissions();this.availablePermissions.set(e)}catch(e){console.error("Error loading available permissions:",e)}})}onSearchChange(){this.currentPage.set(0)}onPageChange(e){this.currentPage.set(e.pageIndex),this.pageSize.set(e.pageSize)}clearFilters(){this.searchTerm.set(""),this.selectedType.set(""),this.selectedStatus.set(""),this.currentPage.set(0)}isExpired(e){return e?new Date(e)<new Date:!1}openAssignDialog(){this.editingPermission.set(null),this.resetAssignForm(),this.showAssignDialog.set(!0)}closeAssignDialog(){this.showAssignDialog.set(!1),this.editingPermission.set(null),this.resetAssignForm()}editPermission(e){this.editingPermission.set(e),this.assignForm={permissionId:e.permissionId,isGranted:e.isGranted,expiresAt:e.expiresAt?new Date(e.expiresAt):null,reason:e.reason||""},this.showAssignDialog.set(!0)}handleAssignPermission(){return _(this,null,function*(){if(!(!this.userId()||!this.assignForm.permissionId))try{this.isAssigning.set(!0),this.editingPermission()?(yield this.userPermissionService.updateUserPermission(this.editingPermission().id,{isGranted:this.assignForm.isGranted,grantedBy:"current-user",expiresAt:this.assignForm.expiresAt||void 0,reason:this.assignForm.reason||void 0}),this.snackBar.open("C\u1EADp nh\u1EADt quy\u1EC1n th\xE0nh c\xF4ng","\u0110\xF3ng",{duration:3e3})):(yield this.userPermissionService.assignPermissionToUser({userId:this.userId(),permissionId:this.assignForm.permissionId,isGranted:this.assignForm.isGranted,expiresAt:this.assignForm.expiresAt||void 0,reason:this.assignForm.reason||void 0,grantedBy:"current-user"}),this.snackBar.open("Th\xEAm quy\u1EC1n th\xE0nh c\xF4ng","\u0110\xF3ng",{duration:3e3})),yield this.loadUserPermissions(),this.closeAssignDialog()}catch(e){console.error("Error assigning permission:",e),this.snackBar.open(e.message||"C\xF3 l\u1ED7i x\u1EA3y ra khi x\u1EED l\xFD quy\u1EC1n","\u0110\xF3ng",{duration:5e3})}finally{this.isAssigning.set(!1)}})}revokePermission(e){return _(this,null,function*(){if(confirm("B\u1EA1n c\xF3 ch\u1EAFc ch\u1EAFn mu\u1ED1n thu h\u1ED3i quy\u1EC1n n\xE0y kh\xF4ng?"))try{this.processingPermission.set(e.id),yield this.userPermissionService.deleteUserPermission(e.id),this.snackBar.open("Thu h\u1ED3i quy\u1EC1n th\xE0nh c\xF4ng","\u0110\xF3ng",{duration:3e3}),yield this.loadUserPermissions()}catch(t){console.error("Error revoking permission:",t),this.snackBar.open(t.message||"C\xF3 l\u1ED7i x\u1EA3y ra khi thu h\u1ED3i quy\u1EC1n","\u0110\xF3ng",{duration:5e3})}finally{this.processingPermission.set(null)}})}resetAssignForm(){this.assignForm={permissionId:"",isGranted:!0,expiresAt:null,reason:""}}static \u0275fac=function(t){return new(t||s)};static \u0275cmp=H({type:s,selectors:[["app-user-permission-management"]],inputs:{userId:[1,"userId"]},decls:49,vars:9,consts:[["noExpiry",""],["actionMenu","matMenu"],["picker",""],[1,"user-permission-management","p-4"],[1,"header","mb-4"],[1,"flex","justify-between","items-center"],[1,"text-xl","font-bold"],["mat-raised-button","","color","primary",3,"click","disabled"],[1,"text-gray-600","mt-2"],[1,"filters","mb-4","p-4","bg-gray-50","rounded"],[1,"grid","grid-cols-1","md:grid-cols-4","gap-4"],["appearance","outline"],["matInput","","placeholder","T\xEAn quy\u1EC1n...",3,"ngModelChange","input","ngModel"],["matSuffix",""],[3,"ngModelChange","selectionChange","ngModel"],["value",""],["value","granted"],["value","denied"],["value","active"],["value","expired"],[1,"flex","items-end"],["mat-stroked-button","",3,"click"],["class","text-center py-8",4,"ngIf"],["class","table-container",4,"ngIf"],["class","statistics mt-6 p-4 bg-blue-50 rounded",4,"ngIf"],["class","fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",3,"click",4,"ngIf"],[1,"text-center","py-8"],[1,"mx-auto"],[1,"mt-4","text-gray-600"],[1,"text-red-500","text-4xl"],[1,"mt-2","text-red-600"],["mat-raised-button","","color","primary",1,"mt-4",3,"click"],[1,"table-container"],["mat-table","","matSort","",1,"w-full",3,"dataSource"],["matColumnDef","permission"],["mat-header-cell","","mat-sort-header","","class","font-bold",4,"matHeaderCellDef"],["mat-cell","","class","py-3",4,"matCellDef"],["matColumnDef","type"],["mat-header-cell","","class","font-bold",4,"matHeaderCellDef"],["matColumnDef","grantedBy"],["matColumnDef","grantedAt"],["matColumnDef","expiresAt"],["matColumnDef","reason"],["mat-cell","","class","py-3 max-w-xs",4,"matCellDef"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",3,"opacity-50",4,"matRowDef","matRowDefColumns"],["showFirstLastButtons","",3,"length","pageSize","pageSizeOptions","page",4,"ngIf"],["mat-header-cell","","mat-sort-header","",1,"font-bold"],["mat-cell","",1,"py-3"],[1,"flex","flex-col"],[1,"font-medium"],[1,"text-sm","text-gray-500"],["mat-header-cell","",1,"font-bold"],[4,"ngIf","ngIfElse"],["class","block text-xs text-red-500",4,"ngIf"],[1,"block","text-xs","text-red-500"],[1,"text-green-600","text-sm"],["mat-cell","",1,"py-3","max-w-xs"],[1,"text-sm","text-gray-700","line-clamp-2",3,"title"],["mat-icon-button","",3,"matMenuTriggerFor","disabled"],[4,"ngIf"],["diameter","20",4,"ngIf"],["mat-menu-item","",3,"click"],["mat-menu-item","",1,"text-red-600",3,"click"],["diameter","20"],["mat-header-row",""],["mat-row",""],[1,"text-gray-400","text-4xl"],[1,"mt-2","text-gray-600"],["showFirstLastButtons","",3,"page","length","pageSize","pageSizeOptions"],[1,"statistics","mt-6","p-4","bg-blue-50","rounded"],[1,"font-semibold","mb-2"],[1,"grid","grid-cols-2","md:grid-cols-4","gap-4","text-sm"],[1,"text-gray-600"],[1,"font-semibold","ml-1"],[1,"font-semibold","ml-1","text-green-600"],[1,"font-semibold","ml-1","text-red-600"],[1,"font-semibold","ml-1","text-orange-600"],[1,"fixed","inset-0","bg-black","bg-opacity-50","flex","items-center","justify-center","z-50",3,"click"],[1,"bg-white","rounded-lg","p-6","max-w-md","w-full","mx-4",3,"click"],[1,"flex","justify-between","items-center","mb-4"],[1,"text-lg","font-semibold"],["mat-icon-button","",3,"click"],[3,"ngSubmit"],[1,"space-y-4"],["appearance","outline",1,"w-full"],["name","permissionId","required","",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["name","isGranted","required","",3,"ngModelChange","ngModel"],[3,"value"],["matInput","","name","expiresAt",3,"ngModelChange","matDatepicker","ngModel"],["matIconSuffix","",3,"for"],["matInput","","name","reason","rows","3","placeholder","Nh\u1EADp l\xFD do c\u1EA5p/t\u1EEB ch\u1ED1i quy\u1EC1n n\xE0y...",3,"ngModelChange","ngModel"],[1,"flex","justify-end","space-x-2","mt-6"],["type","button","mat-stroked-button","",3,"click"],["type","submit","mat-raised-button","","color","primary",3,"disabled"],["diameter","20","class","mr-2",4,"ngIf"],["diameter","20",1,"mr-2"]],template:function(t,i){t&1&&(n(0,"div",3)(1,"div",4)(2,"div",5)(3,"h2",6),o(4,"Qu\u1EA3n L\xFD Quy\u1EC1n \u0110\u1EB7c Bi\u1EC7t"),a(),n(5,"button",7),P("click",function(){return i.openAssignDialog()}),n(6,"mat-icon"),o(7,"add"),a(),o(8," Th\xEAm Quy\u1EC1n "),a()(),n(9,"p",8),o(10," Qu\u1EA3n l\xFD c\xE1c quy\u1EC1n \u0111\u1EB7c bi\u1EC7t cho user n\xE0y (s\u1EBD ghi \u0111\xE8 quy\u1EC1n t\u1EEB roles) "),a()(),n(11,"div",9)(12,"div",10)(13,"mat-form-field",11)(14,"mat-label"),o(15,"T\xECm ki\u1EBFm quy\u1EC1n"),a(),n(16,"input",12),w("ngModelChange",function(l){return M(i.searchTerm,l)||(i.searchTerm=l),l}),P("input",function(){return i.onSearchChange()}),a(),n(17,"mat-icon",13),o(18,"search"),a()(),n(19,"mat-form-field",11)(20,"mat-label"),o(21,"Lo\u1EA1i quy\u1EC1n"),a(),n(22,"mat-select",14),w("ngModelChange",function(l){return M(i.selectedType,l)||(i.selectedType=l),l}),P("selectionChange",function(){return i.loadUserPermissions()}),n(23,"mat-option",15),o(24,"T\u1EA5t c\u1EA3"),a(),n(25,"mat-option",16),o(26,"\u0110\u01B0\u1EE3c c\u1EA5p"),a(),n(27,"mat-option",17),o(28,"B\u1ECB t\u1EEB ch\u1ED1i"),a()()(),n(29,"mat-form-field",11)(30,"mat-label"),o(31,"Tr\u1EA1ng th\xE1i"),a(),n(32,"mat-select",14),w("ngModelChange",function(l){return M(i.selectedStatus,l)||(i.selectedStatus=l),l}),P("selectionChange",function(){return i.loadUserPermissions()}),n(33,"mat-option",15),o(34,"T\u1EA5t c\u1EA3"),a(),n(35,"mat-option",18),o(36,"Ho\u1EA1t \u0111\u1ED9ng"),a(),n(37,"mat-option",19),o(38,"\u0110\xE3 h\u1EBFt h\u1EA1n"),a()()(),n(39,"div",20)(40,"button",21),P("click",function(){return i.clearFilters()}),n(41,"mat-icon"),o(42,"clear"),a(),o(43," X\xF3a b\u1ED9 l\u1ECDc "),a()()()(),h(44,tt,4,0,"div",22)(45,it,7,1,"div",22)(46,Mt,27,5,"div",23)(47,wt,24,4,"div",24),a(),h(48,Tt,42,13,"div",25)),t&2&&(m(5),c("disabled",!i.userId()||i.isLoading()),m(11),U("ngModel",i.searchTerm),m(6),U("ngModel",i.selectedType),m(10),U("ngModel",i.selectedStatus),m(12),c("ngIf",i.isLoading()),m(),c("ngIf",i.error()),m(),c("ngIf",!i.isLoading()&&!i.error()),m(),c("ngIf",!i.isLoading()&&!i.error()),m(),c("ngIf",i.showAssignDialog()))},dependencies:[$,J,Y,Z,xe,Pe,ue,pe,ge,fe,he,_e,Se,Ce,Ee,ve,Me,Ue,ne,ie,se,oe,ae,Ye,Re,We,Qe,He,Oe,Ke,Ne,je,Xe,Je,qe,Le,Ve,Ge,ze,Ae,we,te,be,Fe,Te,Ie,De,ee,ce,me,le,de,ye,ke,Be],encapsulation:2})};export{$e as a};
