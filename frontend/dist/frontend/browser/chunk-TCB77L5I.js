import{a as he,b as ht}from"./chunk-GLRN4W5E.js";import{a as fe,b as ft}from"./chunk-J3IYQA4G.js";import{a as Q}from"./chunk-SCGPCYBL.js";import{a as rt,b as ot}from"./chunk-SSBELGME.js";import{a as lt}from"./chunk-BFIAAR4D.js";import"./chunk-XLFIXRGG.js";import"./chunk-LTIMMLFX.js";import{d as it,e as nt}from"./chunk-STTHC4C4.js";import"./chunk-ZW44ZSN2.js";import"./chunk-BQNHPUMH.js";import{a as Ge,b as qe,c as Qe,d as ze}from"./chunk-SLRDYDMI.js";import{a as Oe}from"./chunk-N7PBUGTM.js";import{a as ut,b as pt,d as _t,f as gt}from"./chunk-W4IWOATG.js";import{c as dt,e as ct,f as B}from"./chunk-SNPDHAIQ.js";import{b as We,c as Ne,d as je,e as $e}from"./chunk-ZECXV4P7.js";import{b as mt}from"./chunk-TPFOWWOO.js";import"./chunk-TDAACTQD.js";import{a as He,b as Ke,c as Xe,e as Je,f as Ye,g as Ze,h as z}from"./chunk-INJUMOX2.js";import"./chunk-H7UDLENL.js";import{a as re}from"./chunk-GD7IEZTW.js";import"./chunk-DP4FJZ2N.js";import"./chunk-QIIVLJEC.js";import{a as Be,c as Le}from"./chunk-RFYKARPR.js";import{a as st,b as at}from"./chunk-IKSNCL6N.js";import{a as W,b as N,c as j,d as ge,f as $,g as H}from"./chunk-LAM2JYAU.js";import"./chunk-B52A5VRT.js";import{a as tt,b as _e}from"./chunk-6S4AGD7B.js";import{A as pe,b as oe,g as se,j as ae,o as le,q as me,t as et,w as de,x as ce,z as ue}from"./chunk-KWM4OIFF.js";import"./chunk-KBSHTQVA.js";import{a as F,b as A}from"./chunk-4KMAECDD.js";import"./chunk-B5XVARHK.js";import"./chunk-KY47JUDC.js";import"./chunk-2PPFUFFT.js";import{a as I,c as ne,e as k}from"./chunk-5RXGINDA.js";import{ka as Ve}from"./chunk-RO6MDUJX.js";import"./chunk-HMVCX5BQ.js";import{m as q,w as T}from"./chunk-RGQ7KTVF.js";import{$b as E,Cc as te,Db as D,Dc as a,Ec as b,Fc as C,Gc as Ae,Ic as R,J as Ie,Jc as U,Kb as _,Kc as M,Na as J,Ra as g,Ub as p,Vb as Fe,Wb as ee,ac as Se,cc as S,d as be,dc as w,ec as o,fc as r,gc as G,hc as we,ic as De,ja as Z,kc as P,kd as L,md as ie,oa as ke,pa as y,pc as h,q as X,rb as m,rc as d,v as Te,ya as x,za as v}from"./chunk-OL5DVADB.js";import"./chunk-LWLSKGAV.js";import{a as O,b as K,j as f}from"./chunk-6DYNGEAS.js";var xe=class n{constructor(t){this.storageService=t}_allRoles=g([]);_searchTerm=g("");_currentPage=g(1);_pageSize=g(50);_isLoading=g(!1);_selectedRoles=g(new Set);_statusFilter=g("all");searchResults=L(()=>{let t=this._allRoles(),e=this._searchTerm().toLowerCase();return e&&(t=t.filter(i=>i.name.toLowerCase().includes(e))),t});allRoles=this._allRoles.asReadonly();filteredRoles=this.searchResults;searchTerm=this._searchTerm.asReadonly();currentPage=this._currentPage.asReadonly();pageSize=this._pageSize.asReadonly();isLoading=this._isLoading.asReadonly();selectedRoles=this._selectedRoles.asReadonly();statusFilter=this._statusFilter.asReadonly();totalItems=L(()=>this.searchResults().length);totalPages=L(()=>Math.ceil(this.totalItems()/this._pageSize()));paginatedRoles=L(()=>{let t=(this._currentPage()-1)*this._pageSize(),e=t+this._pageSize();return this.searchResults().slice(t,e)});graphqlService=y(lt);loadAllRoles(t=!1){return f(this,null,function*(){if(!t&&this._allRoles().length>0)return this._allRoles();this._isLoading.set(!0);try{let e={orderBy:{name:"asc"},include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}},i=yield this.graphqlService.findMany("role",e);return this._allRoles.set(i),this._currentPage.set(1),i}catch(e){throw console.error("Error loading roles:",e),e}finally{this._isLoading.set(!1)}})}createRole(t){return f(this,null,function*(){this._isLoading.set(!0);try{let e={name:t.name},i=yield this.graphqlService.createOne("role",{data:e,include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}});if(t.permissionIds&&t.permissionIds.length>0){yield this.assignPermissionsToRole(i.id,t.permissionIds);let l=yield this.getRoleById(i.id);if(l){let c=this._allRoles();return this._allRoles.set([l,...c.filter(u=>u.id!==i.id)]),l}}let s=this._allRoles();return this._allRoles.set([i,...s]),i}catch(e){throw console.error("Error creating role:",e),e}finally{this._isLoading.set(!1)}})}updateRole(t,e){return f(this,null,function*(){this._isLoading.set(!0);try{let i=yield this.graphqlService.updateOne("role",{id:t},e,{include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}}),s=this._allRoles(),l=s.findIndex(c=>c.id===t);if(l!==-1){let c=[...s];c[l]=i,this._allRoles.set(c)}return i}catch(i){throw console.error("Error updating role:",i),i}finally{this._isLoading.set(!1)}})}deleteRole(t){return f(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("role",{id:t});let i=this._allRoles().filter(l=>l.id!==t);this._allRoles.set(i);let s=new Set(this._selectedRoles());s.delete(t),this._selectedRoles.set(s)}catch(e){throw console.error("Error deleting role:",e),e}finally{this._isLoading.set(!1)}})}getRoleById(t){return f(this,null,function*(){try{return yield this.graphqlService.findUnique("role",{id:t},{include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}})}catch(e){return console.error("Error getting role by id:",e),null}})}assignPermissionsToRole(t,e){return f(this,null,function*(){this._isLoading.set(!0);try{let i=e.map(l=>({roleId:t,permissionId:l}));yield this.graphqlService.batchCreate("rolePermission",i);let s=yield this.getRoleById(t);if(s){let l=this._allRoles(),c=l.findIndex(u=>u.id===t);if(c!==-1){let u=[...l];u[c]=s,this._allRoles.set(u)}}}catch(i){throw console.error("Error assigning permissions to role:",i),i}finally{this._isLoading.set(!1)}})}removePermissionFromRole(t,e){return f(this,null,function*(){this._isLoading.set(!0);try{let s=(yield this.getRoleById(t))?.permissions?.find(l=>l.permissionId===e);if(s){yield this.graphqlService.deleteOne("rolePermission",{id:s.id});let l=yield this.getRoleById(t);if(l){let c=this._allRoles(),u=c.findIndex(V=>V.id===t);if(u!==-1){let V=[...c];V[u]=l,this._allRoles.set(V)}}}}catch(i){throw console.error("Error removing permission from role:",i),i}finally{this._isLoading.set(!1)}})}setSearchTerm(t){this._searchTerm.set(t),this._currentPage.set(1)}setStatusFilter(t){this._statusFilter.set(t),this._currentPage.set(1)}setPage(t){t>=1&&t<=this.totalPages()&&this._currentPage.set(t)}setPageSize(t){this._pageSize.set(t),this._currentPage.set(1)}nextPage(){this._currentPage()<this.totalPages()&&this._currentPage.set(this._currentPage()+1)}previousPage(){this._currentPage()>1&&this._currentPage.set(this._currentPage()-1)}toggleRoleSelection(t){let e=new Set(this._selectedRoles());e.has(t)?e.delete(t):e.add(t),this._selectedRoles.set(e)}selectAllCurrentPage(){let t=new Set(this._selectedRoles());this.paginatedRoles().forEach(e=>{t.add(e.id)}),this._selectedRoles.set(t)}deselectAllCurrentPage(){let t=new Set(this._selectedRoles());this.paginatedRoles().forEach(e=>{t.delete(e.id)}),this._selectedRoles.set(t)}clearSelection(){this._selectedRoles.set(new Set)}isSelected(t){return this._selectedRoles().has(t)}get selectedCount(){return this._selectedRoles().size}get selectedIds(){return Array.from(this._selectedRoles())}findRoleById(t){return this._allRoles().find(e=>e.id===t)}getRolesByPermission(t){return this._allRoles().filter(e=>e.permissions?.some(i=>i.permissionId===t))}getRolePermissions(t){let e=this.findRoleById(t);return!e||!e.permissions?[]:e.permissions.map(i=>i.permission)}hasPermission(t,e){return this.getRolePermissions(t).some(s=>s.codeId===e)}getRolesByGroup(t){return this._allRoles().filter(e=>e.permissions?.some(i=>i.permission.group===t))}getUsersInRole(t){let e=this.findRoleById(t);return!e||!e.users?[]:e.users.map(i=>i.user)}clearCache(){this._allRoles.set([]),this._searchTerm.set(""),this._currentPage.set(1),this.clearSelection()}refreshData(){return this.loadAllRoles(!0)}static \u0275fac=function(e){return new(e||n)(ke(Oe))};static \u0275prov=Z({token:n,factory:n.\u0275fac,providedIn:"root"})};var ve=class n{userPermissionService=y(fe);permissionService=y(ft);userService=y(he);cachedUsers=new Map;cachedPermissions=[];getUserPermissionDetails(t){return!t||t==="new"?X(null):this.cachedUsers.has(t)?X(this.cachedUsers.get(t)):this.loadUserWithPermissions(t).pipe(Te(e=>(e&&this.cachedUsers.set(t,e),e)),Ie(e=>(console.error("Error loading user permission details:",e),X(null))))}getAllPermissions(){return this.cachedPermissions.length>0?X(this.cachedPermissions):new be(t=>{this.permissionService.loadAllPermissions().then(()=>{this.cachedPermissions=this.permissionService.allPermissions(),t.next(this.cachedPermissions),t.complete()}).catch(e=>{console.error("Error loading permissions:",e),t.next([]),t.complete()})})}getPermissionSummary(t){let e=this.extractRolePermissions(t.roles),i=t.userPermissions.filter(c=>c.isGranted),s=t.userPermissions.filter(c=>!c.isGranted);console.log("rolePermissions",e),console.log("userGranted",i),console.log("userDenied",s);let l=this.calculateEffectivePermissions(e,i.map(c=>c.permission),s.map(c=>c.permission));return{totalRolePermissions:e.length,grantedPermissions:i.length,deniedPermissions:s.length,effectivePermissions:l,rolePermissions:e,userGranted:i,userDenied:s}}clearCache(){this.cachedUsers.clear(),this.cachedPermissions=[]}clearUserCache(t){this.cachedUsers.delete(t)}loadUserWithPermissions(t){return new be(e=>{this.loadUserWithPermissionsAsync(t).then(i=>{e.next(i),e.complete()}).catch(i=>{console.error("Error in loadUserWithPermissions:",i),e.next(null),e.complete()})})}loadUserWithPermissionsAsync(t){return f(this,null,function*(){try{let e=yield this.userService.getUserById(t);if(!e)return null;let i=yield this.userPermissionService.getUserPermissions(t);return{id:e.id,email:e.email,SDT:e.SDT,isActive:e.isActive,profile:e.profile,roles:e.roles||[],userPermissions:i.map(l=>({id:l.id,isGranted:l.isGranted,permission:l.permission?{id:l.permission.id,name:l.permission.name,code:l.permission.codeId||"",description:l.permission.description,isActive:!0,createdAt:new Date,updatedAt:new Date}:{id:"",name:"Unknown Permission",code:"",description:"",isActive:!1,createdAt:new Date,updatedAt:new Date},createdAt:l.createdAt?.toISOString(),updatedAt:l.updatedAt?.toISOString()}))}}catch(e){return console.error("Error in loadUserWithPermissionsAsync:",e),null}})}extractRolePermissions(t){let e=new Map;return t.forEach(i=>{let s=i.role;console.log("role.permissions",s.permissions),s&&s.permissions&&s.permissions.forEach(l=>{if(l&&l.id){let c={id:l.id,name:l?.permission?.name,code:l?.permission?.codeId||l?.permission?.code||"",description:l.description,isActive:!0,createdAt:new Date,updatedAt:new Date};e.set(l.id,c)}})}),Array.from(e.values())}calculateEffectivePermissions(t,e,i){let s=new Map;return t.forEach(l=>{s.set(l.id,l)}),e.forEach(l=>{if(l&&l.id){let c={id:l.id,name:l.name,code:l.codeId||l.code||"",description:l.description,isActive:!0,createdAt:new Date,updatedAt:new Date};s.set(l.id,c)}}),i.forEach(l=>{l&&l.id&&s.delete(l.id)}),Array.from(s.values())}static \u0275fac=function(e){return new(e||n)};static \u0275prov=Z({token:n,factory:n.\u0275fac,providedIn:"root"})};var Et=(n,t)=>t.id||t.roleId,yt=(n,t)=>t.id||t.name;function Pt(n,t){if(n&1&&(o(0,"div",7)(1,"small",8),a(2),r()()),n&2){let e,i=d();m(2),C("\u2705 UserRolesInfoComponent loaded - User: ",((e=i.user())==null?null:e.email)||((e=i.user())==null?null:e.name)||((e=i.user())==null?null:e.id),"")}}function bt(n,t){if(n&1&&(o(0,"p",14),a(1),r()),n&2){let e=d().$implicit;m(),C(" ",(e.role==null?null:e.role.description)||e.description," ")}}function St(n,t){if(n&1&&(o(0,"span",15),a(1),r()),n&2){let e=d().$implicit,i=d(2);m(),C(" ",i.getRolePermissions(e).length," quy\u1EC1n ")}}function wt(n,t){if(n&1&&(o(0,"span",20),a(1),r()),n&2){let e=t.$implicit;p("title",e.description||e.name),m(),C(" ",e.permission.name," ")}}function Dt(n,t){if(n&1){let e=P();o(0,"button",22),h("click",function(){x(e);let s=d(2).$implicit,l=d(2);return v(l.toggleShowPermissions(s.id||s.roleId))}),a(1),r()}if(n&2){let e=d(2).$implicit,i=d(2);m(),C(" ",i.showAllPermissions[e.id||e.roleId]?"Thu g\u1ECDn":"..."+(i.getRolePermissions(e).length-4)+" n\u1EEFa"," ")}}function Rt(n,t){if(n&1&&(o(0,"div",16)(1,"div",19),S(2,wt,2,2,"span",20,yt),_(4,Dt,2,1,"button",21),r()()),n&2){let e=d().$implicit,i=d(2);m(2),w(i.getRolePermissions(e).slice(0,i.showAllPermissions[e.id||e.roleId]?i.getRolePermissions(e).length:4)),m(2),E(i.getRolePermissions(e).length>4?4:-1)}}function Ut(n,t){n&1&&(o(0,"div",17)(1,"mat-icon",23),a(2,"block"),r(),o(3,"p"),a(4,"Kh\xF4ng c\xF3 quy\u1EC1n"),r()())}function Mt(n,t){if(n&1&&(o(0,"div",18)(1,"mat-icon",24),a(2,"schedule"),r(),o(3,"span",25),a(4),r()()),n&2){let e=d().$implicit,i=d(2);m(4),C(" G\xE1n l\xFAc: ",i.formatDate(e.assignedAt||e.createdAt)," ")}}function Tt(n,t){if(n&1&&(o(0,"div",9)(1,"div",10)(2,"div",11)(3,"mat-icon",12),a(4),r(),o(5,"div")(6,"h4",13),a(7),r(),_(8,bt,2,1,"p",14),r()(),_(9,St,2,1,"span",15),r(),_(10,Rt,5,1,"div",16)(11,Ut,5,0,"div",17)(12,Mt,5,1,"div",18),r()),n&2){let e=t.$implicit,i=d(2);m(4),C(" ",i.getRoleIcon((e.role==null?null:e.role.name)||e.name)," "),m(3),C(" ",(e.role==null?null:e.role.name)||e.name," "),m(),E(e.role!=null&&e.role.description||e.description?8:-1),m(),E(i.getRolePermissions(e).length>0?9:-1),m(),E(i.getRolePermissions(e).length>0?10:11),m(2),E(e.assignedAt||e.createdAt?12:-1)}}function It(n,t){if(n&1&&(o(0,"div",5),S(1,Tt,13,6,"div",9,Et),r()),n&2){let e=d();m(),w(e.user().roles)}}function kt(n,t){n&1&&(o(0,"div",6)(1,"mat-icon",26),a(2,"person_outline"),r(),o(3,"p",27),a(4,"Ch\u01B0a c\xF3 vai tr\xF2 n\xE0o"),r(),o(5,"p",4),a(6,"User n\xE0y ch\u01B0a \u0111\u01B0\u1EE3c g\xE1n vai tr\xF2 n\xE0o"),r()())}var Ce=class n{user=J();showAllPermissions={};constructor(){ie(()=>{console.log("\u{1F50D} UserRolesInfoComponent - user data:",this.user()),console.log("\u{1F50D} UserRolesInfoComponent - user roles:",this.user()?.roles)})}getRolePermissions(t){let e=t.role?.permissions||t.permissions||t.role?.rolePermissions?.map(i=>i.permission)||[];return console.log("Extracting permissions for role result:",e),e}getRoleIcon(t){if(!t)return"person";let e=t.toLowerCase();return e.includes("admin")?"admin_panel_settings":e.includes("manager")||e.includes("qu\u1EA3n l\xFD")?"manage_accounts":e.includes("user")||e.includes("ng\u01B0\u1EDDi d\xF9ng")?"person":e.includes("guest")||e.includes("kh\xE1ch")?"person_outline":e.includes("moderator")?"gavel":e.includes("editor")?"edit":e.includes("viewer")?"visibility":"group"}toggleShowPermissions(t){this.showAllPermissions[t]=!this.showAllPermissions[t]}formatDate(t){return t?new Date(t).toLocaleDateString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}):""}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=D({type:n,selectors:[["app-user-roles-info"]],inputs:{user:[1,"user"]},decls:12,vars:3,consts:[["class","mb-2 p-2 bg-blue-50 border border-blue-200 rounded",4,"ngIf"],[1,"roles-info"],[1,"text-sm","font-medium","flex","items-center"],[1,"mr-2","text-blue-500"],[1,"text-xs"],[1,"space-y-4"],[1,"text-center","py-6","text-gray-500"],[1,"mb-2","p-2","bg-blue-50","border","border-blue-200","rounded"],[1,"text-blue-700"],[1,"border","rounded-lg","p-3","bg-gray-50"],[1,"flex","items-center","justify-between","mb-2"],[1,"flex","items-center"],[1,"mr-2","text-blue-600"],[1,"font-medium","text-sm","text-gray-800"],[1,"text-xs","text-gray-600"],[1,"px-2","py-1","text-xs","bg-blue-100","text-blue-800","rounded-full"],[1,"mt-2"],[1,"text-center","text-gray-400","text-xs","py-2"],[1,"flex","items-center","mt-2","pt-2","border-t","border-gray-200"],[1,"flex","flex-wrap","gap-1"],[1,"px-2","py-1","text-xs","bg-white","border","border-blue-200","text-blue-700","rounded",3,"title"],["mat-button","",1,"!text-xs","!p-1","!min-w-0","text-blue-600"],["mat-button","",1,"!text-xs","!p-1","!min-w-0","text-blue-600",3,"click"],[1,"text-gray-300"],[1,"mr-1","text-gray-400",2,"font-size","14px"],[1,"text-xs","text-gray-500"],[1,"text-4xl","text-gray-300"],[1,"mt-2","text-sm"]],template:function(e,i){if(e&1&&(_(0,Pt,3,1,"div",0),o(1,"mat-card",1)(2,"mat-card-header")(3,"mat-card-title",2)(4,"mat-icon",3),a(5,"groups"),r(),a(6," Vai Tr\xF2 & Quy\u1EC1n "),r(),o(7,"mat-card-subtitle",4),a(8),r()(),o(9,"mat-card-content"),_(10,It,3,0,"div",5)(11,kt,7,0,"div",6),r()()),e&2){let s,l;p("ngIf",i.user()),m(8),C(" ",((s=i.user())==null||s.roles==null?null:s.roles.length)||0," vai tr\xF2 \u0111\u01B0\u1EE3c g\xE1n "),m(2),E((l=i.user())!=null&&l.roles&&i.user().roles.length>0?10:11)}},dependencies:[T,q,H,W,j,$,ge,N,A,F,B,k,I],styles:[".roles-info[_ngcontent-%COMP%]{border-left:4px solid #2196f3}.roles-info[_ngcontent-%COMP%]   mat-card-header[_ngcontent-%COMP%]{padding-bottom:8px}.roles-info[_ngcontent-%COMP%]   mat-card-content[_ngcontent-%COMP%]{font-size:12px}.roles-info[_ngcontent-%COMP%]   .border[_ngcontent-%COMP%]:hover{border-color:#2196f3;background-color:#f3f4f6}"]})};var Lt=(n,t)=>t.name,Vt=(n,t)=>t.id;function Ot(n,t){if(n&1&&(o(0,"div",34),a(1),r()),n&2){let e=d().$implicit;m(),b(e.description)}}function Gt(n,t){n&1&&(o(0,"span",36),a(1," T\u1EEB Role "),r())}function qt(n,t){n&1&&(o(0,"span",37),a(1," \u0110\xE3 c\u1EA5p ri\xEAng "),r())}function Qt(n,t){n&1&&(o(0,"span",38),a(1," \u0110\xE3 t\u1EEB ch\u1ED1i "),r())}function zt(n,t){if(n&1&&(o(0,"div",35),_(1,Gt,2,0,"span",36)(2,qt,2,0,"span",37)(3,Qt,2,0,"span",38),r()),n&2){let e=t;m(),E(e==="role"?1:e==="granted"?2:e==="denied"?3:-1)}}function Wt(n,t){if(n&1){let e=P();o(0,"div",30)(1,"mat-checkbox",31),h("change",function(s){let l=x(e).$implicit,c=d(2);return v(c.togglePermission(l,s.checked))}),r(),o(2,"div",32)(3,"div",33),a(4),r(),_(5,Ot,2,1,"div",34)(6,zt,4,1,"div",35),r()()}if(n&2){let e,i=t.$implicit,s=d(2);ee("bg-blue-50",s.isPermissionSelected(i))("border-blue-200",s.isPermissionSelected(i)),m(),p("checked",s.isPermissionSelected(i))("disabled",s.isPermissionDisabled(i)),m(3),b(i.name),m(),E(i.description?5:-1),m(),E((e=s.getPermissionStatus(i))?6:-1,e)}}function Nt(n,t){if(n&1&&(o(0,"div",16)(1,"div",25)(2,"h4",26)(3,"mat-icon",2),a(4,"folder"),r(),a(5),r(),o(6,"span",27),a(7),r()(),o(8,"div",28),S(9,Wt,7,9,"div",29,Vt),r()()),n&2){let e=t.$implicit;m(5),C(" ",e.name||"Kh\xE1c"," "),m(2),C("",e.permissions.length," quy\u1EC1n"),m(2),w(e.permissions)}}var Ee=class n{dialogRef=y(He);data=y(Ke);searchTerm="";grantType="grant";reason="";selectedPermissions=g([]);filteredPermissions=g([]);permissionGroups=g([]);constructor(){this.filteredPermissions.set(this.data.availablePermissions),this.filterPermissions()}filterPermissions(){let t=this.searchTerm.toLowerCase(),e=this.data.availablePermissions;t&&(e=e.filter(i=>i.name.toLowerCase().includes(t)||i.description&&i.description.toLowerCase().includes(t))),this.filteredPermissions.set(e),this.updatePermissionGroups()}updatePermissionGroups(){let t=new Map;this.filteredPermissions().forEach(i=>{let s=i.group||"Kh\xE1c";t.has(s)||t.set(s,[]),t.get(s).push(i)});let e=Array.from(t.entries()).map(([i,s])=>({name:i,permissions:s.sort((l,c)=>l.name.localeCompare(c.name))})).sort((i,s)=>i.name.localeCompare(s.name));this.permissionGroups.set(e)}isPermissionSelected(t){return this.selectedPermissions().some(e=>e.id===t.id)}isPermissionDisabled(t){return!1}getPermissionStatus(t){if(this.data.currentRolePermissions.some(s=>s.id===t.id))return"role";let i=this.data.currentUserPermissions.find(s=>s.permission.id===t.id);return i?i.isGranted?"granted":"denied":null}togglePermission(t,e){let i=this.selectedPermissions();e?this.isPermissionSelected(t)||this.selectedPermissions.set([...i,t]):this.selectedPermissions.set(i.filter(s=>s.id!==t.id))}onCancel(){this.dialogRef.close()}onConfirm(){let t={selectedPermissions:this.selectedPermissions(),grantType:this.grantType,reason:this.reason.trim()||void 0};this.dialogRef.close(t)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=D({type:n,selectors:[["app-permission-selector-dialog"]],decls:48,vars:8,consts:[[1,"permission-selector-dialog"],["mat-dialog-title","",1,"flex","items-center"],[1,"mr-2","text-blue-500"],[1,"min-h-96","max-h-96","overflow-y-auto"],[1,"space-y-4"],[1,"mb-4"],[1,"block","text-sm","font-medium","text-gray-700","mb-2"],["appearance","outline",1,"w-full"],["placeholder","Ch\u1ECDn lo\u1EA1i",3,"valueChange","value"],["value","grant"],[1,"flex","items-center"],[1,"mr-2","text-green-500"],["value","deny"],[1,"mr-2","text-red-500"],["matInput","","placeholder","Nh\u1EADp t\xEAn quy\u1EC1n ho\u1EB7c m\xF4 t\u1EA3...",3,"ngModelChange","ngModel"],["matSuffix",""],[1,"border","rounded-lg","p-3"],[1,"mt-4"],["matInput","","rows","3","placeholder","Nh\u1EADp l\xFD do c\u1EA5p/t\u1EEB ch\u1ED1i quy\u1EC1n n\xE0y...",3,"ngModelChange","ngModel"],[1,"flex","justify-between"],[1,"text-sm","text-gray-600"],[1,"space-x-2"],["mat-button","",3,"click"],["mat-raised-button","","color","primary",3,"click","disabled"],[1,"mr-1"],[1,"flex","items-center","justify-between","mb-3"],[1,"font-medium","text-gray-800","flex","items-center"],[1,"text-xs","text-gray-500"],[1,"space-y-2","max-h-48","overflow-y-auto"],[1,"flex","items-center","p-2","rounded","hover:bg-gray-50",3,"bg-blue-50","border-blue-200"],[1,"flex","items-center","p-2","rounded","hover:bg-gray-50"],[1,"mr-3",3,"change","checked","disabled"],[1,"flex-1"],[1,"font-medium","text-sm"],[1,"text-xs","text-gray-600"],[1,"mt-1"],[1,"text-xs","bg-blue-100","text-blue-800","px-2","py-1","rounded"],[1,"text-xs","bg-green-100","text-green-800","px-2","py-1","rounded"],[1,"text-xs","bg-red-100","text-red-800","px-2","py-1","rounded"]],template:function(e,i){e&1&&(o(0,"div",0)(1,"div",1)(2,"mat-icon",2),a(3,"add_task"),r(),o(4,"span"),a(5,"C\u1EA5p Quy\u1EC1n M\u1EDBi"),r()(),o(6,"mat-dialog-content",3)(7,"div",4)(8,"div",5)(9,"label",6),a(10,"Lo\u1EA1i c\u1EA5p quy\u1EC1n:"),r(),o(11,"mat-form-field",7)(12,"mat-select",8),M("valueChange",function(l){return U(i.grantType,l)||(i.grantType=l),l}),o(13,"mat-option",9)(14,"div",10)(15,"mat-icon",11),a(16,"add_circle"),r(),a(17," C\u1EA5p quy\u1EC1n (Grant) "),r()(),o(18,"mat-option",12)(19,"div",10)(20,"mat-icon",13),a(21,"remove_circle"),r(),a(22," T\u1EEB ch\u1ED1i quy\u1EC1n (Deny) "),r()()()()(),o(23,"div",5)(24,"mat-form-field",7)(25,"mat-label"),a(26,"T\xECm ki\u1EBFm quy\u1EC1n"),r(),o(27,"input",14),M("ngModelChange",function(l){return U(i.searchTerm,l)||(i.searchTerm=l),l}),h("ngModelChange",function(){return i.filterPermissions()}),r(),o(28,"mat-icon",15),a(29,"search"),r()()(),o(30,"div",4),S(31,Nt,11,2,"div",16,Lt),r(),o(33,"div",17)(34,"mat-form-field",7)(35,"mat-label"),a(36,"L\xFD do (t\xF9y ch\u1ECDn)"),r(),o(37,"textarea",18),M("ngModelChange",function(l){return U(i.reason,l)||(i.reason=l),l}),r()()()()(),o(38,"mat-dialog-actions",19)(39,"div",20),a(40),r(),o(41,"div",21)(42,"button",22),h("click",function(){return i.onCancel()}),a(43,"H\u1EE7y"),r(),o(44,"button",23),h("click",function(){return i.onConfirm()}),o(45,"mat-icon",24),a(46),r(),a(47),r()()()()),e&2&&(m(12),R("value",i.grantType),m(15),R("ngModel",i.searchTerm),m(4),w(i.permissionGroups()),m(6),R("ngModel",i.reason),m(3),C(" \u0110\xE3 ch\u1ECDn: ",i.selectedPermissions().length," quy\u1EC1n "),m(4),p("disabled",i.selectedPermissions().length===0),m(2),C(" ",i.grantType==="grant"?"add_circle":"remove_circle"," "),m(),Ae(" ",i.grantType==="grant"?"C\u1EA5p Quy\u1EC1n":"T\u1EEB Ch\u1ED1i"," (",i.selectedPermissions().length,") "))},dependencies:[T,le,oe,se,ae,z,Je,Ze,Ye,k,I,A,F,ot,rt,ce,de,me,et,pe,ue,_e,tt,Ve,B,Q],styles:[".permission-selector-dialog[_ngcontent-%COMP%]{width:100%;max-width:600px}  .mat-mdc-dialog-content{max-height:60vh}"]})};var Pe=(n,t)=>t.id;function jt(n,t){n&1&&G(0,"mat-spinner",4)}function $t(n,t){n&1&&(o(0,"div",6),G(1,"mat-spinner",10),o(2,"p",11),a(3,"\u0110ang t\u1EA3i th\xF4ng tin quy\u1EC1n..."),r()())}function Ht(n,t){if(n&1){let e=P();o(0,"div",7)(1,"mat-icon",12),a(2,"error"),r(),o(3,"p",13),a(4),r(),o(5,"button",14),h("click",function(){x(e);let s=d();return v(s.loadPermissionData())}),o(6,"mat-icon"),a(7,"refresh"),r(),a(8," Th\u1EED l\u1EA1i "),r()()}if(n&2){let e=d();m(4),b(e.error())}}function Kt(n,t){n&1&&(o(0,"mat-icon",58),a(1,"groups"),r(),a(2," Roles & Nh\xF3m Quy\u1EC1n "))}function Xt(n,t){if(n&1&&G(0,"app-user-roles-info",59),n&2){let e=d(2);p("user",e.user())}}function Jt(n,t){n&1&&(o(0,"mat-icon",58),a(1,"dashboard"),r(),a(2," T\u1ED5ng Quan "))}function Yt(n,t){if(n&1&&(o(0,"span",60),a(1),r()),n&2){let e=t.$implicit;p("title",e.description||e.name),m(),C(" ",e.name," ")}}function Zt(n,t){if(n&1&&(o(0,"div",36),S(1,Yt,2,2,"span",60,Pe),r()),n&2){let e=d(2);m(),w(e.currentSummary().rolePermissions)}}function ei(n,t){n&1&&(o(0,"p",37),a(1,"Kh\xF4ng c\xF3 quy\u1EC1n t\u1EEB roles"),r())}function ti(n,t){if(n&1&&(o(0,"span",61),a(1),r()),n&2){let e=t.$implicit;p("title",e.description||e.name),m(),C(" ",e.name," ")}}function ii(n,t){if(n&1&&(o(0,"div",36),S(1,ti,2,2,"span",61,Pe),r()),n&2){let e=d(2);m(),w(e.currentSummary().effectivePermissions)}}function ni(n,t){n&1&&(o(0,"div",9)(1,"mat-icon",62),a(2,"block"),r(),o(3,"p",63),a(4,"Ng\u01B0\u1EDDi d\xF9ng kh\xF4ng c\xF3 quy\u1EC1n n\xE0o"),r()())}function ri(n,t){n&1&&(o(0,"mat-icon",58),a(1,"settings"),r(),a(2," Qu\u1EA3n L\xFD "))}function oi(n,t){if(n&1){let e=P();o(0,"div",64)(1,"span",24),a(2),r(),o(3,"button",65),h("click",function(){let s=x(e).$implicit,l=d(3);return v(l.revokePermission(s))}),o(4,"mat-icon",5),a(5,"close"),r()()()}if(n&2){let e=t.$implicit,i=d(3);m(2),b(e.permission.name),m(),p("disabled",i.isUpdatingPermission())}}function si(n,t){if(n&1&&(o(0,"div",36),S(1,oi,6,2,"div",64,Pe),r()),n&2){let e=d(2);m(),w(e.currentSummary().userGranted)}}function ai(n,t){n&1&&(o(0,"p",45),a(1,"Ch\u01B0a c\xF3 quy\u1EC1n n\xE0o \u0111\u01B0\u1EE3c c\u1EA5p ri\xEAng"),r())}function li(n,t){if(n&1){let e=P();o(0,"div",66)(1,"span",27),a(2),r(),o(3,"button",67),h("click",function(){let s=x(e).$implicit,l=d(3);return v(l.restorePermission(s))}),o(4,"mat-icon",5),a(5,"refresh"),r()()()}if(n&2){let e=t.$implicit,i=d(3);m(2),b(e.permission.name),m(),p("disabled",i.isUpdatingPermission())}}function mi(n,t){if(n&1&&(o(0,"div",36),S(1,li,6,2,"div",66,Pe),r()),n&2){let e=d(2);m(),w(e.currentSummary().userDenied)}}function di(n,t){n&1&&(o(0,"p",50),a(1,"Kh\xF4ng c\xF3 quy\u1EC1n n\xE0o b\u1ECB t\u1EEB ch\u1ED1i"),r())}function ci(n,t){if(n&1){let e=P();o(0,"mat-tab-group",8)(1,"mat-tab"),_(2,Kt,3,0,"ng-template",15),o(3,"div",16),_(4,Xt,1,1,"app-user-roles-info",17),r()(),o(5,"mat-tab"),_(6,Jt,3,0,"ng-template",15),o(7,"div",16)(8,"div",18)(9,"div",19)(10,"div",20),a(11),r(),o(12,"div",21),a(13,"T\u1EEB Roles"),r()(),o(14,"div",22)(15,"div",23),a(16),r(),o(17,"div",24),a(18,"\u0110\u01B0\u1EE3c C\u1EA5p"),r()(),o(19,"div",25)(20,"div",26),a(21),r(),o(22,"div",27),a(23,"B\u1ECB T\u1EEB Ch\u1ED1i"),r()(),o(24,"div",28)(25,"div",29),a(26),r(),o(27,"div",30),a(28,"Cu\u1ED1i C\xF9ng"),r()()(),o(29,"div",31)(30,"mat-expansion-panel",32)(31,"mat-expansion-panel-header")(32,"mat-panel-title",33)(33,"mat-icon",34),a(34,"groups"),r(),a(35),r()(),o(36,"div",35),_(37,Zt,3,0,"div",36)(38,ei,2,0,"p",37),r()(),o(39,"mat-expansion-panel",38)(40,"mat-expansion-panel-header")(41,"mat-panel-title",33)(42,"mat-icon",39),a(43,"verified_user"),r(),a(44),r()(),o(45,"div",35),_(46,ii,3,0,"div",36)(47,ni,5,0,"div",9),r()()()()(),o(48,"mat-tab"),_(49,ri,3,0,"ng-template",15),o(50,"div",16)(51,"div",31)(52,"div",40)(53,"div",41)(54,"div",33)(55,"mat-icon",42),a(56,"add_circle"),r(),o(57,"h3",43),a(58,"Quy\u1EC1n \u0110\u01B0\u1EE3c C\u1EA5p Ri\xEAng"),r()(),o(59,"span",44),a(60),r()(),_(61,si,3,0,"div",36)(62,ai,2,0,"p",45),r(),o(63,"div",46)(64,"div",41)(65,"div",33)(66,"mat-icon",47),a(67,"remove_circle"),r(),o(68,"h3",48),a(69,"Quy\u1EC1n B\u1ECB T\u1EEB Ch\u1ED1i"),r()(),o(70,"span",49),a(71),r()(),_(72,mi,3,0,"div",36)(73,di,2,0,"p",50),r(),o(74,"div",51)(75,"div",52)(76,"mat-icon",53),a(77,"add_task"),r(),o(78,"h3",54),a(79,"C\u1EA5p Quy\u1EC1n M\u1EDBi"),r()(),o(80,"div",55)(81,"p",56),a(82,"Ch\u1ECDn quy\u1EC1n \u0111\u1EC3 c\u1EA5p ri\xEAng cho ng\u01B0\u1EDDi d\xF9ng n\xE0y (override quy\u1EC1n t\u1EEB roles)"),r(),o(83,"button",57),h("click",function(){x(e);let s=d();return v(s.openPermissionSelector())}),o(84,"mat-icon"),a(85,"add"),r(),a(86," Th\xEAm Quy\u1EC1n "),r()()()()()()()}if(n&2){let e=d();m(4),p("ngIf",e.user()),m(7),b(e.currentSummary().totalRolePermissions),m(5),b(e.currentSummary().grantedPermissions),m(5),b(e.currentSummary().deniedPermissions),m(5),b(e.currentSummary().effectivePermissions.length),m(4),p("expanded",!0),m(5),C(" Quy\u1EC1n t\u1EEB Roles (",e.currentSummary().rolePermissions.length,") "),m(2),E(e.currentSummary().rolePermissions.length>0?37:38),m(7),C(" Quy\u1EC1n Cu\u1ED1i C\xF9ng (",e.currentSummary().effectivePermissions.length,") "),m(2),E(e.currentSummary().effectivePermissions.length>0?46:47),m(14),C(" ",e.currentSummary().userGranted.length," "),m(),E(e.currentSummary().userGranted.length>0?61:62),m(10),C(" ",e.currentSummary().userDenied.length," "),m(),E(e.currentSummary().userDenied.length>0?72:73),m(11),p("disabled",e.isUpdatingPermission())}}function ui(n,t){n&1&&(o(0,"div",9)(1,"mat-icon",62),a(2,"info"),r(),o(3,"p",63),a(4,"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u quy\u1EC1n"),r()())}var ye=class n{userPermissionService=y(ve);userPermissionGraphQLService=y(fe);dialog=y(Xe);snackBar=y(re);userId=J.required();user=J();isLoading=g(!1);isUpdatingPermission=g(!1);summary=g(null);error=g(null);availablePermissions=g([]);currentSummary=L(()=>this.summary());constructor(){ie(()=>{let t=this.userId();t&&t!=="new"?(this.error.set(null),this.summary.set(null),setTimeout(()=>{this.loadPermissionData(),this.loadAvailablePermissions()},0)):(this.summary.set(null),this.error.set(null))})}loadPermissionData(){return f(this,null,function*(){let t=this.userId();if(!t||t==="new"){this.summary.set(null),this.error.set(null);return}this.isLoading.set(!0),this.error.set(null);try{let e=yield new Promise((i,s)=>{this.userPermissionService.getUserPermissionDetails(t).subscribe({next:l=>i(l),error:l=>s(l)})});if(e){let i=this.userPermissionService.getPermissionSummary(e);console.log("summaryData",i),this.summary.set(i),this.error.set(null)}else this.summary.set(null),this.error.set("Kh\xF4ng t\xECm th\u1EA5y d\u1EEF li\u1EC7u ng\u01B0\u1EDDi d\xF9ng")}catch(e){console.error("Error loading permission data:",e),this.summary.set(null),this.error.set("L\u1ED7i khi t\u1EA3i th\xF4ng tin quy\u1EC1n. Vui l\xF2ng th\u1EED l\u1EA1i.")}finally{this.isLoading.set(!1)}})}loadAvailablePermissions(){return f(this,null,function*(){try{let t=yield new Promise((e,i)=>{this.userPermissionService.getAllPermissions().subscribe({next:s=>e(s),error:s=>i(s)})});this.availablePermissions.set(t)}catch(t){console.error("Error loading available permissions:",t)}})}revokePermission(t){return f(this,null,function*(){if(!(!t||this.isUpdatingPermission())){this.isUpdatingPermission.set(!0);try{yield this.userPermissionGraphQLService.updateUserPermission(t.id,{isGranted:!1,grantedBy:"system",reason:"Revoked by admin"}),yield this.loadPermissionData()}catch(e){console.error("Error revoking permission:",e),this.error.set("L\u1ED7i khi thu h\u1ED3i quy\u1EC1n")}finally{this.isUpdatingPermission.set(!1)}}})}restorePermission(t){return f(this,null,function*(){if(!(!t||this.isUpdatingPermission())){this.isUpdatingPermission.set(!0);try{yield this.userPermissionGraphQLService.updateUserPermission(t.id,{isGranted:!0,grantedBy:"system",reason:"Restored by admin"}),yield this.loadPermissionData()}catch(e){console.error("Error restoring permission:",e),this.error.set("L\u1ED7i khi kh\xF4i ph\u1EE5c quy\u1EC1n")}finally{this.isUpdatingPermission.set(!1)}}})}openPermissionSelector(){let t=this.summary();if(!t||this.isUpdatingPermission())return;this.dialog.open(Ee,{width:"700px",maxHeight:"80vh",data:{availablePermissions:this.availablePermissions(),currentUserPermissions:t.userGranted.concat(t.userDenied),currentRolePermissions:t.rolePermissions}}).afterClosed().subscribe(i=>f(this,null,function*(){i&&i.selectedPermissions.length>0&&(yield this.processPermissionChanges(i))}))}processPermissionChanges(t){return f(this,null,function*(){if(this.isUpdatingPermission())return;this.isUpdatingPermission.set(!0);let e=this.userId(),i=0,s=0;try{for(let c of t.selectedPermissions)try{let u=this.summary()?.userGranted.concat(this.summary()?.userDenied||[]).find(V=>V.permission.id===c.id);u?yield this.userPermissionGraphQLService.updateUserPermission(u.id,{isGranted:t.grantType==="grant",grantedBy:"admin",reason:t.reason}):yield this.userPermissionGraphQLService.assignPermissionToUser({userId:e,permissionId:c.id,isGranted:t.grantType==="grant",grantedBy:"admin",reason:t.reason}),i++}catch(u){console.error(`Error processing permission ${c.name}:`,u),s++}let l=t.grantType==="grant"?"c\u1EA5p":"t\u1EEB ch\u1ED1i";i>0?this.snackBar.open(`\u0110\xE3 ${l} ${i} quy\u1EC1n th\xE0nh c\xF4ng${s>0?`, ${s} l\u1ED7i`:""}`,"\u0110\xF3ng",{duration:5e3}):s>0&&this.snackBar.open(`L\u1ED7i khi ${l} quy\u1EC1n`,"\u0110\xF3ng",{duration:5e3}),yield this.loadPermissionData()}finally{this.isUpdatingPermission.set(!1)}})}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=D({type:n,selectors:[["app-user-permission-overview"]],inputs:{userId:[1,"userId"],user:[1,"user"]},decls:15,vars:2,consts:[[1,"permission-overview"],[1,"permission-main-card"],[1,"text-lg","font-medium","flex","items-center"],[1,"mr-2","text-indigo-500"],["diameter","16",1,"ml-2"],[1,"text-sm"],[1,"text-center","py-8"],[1,"text-center","py-8","text-red-500"],["animationDuration","300ms"],[1,"text-center","py-8","text-gray-500"],["diameter","48"],[1,"mt-4","text-gray-600"],[1,"text-4xl","text-red-400"],[1,"mt-2","font-medium"],["mat-raised-button","","color","primary",1,"mt-4",3,"click"],["mat-tab-label",""],[1,"py-4"],[3,"user",4,"ngIf"],[1,"grid","grid-cols-2","md:grid-cols-4","gap-4","mb-6"],[1,"text-center","p-4","bg-blue-50","rounded-lg","border","border-blue-200"],[1,"text-2xl","font-bold","text-blue-600"],[1,"text-sm","text-blue-800","font-medium"],[1,"text-center","p-4","bg-green-50","rounded-lg","border","border-green-200"],[1,"text-2xl","font-bold","text-green-600"],[1,"text-sm","text-green-800","font-medium"],[1,"text-center","p-4","bg-red-50","rounded-lg","border","border-red-200"],[1,"text-2xl","font-bold","text-red-600"],[1,"text-sm","text-red-800","font-medium"],[1,"text-center","p-4","bg-purple-50","rounded-lg","border","border-purple-200"],[1,"text-2xl","font-bold","text-purple-600"],[1,"text-sm","text-purple-800","font-medium"],[1,"space-y-6"],[1,"permission-section",3,"expanded"],[1,"flex","items-center"],[1,"mr-2","text-blue-500"],[1,"pt-4"],[1,"flex","flex-wrap","gap-2"],[1,"text-gray-500","text-center","py-4"],[1,"permission-section"],[1,"mr-2","text-purple-500"],[1,"bg-green-50","rounded-lg","p-4","border","border-green-200"],[1,"flex","items-center","justify-between","mb-4"],[1,"mr-2","text-green-600"],[1,"text-lg","font-medium","text-green-800"],[1,"px-3","py-1","bg-green-200","text-green-800","rounded-full","text-sm","font-medium"],[1,"text-green-700","text-center","py-4"],[1,"bg-red-50","rounded-lg","p-4","border","border-red-200"],[1,"mr-2","text-red-600"],[1,"text-lg","font-medium","text-red-800"],[1,"px-3","py-1","bg-red-200","text-red-800","rounded-full","text-sm","font-medium"],[1,"text-red-700","text-center","py-4"],[1,"bg-gray-50","rounded-lg","p-4","border","border-gray-200"],[1,"flex","items-center","mb-4"],[1,"mr-2","text-gray-600"],[1,"text-lg","font-medium","text-gray-800"],[1,"space-y-3"],[1,"text-sm","text-gray-600"],["mat-raised-button","","color","primary",3,"click","disabled"],[1,"mr-2"],[3,"user"],[1,"px-3","py-1","text-sm","bg-blue-100","text-blue-800","rounded-full","border","border-blue-200",3,"title"],[1,"px-3","py-1","text-sm","bg-purple-100","text-purple-800","rounded-full","border","border-purple-200","font-medium",3,"title"],[1,"text-4xl","text-gray-400"],[1,"mt-2"],[1,"flex","items-center","bg-white","rounded-lg","px-3","py-2","border","border-green-300"],["mat-icon-button","","color","warn","title","Thu h\u1ED3i quy\u1EC1n",1,"ml-2","w-6","h-6",3,"click","disabled"],[1,"flex","items-center","bg-white","rounded-lg","px-3","py-2","border","border-red-300"],["mat-icon-button","","color","primary","title","Kh\xF4i ph\u1EE5c quy\u1EC1n",1,"ml-2","w-6","h-6",3,"click","disabled"]],template:function(e,i){e&1&&(o(0,"div",0)(1,"mat-card",1)(2,"mat-card-header")(3,"mat-card-title",2)(4,"mat-icon",3),a(5,"admin_panel_settings"),r(),a(6," Qu\u1EA3n L\xFD Quy\u1EC1n H\u1EA1n "),_(7,jt,1,0,"mat-spinner",4),r(),o(8,"mat-card-subtitle",5),a(9," T\xF3m t\u1EAFt v\xE0 qu\u1EA3n l\xFD quy\u1EC1n chi ti\u1EBFt cho ng\u01B0\u1EDDi d\xF9ng "),r()(),o(10,"mat-card-content"),_(11,$t,4,0,"div",6)(12,Ht,9,1,"div",7)(13,ci,87,15,"mat-tab-group",8)(14,ui,5,0,"div",9),r()()()),e&2&&(m(7),E(i.isLoading()?7:-1),m(4),E(i.isLoading()?11:i.error()?12:i.currentSummary()?13:14))},dependencies:[T,q,H,W,j,$,ge,N,A,F,B,at,st,k,I,ne,Q,gt,ut,pt,_t,$e,We,Ne,je,z,Ce],styles:[".permission-overview[_ngcontent-%COMP%]{width:100%}.permission-main-card[_ngcontent-%COMP%]{border-left:4px solid #4f46e5;box-shadow:0 4px 6px -1px #0000001a}.permission-section[_ngcontent-%COMP%]{box-shadow:0 1px 3px #0000001a}.permission-section[_ngcontent-%COMP%]   mat-expansion-panel-header[_ngcontent-%COMP%]{background-color:#f8fafc}  .mat-mdc-tab-group .mat-mdc-tab-header{border-bottom:2px solid #e2e8f0}"]})};function pi(n,t){if(n&1){let e=P();o(0,"button",3),h("click",function(){x(e);let s=d();return v(s.handleUserAction())}),o(1,"mat-icon"),a(2,"save"),r()()}}function _i(n,t){if(n&1){let e=P();o(0,"button",3),h("click",function(){x(e);let s=d();return v(s.toggleEdit())}),o(1,"mat-icon"),a(2,"edit"),r()()}}function gi(n,t){if(n&1){let e=P();o(0,"button",10),h("click",function(){x(e);let s=d();return v(s.toggleDelete())}),o(1,"mat-icon"),a(2,"delete"),r()()}}function fi(n,t){if(n&1){let e=P();we(0),o(1,"div",11)(2,"div",12),a(3,"B\u1EA1n ch\u1EAFc ch\u1EAFn mu\u1ED1n xo\xE1 kh\xF4ng?"),r(),o(4,"div",13)(5,"button",14),h("click",function(){x(e);let s=d();return v(s.DeleteData())}),a(6,"\u0110\u1ED3ng \xDD"),r(),o(7,"button",15),h("click",function(){x(e);let s=d();return v(s.toggleDelete())}),a(8,"Hu\u1EF7 B\u1ECF"),r()()(),De()}}function hi(n,t){n&1&&(o(0,"mat-icon",42),a(1,"refresh"),r())}function xi(n,t){if(n&1){let e=P();o(0,"mat-icon",44),h("click",function(){x(e);let s=d().$implicit,l=d(3);return v(l.handleRemoveRole(s))}),a(1," close "),r()}n&2&&Fe("cursor","pointer")}function vi(n,t){if(n&1&&(o(0,"mat-chip-listbox")(1,"mat-chip-option",39)(2,"div",40)(3,"span",41),a(4),r(),_(5,hi,2,0,"mat-icon",42)(6,xi,2,2,"mat-icon",43),r()()()),n&2){let e=t.$implicit,i=d(3);m(),ee("opacity-50",i.isRemovingRole()),m(3),b((e==null||e.role==null?null:e.role.name)||(e==null?null:e.name)),m(),E(i.isRemovingRole()?5:i.isEdit()?6:-1)}}function Ci(n,t){if(n&1&&(o(0,"div",28),S(1,vi,7,4,"mat-chip-listbox",null,Se),r()),n&2){let e=d(2);m(),w(e.DetailUser().roles)}}function Ei(n,t){if(n&1&&(o(0,"button",47)(1,"mat-icon"),a(2,"add"),r(),a(3," Th\xEAm nh\xF3m \u0111\u1EA7u ti\xEAn "),r()),n&2){d(2);let e=te(35);p("matMenuTriggerFor",e)}}function yi(n,t){if(n&1&&(o(0,"div",29)(1,"mat-icon",45),a(2,"group_off"),r(),o(3,"p",46),a(4,"Ch\u01B0a c\xF3 nh\xF3m quy\u1EC1n n\xE0o"),r(),_(5,Ei,4,1,"button",47),r()),n&2){let e=d(2);m(5),E(e.isEdit()?5:-1)}}function Pi(n,t){if(n&1){let e=P();o(0,"button",48),h("click",function(){let s=x(e).$implicit,l=d(2);return v(l.handleAddRole(s))}),a(1),r()}if(n&2){let e=t.$implicit;m(),b(e.name)}}function bi(n,t){if(n&1&&G(0,"app-user-permission-overview",53),n&2){let e,i=d(3);p("userId",(e=i.DetailUser())==null?null:e.id)("user",i.DetailUser())}}function Si(n,t){n&1&&(o(0,"div",54)(1,"mat-icon",55),a(2,"refresh"),r(),o(3,"p",56),a(4,"\u0110ang t\u1EA3i th\xF4ng tin quy\u1EC1n..."),r()())}function wi(n,t){if(n&1&&(o(0,"div",49)(1,"div",50),_(2,bi,1,2,"app-user-permission-overview",51)(3,Si,5,0,"div",52),r()()),n&2){let e,i=d(2);m(2),p("ngIf",i.DetailUser()&&((e=i.DetailUser())==null?null:e.id)&&!i.isLoading()),m(),p("ngIf",i.isLoading())}}function Di(n,t){n&1&&(o(0,"div",49)(1,"div",50)(2,"div",57)(3,"mat-icon",58),a(4,"info"),r(),o(5,"p",59),a(6,"L\u01B0u user tr\u01B0\u1EDBc \u0111\u1EC3 qu\u1EA3n l\xFD quy\u1EC1n \u0111\u1EB7c bi\u1EC7t"),r(),o(7,"p",60),a(8,"Sau khi t\u1EA1o user, b\u1EA1n c\xF3 th\u1EC3 c\u1EA5p/thu h\u1ED3i quy\u1EC1n ri\xEAng"),r()()()())}function Ri(n,t){if(n&1){let e=P();we(0),o(1,"div",16)(2,"mat-form-field",17)(3,"mat-label"),a(4,"Email"),r(),o(5,"input",18),M("ngModelChange",function(s){x(e);let l=d();return U(l.DetailUser().email,s)||(l.DetailUser().email=s),v(s)}),r()(),o(6,"mat-form-field",17)(7,"mat-label"),a(8,"H\u1ECD V\xE0 T\xEAn"),r(),o(9,"input",19),h("input",function(s){x(e);let l=d();return v(l.updateUserName(s))}),r()(),o(10,"mat-form-field",17)(11,"mat-label"),a(12,"S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i"),r(),o(13,"input",20),M("ngModelChange",function(s){x(e);let l=d();return U(l.DetailUser().SDT,s)||(l.DetailUser().SDT=s),v(s)}),r()(),o(14,"mat-form-field",17)(15,"mat-label"),a(16,"M\u1EADt Kh\u1EA9u "),r(),o(17,"input",21),M("ngModelChange",function(s){x(e);let l=d();return U(l.DetailUser().password,s)||(l.DetailUser().password=s),v(s)}),r()(),o(18,"div",22)(19,"button",23,0)(21,"mat-icon"),a(22,"add"),r(),a(23," Th\xEAm Nh\xF3m "),r()(),o(24,"div",24)(25,"mat-card",25)(26,"mat-card-header")(27,"mat-card-title",26)(28,"mat-icon",27),a(29,"groups"),r(),a(30),r()(),o(31,"mat-card-content"),_(32,Ci,3,0,"div",28)(33,yi,6,1,"div",29),r()()(),o(34,"mat-menu",null,1)(36,"div",30),h("click",function(s){return x(e),v(s.stopPropagation())}),o(37,"div",31)(38,"input",32),h("keyup",function(s){x(e);let l=d();return v(l.doFilterHederColumn(s))}),r(),o(39,"div",33)(40,"span",34),a(41,"search"),r()()(),o(42,"div",35),S(43,Pi,2,1,"button",36,Se),r(),o(45,"div",37)(46,"button",15),h("click",function(){x(e);let s=te(20);return v(s.closeMenu())}),a(47,"\u0110\xF3ng"),r()()()(),_(48,wi,4,2,"div",38)(49,Di,9,0,"div",38),r(),De()}if(n&2){let e,i,s,l,c=te(35),u=d();m(5),R("ngModel",u.DetailUser().email),p("disabled",!u.isEdit()),m(4),p("value",((e=u.DetailUser())==null||e.profile==null?null:e.profile.name)||"")("disabled",!u.isEdit()),m(4),R("ngModel",u.DetailUser().SDT),p("disabled",!u.isEdit()),m(4),R("ngModel",u.DetailUser().password),p("disabled",!u.isEdit()),m(2),p("disabled",!u.isEdit()||u.isAddingRole())("matMenuTriggerFor",c),m(11),C(" Nh\xF3m Quy\u1EC1n (",((i=u.DetailUser().roles)==null?null:i.length)||0,") "),m(2),E(u.DetailUser().roles&&u.DetailUser().roles.length>0?32:33),m(11),w(u.FilterRole()),m(5),p("ngIf",((s=u.DetailUser())==null?null:s.id)&&((s=u.DetailUser())==null?null:s.id)!=="new"),m(),p("ngIf",((l=u.DetailUser())==null?null:l.id)==="new")}}var Ct=class n{_ListuserComponent=y(ht);_UserGraphQLService=y(he);_RoleGraphQLService=y(xe);_route=y(Be);_router=y(Le);_snackBar=y(re);constructor(){this._route.paramMap.subscribe(t=>{let e=t.get("id");e==="new"?this.userId.set(e):e&&!this._UserGraphQLService.currentUser()&&this.userId.set(e)})}DetailUser=g(null);isEdit=g(!1);isDelete=g(!1);isLoading=g(!1);isAddingRole=g(!1);isRemovingRole=g(!1);userId=g(null);ListRole=g([]);FilterRole=g([]);getUserById(t){return f(this,null,function*(){try{let e=yield this._UserGraphQLService.getUserById(t);e&&this.DetailUser.set(K(O({},e),{SDT:e.SDT||""}))}catch(e){console.error("Error loading user:",e),this._snackBar.open("L\u1ED7i khi t\u1EA3i th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng","\u0110\xF3ng",{duration:3e3})}})}ngOnInit(){return f(this,null,function*(){let t=this.userId();if(!t){this._router.navigate(["/admin/user"]),this._ListuserComponent.drawer.close();return}if(t==="new")this.DetailUser.set({id:"new",email:"",password:"",SDT:"",name:"",isActive:!0,roles:[],profile:{name:"",avatar:"",bio:""}}),this._ListuserComponent?.drawer?.open(),this.isEdit.set(!0);else if(t)try{yield this.getUserById(t),this._ListuserComponent?.drawer?.open(),this._router.navigate(["/admin/user",t])}catch(e){console.error("Error loading user:",e),this._snackBar.open("L\u1ED7i khi t\u1EA3i th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng","\u0110\xF3ng",{duration:3e3}),this._router.navigate(["/admin/user"]);return}try{yield this._RoleGraphQLService.loadAllRoles(),this.ListRole.set(this._RoleGraphQLService.allRoles()),this.updateFilterRole()}catch(e){console.error("Error loading roles:",e)}})}updateFilterRole(){let t=this.ListRole()||[],i=this.DetailUser()?.roles||[];if(t.length===0){this.FilterRole.set([]);return}let s=t.filter(l=>!l||!l.id?!1:!i.some(c=>c?c.roleId===l.id||c.role?.id===l.id:!1));this.FilterRole.set(s)}updateUserName(t){let e=t.target.value,i=this.DetailUser();i&&(i.profile||(i.profile={name:"",avatar:"",bio:""}),i.profile.name=e,this.DetailUser.set(O({},i)))}handleUserAction(){return f(this,null,function*(){this.userId()==="new"?yield this.createUser():yield this.updateUser()})}createUser(){return f(this,null,function*(){try{if(!this.DetailUser().password||this.DetailUser().password.trim()===""){this._snackBar.open("Vui l\xF2ng nh\u1EADp password","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}if(!this.DetailUser().SDT||this.DetailUser().SDT.trim()===""){this._snackBar.open("Vui l\xF2ng nh\u1EADp SDT","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}yield this._UserGraphQLService.createUser(this.DetailUser()),this._snackBar.open("T\u1EA1o M\u1EDBi Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.update(t=>!t)}catch(t){console.error("L\u1ED7i khi t\u1EA1o user:",t)}})}updateUser(){return f(this,null,function*(){try{yield this._UserGraphQLService.updateUser(this.DetailUser().id,this.DetailUser()),this._snackBar.open("C\u1EADp Nh\u1EADt Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.update(t=>!t)}catch(t){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt user:",t)}})}DeleteData(){return f(this,null,function*(){try{yield this._UserGraphQLService.deleteUser(this.DetailUser().id),this._snackBar.open("X\xF3a Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this._router.navigate(["/admin/user"])}catch(t){console.error("L\u1ED7i khi x\xF3a user:",t)}})}FillSlug(){this.DetailUser.update(t=>K(O({},t),{slug:it(t.title)}))}doFilterHederColumn(t){let e=this.ListRole();this.FilterRole.set(e.filter(i=>i.name.toLowerCase().includes(t.target.value.toLowerCase())))}handleAddRole(t){return f(this,null,function*(){if(!t||!t.id||this.isAddingRole()){(!t||!t.id)&&this._snackBar.open("D\u1EEF li\u1EC7u vai tr\xF2 kh\xF4ng h\u1EE3p l\u1EC7","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}this.isAddingRole.set(!0);try{if((this.DetailUser()?.roles||[]).some(s=>s.roleId===t.id||s.role?.id===t.id)){this._snackBar.open("Vai tr\xF2 \u0111\xE3 \u0111\u01B0\u1EE3c th\xEAm","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-warning"]});return}yield this._UserGraphQLService.assignRolesToUser(this.DetailUser().id,[t.id]),this.DetailUser.update(s=>K(O({},s),{roles:[...s.roles||[],{id:nt(8,!1),userId:this.DetailUser().id,roleId:t.id,role:t}]})),this.updateFilterRole(),this._snackBar.open("Th\xEAm vai tr\xF2 th\xE0nh c\xF4ng","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(e){console.error("Error adding role:",e),this._snackBar.open("L\u1ED7i khi th\xEAm vai tr\xF2","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}finally{this.isAddingRole.set(!1)}})}handleRemoveRole(t){return f(this,null,function*(){if(!t||this.isRemovingRole()){t||this._snackBar.open("D\u1EEF li\u1EC7u vai tr\xF2 kh\xF4ng h\u1EE3p l\u1EC7","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}this.isRemovingRole.set(!0);try{let e=t.role?.id||t.roleId;if(!e){this._snackBar.open("Kh\xF4ng th\u1EC3 x\xE1c \u0111\u1ECBnh ID vai tr\xF2","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}yield this._UserGraphQLService.removeRoleFromUser(this.DetailUser().id,e),this.DetailUser.update(i=>K(O({},i),{roles:(i.roles||[]).filter(s=>(s.role?.id||s.roleId)!==e)})),this.updateFilterRole(),this._snackBar.open("X\xF3a vai tr\xF2 th\xE0nh c\xF4ng","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(e){console.error("Error removing role:",e),this._snackBar.open("L\u1ED7i khi x\xF3a vai tr\xF2","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}finally{this.isRemovingRole.set(!1)}})}goBack(){this._UserGraphQLService.clearCurrentUser(),this._ListuserComponent.drawer.close(),this._router.navigate(["/admin/user"])}trackByFn(t,e){return e.id}toggleEdit(){this.isEdit.update(t=>!t)}toggleDelete(){this.isDelete.update(t=>!t)}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=D({type:n,selectors:[["app-detailuser"]],decls:13,vars:6,consts:[["menuTrigger","matMenuTrigger"],["menu","matMenu"],[1,"flex","flex-row","justify-between","items-center","space-x-2","p-2"],["mat-icon-button","","color","primary",3,"click"],[1,"font-bold"],[1,"flex","flex-row","space-x-2","items-center"],["mat-icon-button","","color","primary",3,"click",4,"ngIf"],["mat-icon-button","","color","warn",3,"click",4,"ngIf"],[1,"relative","flex","flex-col","w-full","p-4","overflow-auto"],[4,"ngIf"],["mat-icon-button","","color","warn",3,"click"],[1,"flex","flex-col","space-y-4","items-center","justify-center"],[1,"font-bold","text-2xl"],[1,"flex","flex-row","space-x-2","items-center","justify-center"],["mat-flat-button","","color","primary",3,"click"],["mat-flat-button","","color","warn",3,"click"],[1,"w-full","flex","flex-col","space-y-2"],["appearance","outline"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp Email",3,"ngModelChange","ngModel","disabled"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp H\u1ECD V\xE0 T\xEAn",3,"input","value","disabled"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i",3,"ngModelChange","ngModel","disabled"],["matInput","","type","password","placeholder","Vui l\xF2ng nh\u1EADp M\u1EADt kh\u1EA9u",3,"ngModelChange","ngModel","disabled"],[1,"w-full","flex","flex-wrap","gap-2","space-x-2"],["mat-flat-button","","color","primary",1,"mt-2","flex","items-center",3,"disabled","matMenuTriggerFor"],[1,"mb-4"],[1,"bg-blue-50"],[1,"text-sm","font-medium","flex","items-center"],[1,"mr-2","text-blue-500"],[1,"flex","flex-row","flex-wrap","gap-2"],[1,"text-center","text-gray-500","py-4"],[1,"cursor-pointer","flex","flex-col","space-y-4","p-3",3,"click"],[1,"relative","w-full"],["type","text","placeholder","T\xECm Ki\u1EBFm...",1,"block","w-full","pl-10","pr-4","py-2","text-gray-700","bg-white","border","border-gray-300","rounded-lg","focus:border-blue-400","focus:ring-blue-400","focus:outline-none","focus:ring","focus:ring-opacity-40",3,"keyup"],[1,"absolute","inset-y-0","left-0","flex","items-center","pl-3","pointer-events-none"],[1,"material-symbols-outlined","text-gray-500"],[1,"w-full","flex","flex-col","space-y-2","max-h-44","overflow-auto"],["mat-menu-item",""],[1,"flex","flex-row","space-x-2","items-center","justify-end"],["class","mt-8",4,"ngIf"],[1,"bg-blue-100"],[1,"flex","items-center"],[1,"mr-2"],[1,"animate-spin","text-gray-500","text-sm"],["color","warn",1,"text-sm","hover:text-red-600",3,"cursor"],["color","warn",1,"text-sm","hover:text-red-600",3,"click"],[1,"text-gray-400"],[1,"text-sm","mt-1"],["mat-stroked-button","","color","primary",1,"mt-2","flex","items-center",3,"matMenuTriggerFor"],["mat-menu-item","",3,"click"],[1,"mt-8"],[1,"border-t","pt-6"],[3,"userId","user",4,"ngIf"],["class","p-8 text-center",4,"ngIf"],[3,"userId","user"],[1,"p-8","text-center"],[1,"animate-spin","text-4xl","text-gray-400"],[1,"text-lg","text-gray-500","mt-4"],[1,"text-center","text-gray-500","py-8"],[1,"text-4xl","text-gray-400"],[1,"mt-2"],[1,"text-xs"]],template:function(e,i){if(e&1&&(o(0,"div",2)(1,"button",3),h("click",function(){return i.goBack()}),o(2,"mat-icon"),a(3,"arrow_back"),r()(),o(4,"div",4),a(5),r(),o(6,"div",5),_(7,pi,3,0,"button",6)(8,_i,3,0,"button",6)(9,gi,3,0,"button",7),r()(),o(10,"div",8),_(11,fi,9,0,"ng-container",9)(12,Ri,50,14,"ng-container",9),r()),e&2){let s;m(5),b(((s=i.DetailUser())==null?null:s.email)||"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"),m(2),p("ngIf",i.isEdit()&&i.DetailUser()),m(),p("ngIf",!i.isEdit()&&i.DetailUser()),m(),p("ngIf",i.DetailUser()),m(2),p("ngIf",i.isDelete()),m(),p("ngIf",!i.isDelete()&&i.DetailUser())}},dependencies:[ce,de,me,pe,ue,le,oe,se,ae,A,F,k,I,ne,_e,z,T,q,mt,ze,qe,Ge,Qe,H,W,j,$,N,Q,B,ct,dt,ye],styles:[".permission-management[_ngcontent-%COMP%]{border-left:4px solid #4caf50}.permission-management[_ngcontent-%COMP%]   mat-card-header[_ngcontent-%COMP%]{padding-bottom:8px}.permission-management[_ngcontent-%COMP%]   mat-card-content[_ngcontent-%COMP%]{font-size:12px}"]})};export{Ct as DetailUserComponent};
