import{a as $}from"./chunk-G5IIQAME.js";import{a as G}from"./chunk-MXRERSWW.js";import{a as B}from"./chunk-JNVUT6FC.js";import{a as P}from"./chunk-IXY23C6B.js";import{c as L}from"./chunk-PWU56VV4.js";import{a as w}from"./chunk-H7UDLENL.js";import{a as _}from"./chunk-RQQ6YENK.js";import{a as D}from"./chunk-VXBHOSYZ.js";import{a as b}from"./chunk-RHYJKD3I.js";import{Ra as h,ja as f,pa as g}from"./chunk-WYL4U5YK.js";import{a as y,b as S,g as E,j as o}from"./chunk-6DYNGEAS.js";var v=E(B());var I=class m{_GraphqlService=g(b);_StorageService=g(_);_router=g(L);_snackBar=g(D);_ErrorLogService=g(P);_sharedSocketService=g(G);_donhangService=g($);socket;ListDonhang=h([]);ListVandon=h([]);DetailDonhang=h({});page=h(1);totalPages=h(1);total=h(0);pageSize=h(50);donhangId=h(null);loading=h(!1);error=h(null);constructor(){this.socket=this._sharedSocketService.getSocket(),this.socket?.on("donhang:updated",n=>{this.refreshDonhangData()})}setDonhangId(n){this.donhangId.set(n),n&&this.getOneDonhang(n)}searchDonhang(n){return o(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t={};n.Batdau&&n.Ketthuc&&(t.ngaygiao={gte:(0,v.default)(n.Batdau).startOf("day").toISOString(),lte:(0,v.default)(n.Ketthuc).endOf("day").toISOString()}),n.Status&&(t.status=n.Status);let r=yield this._GraphqlService.findMany("donhang",{where:t,include:{khachhang:{select:{id:!0,name:!0,sdt:!0,diachi:!0}},sanpham:{select:{id:!0,idSP:!0,sldat:!0,slgiao:!0,slnhan:!0,slhuy:!0,ttdat:!0,ttgiao:!0,ttnhan:!0,ghichu:!0,order:!0,isActive:!0,giaban:!0,ttsauvat:!0,vat:!0,sanpham:{select:{id:!0,masp:!0,title:!0,giagoc:!0,dvt:!0}}}}},orderBy:{createdAt:"desc"},take:n.pageSize||9999});this.ListDonhang.set(r||[]);let e=this.createVandonList(r||[]);return this.ListVandon.set(e),this.loading.set(!1),r}catch(t){throw this.error.set(t.message||"L\u1ED7i khi t\u1EA3i d\u1EEF li\u1EC7u \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i t\xECm ki\u1EBFm \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),t}})}createVandonList(n){return n.flatMap((t,r)=>(t.sanpham||[]).map(e=>({id:e.id,idSP:e.idSP,sldat:e.sldat,slgiao:e.slgiao,slnhan:e.slnhan,slhuy:e.slhuy,ttdat:e.ttdat,ttgiao:e.ttgiao,ttnhan:e.ttnhan,ghichu:e.ghichu,order:e.order,isActive:e.isActive,giaban:e.giaban,ttsauvat:e.ttsauvat,vat:e.vat,masp:e.sanpham?.masp,title:e.sanpham?.title,giagoc:e.sanpham?.giagoc,dvt:e.sanpham?.dvt,madonhang:t.madonhang,khachhang:t.khachhang?.name,sdt:t.khachhang?.sdt,diachi:t.khachhang?.diachi,createdAt:t.createdAt,ngaygiao:t.ngaygiao,status:t.status,shipper:t.shipper,phieuve:t.phieuve,giodi:t.giodi,giove:t.giove,kynhan:t.kynhan}))).map((t,r)=>S(y({},t),{stt:r+1}))}getOneDonhang(n){return o(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t=yield this._GraphqlService.findUnique("donhang",{id:n},{include:{khachhang:{select:{id:!0,name:!0,sdt:!0,diachi:!0,email:!0}},sanpham:{select:{id:!0,idSP:!0,sldat:!0,slgiao:!0,slnhan:!0,slhuy:!0,ttdat:!0,ttgiao:!0,ttnhan:!0,ghichu:!0,order:!0,isActive:!0,giaban:!0,ttsauvat:!0,vat:!0,sanpham:{select:{id:!0,masp:!0,title:!0,giagoc:!0,dvt:!0}}}},user:{select:{id:!0,email:!0,profile:{select:{name:!0}}}}}});return this.DetailDonhang.set(t||{}),this.loading.set(!1),t}catch(t){throw this.error.set(t.message||"L\u1ED7i khi t\u1EA3i chi ti\u1EBFt \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i l\u1EA5y chi ti\u1EBFt \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),t}})}CreateDonhang(n){return o(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t={madonhang:n.madonhang||this.generateMaDonhang(),status:n.status||"dadat",tongtien:n.tongtien||0,khachhangId:n.khachhangId,ngaygiao:n.ngaygiao?new Date(n.ngaygiao).toISOString():null,ghichu:n.ghichu||"",order:n.order||1,isActive:n.isActive!==void 0?n.isActive:!0},r=yield this._GraphqlService.createOne("donhang",t);return yield this.refreshDonhangData(),this._snackBar.open("T\u1EA1o \u0111\u01A1n h\xE0ng th\xE0nh c\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.loading.set(!1),r}catch(t){throw this.error.set(t.message||"L\u1ED7i khi t\u1EA1o \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i t\u1EA1o \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),this._snackBar.open("L\u1ED7i khi t\u1EA1o \u0111\u01A1n h\xE0ng: "+t.message,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}})}updateDonhang(n){return o(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t={madonhang:n.madonhang,status:n.status,tongtien:n.tongtien,khachhangId:n.khachhangId,ngaygiao:n.ngaygiao?new Date(n.ngaygiao).toISOString():null,ghichu:n.ghichu,order:n.order,isActive:n.isActive},r=yield this._GraphqlService.updateOne("donhang",{id:n.id},t);return yield this.refreshDonhangData(),this._snackBar.open("C\u1EADp nh\u1EADt \u0111\u01A1n h\xE0ng th\xE0nh c\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.loading.set(!1),r}catch(t){throw this.error.set(t.message||"L\u1ED7i khi c\u1EADp nh\u1EADt \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i c\u1EADp nh\u1EADt \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),this._snackBar.open("L\u1ED7i khi c\u1EADp nh\u1EADt \u0111\u01A1n h\xE0ng: "+t.message,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}})}deleteDonhang(n){return o(this,null,function*(){try{this.loading.set(!0),this.error.set(null),yield this._GraphqlService.deleteOne("donhang",{id:n}),yield this.refreshDonhangData(),this._snackBar.open("X\xF3a \u0111\u01A1n h\xE0ng th\xE0nh c\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.loading.set(!1)}catch(t){throw this.error.set(t.message||"L\u1ED7i khi x\xF3a \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),this._snackBar.open("L\u1ED7i khi x\xF3a \u0111\u01A1n h\xE0ng: "+t.message,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}})}refreshDonhangData(){return o(this,null,function*(){this.ListDonhang().length>0&&(yield this.searchDonhang({pageSize:9999}))})}generateMaDonhang(){let n=new Date().getTime(),t=Math.floor(Math.random()*1e3);return`DH${n}${t}`}exportVandonToExcel(n){return o(this,null,function*(){try{let t=n||this.ListVandon(),r=this._donhangService.ListDonhang();if(t.length===0&&r.length===0){this._snackBar.open("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u \u0111\u1EC3 xu\u1EA5t","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-warning"]});return}let e=t.map((a,i)=>({STT:i+1,"M\xE3 \u0110\u01A1n H\xE0ng":a.madonhang||"","Kh\xE1ch H\xE0ng":a.khachhang||"","T\xEAn S\u1EA3n Ph\u1EA9m":a.title||"","\u0110\u01A1n V\u1ECB T\xEDnh":a.dvt||"","SL \u0110\u1EB7t":Number(a.sldat)||0,"SL Giao":Number(a.slgiao)||0,"SL Nh\u1EADn":Number(a.slnhan)||0,"Ng\xE0y Giao":a.ngaygiao?new Date(a.ngaygiao).toLocaleDateString("vi-VN"):"","Tr\u1EA1ng Th\xE1i":this.getStatusLabel(a.status)||""})),s=r.map((a,i)=>({STT:i+1,"M\xE3 \u0110\u01A1n H\xE0ng":a.madonhang||"","Ng\xE0y Giao":a.ngaygiao?new Date(a.ngaygiao).toLocaleString("vi-VN"):"","T\xEAn Kh\xE1ch H\xE0ng":a.name||"","S\u1ED1 L\u01B0\u1EE3ng":a.soluongtt||0,Chuy\u1EBFn:a.chuyen||"","\u0110\u1ECBa Ch\u1EC9":a.diachi||"","Li\xEAn H\u1EC7":"","S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i":a.sdt||"","Gi\u1EDD Nh\u1EADn H\xE0ng":a.gionhanhang||"","T\u1ED5ng S\u1ED1 M\xF3n":a.tongsomon||0,"S\u1ED1 L\u01B0\u1EE3ng TT":a.loadpoint||0,Shipper:a.shipper||"","Phi\u1EBFu V\u1EC1":a.phieuve||"","Gi\u1EDD \u0110i":a.giodi||"","Gi\u1EDD V\u1EC1":a.giove||"","K\xFD Nh\u1EADn":a.kynhan||""})),{writeExcelFileSheets:u}=yield import("./chunk-VGXD64E4.js"),d=`VanDon_PhieuChuyen_${new Date().toISOString().slice(0,10)}`;u({"V\u1EADn \u0110\u01A1n":{data:e},"Phi\u1EBFu Chuy\u1EC3n":{data:s}},d),this._snackBar.open("Xu\u1EA5t Excel th\xE0nh c\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(t){yield this._ErrorLogService.logError(`L\u1ED7i xu\u1EA5t Excel v\u1EADn \u0111\u01A1n: ${t.message||t}`),this._snackBar.open("L\u1ED7i khi xu\u1EA5t Excel: "+t.message,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}})}getStatusLabel(n){return{dadat:"\u0110\xE3 \u0110\u1EB7t",dagiao:"\u0110\xE3 Giao",danhan:"\u0110\xE3 Nh\u1EADn",hoanthanh:"Ho\xE0n Th\xE0nh",huy:"H\u1EE7y"}[n]||n}importPhieuChuyenFromExcel(n){return o(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t=0,r=0,e=[],s=n.length;console.log(`[IMPORT] B\u1EAFt \u0111\u1EA7u import ${s} d\xF2ng...`),this._snackBar.open(`\u23F3 \u0110ang x\u1EED l\xFD 0/${s}...`,"",{duration:void 0,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-info"]});for(let a=0;a<n.length;a++){let i=n[a];if(a%10===0||a===s-1){let c=Math.round((a+1)/s*100);this._snackBar.open(`\u23F3 \u0110ang x\u1EED l\xFD ${a+1}/${s} (${c}%)...`,"",{duration:void 0,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-info"]})}try{let c=i["M\xE3 \u0110\u01A1n H\xE0ng"]?.toString().trim();if(!c){console.warn(`[IMPORT] D\xF2ng ${a+1}: B\u1ECF qua - kh\xF4ng c\xF3 m\xE3 \u0111\u01A1n h\xE0ng`);continue}let p=yield this._GraphqlService.findFirst("donhang",{where:{madonhang:c}});if(!p){e.push(`${c}: Kh\xF4ng t\xECm th\u1EA5y`),r++;continue}let l={};i.Shipper&&(l.shipper=i.Shipper.toString().trim()),i["Phi\u1EBFu V\u1EC1"]&&(l.phieuve=i["Phi\u1EBFu V\u1EC1"].toString().trim()),i["Gi\u1EDD \u0110i"]&&(l.giodi=i["Gi\u1EDD \u0110i"].toString().trim()),i["Gi\u1EDD V\u1EC1"]&&(l.giove=i["Gi\u1EDD V\u1EC1"].toString().trim()),i["K\xFD Nh\u1EADn"]&&(l.kynhan=i["K\xFD Nh\u1EADn"].toString().trim()),Object.keys(l).length>0&&(yield this._GraphqlService.updateOne("donhang",{id:p.id},l),t++)}catch(c){let p=i.STT||a+1;e.push(`D\xF2ng ${p}: ${c.message}`),r++}}console.log("[IMPORT] \u0110ang x\xF3a cache...");let u=this._StorageService.getItem("token");u&&(yield fetch(`${w.APIURL}/cache/invalidate/donhang`,{method:"POST",headers:{Authorization:`Bearer ${u}`}})),console.log("[IMPORT] \u0110ang l\xE0m m\u1EDBi d\u1EEF li\u1EC7u..."),yield this.refreshDonhangData(),this.loading.set(!1);let d=r>0?"\u26A0\uFE0F":"\u2705",k=r>0?`${d} ${t} th\xE0nh c\xF4ng, ${r} l\u1ED7i`:`${d} Import th\xE0nh c\xF4ng ${t} \u0111\u01A1n h\xE0ng`;return this._snackBar.open(k,"\u0110\xF3ng",{duration:4e3,horizontalPosition:"end",verticalPosition:"top",panelClass:r>0?["snackbar-warning"]:["snackbar-success"]}),e.length>0&&(console.warn("[IMPORT] L\u1ED7i:",e.slice(0,10)),e.length>10&&console.warn(`[IMPORT] ... v\xE0 ${e.length-10} l\u1ED7i kh\xE1c`)),{success:t,error:r,total:s}}catch(t){throw this.error.set(t.message||"L\u1ED7i import"),this.loading.set(!1),yield this._ErrorLogService.logError(`Import error: ${t.message||t}`),this._snackBar.open(`\u274C ${t.message}`,"\u0110\xF3ng",{duration:4e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}})}getStatistics(n){return o(this,null,function*(){try{let t={};n?.Batdau&&n?.Ketthuc&&(t.createdAt={gte:new Date(n.Batdau).toISOString(),lte:new Date(n.Ketthuc).toISOString()});let r=yield this._GraphqlService.findMany("donhang",{where:t,select:{id:!0}}),e=yield this._GraphqlService.findMany("donhang",{where:S(y({},t),{status:"hoanthanh"}),select:{id:!0}}),s=yield this._GraphqlService.findMany("donhang",{where:S(y({},t),{status:"huy"}),select:{id:!0}});return{total:r?.length||0,completed:e?.length||0,cancelled:s?.length||0,pending:(r?.length||0)-(e?.length||0)-(s?.length||0)}}catch(t){return console.error("Error getting statistics:",t),{total:0,completed:0,cancelled:0,pending:0}}})}quickSearch(n){return o(this,null,function*(){try{this.loading.set(!0);let t=yield this._GraphqlService.findMany("donhang",{where:{OR:[{madonhang:{contains:n,mode:"insensitive"}},{khachhang:{name:{contains:n,mode:"insensitive"}}},{khachhang:{sdt:{contains:n}}}]},include:{khachhang:{select:{id:!0,name:!0,sdt:!0,diachi:!0}},sanpham:{select:{id:!0,idSP:!0,sldat:!0,slgiao:!0,slnhan:!0,slhuy:!0,ttdat:!0,ttgiao:!0,ttnhan:!0,ghichu:!0,order:!0,isActive:!0,giaban:!0,ttsauvat:!0,vat:!0,sanpham:{select:{id:!0,masp:!0,title:!0,giagoc:!0,dvt:!0}}}}},orderBy:{createdAt:"desc"},take:100});this.ListDonhang.set(t||[]);let r=this.createVandonList(t||[]);return this.ListVandon.set(r),this.loading.set(!1),t}catch(t){throw this.error.set(t.message||"L\u1ED7i khi t\xECm ki\u1EBFm"),this.loading.set(!1),t}})}static \u0275fac=function(t){return new(t||m)};static \u0275prov=f({token:m,factory:m.\u0275fac,providedIn:"root"})};export{I as a};
