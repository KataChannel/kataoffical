import{a as ke}from"./chunk-BDDAWAYV.js";import{a as ye}from"./chunk-QHCPJI62.js";import{a as fe,b as at}from"./chunk-NULFSBS2.js";import{a as ue}from"./chunk-3RLVAOOD.js";import{a as de}from"./chunk-SR7RCIEL.js";import{a as O,b as Jt}from"./chunk-EQHO5CVZ.js";import{b as Ut}from"./chunk-5NC4P5UG.js";import{a as Wt}from"./chunk-AGNKQBAM.js";import{a as et}from"./chunk-ZW44ZSN2.js";import{a as wt,b as vt,c as bt}from"./chunk-P7BBNZNS.js";import{a as Lt,b as Mt,c as It,d as Dt}from"./chunk-LECLUHD2.js";import{a as xt}from"./chunk-IE4L6KDU.js";import{c as ge,g as pe}from"./chunk-35TLWMLN.js";import{a as H,b as Yt,c as Zt}from"./chunk-N2KOTR2C.js";import{c as At,d as Nt,f as $t,h as zt}from"./chunk-ILGJOBJG.js";import{a as ft}from"./chunk-H7UDLENL.js";import{a as R}from"./chunk-Q3KOS33T.js";import{b as dt,c as G}from"./chunk-OJMQSPC3.js";import{b as _e}from"./chunk-OZW3KHHG.js";import{a as Qt,b as Xt,c as te,d as ee,e as ie,g as ae,h as ne,j as re,k as oe,m as se,n as le,p as he,q as ce,r as me,s as it}from"./chunk-LXFX5R3F.js";import{b as jt}from"./chunk-KJ3ORMDZ.js";import{b as Ft,g as Tt,j as Pt,n as Bt,p as Vt,r as qt,v as Gt,w as Rt,y as Ot,z as Ht}from"./chunk-M2YCC4SP.js";import{a as Et,b as Kt}from"./chunk-PYCEOLIX.js";import{a as yt,c as Ct,e as St}from"./chunk-BAEDUNPT.js";import{y as _t,z as kt}from"./chunk-DL37TIRW.js";import{m as gt,r as pt,v as ut}from"./chunk-GKGVKDD5.js";import{$b as A,Cc as F,Db as rt,Dc as c,Ec as T,Fc as v,Hc as ct,Ic as Q,Jc as X,Kb as E,Kc as J,Mc as V,Ra as x,Sc as Y,Ub as y,Uc as Z,Yb as ot,Yc as tt,bc as st,cc as U,dc as W,ec as o,fc as s,gc as D,hc as lt,ic as ht,ja as nt,kc as K,kd as mt,md as q,pa as S,pc as C,rb as m,rc as p,xc as N,ya as _,yc as $,za as k,zc as z}from"./chunk-OL5DVADB.js";import{a as L,b as P,h as B,j as f}from"./chunk-6DYNGEAS.js";var j=class n{_GraphqlService=S(ye);_StorageService=S(xt);_router=S(G);_snackBar=S(R);_ErrorLogService=S(Wt);_sharedSocketService=S(ke);socket;ListKhachhang=x([]);DetailKhachhang=x({});page=x(1);totalPages=x(1);total=x(0);pageSize=x(50);khachhangId=x(null);loading=x(!1);error=x(null);constructor(){this.socket=this._sharedSocketService.getSocket(),this.listenKhachhangUpdates()}setKhachhangId(e){this.khachhangId.set(e)}getAllKhachhang(){return f(this,arguments,function*(e={}){try{this.loading.set(!0),this.error.set(null);let t={id:!0,makh:!0,name:!0,diachi:!0,quan:!0,email:!0,sdt:!0,mst:!0,gionhanhang:!0,loaikh:!0,ghichu:!0,isActive:!0,createdAt:!0,banggiaId:!0,banggia:{select:{id:!0,title:!0,mabanggia:!0}}},i={isActive:!0};e.subtitle&&(i.OR=[{name:{contains:e.subtitle,mode:"insensitive"}},{makh:{contains:e.subtitle,mode:"insensitive"}},{email:{contains:e.subtitle,mode:"insensitive"}},{sdt:{contains:e.subtitle,mode:"insensitive"}}]),e.loaikh&&(i.loaikh=e.loaikh),e.banggiaId&&(i.banggiaId=e.banggiaId);let a={createdAt:"desc"},r=yield this._GraphqlService.findMany("khachhang",{where:i,orderBy:a,select:t}),g=r?.length||0;return this.ListKhachhang.set(r||[]),this.total.set(g),this.totalPages.set(1),this.page.set(1),r}catch(t){throw console.error("L\u1ED7i khi l\u1EA5y danh s\xE1ch kh\xE1ch h\xE0ng:",t),this.error.set("Kh\xF4ng th\u1EC3 t\u1EA3i danh s\xE1ch kh\xE1ch h\xE0ng"),this._ErrorLogService.logError("getAllKhachhang",t),t}finally{this.loading.set(!1)}})}getKhachhangBy(e){return f(this,null,function*(){try{return yield this.getAllKhachhang(e)}catch(t){throw console.error("L\u1ED7i t\xECm ki\u1EBFm kh\xE1ch h\xE0ng:",t),t}})}getKhachhangById(e){return f(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t={banggia:{select:{id:!0,title:!0,mabanggia:!0,type:!0,status:!0}}},i=yield this._GraphqlService.findUnique("khachhang",{id:e},{include:t});return console.log(i),i&&(this.DetailKhachhang.set(i),this.setKhachhangId(e)),i}catch(t){throw console.error("L\u1ED7i khi l\u1EA5y chi ti\u1EBFt kh\xE1ch h\xE0ng:",t),this.error.set("Kh\xF4ng th\u1EC3 t\u1EA3i th\xF4ng tin kh\xE1ch h\xE0ng"),this._ErrorLogService.logError("getKhachhangById",t),t}finally{this.loading.set(!1)}})}createKhachhang(e){return f(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t={makh:e.makh||(yield this.generateMaKhachHang(e.loaikh)),subtitle:e.subtitle||"",tenfile:e.tenfile||"",name:e.name,diachi:e.diachi||"",quan:e.quan||"",email:e.email||"",sdt:e.sdt||"",mst:e.mst||"",gionhanhang:e.gionhanhang||"",loaikh:e.loaikh||"banle",ghichu:e.ghichu||"",isActive:e.isActive!==!1,isshowvat:e.isshowvat,hiengia:e.hiengia,istitle2:e.istitle2,banggiaId:e.banggiaId||null},i={banggia:{select:{id:!0,title:!0,mabanggia:!0}}},a=yield this._GraphqlService.createOne("khachhang",t,{include:i});return this.khachhangId.set(a.id),this.DetailKhachhang.set(a),yield this.getAllKhachhang(),this._snackBar.open("T\u1EA1o kh\xE1ch h\xE0ng th\xE0nh c\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),a}catch(t){throw console.error("L\u1ED7i t\u1EA1o kh\xE1ch h\xE0ng:",t),this.error.set("Kh\xF4ng th\u1EC3 t\u1EA1o kh\xE1ch h\xE0ng"),this._snackBar.open("L\u1ED7i t\u1EA1o kh\xE1ch h\xE0ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}finally{this.loading.set(!1)}})}updateKhachhang(e,t){return f(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let i={name:t.name,subtitle:t.subtitle,tenfile:t.tenfile,diachi:t.diachi,quan:t.quan,email:t.email,sdt:t.sdt,mst:t.mst,gionhanhang:t.gionhanhang,loaikh:t.loaikh,ghichu:t.ghichu,isActive:t.isActive,isshowvat:t.isshowvat,hiengia:t.hiengia,istitle2:t.istitle2,banggiaId:t.banggiaId},a={banggia:{select:{id:!0,title:!0,mabanggia:!0}}},r=yield this._GraphqlService.updateOne("khachhang",{id:e},i,{include:a});return this.DetailKhachhang.set(r),yield this.getAllKhachhang(),this._snackBar.open("C\u1EADp nh\u1EADt kh\xE1ch h\xE0ng th\xE0nh c\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),r}catch(i){throw console.error("L\u1ED7i c\u1EADp nh\u1EADt kh\xE1ch h\xE0ng:",i),this.error.set("Kh\xF4ng th\u1EC3 c\u1EADp nh\u1EADt kh\xE1ch h\xE0ng"),this._snackBar.open("L\u1ED7i c\u1EADp nh\u1EADt kh\xE1ch h\xE0ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),i}finally{this.loading.set(!1)}})}deleteKhachhang(e){return f(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t=yield this._GraphqlService.updateOne("khachhang",{id:e},{isActive:!1});return yield this.getAllKhachhang(),this._snackBar.open("X\xF3a kh\xE1ch h\xE0ng th\xE0nh c\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),t}catch(t){throw console.error("L\u1ED7i x\xF3a kh\xE1ch h\xE0ng:",t),this.error.set("Kh\xF4ng th\u1EC3 x\xF3a kh\xE1ch h\xE0ng"),this._snackBar.open("L\u1ED7i x\xF3a kh\xE1ch h\xE0ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}finally{this.loading.set(!1)}})}importKhachhang(e){return f(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t=e.map((h,d)=>P(L({},h),{index:d})),i=t.filter(h=>!h.makh),a=t.filter(h=>h.makh),r={};i.length>0&&(console.log(`Generating codes for ${i.length} customers...`),r=yield this.generateBatchMaKhachHang(i));let g=t.map(h=>({makh:h.makh||r[h.index]||`FALLBACK-${h.index}-${Date.now()}`,name:h.name,diachi:h.diachi||"",quan:h.quan||"",email:h.email||"",sdt:h.sdt||"",mst:h.mst||"",gionhanhang:h.gionhanhang||"",loaikh:h.loaikh||"banle",ghichu:h.ghichu||"",isActive:h.isActive!==!1,banggiaId:h.banggiaId||null}));console.log(`Creating ${g.length} customers...`);let l=yield this._GraphqlService.batchCreate("khachhang",g);return yield this.getAllKhachhang(),this._snackBar.open(`Import th\xE0nh c\xF4ng ${l.length} kh\xE1ch h\xE0ng`,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),l}catch(t){throw console.error("L\u1ED7i import kh\xE1ch h\xE0ng:",t),this.error.set("Kh\xF4ng th\u1EC3 import kh\xE1ch h\xE0ng"),this._snackBar.open("L\u1ED7i import kh\xE1ch h\xE0ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}finally{this.loading.set(!1)}})}changePage(e,t){return f(this,null,function*(){return console.log("Pagination disabled - all data loaded"),this.ListKhachhang()})}listenKhachhangUpdates(){this.socket&&(this.socket.on("khachhang:created",e=>{let t=this.ListKhachhang();this.ListKhachhang.set([e,...t]),this.total.set(this.total()+1)}),this.socket.on("khachhang:updated",e=>{let t=this.ListKhachhang(),i=t.findIndex(a=>a.id===e.id);i!==-1&&(t[i]=e,this.ListKhachhang.set([...t])),this.khachhangId()===e.id&&this.DetailKhachhang.set(e)}),this.socket.on("khachhang:deleted",e=>{let i=this.ListKhachhang().filter(a=>a.id!==e.id);this.ListKhachhang.set(i),this.total.set(this.total()-1)}))}generateMaKhachHang(e="khachle",t=10){return f(this,null,function*(){let i=e==="khachsi"?"TG-KS":"TG-KL",a=0;for(;a<t;)try{let h=yield this._GraphqlService.findMany("khachhang",{where:{makh:{startsWith:i}},orderBy:{makh:"desc"},select:{makh:!0},take:1}),d=1;if(h&&h.length>0&&h[0].makh){let w=parseInt(h[0].makh.slice(i.length),10);isNaN(w)||(d=w+1)}d+=a;let u=`${i}${d.toString().padStart(5,"0")}`,I=yield this._GraphqlService.findMany("khachhang",{where:{makh:u},select:{id:!0},take:1});if(!I||I.length===0)return console.log(`Generated unique customer code: ${u} (attempt ${a+1})`),u;console.warn(`Customer code ${u} already exists, retrying... (attempt ${a+1})`),a++}catch(h){if(console.error(`Error generating customer code (attempt ${a+1}):`,h),a++,a>=t)break;yield new Promise(d=>setTimeout(d,100*a))}console.warn("Max retries reached, using fallback generation method");let r=Date.now().toString(36),g=Math.random().toString(36).substr(2,3),l=`${i}${r}${g}`.toUpperCase();try{let h=yield this._GraphqlService.findMany("khachhang",{where:{makh:l},select:{id:!0},take:1});if(h&&h.length>0){let d=`${i}${r}${g}${Date.now().toString(36).slice(-2)}`.toUpperCase();return console.warn(`Fallback code collision, using: ${d}`),d}return l}catch{let d=`${i}${r}${g}${Date.now().toString(36).slice(-2)}`.toUpperCase();return console.error("Error checking fallback code, using ultimate fallback:",d),d}})}generateBatchMaKhachHang(e){return f(this,null,function*(){let t={},i=new Set;try{let a=e.filter(u=>u.loaikh==="khachsi"),r=e.filter(u=>u.loaikh!=="khachsi"),[g,l]=yield Promise.all([this._GraphqlService.findMany("khachhang",{where:{makh:{startsWith:"TG-KS"}},orderBy:{makh:"desc"},select:{makh:!0},take:1}),this._GraphqlService.findMany("khachhang",{where:{makh:{startsWith:"TG-KL"}},orderBy:{makh:"desc"},select:{makh:!0},take:1})]),h=1,d=1;if(g?.[0]?.makh){let u=parseInt(g[0].makh.slice(5),10);h=isNaN(u)?1:u+1}if(l?.[0]?.makh){let u=parseInt(l[0].makh.slice(5),10);d=isNaN(u)?1:u+1}for(let u=0;u<a.length;u++){let I=a[u],w=0,b;do b=`TG-KS${(h+u+w).toString().padStart(5,"0")}`,w++;while(i.has(b)&&w<100);i.add(b),t[I.index||u]=b}for(let u=0;u<r.length;u++){let I=r[u],w=0,b;do b=`TG-KL${(d+u+w).toString().padStart(5,"0")}`,w++;while(i.has(b)&&w<100);i.add(b),t[I.index||u+a.length]=b}return console.log(`Generated ${Object.keys(t).length} unique customer codes for batch import`),t}catch(a){console.error("Error in batch code generation, falling back to individual generation:",a);for(let r=0;r<e.length;r++){let g=e[r];try{let l=yield this.generateMaKhachHang(g.loaikh);t[g.index||r]=l}catch(l){console.error(`Failed to generate code for customer ${r}:`,l);let h=Date.now().toString(36),d=Math.random().toString(36).substr(2,3),u=g.loaikh==="khachsi"?"TG-KS":"TG-KL";t[g.index||r]=`${u}${h}${d}${r}`.toUpperCase()}}return t}})}getUpdatedCodeIds(){return f(this,null,function*(){try{return yield this._GraphqlService.findMany("khachhang",{where:{isActive:!0},select:{id:!0,makh:!0},orderBy:{updatedAt:"desc"},take:100})}catch(e){return console.error("L\u1ED7i l\u1EA5y updated code IDs:",e),[]}})}clearCache(){this.ListKhachhang.set([]),this.DetailKhachhang.set({}),this.khachhangId.set(null),this.error.set(null),this.page.set(1)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=nt({token:n,factory:n.\u0275fac,providedIn:"root"})};var we=["drawer"],ve=()=>[25,50,100,200,500],Ce=()=>({standalone:!0}),be=(n,e)=>e.key;function Ee(n,e){if(n&1){let t=K();o(0,"button",48),C("click",function(){_(t);let a=p(),r=F(81);return k(a.openDeleteDialog(r))}),o(1,"mat-icon"),c(2,"delete"),s(),o(3,"span",19),c(4,"Xo\xE1"),s()()}}function Ke(n,e){if(n&1){let t=K();o(0,"button",49),C("click",function(a){let r=_(t).$implicit;return p().toggleColumn(r),k(a.stopPropagation())}),o(1,"mat-icon"),c(2),s(),o(3,"span"),c(4),s()()}if(n&2){let t=e.$implicit;m(2),T(t.isShow?"check_box":"check_box_outline_blank"),m(2),T(t.value)}}function Le(n,e){if(n&1&&(o(0,"th",50)(1,"span"),c(2),s()()),n&2){let t=p(2).$implicit,i=p();m(2),T(i.ColumnName[t])}}function Me(n,e){n&1&&E(0,Le,3,1,"th",53)}function Ie(n,e){if(n&1){let t=K();o(0,"th",51)(1,"span",55),c(2),s(),o(3,"app-searchfilter",56),C("OutFilter",function(a){_(t);let r=p(3);return k(r.onOutFilter(a))}),s()()}if(n&2){let t=p(2).$implicit,i=p();m(2),v(" ",i.ColumnName[t]," "),m(),y("icon","filter_alt")("ListItem",i.Listkhachhang())("fieldsearch",t)("ListFilter",i.ListFilter)("filterItem",i.FilterHederColumn(i.dataSource.filteredData,t))}}function De(n,e){n&1&&E(0,Ie,4,6,"th",54)}function Fe(n,e){if(n&1){let t=K();o(0,"span",61),C("click",function(){_(t);let a=p().$implicit,r=p(2);return k(r.goToDetail(a))}),c(1),s()}if(n&2){let t=p().$implicit,i=p().$implicit;m(),v(" ",t[i]," ")}}function Te(n,e){if(n&1&&(o(0,"span",59),c(1),s()),n&2){let t=p().index;m(),v(" ",t+1," ")}}function Pe(n,e){if(n&1&&(o(0,"span",60),c(1),Y(2,"date"),s()),n&2){let t=p().$implicit,i=p().$implicit;m(),v(" ",Z(2,1,t[i],"dd/MM/yyyy")," ")}}function Be(n,e){if(n&1&&(o(0,"span",60),c(1),s()),n&2){let t=p().$implicit,i=p().$implicit;m(),v(" ",t[i]==null?null:t[i].mabanggia," ")}}function Ae(n,e){if(n&1&&(o(0,"span",60),c(1),s()),n&2){let t=p().$implicit,i=p().$implicit;m(),v(" ",t[i],"% ")}}function Ne(n,e){n&1&&(o(0,"mat-icon",62),c(1,"check_circle"),s())}function $e(n,e){n&1&&(o(0,"mat-icon",63),c(1,"cancel"),s())}function ze(n,e){if(n&1&&(o(0,"span",60),E(1,Ne,2,0,"mat-icon",62)(2,$e,2,0,"mat-icon",63),s()),n&2){let t=p().$implicit,i=p().$implicit;m(),A(t[i]?1:2)}}function Ve(n,e){if(n&1&&(o(0,"span",60),c(1),Y(2,"date"),s()),n&2){let t=p().$implicit,i=p().$implicit;m(),v(" ",Z(2,1,t[i],"dd/MM/yyyy")," ")}}function qe(n,e){if(n&1&&(o(0,"span",60),c(1),s()),n&2){let t=p().$implicit,i=p().$implicit;m(),v(" ",t[i]," ")}}function Ge(n,e){if(n&1&&(o(0,"td",57),E(1,Fe,2,1,"span",58)(2,Te,2,1,"span",59)(3,Pe,3,4,"span",60)(4,Be,2,1,"span",60)(5,Ae,2,1,"span",60)(6,ze,3,1,"span",60)(7,Ve,3,4,"span",60)(8,qe,2,1,"span",60),s()),n&2){let t,i=p().$implicit;m(),A((t=i)==="makh"?1:t==="stt"?2:t==="createdAt"?3:t==="banggia"?4:t==="haohut"?5:t==="isActive"?6:t==="updatedAt"?7:8)}}function Re(n,e){if(n&1&&(lt(0,32),E(1,Me,1,0,"th",50)(2,De,1,0,"th",51)(3,Ge,9,1,"td",52),ht()),n&2){let t=e.$implicit;y("matColumnDef",t),m(),A(t=="stt"?1:2)}}function Oe(n,e){n&1&&D(0,"tr",64)}function He(n,e){if(n&1){let t=K();o(0,"tr",65),C("click",function(){let a=_(t).$implicit,r=p();return k(r.AddToEdit(a))}),s()}if(n&2){let t=e.$implicit,i=p();ot("hover:bg-slate-50 ",i.CheckItemInEdit(t)?"!bg-blue-50":"","")}}function je(n,e){n&1&&(o(0,"tr",66)(1,"td",67),c(2,"Kh\xF4ng t\xECm th\u1EA5y"),s()())}function Ue(n,e){n&1&&(o(0,"mat-dialog-content")(1,"div",68)(2,"div",69),c(3,"X\xE1c Nh\u1EADn"),s(),o(4,"div"),c(5,"B\u1EA1n ch\u1EAFc ch\u1EAFn mu\u1ED1n xo\xE1 kh\xF4ng?"),s(),o(6,"div",70)(7,"button",71),c(8,"\u0110\u1ED3ng \xDD"),s(),o(9,"button",72),c(10,"Hu\u1EF7 B\u1ECF"),s()()()())}function We(n,e){if(n&1){let t=K();o(0,"mat-dialog-content",73)(1,"div",74)(2,"mat-form-field",23)(3,"mat-label"),c(4,"IdSheet"),s(),o(5,"input",75),J("ngModelChange",function(a){_(t);let r=p();return X(r.IdSheet,a)||(r.IdSheet=a),k(a)}),s()(),o(6,"mat-form-field",23)(7,"mat-label"),c(8,"SheetName"),s(),o(9,"input",76),J("ngModelChange",function(a){_(t);let r=p();return X(r.SheetName,a)||(r.SheetName=a),k(a)}),s()()(),D(10,"div",77),o(11,"div",78)(12,"button",71),c(13,"\u0110\u1ED3ng \xDD"),s(),o(14,"button",72),c(15,"Hu\u1EF7 B\u1ECF"),s()()()}if(n&2){let t=p();m(5),Q("ngModel",t.IdSheet),y("ngModelOptions",V(4,Ce)),m(4),Q("ngModel",t.SheetName),y("ngModelOptions",V(5,Ce))}}var M=class M{displayedColumns=[];ColumnName={stt:"#",makh:"M\xE3 KH",name:"T\xEAn KH",banggia:"B\u1EA3ng Gi\xE1",diachi:"\u0110\u1ECBa Ch\u1EC9",quan:"Qu\u1EADn",email:"Email",sdt:"SDT",mst:"MST",gionhanhang:"Gi\u1EDD Nh\u1EADn H\xE0ng",loaikh:"Lo\u1EA1i KH",ghichu:"Ghi Ch\xFA",isActive:"Tr\u1EA1ng Th\xE1i",createdAt:"Ng\xE0y T\u1EA1o"};FilterColumns=JSON.parse(localStorage.getItem("KhachhangColFilter")||"[]");Columns=[];paginator;sort;drawer;_KhachhangService=S(j);_breakpointObserver=S(_t);_GoogleSheetService=S(ue);_router=S(G);_dialog=S(At);_snackBar=S(R);Listkhachhang=this._KhachhangService.ListKhachhang;page=this._KhachhangService.page;totalPages=this._KhachhangService.totalPages;total=this._KhachhangService.total;pageSize=this._KhachhangService.pageSize;khachhangId=this._KhachhangService.khachhangId;loading=this._KhachhangService.loading;error=this._KhachhangService.error;dataSource=new it([]);EditList=[];isSearch=x(!1);searchParam={};paginationInfo=mt(()=>{let e=this.paginator;return e?{currentPage:e.pageIndex+1,totalPages:Math.ceil(e.length/e.pageSize),pageSize:e.pageSize,totalRecords:e.length,displayStart:e.length===0?0:e.pageIndex*e.pageSize+1,displayEnd:Math.min((e.pageIndex+1)*e.pageSize,e.length)}:null});constructor(){q(()=>{let e=this.Listkhachhang();e&&e.length>0&&(this.dataSource.data=e,this.dataSource.sort=this.sort,this.paginator&&(this.paginator.pageIndex=0,this.paginator.pageSize=50,this.paginator.length=e.length,this.paginator.pageSizeOptions=[25,50,100,200,500],this.paginator.showFirstLastButtons=!0))}),q(()=>{let e=this.error();e&&this._snackBar.open(e,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}),q(()=>{this.loading()&&console.log("Loading kh\xE1ch h\xE0ng...")})}ngOnInit(){return f(this,null,function*(){this.initializeColumns(),this.setupDrawer();try{yield this._KhachhangService.getAllKhachhang(this.searchParam);let e=this.Listkhachhang();this.dataSource=new it(e),this.dataSource.sort=this.sort,this.dataSource.paginator=this.paginator,this.dataSource.sortingDataAccessor=(t,i)=>{switch(i){case"banggia":return t.banggia?.title||"";case"createdAt":case"updatedAt":return new Date(t[i]);default:return t[i]||""}}}catch(e){console.error("L\u1ED7i khi load d\u1EEF li\u1EC7u kh\xE1ch h\xE0ng:",e),this._snackBar.open("Kh\xF4ng th\u1EC3 t\u1EA3i d\u1EEF li\u1EC7u kh\xE1ch h\xE0ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}})}initializeColumns(){this.Columns=Object.entries(this.ColumnName).map(([e,t])=>({key:e,value:t,isShow:!0})),this.FilterColumns=this.FilterColumns.length?this.FilterColumns:this.Columns,localStorage.setItem("KhachhangColFilter",JSON.stringify(this.FilterColumns)),this.displayedColumns=this.FilterColumns.filter(e=>e.isShow).map(e=>e.key),this.ColumnName=this.FilterColumns.reduce((e,{key:t,value:i,isShow:a})=>a?P(L({},e),{[t]:i}):e,{})}applyFilter(e){return f(this,null,function*(){let t=e.target.value;if(t.length===0){this.dataSource.filter="";return}try{let i=et(t.trim().toLowerCase());this.dataSource.filterPredicate=(a,r)=>{let l=["makh","name","email","sdt","diachi","quan","loaikh","ghichu"].map(d=>d==="banggia"?a.banggia?.title||"":a[d]?a[d].toString():"").join(" ").toLowerCase(),h=et(l);return l.includes(r)||h.includes(r)},this.dataSource.filter=i,this.paginator&&this.paginator.firstPage()}catch(i){console.error("Error applying filter:",i),this._snackBar.open("L\u1ED7i khi t\xECm ki\u1EBFm","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}})}getUpdatedCodeIds(){return f(this,null,function*(){try{yield this._KhachhangService.getUpdatedCodeIds(),this._snackBar.open("C\u1EADp nh\u1EADt th\xE0nh c\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(e){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt:",e),this._snackBar.open("L\u1ED7i khi c\u1EADp nh\u1EADt","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}})}refreshData(){return f(this,null,function*(){try{yield this._KhachhangService.getAllKhachhang({}),this._snackBar.open("D\u1EEF li\u1EC7u \u0111\xE3 \u0111\u01B0\u1EE3c c\u1EADp nh\u1EADt","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(e){console.error("L\u1ED7i khi refresh d\u1EEF li\u1EC7u:",e),this._snackBar.open("Kh\xF4ng th\u1EC3 refresh d\u1EEF li\u1EC7u","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}})}setupDrawer(){this._breakpointObserver.observe([kt.Handset]).subscribe(e=>{e.matches?this.drawer.mode="over":this.drawer.mode="side"})}toggleColumn(e){let t=this.FilterColumns.find(i=>i.key===e.key);t&&(t.isShow=!t.isShow,this.updateDisplayedColumns())}FilterHederColumn(e,t){return e.filter((a,r,g)=>r===g.findIndex(l=>l[t]===a[t]))}doFilterHederColumn(e,t){this.dataSource.filteredData=this.Listkhachhang().filter(i=>i[t].toLowerCase().includes(e.target.value.toLowerCase()))}ListFilter=[];ChosenItem(e,t){let i=this.dataSource.filteredData.filter(r=>r[t]===e[t]);this.ListFilter.filter(r=>r[t]===e[t]).length>0?this.ListFilter=this.ListFilter.filter(r=>r[t]!==e[t]):this.ListFilter=[...this.ListFilter,...i]}ChosenAll(e){e.forEach(t=>{!!this.ListFilter.find(a=>a.id===t.id)?this.ListFilter=this.ListFilter.filter(a=>a.id!==t.id):this.ListFilter.push(t)})}ResetFilter(){this.ListFilter=this.Listkhachhang()}EmptyFiter(){this.ListFilter=[]}CheckItem(e){return!!this.ListFilter.find(t=>t.id===e.id)}ApplyFilterColum(e){this.dataSource.data=this.Listkhachhang().filter(t=>this.ListFilter.some(i=>i.id===t.id)),this.dataSource.paginator=this.paginator,this.dataSource.sort=this.sort,e.closeMenu()}onOutFilter(e){this.dataSource.data=e,this.dataSource.paginator=this.paginator,this.dataSource.sort=this.sort}updateDisplayedColumns(){this.displayedColumns=this.FilterColumns.filter(e=>e.isShow).map(e=>e.key),this.ColumnName=this.FilterColumns.reduce((e,t)=>(t.isShow&&(e[t.key]=t.value),e),{}),localStorage.setItem("KhachhangColFilter",JSON.stringify(this.FilterColumns))}doFilterColumns(e){let t=e.target.value.toLowerCase();this.FilterColumns=this.Columns.filter(i=>i.value.toLowerCase().includes(t))}create(){this.drawer.open(),this._router.navigate(["admin/khachhang","new"])}openDeleteDialog(e){this._dialog.open(e,{hasBackdrop:!0,disableClose:!0}).afterClosed().subscribe(i=>{i==="true"&&this.DeleteListItem()})}DeleteListItem(){this.EditList.forEach(e=>{this._KhachhangService.deleteKhachhang(e.id)}),this.EditList=[],this._snackBar.open("X\xF3a Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}AddToEdit(e){this.EditList.find(i=>i.id===e.id)?this.EditList=this.EditList.filter(i=>i.id!==e.id):this.EditList.push(e)}CheckItemInEdit(e){return this.EditList.some(t=>t.id===e.id)}goToDetail(e){this.drawer.open(),this._KhachhangService.setKhachhangId(e.id),this._router.navigate(["admin/khachhang",e.id])}OpenLoadDrive(e){}IdSheet="15npo25qyH5FmfcEjl1uyqqyFMS_vdFnmxM_kt0KYmZk";SheetName="SPImport";ImportIteam=[];ImportColumnName={};ImportdisplayedColumns=[];LoadDrive(){return f(this,null,function*(){let e={IdSheet:this.IdSheet,SheetName:this.SheetName,ApiKey:ft.GSApiKey},t=yield this._GoogleSheetService.getDrive(e);this.ImportIteam=Ut(t.values),this.ImportColumnName=Object.fromEntries(t.values[0].map((i,a)=>[i,t.values[1][a]])),this.ImportdisplayedColumns=t.values[0]})}DoImportData(e){return f(this,null,function*(){let t=e.map(l=>({title:l.title?.trim()||"",masp:l.masp?.trim()||"",giagoc:Number(l.giagoc)||0,dvt:l.dvt?.trim()||"",soluong:Number(l.soluong)||0,soluongkho:Number(l.soluongkho)||0,haohut:Number(l.haohut)||0,ghichu:l.ghichu?.trim()||""})),i=Array.from(new Map(t.map(l=>[l.masp,l])).values()),a=this._KhachhangService.ListKhachhang(),r=a.map(l=>l.masp),g=i.map(l=>l.masp).filter(l=>!r.includes(l));yield Promise.all(i.map(l=>f(this,null,function*(){let h=a.find(d=>d.masp===l.masp);if(h){let d=L(L({},h),l);yield this._KhachhangService.updateKhachhang(d.id,d)}else yield this._KhachhangService.createKhachhang(l)}))),yield Promise.all(a.filter(l=>!i.some(h=>h.masp===l.masp)).map(l=>this._KhachhangService.updateKhachhang(l.id,P(L({},l),{isActive:!1})))),this._snackBar.open("C\u1EADp Nh\u1EADt Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})})}ImporExcel(e){return f(this,null,function*(){let t=yield pe(e);this.DoImportData(t)})}ExportExcel(e,t){let i=e.map(a=>({title:a.title,masp:a.masp,giagoc:a.giagoc,dvt:a.dvt,soluong:a.soluong,soluongkho:a.soluongkho,haohut:a.haohut,ghichu:a.ghichu}));ge(i,t)}trackByFn(e,t){return t.id||e.toString()}trackByFilteredFn=(e,t)=>`${t.id}-${t.updatedAt||t.createdAt}`;getCurrentPage(){return this.paginator?this.paginator.pageIndex+1:1}getTotalPages(){return this.paginator?Math.ceil(this.paginator.length/this.paginator.pageSize):1}getCurrentPageSize(){return this.paginator?this.paginator.pageSize:50}getDisplayStart(){return!this.paginator||this.paginator.length===0?0:this.paginator.pageIndex*this.paginator.pageSize+1}getDisplayEnd(){if(!this.paginator||this.paginator.length===0)return 0;let e=(this.paginator.pageIndex+1)*this.paginator.pageSize;return Math.min(e,this.paginator.length)}getTotalRecords(){return this.paginator?this.paginator.length:0}canGoToPrevious(){return this.paginator?this.paginator.hasPreviousPage():!1}canGoToNext(){return this.paginator?this.paginator.hasNextPage():!1}onPageSizeChange(e,t){return f(this,null,function*(){if(e<1){this._snackBar.open("S\u1ED1 l\u01B0\u1EE3ng ph\u1EA3i l\u1EDBn h\u01A1n 0","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}this.paginator&&(this.paginator.pageSize=e,this.paginator.firstPage()),this._snackBar.open(`Hi\u1EC3n th\u1ECB ${e} items m\u1ED7i trang`,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),t.closeMenu()})}onPreviousPage(){return f(this,null,function*(){this.paginator&&this.paginator.hasPreviousPage()&&this.paginator.previousPage()})}onNextPage(){return f(this,null,function*(){this.paginator&&this.paginator.hasNextPage()&&this.paginator.nextPage()})}static \u0275fac=function(t){return new(t||M)};static \u0275cmp=rt({type:M,selectors:[["app-listkhachhang"]],viewQuery:function(t,i){if(t&1&&(N(O,5),N(H,5),N(we,7)),t&2){let a;$(a=z())&&(i.paginator=a.first),$(a=z())&&(i.sort=a.first),$(a=z())&&(i.drawer=a.first)}},decls:84,vars:22,consts:[["drawer",""],["menu","matMenu"],["paginator",""],["menuHienthi","matMenuTrigger"],["menu1","matMenu"],["pageSizeInput",""],["DeleteDialog",""],["LoadDriveDialog",""],["autosize","",1,"w-full","h-full"],["mode","over",1,"flex","flex-col","!w-full","h-full",3,"position"],[1,"flex","flex-col","space-y-2","h-screen-16","w-full","p-2"],[1,"p-2","cursor-pointer","w-full","relative","flex","lg:flex-row","lg:space-y-2","space-y-0","flex-col","space-x-2","justify-between","items-center","bg-white","rounded-lg"],[1,"w-full","flex","flex-col","gap-2","lg:flex-row","lg:items-center","lg:justify-between"],[1,"flex","flex-row","space-x-2","items-center"],[1,"relative","w-full"],["type","text","placeholder","T\xECm Ki\u1EBFm...",1,"block","w-full","pl-10","pr-4","py-2","text-gray-700","bg-white","border","border-gray-300","rounded-lg","focus:border-blue-400","focus:ring-blue-400","focus:outline-none","focus:ring","focus:ring-opacity-40",3,"keyup"],[1,"absolute","inset-y-0","left-0","flex","items-center","pl-3","pointer-events-none"],[1,"material-symbols-outlined","text-gray-500"],["color","primary","matTooltip","Th\xEAm m\u1EDBi","mat-flat-button","",1,"flex","flex-row","items-center",3,"click"],[1,"whitespace-nowrap"],["class","flex flex-row items-center","color","warn","matTooltip","Xo\xE1","mat-flat-button","",3,"click",4,"ngIf"],["matTooltip","\u1EA8n hi\u1EC7n c\u1ED9t","mat-icon-button","","color","primary",3,"matMenuTriggerFor"],[1,"p-4"],["appearance","outline","subscriptSizing","dynamic",1,"w-full"],["matInput","","placeholder","T\xECm Ki\u1EBFm",3,"input","click"],["matPrefix",""],[1,"flex","flex-col","max-h-80","overflow-auto"],["mat-menu-item",""],["mat-icon-button","","color","primary","matTooltip","C\u1EADp Nh\u1EADt L\u1EA1i Code",3,"click"],["mat-icon-button","","color","primary","matTooltip","Refresh D\u1EEF Li\u1EC7u",3,"click"],[1,"w-full","h-full","overflow-auto"],["mat-table","","matSort","",1,"!border","w-full","cursor-pointer",3,"dataSource"],[3,"matColumnDef"],["mat-header-row","",4,"matHeaderRowDef","matHeaderRowDefSticky"],["class","border","mat-row","",3,"class","click",4,"matRowDef","matRowDefColumns"],["class","mat-row border",4,"matNoDataRow"],[1,"hidden",3,"length","pageSize","pageSizeOptions","showFirstLastButtons"],[1,"cursor-pointer","border","rounded-lg","px-3","p-1","flex","flex-row","space-x-2","items-center","justify-between"],[1,"w-full","flex","lg:p-0","p-2","lg:flex-row","lg:space-x-2","lg:items-center","lg:justify-between","flex-col","justify-center"],[1,"w-full","text-center"],[1,"w-full","flex","flex-row","space-x-2","items-center","lg:justify-end","justify-center"],[1,"font-bold","text-blue-600",3,"matMenuTriggerFor"],[1,"w-full","flex","flex-row","space-x-2","p-4",3,"click"],["appearance","outline","subscriptSizing","dynamic"],["matInput","","placeholder","Vui l\xF2ng Nh\u1EADp S\u1ED1 L\u01B0\u1EE3ng",3,"value"],["mat-icon-button","","color","primary",3,"click"],[1,"pagination-controls"],["mat-icon-button","","color","primary",3,"click","disabled"],["color","warn","matTooltip","Xo\xE1","mat-flat-button","",1,"flex","flex-row","items-center",3,"click"],["mat-menu-item","",3,"click"],["mat-header-cell","",1,"!border","!bg-slate-100"],["mat-header-cell","","mat-sort-header","",1,"!border","whitespace-nowrap","!bg-slate-100"],["class","border","mat-cell","",4,"matCellDef"],["class","!border !bg-slate-100","mat-header-cell","",4,"matHeaderCellDef"],["class","!border whitespace-nowrap !bg-slate-100","mat-header-cell","","mat-sort-header","",4,"matHeaderCellDef"],[1,"max-w-40","line-clamp-4","me-4"],[3,"OutFilter","icon","ListItem","fieldsearch","ListFilter","filterItem"],["mat-cell","",1,"border"],[1,"max-w-40","line-clamp-4","font-bold","text-blue-600"],[1,"flex","text-center"],[1,"max-w-40","line-clamp-4"],[1,"max-w-40","line-clamp-4","font-bold","text-blue-600",3,"click"],[1,"text-green-500"],[1,"text-red-500"],["mat-header-row",""],["mat-row","",1,"border",3,"click"],[1,"mat-row","border"],["colspan","4",1,"mat-cell","p-4"],[1,"flex","flex-col","space-y-8","items-center","justify-center"],[1,"font-bold"],[1,"flex","flex-row","space-x-2","items-center","justify-center"],["mat-flat-button","","color","primary","mat-dialog-close","true"],["mat-flat-button","","color","warn","mat-dialog-close","false"],[1,"!w-screen","!h-screen","!max-h-screen","!relative","!flex","flex-col","space-y-8","items-center","justify-center"],[1,"relative","flex","flex-row","space-x-2","items-center"],["matInput","","placeholder","Vui l\xF2ng Nh\u1EADp IdSheet",3,"ngModelChange","ngModel","ngModelOptions"],["matInput","","placeholder","Vui l\xF2ng Nh\u1EADp SheetName",3,"ngModelChange","ngModel","ngModelOptions"],[1,"relative","h-full","w-full","overflow-auto"],[1,"relative","flex","flex-row","space-x-2","items-center","justify-center"]],template:function(t,i){if(t&1){let a=K();o(0,"mat-drawer-container",8)(1,"mat-drawer",9,0),D(3,"router-outlet"),s(),o(4,"div",10)(5,"div",11)(6,"div",12)(7,"div",13)(8,"div",14)(9,"input",15),C("keyup",function(g){return _(a),k(i.applyFilter(g))}),s(),o(10,"div",16)(11,"span",17),c(12,"search"),s()()(),o(13,"button",18),C("click",function(){return _(a),k(i.create())}),o(14,"mat-icon"),c(15,"add_circle"),s(),o(16,"span",19),c(17,"T\u1EA1o M\u1EDBi"),s()(),E(18,Ee,5,0,"button",20),s(),o(19,"div",13)(20,"button",21)(21,"mat-icon"),c(22,"tune"),s()(),o(23,"mat-menu",null,1)(25,"div",22)(26,"mat-form-field",23)(27,"input",24),C("input",function(g){return _(a),k(i.doFilterColumns(g))})("click",function(g){return _(a),k(g.stopPropagation())}),s(),o(28,"mat-icon",25),c(29,"search"),s()()(),o(30,"div",26),U(31,Ke,5,2,"button",27,be),s()(),o(33,"button",28),C("click",function(){return _(a),k(i.getUpdatedCodeIds())}),o(34,"mat-icon"),c(35,"cached"),s()(),o(36,"button",29),C("click",function(){return _(a),k(i.refreshData())}),o(37,"mat-icon"),c(38,"refresh"),s()()()()(),o(39,"div",30)(40,"table",31),U(41,Re,4,2,"ng-container",32,st),E(43,Oe,1,0,"tr",33)(44,He,1,3,"tr",34)(45,je,3,0,"tr",35),s(),D(46,"mat-paginator",36,2),s(),o(48,"div",37)(49,"div",38)(50,"span",39),c(51,"\u0110ang Xem "),o(52,"strong"),c(53),s(),c(54," - "),o(55,"strong"),c(56),s(),c(57),s(),o(58,"div",40)(59,"span",41,3),c(61),s(),o(62,"mat-menu",null,4)(64,"div",42),C("click",function(g){return _(a),k(g.stopPropagation())}),o(65,"mat-form-field",43)(66,"mat-label"),c(67,"S\u1ED1 l\u01B0\u1EE3ng"),s(),D(68,"input",44,5),s(),o(70,"button",45),C("click",function(){_(a);let g=F(60),l=F(69);return k(i.onPageSizeChange(+l.value,g))}),o(71,"mat-icon"),c(72,"published_with_changes"),s()()()(),o(73,"div",46)(74,"button",47),C("click",function(){return _(a),k(i.onPreviousPage())}),o(75,"mat-icon"),c(76,"keyboard_arrow_left"),s()(),o(77,"button",47),C("click",function(){return _(a),k(i.onNextPage())}),o(78,"mat-icon"),c(79,"keyboard_arrow_right"),s()()()()()()()(),E(80,Ue,11,0,"ng-template",null,6,tt)(82,We,16,6,"ng-template",null,7,tt)}if(t&2){let a=F(24),r=F(63);m(),y("position","end"),m(17),y("ngIf",i.EditList.length>0),m(2),y("matMenuTriggerFor",a),m(11),W(i.FilterColumns),m(9),y("dataSource",i.dataSource),m(),W(i.displayedColumns),m(2),y("matHeaderRowDef",i.displayedColumns)("matHeaderRowDefSticky",!0),m(),y("matRowDefColumns",i.displayedColumns),m(2),y("length",i.getTotalRecords())("pageSize",i.getCurrentPageSize())("pageSizeOptions",V(21,ve))("showFirstLastButtons",!0),m(7),T(i.getDisplayStart()),m(3),T(i.getDisplayEnd()),m(),ct(" trong s\u1ED1 ",i.getTotalRecords()," m\u1EE5c, ",i.getCurrentPage(),"/",i.getTotalPages()," Trang "),m(2),y("matMenuTriggerFor",r),m(2),v("Hi\u1EC7n Th\u1ECB : ",i.getCurrentPageSize()," m\u1EE5c"),m(7),y("value",i.getCurrentPageSize()),m(6),y("disabled",!i.canGoToPrevious()),m(3),y("disabled",!i.canGoToNext())}},dependencies:[Rt,Gt,Vt,qt,Ht,Ot,me,te,ie,oe,ae,ee,se,ne,re,le,he,ce,Zt,H,Yt,Jt,O,Dt,Mt,Lt,It,bt,wt,vt,dt,Kt,Et,St,yt,Ct,jt,ut,gt,pt,Bt,Ft,Tt,Pt,Xt,Qt,zt,Nt,$t,de,_e],encapsulation:2,changeDetection:0})};B([at(300)],M.prototype,"applyFilter",1),B([fe()],M.prototype,"FilterHederColumn",1),B([at(300)],M.prototype,"doFilterHederColumn",1);var Se=M;export{j as a,Se as b};
