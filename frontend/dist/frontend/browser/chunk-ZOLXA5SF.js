import{a as Re,b as ve,c as ye}from"./chunk-LYLKJWJT.js";import{a as fe}from"./chunk-DFEBKCCY.js";import"./chunk-Z4HIZU65.js";import{a as _e,b as ge}from"./chunk-RLTNMUN6.js";import"./chunk-2PVH7Z6P.js";import{d as pe,e as he}from"./chunk-SUUFLDBI.js";import{h as oe}from"./chunk-EJAZH3JY.js";import"./chunk-ZW44ZSN2.js";import"./chunk-Z2ZDGSWT.js";import{a as Z,b as $,c as ee,d as te}from"./chunk-UQRYBWA2.js";import"./chunk-Q7E7WSHM.js";import"./chunk-AZMUMNOS.js";import"./chunk-IDXNS6DX.js";import"./chunk-POPZSE3V.js";import{b as me}from"./chunk-POHUA43U.js";import{b as ie,g as re,j as se,n as ne,p as le,v as ae,w as ce,y as de,z as ue}from"./chunk-A3B3GZND.js";import"./chunk-AW6ETFJX.js";import{a as J,b as Y}from"./chunk-MGAKVDEP.js";import{a as K,b as X}from"./chunk-CBIWJPH2.js";import"./chunk-2NDWID3Z.js";import"./chunk-KMDUY2WI.js";import"./chunk-2PPFUFFT.js";import{a as j,c as O,e as H}from"./chunk-K4TPENAW.js";import"./chunk-27DT4LBZ.js";import{a as W,c as q}from"./chunk-VF6Z3BLE.js";import"./chunk-HB5OTZ3Y.js";import{m as Q,v as N}from"./chunk-CNCZQRZQ.js";import{Cc as B,Db as z,Dc as a,Ec as w,Ic as S,Jc as x,Kb as M,Kc as C,Ra as d,Ub as R,ac as k,cc as I,dc as T,ec as n,fc as o,hc as L,ic as F,ja as V,jd as U,kc as y,ld as A,oa as G,pa as f,pc as _,rb as u,rc as g,ya as m,za as p}from"./chunk-TAKLKH4V.js";import{a as b,b as P,j as c}from"./chunk-WJTR2IJE.js";var E=class l{constructor(e){this.storageService=e;this.searchResults()}_allRoles=d([]);_filteredRoles=d([]);_searchTerm=d("");_currentPage=d(1);_pageSize=d(50);_isLoading=d(!1);_selectedRoles=d(new Set);_statusFilter=d("all");allRoles=this._allRoles.asReadonly();filteredRoles=this._filteredRoles.asReadonly();searchTerm=this._searchTerm.asReadonly();currentPage=this._currentPage.asReadonly();pageSize=this._pageSize.asReadonly();isLoading=this._isLoading.asReadonly();selectedRoles=this._selectedRoles.asReadonly();statusFilter=this._statusFilter.asReadonly();totalItems=U(()=>this._filteredRoles().length);totalPages=U(()=>Math.ceil(this.totalItems()/this._pageSize()));paginatedRoles=U(()=>{let e=(this._currentPage()-1)*this._pageSize(),t=e+this._pageSize();return this._filteredRoles().slice(e,t)});searchResults=U(()=>{let e=this._allRoles(),t=this._statusFilter();t!=="all"&&(e=e.filter(r=>t==="active"?r.isActive:!r.isActive));let i=this._searchTerm().toLowerCase();return i&&(e=e.filter(r=>r.name.toLowerCase().includes(i)||r.description?.toLowerCase().includes(i))),this._filteredRoles.set(e),e});graphqlService=f(fe);loadAllRoles(e=!1){return c(this,null,function*(){if(!e&&this._allRoles().length>0)return this._allRoles();this._isLoading.set(!0);try{let t={orderBy:{name:"asc"},include:{permissions:{include:{permission:{select:{id:!0,name:!0,code:!0,module:!0}}}},users:{include:{user:{select:{id:!0,email:!0,username:!0,fullName:!0}}}}}},i=yield this.graphqlService.findMany("role",t);return this._allRoles.set(i),this._filteredRoles.set(i),this._currentPage.set(1),i}catch(t){throw console.error("Error loading roles:",t),t}finally{this._isLoading.set(!1)}})}createRole(e){return c(this,null,function*(){this._isLoading.set(!0);try{let t={name:e.name,description:e.description,isActive:e.isActive??!0},i=yield this.graphqlService.createOne("role",{data:t,include:{permissions:{include:{permission:{select:{id:!0,name:!0,code:!0,module:!0}}}},users:{include:{user:{select:{id:!0,email:!0,username:!0,fullName:!0}}}}}});if(e.permissionIds&&e.permissionIds.length>0){yield this.assignPermissionsToRole(i.id,e.permissionIds);let s=yield this.getRoleById(i.id);if(s){let h=this._allRoles();return this._allRoles.set([s,...h.filter(v=>v.id!==i.id)]),s}}let r=this._allRoles();return this._allRoles.set([i,...r]),i}catch(t){throw console.error("Error creating role:",t),t}finally{this._isLoading.set(!1)}})}updateRole(e,t){return c(this,null,function*(){this._isLoading.set(!0);try{let i=yield this.graphqlService.updateOne("role",{id:e},t,{include:{permissions:{include:{permission:{select:{id:!0,name:!0,code:!0,module:!0}}}},users:{include:{user:{select:{id:!0,email:!0,username:!0,fullName:!0}}}}}}),r=this._allRoles(),s=r.findIndex(h=>h.id===e);if(s!==-1){let h=[...r];h[s]=i,this._allRoles.set(h)}return i}catch(i){throw console.error("Error updating role:",i),i}finally{this._isLoading.set(!1)}})}deleteRole(e){return c(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("role",{id:e});let i=this._allRoles().filter(s=>s.id!==e);this._allRoles.set(i);let r=new Set(this._selectedRoles());r.delete(e),this._selectedRoles.set(r)}catch(t){throw console.error("Error deleting role:",t),t}finally{this._isLoading.set(!1)}})}getRoleById(e){return c(this,null,function*(){try{return yield this.graphqlService.findUnique("role",{id:e},{include:{permissions:{include:{permission:{select:{id:!0,name:!0,code:!0,module:!0}}}},users:{include:{user:{select:{id:!0,email:!0,username:!0,fullName:!0}}}}}})}catch(t){return console.error("Error getting role by id:",t),null}})}assignPermissionsToRole(e,t){return c(this,null,function*(){this._isLoading.set(!0);try{let i=t.map(s=>({roleId:e,permissionId:s}));yield this.graphqlService.batchCreate("rolePermission",i);let r=yield this.getRoleById(e);if(r){let s=this._allRoles(),h=s.findIndex(v=>v.id===e);if(h!==-1){let v=[...s];v[h]=r,this._allRoles.set(v)}}}catch(i){throw console.error("Error assigning permissions to role:",i),i}finally{this._isLoading.set(!1)}})}removePermissionFromRole(e,t){return c(this,null,function*(){this._isLoading.set(!0);try{let r=(yield this.getRoleById(e))?.permissions?.find(s=>s.permissionId===t);if(r){yield this.graphqlService.deleteOne("rolePermission",{id:r.id});let s=yield this.getRoleById(e);if(s){let h=this._allRoles(),v=h.findIndex(D=>D.id===e);if(v!==-1){let D=[...h];D[v]=s,this._allRoles.set(D)}}}}catch(i){throw console.error("Error removing permission from role:",i),i}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setStatusFilter(e){this._statusFilter.set(e),this._currentPage.set(1)}setPage(e){e>=1&&e<=this.totalPages()&&this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}nextPage(){this._currentPage()<this.totalPages()&&this._currentPage.set(this._currentPage()+1)}previousPage(){this._currentPage()>1&&this._currentPage.set(this._currentPage()-1)}toggleRoleSelection(e){let t=new Set(this._selectedRoles());t.has(e)?t.delete(e):t.add(e),this._selectedRoles.set(t)}selectAllCurrentPage(){let e=new Set(this._selectedRoles());this.paginatedRoles().forEach(t=>{e.add(t.id)}),this._selectedRoles.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedRoles());this.paginatedRoles().forEach(t=>{e.delete(t.id)}),this._selectedRoles.set(e)}clearSelection(){this._selectedRoles.set(new Set)}isSelected(e){return this._selectedRoles().has(e)}get selectedCount(){return this._selectedRoles().size}get selectedIds(){return Array.from(this._selectedRoles())}findRoleById(e){return this._allRoles().find(t=>t.id===e)}getRolesByPermission(e){return this._allRoles().filter(t=>t.permissions?.some(i=>i.permissionId===e))}getActiveRoles(){return this._allRoles().filter(e=>e.isActive)}getRolePermissions(e){let t=this.findRoleById(e);return!t||!t.permissions?[]:t.permissions.map(i=>i.permission)}hasPermission(e,t){return this.getRolePermissions(e).some(r=>r.code===t)}getRolesByModule(e){return this._allRoles().filter(t=>t.permissions?.some(i=>i.permission.module===e))}getUsersInRole(e){let t=this.findRoleById(e);return!t||!t.users?[]:t.users.map(i=>i.user)}clearCache(){this._allRoles.set([]),this._filteredRoles.set([]),this._searchTerm.set(""),this._statusFilter.set("all"),this._currentPage.set(1),this.clearSelection()}refreshData(){return this.loadAllRoles(!0)}static \u0275fac=function(t){return new(t||l)(G(X))};static \u0275prov=V({token:l,factory:l.\u0275fac,providedIn:"root"})};function xe(l,e){if(l&1){let t=y();n(0,"button",3),_("click",function(){m(t);let r=g();return p(r.handleUserAction())}),n(1,"mat-icon"),a(2,"save"),o()()}}function Ce(l,e){if(l&1){let t=y();n(0,"button",3),_("click",function(){m(t);let r=g();return p(r.toggleEdit())}),n(1,"mat-icon"),a(2,"edit"),o()()}}function Ue(l,e){if(l&1){let t=y();L(0),n(1,"div",11)(2,"div",12),a(3,"B\u1EA1n ch\u1EAFc ch\u1EAFn mu\u1ED1n xo\xE1 kh\xF4ng?"),o(),n(4,"div",13)(5,"button",14),_("click",function(){m(t);let r=g();return p(r.DeleteData())}),a(6,"\u0110\u1ED3ng \xDD"),o(),n(7,"button",15),_("click",function(){m(t);let r=g();return p(r.toggleDelete())}),a(8,"Hu\u1EF7 B\u1ECF"),o()()(),F()}}function De(l,e){if(l&1){let t=y();n(0,"div",23)(1,"div",4),a(2),o(),n(3,"mat-icon",32),_("click",function(){let r=m(t).$implicit,s=g(2);return p(s.handleRemoveRole(r))}),a(4,"close"),o()()}if(l&2){let t=e.$implicit;u(2),w(t==null?null:t.name)}}function Ee(l,e){if(l&1){let t=y();n(0,"button",33),_("click",function(){let r=m(t).$implicit,s=g(2);return p(s.handleAddRole(r))}),a(1),o()}if(l&2){let t=e.$implicit;u(),w(t.name)}}function be(l,e){if(l&1){let t=y();L(0),n(1,"div",16)(2,"mat-form-field",17)(3,"mat-label"),a(4,"Email"),o(),n(5,"input",18),C("ngModelChange",function(r){m(t);let s=g();return x(s.DetailUser().email,r)||(s.DetailUser().email=r),p(r)}),o()(),n(6,"mat-form-field",17)(7,"mat-label"),a(8,"S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i"),o(),n(9,"input",19),C("ngModelChange",function(r){m(t);let s=g();return x(s.DetailUser().sdt,r)||(s.DetailUser().sdt=r),p(r)}),o()(),n(10,"mat-form-field",17)(11,"mat-label"),a(12,"M\u1EADt Kh\u1EA9u "),o(),n(13,"input",20),C("ngModelChange",function(r){m(t);let s=g();return x(s.DetailUser().password,r)||(s.DetailUser().password=r),p(r)}),o()(),n(14,"div",21)(15,"button",22,0),a(17," Th\xEAm Nh\xF3m "),o(),n(18,"div",5),I(19,De,5,1,"div",23,k),o()(),n(21,"mat-menu",null,1)(23,"div",24),_("click",function(r){return m(t),p(r.stopPropagation())}),n(24,"div",25)(25,"input",26),_("keyup",function(r){m(t);let s=g();return p(s.doFilterHederColumn(r))}),o(),n(26,"div",27)(27,"span",28),a(28,"search"),o()()(),n(29,"div",29),I(30,Ee,2,1,"button",30,k),o(),n(32,"div",31)(33,"button",15),_("click",function(){m(t);let r=B(16);return p(r.closeMenu())}),a(34,"\u0110\xF3ng"),o()()()()(),F()}if(l&2){let t=B(22),i=g();u(5),S("ngModel",i.DetailUser().email),R("disabled",!i.isEdit()),u(4),S("ngModel",i.DetailUser().sdt),R("disabled",!i.isEdit()),u(4),S("ngModel",i.DetailUser().password),R("disabled",!i.isEdit()),u(2),R("disabled",!i.isEdit())("matMenuTriggerFor",t),u(4),T(i.DetailUser().roles),u(11),T(i.FilterRole())}}var we=class l{_ListuserComponent=f(ye);_UserGraphQLService=f(Re);_RoleGraphQLService=f(E);_route=f(W);_router=f(q);_snackBar=f(K);_drawerService=f(ve);constructor(){this._route.paramMap.subscribe(e=>{let t=e.get("id");t==="new"?this.userId.set(t):t&&!this._UserGraphQLService.currentUser()&&this.userId.set(t)}),A(()=>{let e=this._UserGraphQLService.currentUser();e&&(this.DetailUser.set(P(b({},e),{sdt:e.sdt||""})),this.userId.set(e.id),this.isEdit.set(!1))}),A(()=>c(this,null,function*(){let e=this.userId();e||(this._router.navigate(["/admin/user"]),this._drawerService.close()),e==="new"?(this.DetailUser.set({email:"",username:"",password:"",sdt:"",fullName:"",isActive:!0,roles:[]}),this._drawerService.open(),this.isEdit.update(t=>!t),this._router.navigate(["/admin/user","new"])):e&&(yield this.getUserById(e),this._drawerService.open(),this._router.navigate(["/admin/user",e]))}))}DetailUser=d({});isEdit=d(!1);isDelete=d(!1);userId=d(null);ListRole=d([]);FilterRole=d([]);getUserById(e){return c(this,null,function*(){try{let t=yield this._UserGraphQLService.getUserById(e);t&&this.DetailUser.set(P(b({},t),{sdt:t.sdt||""}))}catch(t){console.error("Error loading user:",t),this._snackBar.open("L\u1ED7i khi t\u1EA3i th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng","\u0110\xF3ng",{duration:3e3})}})}ngOnInit(){return c(this,null,function*(){yield this._RoleGraphQLService.loadAllRoles(),this.ListRole.set(this._RoleGraphQLService.allRoles()),this.updateFilterRole()})}updateFilterRole(){let e=this.ListRole(),t=this.DetailUser()?.roles||[];this.FilterRole.set(e.filter(i=>!t.some(r=>r.roleId===i.id||r.role?.id===i.id)))}handleUserAction(){return c(this,null,function*(){this.userId()==="new"?yield this.createUser():yield this.updateUser()})}createUser(){return c(this,null,function*(){try{if(!this.DetailUser().password||this.DetailUser().password.trim()===""){this._snackBar.open("Vui l\xF2ng nh\u1EADp password","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}if(!this.DetailUser().sdt||this.DetailUser().sdt.trim()===""){this._snackBar.open("Vui l\xF2ng nh\u1EADp SDT","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}yield this._UserGraphQLService.createUser(this.DetailUser()),this._snackBar.open("T\u1EA1o M\u1EDBi Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.update(e=>!e)}catch(e){console.error("L\u1ED7i khi t\u1EA1o user:",e)}})}updateUser(){return c(this,null,function*(){try{yield this._UserGraphQLService.updateUser(this.DetailUser().id,this.DetailUser()),this._snackBar.open("C\u1EADp Nh\u1EADt Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.update(e=>!e)}catch(e){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt user:",e)}})}DeleteData(){return c(this,null,function*(){try{yield this._UserGraphQLService.deleteUser(this.DetailUser().id),this._snackBar.open("X\xF3a Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this._router.navigate(["/admin/user"])}catch(e){console.error("L\u1ED7i khi x\xF3a user:",e)}})}FillSlug(){this.DetailUser.update(e=>(e.slug=pe(e.title),e))}doFilterHederColumn(e){let t=this.ListRole();this.FilterRole.set(t.filter(i=>i.name.toLowerCase().includes(e.target.value.toLowerCase())))}handleAddRole(e){return c(this,null,function*(){try{yield this._UserGraphQLService.assignRolesToUser(this.DetailUser().id,[e.id]),this.DetailUser.update(t=>(t.roles.find(r=>r.role?.id===e.id||r.roleId===e.id)||t.roles.push({id:he(8,!1),userId:this.DetailUser().id,roleId:e.id,role:e}),t)),this.updateFilterRole(),this._snackBar.open("Th\xEAm Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(t){console.error("Error adding role:",t),this._snackBar.open("L\u1ED7i khi th\xEAm vai tr\xF2","\u0110\xF3ng",{duration:3e3})}})}handleRemoveRole(e){return c(this,null,function*(){try{yield this._UserGraphQLService.removeRoleFromUser(this.DetailUser().id,e.role?.id||e.roleId),this.DetailUser.update(t=>(t.roles=t.roles.filter(i=>(i.role?.id||i.roleId)!==(e.role?.id||e.roleId)),t)),this.updateFilterRole(),this._snackBar.open("X\xF3a Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(t){console.error("Error removing role:",t),this._snackBar.open("L\u1ED7i khi x\xF3a vai tr\xF2","\u0110\xF3ng",{duration:3e3})}})}goBack(){this._UserGraphQLService.clearCurrentUser(),this._drawerService.close(),this._router.navigate(["/admin/user"])}trackByFn(e,t){return t.id}toggleEdit(){this.isEdit.update(e=>!e)}toggleDelete(){this.isDelete.update(e=>!e)}static \u0275fac=function(t){return new(t||l)};static \u0275cmp=z({type:l,selectors:[["app-detailuser"]],decls:17,vars:8,consts:[["menuTrigger","matMenuTrigger"],["menu","matMenu"],[1,"flex","flex-row","justify-between","items-center","space-x-2","p-2"],["mat-icon-button","","color","primary",3,"click"],[1,"font-bold"],[1,"flex","flex-row","space-x-2","items-center"],[3,"ngModelChange","ngModel","disabled"],["mat-icon-button","","color","primary",3,"click",4,"ngIf"],["mat-icon-button","","color","warn",3,"click"],[1,"relative","flex","flex-col","w-full","p-4","overflow-auto"],[4,"ngIf"],[1,"flex","flex-col","space-y-4","items-center","justify-center"],[1,"font-bold","text-2xl"],[1,"flex","flex-row","space-x-2","items-center","justify-center"],["mat-flat-button","","color","primary",3,"click"],["mat-flat-button","","color","warn",3,"click"],[1,"w-full","flex","flex-col","space-y-2"],["appearance","outline"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp Email",3,"ngModelChange","ngModel","disabled"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i",3,"ngModelChange","ngModel","disabled"],["matInput","","type","password","placeholder","Vui l\xF2ng nh\u1EADp S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i",3,"ngModelChange","ngModel","disabled"],[1,"w-full","flex","flex-wrap","gap-2","space-x-2"],["mat-flat-button","","color","primary",3,"disabled","matMenuTriggerFor"],[1,"cursor-pointer","flex","flex-row","space-x-2","items-center","p-2","rounded-lg","bg-gray-100"],[1,"cursor-pointer","flex","flex-col","space-y-4","p-3",3,"click"],[1,"relative","w-full"],["type","text","placeholder","T\xECm Ki\u1EBFm...",1,"block","w-full","pl-10","pr-4","py-2","text-gray-700","bg-white","border","border-gray-300","rounded-lg","focus:border-blue-400","focus:ring-blue-400","focus:outline-none","focus:ring","focus:ring-opacity-40",3,"keyup"],[1,"absolute","inset-y-0","left-0","flex","items-center","pl-3","pointer-events-none"],[1,"material-symbols-outlined","text-gray-500"],[1,"w-full","flex","flex-col","space-y-2","max-h-44","overflow-auto"],["mat-menu-item",""],[1,"flex","flex-row","space-x-2","items-center","justify-end"],["color","warn",3,"click"],["mat-menu-item","",3,"click"]],template:function(t,i){if(t&1&&(n(0,"div",2)(1,"button",3),_("click",function(){return i.goBack()}),n(2,"mat-icon"),a(3,"arrow_back"),o()(),n(4,"div",4),a(5),o(),n(6,"div",5)(7,"mat-slide-toggle",6),C("ngModelChange",function(s){return x(i.DetailUser().isActive,s)||(i.DetailUser().isActive=s),s}),a(8),o(),M(9,xe,3,0,"button",7)(10,Ce,3,0,"button",7),n(11,"button",8),_("click",function(){return i.toggleDelete()}),n(12,"mat-icon"),a(13,"delete"),o()()()(),n(14,"div",9),M(15,Ue,9,0,"ng-container",10)(16,be,35,8,"ng-container",10),o()),t&2){let r;u(5),w(((r=i.DetailUser())==null?null:r.email)||"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"),u(2),S("ngModel",i.DetailUser().isActive),R("disabled",!i.isEdit()),u(),w(i.DetailUser().isActive?"Hi\u1EC3n Th\u1ECB":"\u1EA8n"),u(),R("ngIf",i.isEdit()),u(),R("ngIf",!i.isEdit()),u(5),R("ngIf",i.isDelete()),u(),R("ngIf",!i.isDelete())}},dependencies:[ce,ae,le,ue,de,ne,ie,re,se,Y,J,H,j,O,me,oe,N,Q,ge,_e,te,$,Z,ee],encapsulation:2})};export{we as DetailUserComponent};
