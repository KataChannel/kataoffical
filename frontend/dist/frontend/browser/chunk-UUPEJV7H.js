import{a as pt,b as gt}from"./chunk-GLRN4W5E.js";import{b as We}from"./chunk-SSBELGME.js";import{a as L}from"./chunk-BFIAAR4D.js";import"./chunk-XLFIXRGG.js";import{a as Xe,b as Je}from"./chunk-LTIMMLFX.js";import{d as Ge,e as qe}from"./chunk-STTHC4C4.js";import"./chunk-ZW44ZSN2.js";import"./chunk-BQNHPUMH.js";import{a as X,b as J,c as Y,d as Z}from"./chunk-SLRDYDMI.js";import{a as k}from"./chunk-N7PBUGTM.js";import{a as ct,b as ut}from"./chunk-TPFOWWOO.js";import{a as Ye,b as Ze,c as $e}from"./chunk-TDAACTQD.js";import{h as se}from"./chunk-INJUMOX2.js";import"./chunk-H7UDLENL.js";import{a as j}from"./chunk-GD7IEZTW.js";import"./chunk-DP4FJZ2N.js";import{a as Oe,b as Ne,c as Qe,k as je}from"./chunk-QIIVLJEC.js";import{a as Re,c as Ie}from"./chunk-RFYKARPR.js";import{a as He,b as Ke}from"./chunk-IKSNCL6N.js";import{c as et,d as tt,e as it,g as st,h as nt,j as rt,k as ot,m as at,n as lt,p as mt,r as dt}from"./chunk-B52A5VRT.js";import{a as ze,b as me}from"./chunk-6S4AGD7B.js";import{A as le,b as $,g as ee,h as Fe,i as ke,j as te,k as Le,n as Be,o as ie,q as ne,t as Ve,w as re,x as oe,z as ae}from"./chunk-KWM4OIFF.js";import"./chunk-KBSHTQVA.js";import{a as H,b as K}from"./chunk-4KMAECDD.js";import"./chunk-B5XVARHK.js";import"./chunk-KY47JUDC.js";import"./chunk-2PPFUFFT.js";import{a as O,c as N,e as Q}from"./chunk-5RXGINDA.js";import{_ as Te,ka as Ae}from"./chunk-RO6MDUJX.js";import"./chunk-HMVCX5BQ.js";import{l as De,m as q,s as be,w as W}from"./chunk-RGQ7KTVF.js";import{$b as he,Cc as T,Db as z,Dc as l,Ec as C,Fc as A,Gc as Se,Ic as E,Jc as S,Kb as y,Kc as U,Mc as Ue,Na as Ce,Ra as d,Sc as ye,Ub as c,Uc as ve,Vb as Ee,Wb as G,Xb as _e,Yc as we,ac as fe,cc as Pe,dc as xe,ec as r,fc as o,gc as b,hc as M,ic as D,ja as F,kc as w,kd as f,md as Me,oa as V,pa as v,pc as P,rb as m,rc as u,ya as _,za as h}from"./chunk-OL5DVADB.js";import"./chunk-LWLSKGAV.js";import{a as I,b as B,j as p}from"./chunk-6DYNGEAS.js";var de=class n{constructor(e){this.storageService=e}_allRoles=d([]);_searchTerm=d("");_currentPage=d(1);_pageSize=d(50);_isLoading=d(!1);_selectedRoles=d(new Set);_statusFilter=d("all");searchResults=f(()=>{let e=this._allRoles(),t=this._searchTerm().toLowerCase();return t&&(e=e.filter(i=>i.name.toLowerCase().includes(t))),e});allRoles=this._allRoles.asReadonly();filteredRoles=this.searchResults;searchTerm=this._searchTerm.asReadonly();currentPage=this._currentPage.asReadonly();pageSize=this._pageSize.asReadonly();isLoading=this._isLoading.asReadonly();selectedRoles=this._selectedRoles.asReadonly();statusFilter=this._statusFilter.asReadonly();totalItems=f(()=>this.searchResults().length);totalPages=f(()=>Math.ceil(this.totalItems()/this._pageSize()));paginatedRoles=f(()=>{let e=(this._currentPage()-1)*this._pageSize(),t=e+this._pageSize();return this.searchResults().slice(e,t)});graphqlService=v(L);loadAllRoles(e=!1){return p(this,null,function*(){if(!e&&this._allRoles().length>0)return this._allRoles();this._isLoading.set(!0);try{let t={orderBy:{name:"asc"},include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}},i=yield this.graphqlService.findMany("role",t);return this._allRoles.set(i),this._currentPage.set(1),i}catch(t){throw console.error("Error loading roles:",t),t}finally{this._isLoading.set(!1)}})}createRole(e){return p(this,null,function*(){this._isLoading.set(!0);try{let t={name:e.name},i=yield this.graphqlService.createOne("role",{data:t,include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}});if(e.permissionIds&&e.permissionIds.length>0){yield this.assignPermissionsToRole(i.id,e.permissionIds);let a=yield this.getRoleById(i.id);if(a){let x=this._allRoles();return this._allRoles.set([a,...x.filter(g=>g.id!==i.id)]),a}}let s=this._allRoles();return this._allRoles.set([i,...s]),i}catch(t){throw console.error("Error creating role:",t),t}finally{this._isLoading.set(!1)}})}updateRole(e,t){return p(this,null,function*(){this._isLoading.set(!0);try{let i=yield this.graphqlService.updateOne("role",{id:e},t,{include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}}),s=this._allRoles(),a=s.findIndex(x=>x.id===e);if(a!==-1){let x=[...s];x[a]=i,this._allRoles.set(x)}return i}catch(i){throw console.error("Error updating role:",i),i}finally{this._isLoading.set(!1)}})}deleteRole(e){return p(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("role",{id:e});let i=this._allRoles().filter(a=>a.id!==e);this._allRoles.set(i);let s=new Set(this._selectedRoles());s.delete(e),this._selectedRoles.set(s)}catch(t){throw console.error("Error deleting role:",t),t}finally{this._isLoading.set(!1)}})}getRoleById(e){return p(this,null,function*(){try{return yield this.graphqlService.findUnique("role",{id:e},{include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}})}catch(t){return console.error("Error getting role by id:",t),null}})}assignPermissionsToRole(e,t){return p(this,null,function*(){this._isLoading.set(!0);try{let i=t.map(a=>({roleId:e,permissionId:a}));yield this.graphqlService.batchCreate("rolePermission",i);let s=yield this.getRoleById(e);if(s){let a=this._allRoles(),x=a.findIndex(g=>g.id===e);if(x!==-1){let g=[...a];g[x]=s,this._allRoles.set(g)}}}catch(i){throw console.error("Error assigning permissions to role:",i),i}finally{this._isLoading.set(!1)}})}removePermissionFromRole(e,t){return p(this,null,function*(){this._isLoading.set(!0);try{let s=(yield this.getRoleById(e))?.permissions?.find(a=>a.permissionId===t);if(s){yield this.graphqlService.deleteOne("rolePermission",{id:s.id});let a=yield this.getRoleById(e);if(a){let x=this._allRoles(),g=x.findIndex(R=>R.id===e);if(g!==-1){let R=[...x];R[g]=a,this._allRoles.set(R)}}}}catch(i){throw console.error("Error removing permission from role:",i),i}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setStatusFilter(e){this._statusFilter.set(e),this._currentPage.set(1)}setPage(e){e>=1&&e<=this.totalPages()&&this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}nextPage(){this._currentPage()<this.totalPages()&&this._currentPage.set(this._currentPage()+1)}previousPage(){this._currentPage()>1&&this._currentPage.set(this._currentPage()-1)}toggleRoleSelection(e){let t=new Set(this._selectedRoles());t.has(e)?t.delete(e):t.add(e),this._selectedRoles.set(t)}selectAllCurrentPage(){let e=new Set(this._selectedRoles());this.paginatedRoles().forEach(t=>{e.add(t.id)}),this._selectedRoles.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedRoles());this.paginatedRoles().forEach(t=>{e.delete(t.id)}),this._selectedRoles.set(e)}clearSelection(){this._selectedRoles.set(new Set)}isSelected(e){return this._selectedRoles().has(e)}get selectedCount(){return this._selectedRoles().size}get selectedIds(){return Array.from(this._selectedRoles())}findRoleById(e){return this._allRoles().find(t=>t.id===e)}getRolesByPermission(e){return this._allRoles().filter(t=>t.permissions?.some(i=>i.permissionId===e))}getRolePermissions(e){let t=this.findRoleById(e);return!t||!t.permissions?[]:t.permissions.map(i=>i.permission)}hasPermission(e,t){return this.getRolePermissions(e).some(s=>s.codeId===t)}getRolesByGroup(e){return this._allRoles().filter(t=>t.permissions?.some(i=>i.permission.group===e))}getUsersInRole(e){let t=this.findRoleById(e);return!t||!t.users?[]:t.users.map(i=>i.user)}clearCache(){this._allRoles.set([]),this._searchTerm.set(""),this._currentPage.set(1),this.clearSelection()}refreshData(){return this.loadAllRoles(!0)}static \u0275fac=function(t){return new(t||n)(V(k))};static \u0275prov=F({token:n,factory:n.\u0275fac,providedIn:"root"})};var ue=class n{graphqlService=v(L);storageService=v(k);_allUserPermissions=d([]);_selectedUserPermissions=d(new Set);_searchTerm=d("");_userFilter=d("all");_permissionFilter=d("all");_grantedFilter=d("all");_expiredFilter=d("all");_currentPage=d(1);_pageSize=d(50);_isLoading=d(!1);_currentUserPermission=d(null);allUserPermissions=f(()=>this._allUserPermissions());selectedUserPermissions=f(()=>this._selectedUserPermissions());searchTerm=f(()=>this._searchTerm());userFilter=f(()=>this._userFilter());permissionFilter=f(()=>this._permissionFilter());grantedFilter=f(()=>this._grantedFilter());expiredFilter=f(()=>this._expiredFilter());currentPage=f(()=>this._currentPage());pageSize=f(()=>this._pageSize());isLoading=f(()=>this._isLoading());currentUserPermission=f(()=>this._currentUserPermission());filteredUserPermissions=f(()=>{let e=this._allUserPermissions(),t=this._searchTerm().toLowerCase(),i=this._userFilter(),s=this._permissionFilter(),a=this._grantedFilter(),x=this._expiredFilter();return t&&(e=e.filter(g=>g.user?.name?.toLowerCase().includes(t)||g.user?.email?.toLowerCase().includes(t)||g.permission?.name?.toLowerCase().includes(t)||g.permission?.description?.toLowerCase().includes(t)||g.reason?.toLowerCase().includes(t))),i!=="all"&&(e=e.filter(g=>g.userId===i)),s!=="all"&&(e=e.filter(g=>g.permissionId===s)),a==="granted"?e=e.filter(g=>g.isGranted):a==="denied"&&(e=e.filter(g=>!g.isGranted)),x==="active"?e=e.filter(g=>!g.expiresAt||g.expiresAt>new Date):x==="expired"&&(e=e.filter(g=>g.expiresAt&&g.expiresAt<=new Date)),e.sort((g,R)=>g.isGranted!==R.isGranted?g.isGranted?-1:1:new Date(R.createdAt).getTime()-new Date(g.createdAt).getTime())});paginatedUserPermissions=f(()=>{let e=this.filteredUserPermissions(),t=this._currentPage(),i=this._pageSize(),s=(t-1)*i;return e.slice(s,s+i)});totalPages=f(()=>{let e=this.filteredUserPermissions().length,t=this._pageSize();return Math.ceil(e/t)});totalCount=f(()=>this.filteredUserPermissions().length);loadUserPermissions(e){return p(this,null,function*(){this._isLoading.set(!0);try{let t=yield this.graphqlService.findMany("userPermission",I({include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}},orderBy:[{isGranted:"desc"},{createdAt:"desc"}]},e));return this._allUserPermissions.set(t),t}catch(t){throw console.error("Error loading user permissions:",t),t}finally{this._isLoading.set(!1)}})}getUserPermissionById(e){return p(this,null,function*(){try{let t=yield this.graphqlService.findUnique("userPermission",{id:e},{include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}});return this._currentUserPermission.set(t),t}catch(t){return console.error("Error getting user permission by id:",t),null}})}getUserPermissions(e){return p(this,null,function*(){try{return yield this.graphqlService.findMany("userPermission",{where:{userId:e},include:{permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}},orderBy:[{isGranted:"desc"},{permission:{name:"asc"}}]})}catch(t){return console.error("Error getting user permissions:",t),[]}})}assignPermissionToUser(e){return p(this,null,function*(){this._isLoading.set(!0);try{let t=yield this.graphqlService.createOne("userPermission",{data:{userId:e.userId,permissionId:e.permissionId,isGranted:e.isGranted,grantedBy:e.grantedBy,reason:e.reason,expiresAt:e.expiresAt},include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}}),i=this._allUserPermissions();return this._allUserPermissions.set([t,...i]),t}catch(t){throw console.error("Error assigning permission to user:",t),t}finally{this._isLoading.set(!1)}})}updateUserPermission(e,t){return p(this,null,function*(){this._isLoading.set(!0);try{let i=yield this.graphqlService.updateOne("userPermission",{id:e},t,{include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}}),s=this._allUserPermissions(),a=s.findIndex(x=>x.id===e);if(a!==-1){let x=[...s];x[a]=i,this._allUserPermissions.set(x)}return this._currentUserPermission()?.id===e&&this._currentUserPermission.set(i),i}catch(i){throw console.error("Error updating user permission:",i),i}finally{this._isLoading.set(!1)}})}deleteUserPermission(e){return p(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("userPermission",{id:e});let t=this._allUserPermissions();this._allUserPermissions.set(t.filter(s=>s.id!==e)),this._currentUserPermission()?.id===e&&this._currentUserPermission.set(null);let i=this._selectedUserPermissions();return i.has(e)&&(i.delete(e),this._selectedUserPermissions.set(new Set(i))),!0}catch(t){return console.error("Error deleting user permission:",t),!1}finally{this._isLoading.set(!1)}})}deleteUserPermissions(e){return p(this,null,function*(){this._isLoading.set(!0);try{let t=e.map(s=>this.graphqlService.deleteOne("userPermission",{id:s}));yield Promise.all(t);let i=this._allUserPermissions();return this._allUserPermissions.set(i.filter(s=>!e.includes(s.id))),this._selectedUserPermissions.set(new Set),!0}catch(t){return console.error("Error deleting user permissions:",t),!1}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setUserFilter(e){this._userFilter.set(e),this._currentPage.set(1)}setPermissionFilter(e){this._permissionFilter.set(e),this._currentPage.set(1)}setGrantedFilter(e){this._grantedFilter.set(e),this._currentPage.set(1)}setExpiredFilter(e){this._expiredFilter.set(e),this._currentPage.set(1)}setCurrentPage(e){this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}clearFilters(){this._searchTerm.set(""),this._userFilter.set("all"),this._permissionFilter.set("all"),this._grantedFilter.set("all"),this._expiredFilter.set("all"),this._currentPage.set(1)}toggleUserPermissionSelection(e){let t=new Set(this._selectedUserPermissions());t.has(e)?t.delete(e):t.add(e),this._selectedUserPermissions.set(t)}selectAllCurrentPage(){let e=new Set(this._selectedUserPermissions());this.paginatedUserPermissions().forEach(t=>{e.add(t.id)}),this._selectedUserPermissions.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedUserPermissions());this.paginatedUserPermissions().forEach(t=>{e.delete(t.id)}),this._selectedUserPermissions.set(e)}clearSelection(){this._selectedUserPermissions.set(new Set)}isSelected(e){return this._selectedUserPermissions().has(e)}get selectedCount(){return this._selectedUserPermissions().size}get selectedIds(){return Array.from(this._selectedUserPermissions())}findUserPermissionById(e){return this._allUserPermissions().find(t=>t.id===e)}getUserPermissionsByUser(e){return this._allUserPermissions().filter(t=>t.userId===e)}getUserPermissionsByPermission(e){return this._allUserPermissions().filter(t=>t.permissionId===e)}getActiveUserPermissions(){return this._allUserPermissions().filter(e=>!e.expiresAt||e.expiresAt>new Date)}getExpiredUserPermissions(){return this._allUserPermissions().filter(e=>e.expiresAt&&e.expiresAt<=new Date)}getGrantedUserPermissions(){return this._allUserPermissions().filter(e=>e.isGranted)}getDeniedUserPermissions(){return this._allUserPermissions().filter(e=>!e.isGranted)}clearCache(){this._allUserPermissions.set([]),this._searchTerm.set(""),this._userFilter.set("all"),this._permissionFilter.set("all"),this._grantedFilter.set("all"),this._expiredFilter.set("all"),this._currentPage.set(1),this.clearSelection(),this._currentUserPermission.set(null)}refreshData(){return this.loadUserPermissions()}static \u0275fac=function(t){return new(t||n)};static \u0275prov=F({token:n,factory:n.\u0275fac,providedIn:"root"})};var pe=class n{constructor(e){this.storageService=e;this.searchResults()}_allPermissions=d([]);_filteredPermissions=d([]);_searchTerm=d("");_currentPage=d(1);_pageSize=d(50);_isLoading=d(!1);_selectedPermissions=d(new Set);allPermissions=this._allPermissions.asReadonly();filteredPermissions=this._filteredPermissions.asReadonly();searchTerm=this._searchTerm.asReadonly();currentPage=this._currentPage.asReadonly();pageSize=this._pageSize.asReadonly();isLoading=this._isLoading.asReadonly();selectedPermissions=this._selectedPermissions.asReadonly();totalItems=f(()=>this._filteredPermissions().length);totalPages=f(()=>Math.ceil(this.totalItems()/this._pageSize()));paginatedPermissions=f(()=>{let e=(this._currentPage()-1)*this._pageSize(),t=e+this._pageSize();return this._filteredPermissions().slice(e,t)});searchResults=f(()=>{let e=this._searchTerm().toLowerCase();if(!e)return this._filteredPermissions.set(this._allPermissions()),this._allPermissions();let t=this._allPermissions().filter(i=>i.name.toLowerCase().includes(e)||i.code.toLowerCase().includes(e)||i.description?.toLowerCase().includes(e));return this._filteredPermissions.set(t),t});graphqlService=v(L);loadAllPermissions(e=!1){return p(this,null,function*(){if(!e&&this._allPermissions().length>0)return this._allPermissions();this._isLoading.set(!0);try{let t={orderBy:{createdAt:"desc"},include:{roles:{select:{id:!0,name:!0}}}},i=yield this.graphqlService.findMany("permission",t);return this._allPermissions.set(i),this._filteredPermissions.set(i),this._currentPage.set(1),i}catch(t){throw console.error("Error loading permissions:",t),t}finally{this._isLoading.set(!1)}})}createPermission(e){return p(this,null,function*(){this._isLoading.set(!0);try{let t=yield this.graphqlService.createOne("permission",{data:{name:e.name,code:e.code,description:e.description,isActive:e.isActive??!0},include:{roles:{select:{id:!0,name:!0}}}}),i=this._allPermissions();return this._allPermissions.set([t,...i]),t}catch(t){throw console.error("Error creating permission:",t),t}finally{this._isLoading.set(!1)}})}updatePermission(e,t){return p(this,null,function*(){this._isLoading.set(!0);try{let i=yield this.graphqlService.updateOne("permission",{id:e},t,{include:{roles:{select:{id:!0,name:!0}}}}),s=this._allPermissions(),a=s.findIndex(x=>x.id===e);if(a!==-1){let x=[...s];x[a]=i,this._allPermissions.set(x)}return i}catch(i){throw console.error("Error updating permission:",i),i}finally{this._isLoading.set(!1)}})}deletePermission(e){return p(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("permission",{id:e});let i=this._allPermissions().filter(a=>a.id!==e);this._allPermissions.set(i);let s=new Set(this._selectedPermissions());s.delete(e),this._selectedPermissions.set(s)}catch(t){throw console.error("Error deleting permission:",t),t}finally{this._isLoading.set(!1)}})}batchDeletePermissions(e){return p(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.batchDelete("permission",e);let i=this._allPermissions().filter(s=>!e.includes(s.id));this._allPermissions.set(i),this._selectedPermissions.set(new Set)}catch(t){throw console.error("Error batch deleting permissions:",t),t}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setPage(e){e>=1&&e<=this.totalPages()&&this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}nextPage(){this._currentPage()<this.totalPages()&&this._currentPage.set(this._currentPage()+1)}previousPage(){this._currentPage()>1&&this._currentPage.set(this._currentPage()-1)}togglePermissionSelection(e){let t=new Set(this._selectedPermissions());t.has(e)?t.delete(e):t.add(e),this._selectedPermissions.set(t)}selectAllCurrentPage(){let e=new Set(this._selectedPermissions());this.paginatedPermissions().forEach(t=>{e.add(t.id)}),this._selectedPermissions.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedPermissions());this.paginatedPermissions().forEach(t=>{e.delete(t.id)}),this._selectedPermissions.set(e)}clearSelection(){this._selectedPermissions.set(new Set)}isSelected(e){return this._selectedPermissions().has(e)}get selectedCount(){return this._selectedPermissions().size}get selectedIds(){return Array.from(this._selectedPermissions())}findPermissionById(e){return this._allPermissions().find(t=>t.id===e)}getPermissionsByCode(e){return this._allPermissions().filter(t=>e.includes(t.code))}getActivePermissions(){return this._allPermissions().filter(e=>e.isActive)}clearCache(){this._allPermissions.set([]),this._filteredPermissions.set([]),this._searchTerm.set(""),this._currentPage.set(1),this.clearSelection()}refreshData(){return this.loadAllPermissions(!0)}static \u0275fac=function(t){return new(t||n)(V(k))};static \u0275prov=F({token:n,factory:n.\u0275fac,providedIn:"root"})};var Ut=()=>[5,10,25,50];function wt(n,e){n&1&&(r(0,"div",26),b(1,"mat-spinner",27),r(2,"p",28),l(3,"\u0110ang t\u1EA3i d\u1EEF li\u1EC7u..."),o()())}function Mt(n,e){if(n&1){let t=w();r(0,"div",26)(1,"mat-icon",29),l(2,"error"),o(),r(3,"p",30),l(4),o(),r(5,"button",31),P("click",function(){_(t);let s=u();return h(s.loadUserPermissions())}),l(6," Th\u1EED l\u1EA1i "),o()()}if(n&2){let t=u();m(4),C(t.error())}}function Dt(n,e){n&1&&(r(0,"th",48),l(1,"Quy\u1EC1n"),o())}function bt(n,e){if(n&1&&(r(0,"td",49)(1,"div",50)(2,"span",51),l(3),o(),r(4,"span",52),l(5),o()()()),n&2){let t=e.$implicit;m(3),C(t.permission==null?null:t.permission.name),m(2),C(t.permission==null?null:t.permission.description)}}function Rt(n,e){n&1&&(r(0,"th",53),l(1,"Lo\u1EA1i"),o())}function It(n,e){if(n&1&&(r(0,"td",49)(1,"span"),l(2),o()()),n&2){let t=e.$implicit;m(),_e(t.isGranted?"bg-green-100 text-green-800 px-2 py-1 rounded text-xs":"bg-red-100 text-red-800 px-2 py-1 rounded text-xs"),m(),A(" ",t.isGranted?"\u0110\u01B0\u1EE3c c\u1EA5p":"B\u1ECB t\u1EEB ch\u1ED1i"," ")}}function Tt(n,e){n&1&&(r(0,"th",53),l(1,"Ng\u01B0\u1EDDi c\u1EA5p"),o())}function At(n,e){if(n&1&&(r(0,"td",49),l(1),o()),n&2){let t=e.$implicit;m(),A(" ",(t.grantedByUser==null?null:t.grantedByUser.name)||(t.grantedByUser==null?null:t.grantedByUser.email)||"N/A"," ")}}function Ft(n,e){n&1&&(r(0,"th",48),l(1,"Ng\xE0y c\u1EA5p"),o())}function kt(n,e){if(n&1&&(r(0,"td",49),l(1),ye(2,"date"),o()),n&2){let t=e.$implicit;m(),A(" ",ve(2,1,t.grantedAt,"dd/MM/yyyy HH:mm")," ")}}function Lt(n,e){n&1&&(r(0,"th",53),l(1,"H\u1EBFt h\u1EA1n"),o())}function Bt(n,e){n&1&&(r(0,"span",56),l(1,"\u0110\xE3 h\u1EBFt h\u1EA1n"),o())}function Vt(n,e){if(n&1&&(r(0,"div")(1,"span"),l(2),ye(3,"date"),o(),y(4,Bt,2,0,"span",55),o()),n&2){let t=u().$implicit,i=u(2);m(),_e(i.isExpired(t.expiresAt)?"text-red-600 font-medium":"text-gray-700"),m(),A(" ",ve(3,4,t.expiresAt,"dd/MM/yyyy HH:mm")," "),m(2),c("ngIf",i.isExpired(t.expiresAt))}}function zt(n,e){n&1&&(r(0,"span",57),l(1,"V\u0129nh vi\u1EC5n"),o())}function Gt(n,e){if(n&1&&(r(0,"td",49),y(1,Vt,5,7,"div",54)(2,zt,2,0,"ng-template",null,0,we),o()),n&2){let t=e.$implicit,i=T(3);m(),c("ngIf",t.expiresAt)("ngIfElse",i)}}function qt(n,e){n&1&&(r(0,"th",53),l(1,"L\xFD do"),o())}function Wt(n,e){if(n&1&&(r(0,"td",58)(1,"span",59),l(2),o()()),n&2){let t=e.$implicit;m(),c("title",t.reason),m(),A(" ",t.reason||"Kh\xF4ng c\xF3 ghi ch\xFA"," ")}}function Ot(n,e){n&1&&(r(0,"th",53),l(1,"Thao t\xE1c"),o())}function Nt(n,e){n&1&&(r(0,"mat-icon"),l(1,"more_vert"),o())}function Qt(n,e){n&1&&b(0,"mat-spinner",65)}function jt(n,e){if(n&1){let t=w();r(0,"td",49)(1,"button",60),y(2,Nt,2,0,"mat-icon",61)(3,Qt,1,0,"mat-spinner",62),o(),r(4,"mat-menu",null,1)(6,"button",63),P("click",function(){let s=_(t).$implicit,a=u(2);return h(a.editPermission(s))}),r(7,"mat-icon"),l(8,"edit"),o(),l(9," Ch\u1EC9nh s\u1EEDa "),o(),r(10,"button",64),P("click",function(){let s=_(t).$implicit,a=u(2);return h(a.revokePermission(s))}),r(11,"mat-icon"),l(12,"delete"),o(),l(13," Thu h\u1ED3i quy\u1EC1n "),o()()()}if(n&2){let t=e.$implicit,i=T(5),s=u(2);m(),c("matMenuTriggerFor",i)("disabled",s.processingPermission()===t.id),m(),c("ngIf",s.processingPermission()!==t.id),m(),c("ngIf",s.processingPermission()===t.id)}}function Ht(n,e){n&1&&b(0,"tr",66)}function Kt(n,e){if(n&1&&b(0,"tr",67),n&2){let t=e.$implicit,i=u(2);G("opacity-50",i.isExpired(t.expiresAt))}}function Xt(n,e){if(n&1){let t=w();r(0,"div",26)(1,"mat-icon",68),l(2,"assignment_ind"),o(),r(3,"p",69),l(4,"Kh\xF4ng c\xF3 quy\u1EC1n \u0111\u1EB7c bi\u1EC7t n\xE0o \u0111\u01B0\u1EE3c c\u1EA5p"),o(),r(5,"button",31),P("click",function(){_(t);let s=u(2);return h(s.openAssignDialog())}),l(6," Th\xEAm quy\u1EC1n \u0111\u1EA7u ti\xEAn "),o()()}}function Jt(n,e){if(n&1){let t=w();r(0,"mat-paginator",70),P("page",function(s){_(t);let a=u(2);return h(a.onPageChange(s))}),o()}if(n&2){let t=u(2);c("length",t.totalCount())("pageSize",t.pageSize())("pageSizeOptions",Ue(3,Ut))}}function Yt(n,e){if(n&1&&(r(0,"div",32)(1,"table",33),M(2,34),y(3,Dt,2,0,"th",35)(4,bt,6,2,"td",36),D(),M(5,37),y(6,Rt,2,0,"th",38)(7,It,3,3,"td",36),D(),M(8,39),y(9,Tt,2,0,"th",38)(10,At,2,1,"td",36),D(),M(11,40),y(12,Ft,2,0,"th",35)(13,kt,3,4,"td",36),D(),M(14,41),y(15,Lt,2,0,"th",38)(16,Gt,4,2,"td",36),D(),M(17,42),y(18,qt,2,0,"th",38)(19,Wt,3,2,"td",43),D(),M(20,44),y(21,Ot,2,0,"th",38)(22,jt,14,4,"td",36),D(),y(23,Ht,1,0,"tr",45)(24,Kt,1,2,"tr",46),o(),y(25,Xt,7,0,"div",22)(26,Jt,1,4,"mat-paginator",47),o()),n&2){let t=u();m(),c("dataSource",t.displayedPermissions()),m(22),c("matHeaderRowDef",t.displayedColumns),m(),c("matRowDefColumns",t.displayedColumns),m(),c("ngIf",t.displayedPermissions().length===0),m(),c("ngIf",t.displayedPermissions().length>0)}}function Zt(n,e){if(n&1&&(r(0,"div",71)(1,"h3",72),l(2,"Th\u1ED1ng k\xEA"),o(),r(3,"div",73)(4,"div")(5,"span",74),l(6,"T\u1ED5ng quy\u1EC1n:"),o(),r(7,"span",75),l(8),o()(),r(9,"div")(10,"span",74),l(11,"\u0110\u01B0\u1EE3c c\u1EA5p:"),o(),r(12,"span",76),l(13),o()(),r(14,"div")(15,"span",74),l(16,"B\u1ECB t\u1EEB ch\u1ED1i:"),o(),r(17,"span",77),l(18),o()(),r(19,"div")(20,"span",74),l(21,"\u0110\xE3 h\u1EBFt h\u1EA1n:"),o(),r(22,"span",78),l(23),o()()()()),n&2){let t=u();m(8),C(t.statistics().total),m(5),C(t.statistics().granted),m(5),C(t.statistics().denied),m(5),C(t.statistics().expired)}}function $t(n,e){if(n&1&&(r(0,"mat-option",90),l(1),o()),n&2){let t=e.$implicit;c("value",t.id),m(),Se(" ",t.name," - ",t.description," ")}}function ei(n,e){n&1&&b(0,"mat-spinner",98)}function ti(n,e){if(n&1){let t=w();r(0,"div",79),P("click",function(){_(t);let s=u();return h(s.closeAssignDialog())}),r(1,"div",80),P("click",function(s){return _(t),h(s.stopPropagation())}),r(2,"div",81)(3,"h3",82),l(4),o(),r(5,"button",83),P("click",function(){_(t);let s=u();return h(s.closeAssignDialog())}),r(6,"mat-icon"),l(7,"close"),o()()(),r(8,"form",84),P("ngSubmit",function(){_(t);let s=u();return h(s.handleAssignPermission())}),r(9,"div",85)(10,"mat-form-field",86)(11,"mat-label"),l(12,"Ch\u1ECDn quy\u1EC1n"),o(),r(13,"mat-select",87),U("ngModelChange",function(s){_(t);let a=u();return S(a.assignForm.permissionId,s)||(a.assignForm.permissionId=s),h(s)}),r(14,"mat-option",15),l(15,"-- Ch\u1ECDn quy\u1EC1n --"),o(),y(16,$t,2,3,"mat-option",88),o()(),r(17,"mat-form-field",86)(18,"mat-label"),l(19,"Lo\u1EA1i quy\u1EC1n"),o(),r(20,"mat-select",89),U("ngModelChange",function(s){_(t);let a=u();return S(a.assignForm.isGranted,s)||(a.assignForm.isGranted=s),h(s)}),r(21,"mat-option",90),l(22,"C\u1EA5p quy\u1EC1n"),o(),r(23,"mat-option",90),l(24,"T\u1EEB ch\u1ED1i quy\u1EC1n"),o()()(),r(25,"mat-form-field",86)(26,"mat-label"),l(27,"Ng\xE0y h\u1EBFt h\u1EA1n (t\xF9y ch\u1ECDn)"),o(),r(28,"input",91),U("ngModelChange",function(s){_(t);let a=u();return S(a.assignForm.expiresAt,s)||(a.assignForm.expiresAt=s),h(s)}),o(),b(29,"mat-datepicker-toggle",92)(30,"mat-datepicker",null,2),o(),r(32,"mat-form-field",86)(33,"mat-label"),l(34,"L\xFD do"),o(),r(35,"textarea",93),U("ngModelChange",function(s){_(t);let a=u();return S(a.assignForm.reason,s)||(a.assignForm.reason=s),h(s)}),o()()(),r(36,"div",94)(37,"button",95),P("click",function(){_(t);let s=u();return h(s.closeAssignDialog())}),l(38," H\u1EE7y "),o(),r(39,"button",96),y(40,ei,1,0,"mat-spinner",97),l(41),o()()()()()}if(n&2){let t=T(31),i=u();m(4),C(i.editingPermission()?"Ch\u1EC9nh s\u1EEDa quy\u1EC1n":"Th\xEAm quy\u1EC1n m\u1EDBi"),m(9),E("ngModel",i.assignForm.permissionId),m(3),c("ngForOf",i.availablePermissions()),m(4),E("ngModel",i.assignForm.isGranted),m(),c("value",!0),m(2),c("value",!1),m(5),c("matDatepicker",t),E("ngModel",i.assignForm.expiresAt),m(),c("for",t),m(6),E("ngModel",i.assignForm.reason),m(4),c("disabled",!i.assignForm.permissionId||i.isAssigning()),m(),c("ngIf",i.isAssigning()),m(),A(" ",i.editingPermission()?"C\u1EADp nh\u1EADt":"Th\xEAm quy\u1EC1n"," ")}}var ge=class n{userPermissionService=v(ue);permissionService=v(pe);snackBar=v(j);userId=Ce.required();isLoading=d(!1);error=d(null);processingPermission=d(null);showAssignDialog=d(!1);isAssigning=d(!1);editingPermission=d(null);userPermissions=d([]);availablePermissions=d([]);searchTerm=d("");selectedType=d("");selectedStatus=d("");pageSize=d(10);currentPage=d(0);totalCount=d(0);assignForm={permissionId:"",isGranted:!0,expiresAt:null,reason:""};displayedColumns=["permission","type","grantedBy","grantedAt","expiresAt","reason","actions"];displayedPermissions=f(()=>{let e=this.userPermissions();if(this.searchTerm()){let s=this.searchTerm().toLowerCase();e=e.filter(a=>a.permission?.name?.toLowerCase().includes(s)||a.permission?.description?.toLowerCase().includes(s))}if(this.selectedType()){let s=this.selectedType()==="granted";e=e.filter(a=>a.isGranted===s)}if(this.selectedStatus()){let s=new Date;this.selectedStatus()==="expired"?e=e.filter(a=>a.expiresAt&&new Date(a.expiresAt)<s):this.selectedStatus()==="active"&&(e=e.filter(a=>!a.expiresAt||new Date(a.expiresAt)>=s))}let t=this.currentPage()*this.pageSize(),i=t+this.pageSize();return this.totalCount.set(e.length),e.slice(t,i)});statistics=f(()=>{let e=this.userPermissions(),t=new Date;return{total:e.length,granted:e.filter(i=>i.isGranted).length,denied:e.filter(i=>!i.isGranted).length,expired:e.filter(i=>i.expiresAt&&new Date(i.expiresAt)<t).length}});constructor(){Me(()=>{this.userId()&&(this.loadUserPermissions(),this.loadAvailablePermissions())})}loadUserPermissions(){return p(this,null,function*(){if(this.userId())try{this.isLoading.set(!0),this.error.set(null);let e=yield this.userPermissionService.getUserPermissions(this.userId());this.userPermissions.set(e)}catch(e){console.error("Error loading user permissions:",e),this.error.set("Kh\xF4ng th\u1EC3 t\u1EA3i danh s\xE1ch quy\u1EC1n")}finally{this.isLoading.set(!1)}})}loadAvailablePermissions(){return p(this,null,function*(){try{let e=yield this.permissionService.loadAllPermissions();this.availablePermissions.set(e)}catch(e){console.error("Error loading available permissions:",e)}})}onSearchChange(){this.currentPage.set(0)}onPageChange(e){this.currentPage.set(e.pageIndex),this.pageSize.set(e.pageSize)}clearFilters(){this.searchTerm.set(""),this.selectedType.set(""),this.selectedStatus.set(""),this.currentPage.set(0)}isExpired(e){return e?new Date(e)<new Date:!1}openAssignDialog(){this.editingPermission.set(null),this.resetAssignForm(),this.showAssignDialog.set(!0)}closeAssignDialog(){this.showAssignDialog.set(!1),this.editingPermission.set(null),this.resetAssignForm()}editPermission(e){this.editingPermission.set(e),this.assignForm={permissionId:e.permissionId,isGranted:e.isGranted,expiresAt:e.expiresAt?new Date(e.expiresAt):null,reason:e.reason||""},this.showAssignDialog.set(!0)}handleAssignPermission(){return p(this,null,function*(){if(!(!this.userId()||!this.assignForm.permissionId))try{this.isAssigning.set(!0),this.editingPermission()?(yield this.userPermissionService.updateUserPermission(this.editingPermission().id,{isGranted:this.assignForm.isGranted,grantedBy:"current-user",expiresAt:this.assignForm.expiresAt||void 0,reason:this.assignForm.reason||void 0}),this.snackBar.open("C\u1EADp nh\u1EADt quy\u1EC1n th\xE0nh c\xF4ng","\u0110\xF3ng",{duration:3e3})):(yield this.userPermissionService.assignPermissionToUser({userId:this.userId(),permissionId:this.assignForm.permissionId,isGranted:this.assignForm.isGranted,expiresAt:this.assignForm.expiresAt||void 0,reason:this.assignForm.reason||void 0,grantedBy:"current-user"}),this.snackBar.open("Th\xEAm quy\u1EC1n th\xE0nh c\xF4ng","\u0110\xF3ng",{duration:3e3})),yield this.loadUserPermissions(),this.closeAssignDialog()}catch(e){console.error("Error assigning permission:",e),this.snackBar.open(e.message||"C\xF3 l\u1ED7i x\u1EA3y ra khi x\u1EED l\xFD quy\u1EC1n","\u0110\xF3ng",{duration:5e3})}finally{this.isAssigning.set(!1)}})}revokePermission(e){return p(this,null,function*(){if(confirm("B\u1EA1n c\xF3 ch\u1EAFc ch\u1EAFn mu\u1ED1n thu h\u1ED3i quy\u1EC1n n\xE0y kh\xF4ng?"))try{this.processingPermission.set(e.id),yield this.userPermissionService.deleteUserPermission(e.id),this.snackBar.open("Thu h\u1ED3i quy\u1EC1n th\xE0nh c\xF4ng","\u0110\xF3ng",{duration:3e3}),yield this.loadUserPermissions()}catch(t){console.error("Error revoking permission:",t),this.snackBar.open(t.message||"C\xF3 l\u1ED7i x\u1EA3y ra khi thu h\u1ED3i quy\u1EC1n","\u0110\xF3ng",{duration:5e3})}finally{this.processingPermission.set(null)}})}resetAssignForm(){this.assignForm={permissionId:"",isGranted:!0,expiresAt:null,reason:""}}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=z({type:n,selectors:[["app-user-permission-management"]],inputs:{userId:[1,"userId"]},decls:49,vars:9,consts:[["noExpiry",""],["actionMenu","matMenu"],["picker",""],[1,"user-permission-management","p-4"],[1,"header","mb-4"],[1,"flex","justify-between","items-center"],[1,"text-xl","font-bold"],["mat-raised-button","","color","primary",3,"click","disabled"],[1,"text-gray-600","mt-2"],[1,"filters","mb-4","p-4","bg-gray-50","rounded"],[1,"grid","grid-cols-1","md:grid-cols-4","gap-4"],["appearance","outline"],["matInput","","placeholder","T\xEAn quy\u1EC1n...",3,"ngModelChange","input","ngModel"],["matSuffix",""],[3,"ngModelChange","selectionChange","ngModel"],["value",""],["value","granted"],["value","denied"],["value","active"],["value","expired"],[1,"flex","items-end"],["mat-stroked-button","",3,"click"],["class","text-center py-8",4,"ngIf"],["class","table-container",4,"ngIf"],["class","statistics mt-6 p-4 bg-blue-50 rounded",4,"ngIf"],["class","fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",3,"click",4,"ngIf"],[1,"text-center","py-8"],[1,"mx-auto"],[1,"mt-4","text-gray-600"],[1,"text-red-500","text-4xl"],[1,"mt-2","text-red-600"],["mat-raised-button","","color","primary",1,"mt-4",3,"click"],[1,"table-container"],["mat-table","","matSort","",1,"w-full",3,"dataSource"],["matColumnDef","permission"],["mat-header-cell","","mat-sort-header","","class","font-bold",4,"matHeaderCellDef"],["mat-cell","","class","py-3",4,"matCellDef"],["matColumnDef","type"],["mat-header-cell","","class","font-bold",4,"matHeaderCellDef"],["matColumnDef","grantedBy"],["matColumnDef","grantedAt"],["matColumnDef","expiresAt"],["matColumnDef","reason"],["mat-cell","","class","py-3 max-w-xs",4,"matCellDef"],["matColumnDef","actions"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",3,"opacity-50",4,"matRowDef","matRowDefColumns"],["showFirstLastButtons","",3,"length","pageSize","pageSizeOptions","page",4,"ngIf"],["mat-header-cell","","mat-sort-header","",1,"font-bold"],["mat-cell","",1,"py-3"],[1,"flex","flex-col"],[1,"font-medium"],[1,"text-sm","text-gray-500"],["mat-header-cell","",1,"font-bold"],[4,"ngIf","ngIfElse"],["class","block text-xs text-red-500",4,"ngIf"],[1,"block","text-xs","text-red-500"],[1,"text-green-600","text-sm"],["mat-cell","",1,"py-3","max-w-xs"],[1,"text-sm","text-gray-700","line-clamp-2",3,"title"],["mat-icon-button","",3,"matMenuTriggerFor","disabled"],[4,"ngIf"],["diameter","20",4,"ngIf"],["mat-menu-item","",3,"click"],["mat-menu-item","",1,"text-red-600",3,"click"],["diameter","20"],["mat-header-row",""],["mat-row",""],[1,"text-gray-400","text-4xl"],[1,"mt-2","text-gray-600"],["showFirstLastButtons","",3,"page","length","pageSize","pageSizeOptions"],[1,"statistics","mt-6","p-4","bg-blue-50","rounded"],[1,"font-semibold","mb-2"],[1,"grid","grid-cols-2","md:grid-cols-4","gap-4","text-sm"],[1,"text-gray-600"],[1,"font-semibold","ml-1"],[1,"font-semibold","ml-1","text-green-600"],[1,"font-semibold","ml-1","text-red-600"],[1,"font-semibold","ml-1","text-orange-600"],[1,"fixed","inset-0","bg-black","bg-opacity-50","flex","items-center","justify-center","z-50",3,"click"],[1,"bg-white","rounded-lg","p-6","max-w-md","w-full","mx-4",3,"click"],[1,"flex","justify-between","items-center","mb-4"],[1,"text-lg","font-semibold"],["mat-icon-button","",3,"click"],[3,"ngSubmit"],[1,"space-y-4"],["appearance","outline",1,"w-full"],["name","permissionId","required","",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["name","isGranted","required","",3,"ngModelChange","ngModel"],[3,"value"],["matInput","","name","expiresAt",3,"ngModelChange","matDatepicker","ngModel"],["matIconSuffix","",3,"for"],["matInput","","name","reason","rows","3","placeholder","Nh\u1EADp l\xFD do c\u1EA5p/t\u1EEB ch\u1ED1i quy\u1EC1n n\xE0y...",3,"ngModelChange","ngModel"],[1,"flex","justify-end","space-x-2","mt-6"],["type","button","mat-stroked-button","",3,"click"],["type","submit","mat-raised-button","","color","primary",3,"disabled"],["diameter","20","class","mr-2",4,"ngIf"],["diameter","20",1,"mr-2"]],template:function(t,i){t&1&&(r(0,"div",3)(1,"div",4)(2,"div",5)(3,"h2",6),l(4,"Qu\u1EA3n L\xFD Quy\u1EC1n \u0110\u1EB7c Bi\u1EC7t"),o(),r(5,"button",7),P("click",function(){return i.openAssignDialog()}),r(6,"mat-icon"),l(7,"add"),o(),l(8," Th\xEAm Quy\u1EC1n "),o()(),r(9,"p",8),l(10," Qu\u1EA3n l\xFD c\xE1c quy\u1EC1n \u0111\u1EB7c bi\u1EC7t cho user n\xE0y (s\u1EBD ghi \u0111\xE8 quy\u1EC1n t\u1EEB roles) "),o()(),r(11,"div",9)(12,"div",10)(13,"mat-form-field",11)(14,"mat-label"),l(15,"T\xECm ki\u1EBFm quy\u1EC1n"),o(),r(16,"input",12),U("ngModelChange",function(a){return S(i.searchTerm,a)||(i.searchTerm=a),a}),P("input",function(){return i.onSearchChange()}),o(),r(17,"mat-icon",13),l(18,"search"),o()(),r(19,"mat-form-field",11)(20,"mat-label"),l(21,"Lo\u1EA1i quy\u1EC1n"),o(),r(22,"mat-select",14),U("ngModelChange",function(a){return S(i.selectedType,a)||(i.selectedType=a),a}),P("selectionChange",function(){return i.loadUserPermissions()}),r(23,"mat-option",15),l(24,"T\u1EA5t c\u1EA3"),o(),r(25,"mat-option",16),l(26,"\u0110\u01B0\u1EE3c c\u1EA5p"),o(),r(27,"mat-option",17),l(28,"B\u1ECB t\u1EEB ch\u1ED1i"),o()()(),r(29,"mat-form-field",11)(30,"mat-label"),l(31,"Tr\u1EA1ng th\xE1i"),o(),r(32,"mat-select",14),U("ngModelChange",function(a){return S(i.selectedStatus,a)||(i.selectedStatus=a),a}),P("selectionChange",function(){return i.loadUserPermissions()}),r(33,"mat-option",15),l(34,"T\u1EA5t c\u1EA3"),o(),r(35,"mat-option",18),l(36,"Ho\u1EA1t \u0111\u1ED9ng"),o(),r(37,"mat-option",19),l(38,"\u0110\xE3 h\u1EBFt h\u1EA1n"),o()()(),r(39,"div",20)(40,"button",21),P("click",function(){return i.clearFilters()}),r(41,"mat-icon"),l(42,"clear"),o(),l(43," X\xF3a b\u1ED9 l\u1ECDc "),o()()()(),y(44,wt,4,0,"div",22)(45,Mt,7,1,"div",22)(46,Yt,27,5,"div",23)(47,Zt,24,4,"div",24),o(),y(48,ti,42,13,"div",25)),t&2&&(m(5),c("disabled",!i.userId()||i.isLoading()),m(11),E("ngModel",i.searchTerm),m(6),E("ngModel",i.selectedType),m(10),E("ngModel",i.selectedStatus),m(12),c("ngIf",i.isLoading()),m(),c("ngIf",i.error()),m(),c("ngIf",!i.isLoading()&&!i.error()),m(),c("ngIf",!i.isLoading()&&!i.error()),m(),c("ngIf",i.showAssignDialog()))},dependencies:[W,De,q,be,ie,Le,$,ee,Fe,Be,te,ke,oe,re,ne,Ve,le,ae,Q,O,N,K,H,dt,et,it,ot,st,tt,at,nt,rt,lt,mt,Je,Xe,$e,Ye,Ze,me,ze,Ae,We,je,Oe,Ne,Qe,Te,Z,J,X,Y,se,Ke,He],encapsulation:2})};function ii(n,e){if(n&1){let t=w();r(0,"button",3),P("click",function(){_(t);let s=u();return h(s.handleUserAction())}),r(1,"mat-icon"),l(2,"save"),o()()}}function si(n,e){if(n&1){let t=w();r(0,"button",3),P("click",function(){_(t);let s=u();return h(s.toggleEdit())}),r(1,"mat-icon"),l(2,"edit"),o()()}}function ni(n,e){if(n&1){let t=w();M(0),r(1,"div",11)(2,"div",12),l(3,"B\u1EA1n ch\u1EAFc ch\u1EAFn mu\u1ED1n xo\xE1 kh\xF4ng?"),o(),r(4,"div",13)(5,"button",14),P("click",function(){_(t);let s=u();return h(s.DeleteData())}),l(6,"\u0110\u1ED3ng \xDD"),o(),r(7,"button",15),P("click",function(){_(t);let s=u();return h(s.toggleDelete())}),l(8,"Hu\u1EF7 B\u1ECF"),o()()(),D()}}function ri(n,e){n&1&&(M(0),r(1,"mat-icon",34),l(2,"refresh"),o(),l(3," \u0110ang th\xEAm... "),D())}function oi(n,e){n&1&&l(0," Th\xEAm Nh\xF3m ")}function ai(n,e){n&1&&(r(0,"mat-icon",36),l(1,"refresh"),o())}function li(n,e){if(n&1){let t=w();r(0,"mat-icon",38),P("click",function(){_(t);let s=u().$implicit,a=u(2);return h(a.handleRemoveRole(s))}),l(1,"close"),o()}n&2&&Ee("cursor","pointer")}function mi(n,e){if(n&1&&(r(0,"div",35)(1,"div",4),l(2),o(),y(3,ai,2,0,"mat-icon",36)(4,li,2,2,"mat-icon",37),o()),n&2){let t=e.$implicit,i=u(2);G("opacity-50",i.isRemovingRole()),m(2),C((t==null||t.role==null?null:t.role.name)||(t==null?null:t.name)),m(),he(i.isRemovingRole()?3:4)}}function di(n,e){if(n&1){let t=w();r(0,"button",39),P("click",function(){let s=_(t).$implicit,a=u(2);return h(a.handleAddRole(s))}),l(1),o()}if(n&2){let t=e.$implicit;m(),C(t.name)}}function ci(n,e){if(n&1&&(r(0,"div",40)(1,"div",41),b(2,"app-user-permission-management",42),o()()),n&2){let t=u(2);m(2),c("userId",t.DetailUser().id)}}function ui(n,e){if(n&1){let t=w();M(0),r(1,"div",16)(2,"mat-form-field",17)(3,"mat-label"),l(4,"Email"),o(),r(5,"input",18),U("ngModelChange",function(s){_(t);let a=u();return S(a.DetailUser().email,s)||(a.DetailUser().email=s),h(s)}),o()(),r(6,"mat-form-field",17)(7,"mat-label"),l(8,"H\u1ECD V\xE0 T\xEAn"),o(),r(9,"input",19),U("ngModelChange",function(s){_(t);let a=u();return S(a.DetailUser().name,s)||(a.DetailUser().name=s),h(s)}),o()(),r(10,"mat-form-field",17)(11,"mat-label"),l(12,"S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i"),o(),r(13,"input",20),U("ngModelChange",function(s){_(t);let a=u();return S(a.DetailUser().SDT,s)||(a.DetailUser().SDT=s),h(s)}),o()(),r(14,"mat-form-field",17)(15,"mat-label"),l(16,"M\u1EADt Kh\u1EA9u "),o(),r(17,"input",21),U("ngModelChange",function(s){_(t);let a=u();return S(a.DetailUser().password,s)||(a.DetailUser().password=s),h(s)}),o()(),r(18,"div",22)(19,"button",23,0),y(21,ri,4,0,"ng-container")(22,oi,1,0),o(),r(23,"div",5),Pe(24,mi,5,4,"div",24,fe),o()(),r(26,"mat-menu",null,1)(28,"div",25),P("click",function(s){return _(t),h(s.stopPropagation())}),r(29,"div",26)(30,"input",27),P("keyup",function(s){_(t);let a=u();return h(a.doFilterHederColumn(s))}),o(),r(31,"div",28)(32,"span",29),l(33,"search"),o()()(),r(34,"div",30),Pe(35,di,2,1,"button",31,fe),o(),r(37,"div",32)(38,"button",15),P("click",function(){_(t);let s=T(20);return h(s.closeMenu())}),l(39,"\u0110\xF3ng"),o()()()(),y(40,ci,3,1,"div",33),o(),D()}if(n&2){let t=T(27),i=u();m(5),E("ngModel",i.DetailUser().email),c("disabled",!i.isEdit()),m(4),E("ngModel",i.DetailUser().name),c("disabled",!i.isEdit()),m(4),E("ngModel",i.DetailUser().SDT),c("disabled",!i.isEdit()),m(4),E("ngModel",i.DetailUser().password),c("disabled",!i.isEdit()),m(2),c("disabled",!i.isEdit()||i.isAddingRole())("matMenuTriggerFor",t),m(2),he(i.isAddingRole()?21:22),m(3),xe(i.DetailUser().roles),m(11),xe(i.FilterRole()),m(5),c("ngIf",i.DetailUser().id&&i.DetailUser().id!=="new")}}var _t=class n{_ListuserComponent=v(gt);_UserGraphQLService=v(pt);_RoleGraphQLService=v(de);_route=v(Re);_router=v(Ie);_snackBar=v(j);constructor(){this._route.paramMap.subscribe(e=>{let t=e.get("id");t==="new"?this.userId.set(t):t&&!this._UserGraphQLService.currentUser()&&this.userId.set(t)})}DetailUser=d({});isEdit=d(!1);isDelete=d(!1);isLoading=d(!1);isAddingRole=d(!1);isRemovingRole=d(!1);userId=d(null);ListRole=d([]);FilterRole=d([]);getUserById(e){return p(this,null,function*(){try{let t=yield this._UserGraphQLService.getUserById(e);t&&this.DetailUser.set(B(I({},t),{SDT:t.SDT||""}))}catch(t){console.error("Error loading user:",t),this._snackBar.open("L\u1ED7i khi t\u1EA3i th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng","\u0110\xF3ng",{duration:3e3})}})}ngOnInit(){return p(this,null,function*(){let e=this.userId();if(!e){this._router.navigate(["/admin/user"]),this._ListuserComponent.drawer.close();return}e==="new"?(this.DetailUser.set({email:"",password:"",SDT:"",isActive:!0,roles:[],profile:{name:"",avatar:"",bio:""}}),this._ListuserComponent?.drawer?.open(),this.isEdit.update(t=>!t)):e&&(yield this.getUserById(e),this._ListuserComponent?.drawer?.open(),this._router.navigate(["/admin/user",e])),yield this._RoleGraphQLService.loadAllRoles(),this.ListRole.set(this._RoleGraphQLService.allRoles()),this.updateFilterRole()})}updateFilterRole(){let e=this.ListRole()||[],t=this.DetailUser()?.roles||[];if(e.length===0){this.FilterRole.set([]);return}let i=e.filter(s=>!s||!s.id?!1:!t.some(a=>a?a.roleId===s.id||a.role?.id===s.id:!1));this.FilterRole.set(i)}handleUserAction(){return p(this,null,function*(){this.userId()==="new"?yield this.createUser():yield this.updateUser()})}createUser(){return p(this,null,function*(){try{if(!this.DetailUser().password||this.DetailUser().password.trim()===""){this._snackBar.open("Vui l\xF2ng nh\u1EADp password","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}if(!this.DetailUser().SDT||this.DetailUser().SDT.trim()===""){this._snackBar.open("Vui l\xF2ng nh\u1EADp SDT","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}yield this._UserGraphQLService.createUser(this.DetailUser()),this._snackBar.open("T\u1EA1o M\u1EDBi Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.update(e=>!e)}catch(e){console.error("L\u1ED7i khi t\u1EA1o user:",e)}})}updateUser(){return p(this,null,function*(){try{yield this._UserGraphQLService.updateUser(this.DetailUser().id,this.DetailUser()),this._snackBar.open("C\u1EADp Nh\u1EADt Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.update(e=>!e)}catch(e){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt user:",e)}})}DeleteData(){return p(this,null,function*(){try{yield this._UserGraphQLService.deleteUser(this.DetailUser().id),this._snackBar.open("X\xF3a Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this._router.navigate(["/admin/user"])}catch(e){console.error("L\u1ED7i khi x\xF3a user:",e)}})}FillSlug(){this.DetailUser.update(e=>B(I({},e),{slug:Ge(e.title)}))}doFilterHederColumn(e){let t=this.ListRole();this.FilterRole.set(t.filter(i=>i.name.toLowerCase().includes(e.target.value.toLowerCase())))}handleAddRole(e){return p(this,null,function*(){if(!e||!e.id||this.isAddingRole()){(!e||!e.id)&&this._snackBar.open("D\u1EEF li\u1EC7u vai tr\xF2 kh\xF4ng h\u1EE3p l\u1EC7","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}this.isAddingRole.set(!0);try{if((this.DetailUser()?.roles||[]).some(s=>s.roleId===e.id||s.role?.id===e.id)){this._snackBar.open("Vai tr\xF2 \u0111\xE3 \u0111\u01B0\u1EE3c th\xEAm","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-warning"]});return}yield this._UserGraphQLService.assignRolesToUser(this.DetailUser().id,[e.id]),this.DetailUser.update(s=>B(I({},s),{roles:[...s.roles||[],{id:qe(8,!1),userId:this.DetailUser().id,roleId:e.id,role:e}]})),this.updateFilterRole(),this._snackBar.open("Th\xEAm vai tr\xF2 th\xE0nh c\xF4ng","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(t){console.error("Error adding role:",t),this._snackBar.open("L\u1ED7i khi th\xEAm vai tr\xF2","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}finally{this.isAddingRole.set(!1)}})}handleRemoveRole(e){return p(this,null,function*(){if(!e||this.isRemovingRole()){e||this._snackBar.open("D\u1EEF li\u1EC7u vai tr\xF2 kh\xF4ng h\u1EE3p l\u1EC7","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}this.isRemovingRole.set(!0);try{let t=e.role?.id||e.roleId;if(!t){this._snackBar.open("Kh\xF4ng th\u1EC3 x\xE1c \u0111\u1ECBnh ID vai tr\xF2","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}yield this._UserGraphQLService.removeRoleFromUser(this.DetailUser().id,t),this.DetailUser.update(i=>B(I({},i),{roles:(i.roles||[]).filter(s=>(s.role?.id||s.roleId)!==t)})),this.updateFilterRole(),this._snackBar.open("X\xF3a vai tr\xF2 th\xE0nh c\xF4ng","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(t){console.error("Error removing role:",t),this._snackBar.open("L\u1ED7i khi x\xF3a vai tr\xF2","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}finally{this.isRemovingRole.set(!1)}})}goBack(){this._UserGraphQLService.clearCurrentUser(),this._ListuserComponent.drawer.close(),this._router.navigate(["/admin/user"])}trackByFn(e,t){return t.id}toggleEdit(){this.isEdit.update(e=>!e)}toggleDelete(){this.isDelete.update(e=>!e)}static \u0275fac=function(t){return new(t||n)};static \u0275cmp=z({type:n,selectors:[["app-detailuser"]],decls:17,vars:8,consts:[["menuTrigger","matMenuTrigger"],["menu","matMenu"],[1,"flex","flex-row","justify-between","items-center","space-x-2","p-2"],["mat-icon-button","","color","primary",3,"click"],[1,"font-bold"],[1,"flex","flex-row","space-x-2","items-center"],[3,"ngModelChange","ngModel","disabled"],["mat-icon-button","","color","primary",3,"click",4,"ngIf"],["mat-icon-button","","color","warn",3,"click"],[1,"relative","flex","flex-col","w-full","p-4","overflow-auto"],[4,"ngIf"],[1,"flex","flex-col","space-y-4","items-center","justify-center"],[1,"font-bold","text-2xl"],[1,"flex","flex-row","space-x-2","items-center","justify-center"],["mat-flat-button","","color","primary",3,"click"],["mat-flat-button","","color","warn",3,"click"],[1,"w-full","flex","flex-col","space-y-2"],["appearance","outline"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp Email",3,"ngModelChange","ngModel","disabled"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp H\u1ECD V\xE0 T\xEAn",3,"ngModelChange","ngModel","disabled"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i",3,"ngModelChange","ngModel","disabled"],["matInput","","type","password","placeholder","Vui l\xF2ng nh\u1EADp S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i",3,"ngModelChange","ngModel","disabled"],[1,"w-full","flex","flex-wrap","gap-2","space-x-2"],["mat-flat-button","","color","primary",3,"disabled","matMenuTriggerFor"],[1,"cursor-pointer","flex","flex-row","space-x-2","items-center","p-2","rounded-lg","bg-gray-100",3,"opacity-50"],[1,"cursor-pointer","flex","flex-col","space-y-4","p-3",3,"click"],[1,"relative","w-full"],["type","text","placeholder","T\xECm Ki\u1EBFm...",1,"block","w-full","pl-10","pr-4","py-2","text-gray-700","bg-white","border","border-gray-300","rounded-lg","focus:border-blue-400","focus:ring-blue-400","focus:outline-none","focus:ring","focus:ring-opacity-40",3,"keyup"],[1,"absolute","inset-y-0","left-0","flex","items-center","pl-3","pointer-events-none"],[1,"material-symbols-outlined","text-gray-500"],[1,"w-full","flex","flex-col","space-y-2","max-h-44","overflow-auto"],["mat-menu-item",""],[1,"flex","flex-row","space-x-2","items-center","justify-end"],["class","mt-8",4,"ngIf"],[1,"animate-spin"],[1,"cursor-pointer","flex","flex-row","space-x-2","items-center","p-2","rounded-lg","bg-gray-100"],[1,"animate-spin","text-gray-500"],["color","warn",3,"cursor"],["color","warn",3,"click"],["mat-menu-item","",3,"click"],[1,"mt-8"],[1,"border-t","pt-6"],[3,"userId"]],template:function(t,i){if(t&1&&(r(0,"div",2)(1,"button",3),P("click",function(){return i.goBack()}),r(2,"mat-icon"),l(3,"arrow_back"),o()(),r(4,"div",4),l(5),o(),r(6,"div",5)(7,"mat-slide-toggle",6),U("ngModelChange",function(a){return S(i.DetailUser().isActive,a)||(i.DetailUser().isActive=a),a}),l(8),o(),y(9,ii,3,0,"button",7)(10,si,3,0,"button",7),r(11,"button",8),P("click",function(){return i.toggleDelete()}),r(12,"mat-icon"),l(13,"delete"),o()()()(),r(14,"div",9),y(15,ni,9,0,"ng-container",10)(16,ui,41,12,"ng-container",10),o()),t&2){let s;m(5),C(((s=i.DetailUser())==null?null:s.email)||"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"),m(2),E("ngModel",i.DetailUser().isActive),c("disabled",!i.isEdit()),m(),C(i.DetailUser().isActive?"Hi\u1EC3n Th\u1ECB":"\u1EA8n"),m(),c("ngIf",i.isEdit()),m(),c("ngIf",!i.isEdit()),m(5),c("ngIf",i.isDelete()),m(),c("ngIf",!i.isDelete())}},dependencies:[oe,re,ne,le,ae,ie,$,ee,te,K,H,Q,O,N,me,se,W,q,ut,ct,Z,J,X,Y,ge],encapsulation:2})};export{_t as DetailUserComponent};
