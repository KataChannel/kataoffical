{
  "version": 3,
  "sources": ["src/app/admin/khachhang/khachhang.service.ts"],
  "sourcesContent": ["import { inject, Injectable, signal, Signal } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { environment } from '../../../environments/environment.development';\nimport { StorageService } from '../../shared/utils/storage.service';\nimport { openDB } from 'idb';\nimport { ErrorLogService } from '../../shared/services/errorlog.service';\nimport { MatSnackBar } from '@angular/material/snack-bar';\nimport { SharedSocketService } from '../../shared/services/sharedsocket.service';\n@Injectable({\n  providedIn: 'root'\n})\nexport class KhachhangService {\n  private socket: any;\n  constructor(\n    private _StorageService: StorageService,\n    private router: Router,\n    private _ErrorLogService: ErrorLogService,\n    private _sharedSocketService: SharedSocketService,\n  ) {\n    this.socket = this._sharedSocketService.getSocket();\n    this.listenKhachhangUpdates();\n  }\n  private _snackBar: MatSnackBar = inject(MatSnackBar);\n  ListKhachhang = signal<any[]>([]);\n  DetailKhachhang = signal<any>({});\n  page = signal<number>(1);\n  totalPages = signal<number>(1);\n  total = signal<number>(0);\n  pageSize = signal<number>(50); // M·∫∑c ƒë·ªãnh 10 m·ª•c m·ªói trang\n  khachhangId = signal<string | null>(null);\n\n  // Kh·ªüi t·∫°o IndexedDB\n  private async initDB() {\n    return await openDB('KhachhangDB', 4, {\n      upgrade(db, oldVersion) {\n        if (oldVersion < 1) {\n          db.createObjectStore('khachhangs', { keyPath: 'id' });\n        }\n        if (oldVersion < 3) {\n          if (db.objectStoreNames.contains('khachhangs')) {\n            db.deleteObjectStore('khachhangs');\n          }\n          if (db.objectStoreNames.contains('pagination')) {\n            db.deleteObjectStore('pagination');\n          }\n          db.createObjectStore('khachhangs', { keyPath: 'id' });\n        }\n        if (oldVersion < 4) {\n          // Kh√¥ng c·∫ßn x√≥a store, v√¨ c·∫•u tr√∫c v·∫´n t∆∞∆°ng th√≠ch\n          // Ch·ªâ c·∫ßn ƒë·∫£m b·∫£o pagination c√≥ th√™m pageSize\n        }\n      },\n    });\n  }\n\n  // L∆∞u d·ªØ li·ªáu v√† ph√¢n trang v√†o IndexedDB\n\n  // L·∫•y d·ªØ li·ªáu v√† ph√¢n trang t·ª´ cache\n\n  setKhachhangId(id: string | null) {\n    this.khachhangId.set(id);\n  }\n    async ImportKhachhang(dulieu: any) {\n      try {\n        const options = {\n            method:'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n            },\n            body: JSON.stringify(dulieu),\n          };\n          const response = await fetch(`${environment.APIURL}/khachhang/import`, options);\n          if (!response.ok) {\n            throw new Error(`HTTP error! status: ${response.status}`);\n          }\n          const data = await response.json();\n          if (!response.ok) {\n            this.handleError(response.status);\n          }\n          this.getAllKhachhang()\n          this.khachhangId.set(data.id)\n      } catch (error) {\n          return console.error(error);\n      }\n    }\n  async CreateKhachhang(dulieu: any) {\n    try {\n      const options = {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n        body: JSON.stringify(dulieu),\n      };\n      const response = await fetch(`${environment.APIURL}/khachhang`, options);\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      const data = await response.json();\n      this.getAllKhachhang(this.pageSize());\n      this.khachhangId.set(data.id);\n    } catch (error) {\n      this._ErrorLogService.logError('Failed to CreateKhachhang', error);\n      console.error(error);\n    }\n  }\n\n  async getKhachhangforselect() {\n    try {\n      const options = {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n      };\n\n      const response = await fetch(`${environment.APIURL}/khachhang/forselect`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n        return [];\n      }\n      const data = await response.json();\n      this.ListKhachhang.set(data.data);\n      return data.data;\n    } catch (error) {\n      console.error(error);\n      return [];\n    }\n  }\n\n\n  async getAllKhachhang(queryParams: any = {}, forceRefresh: boolean = false) {\n    try {\n      const options = {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n      };\n\n      queryParams = {\n        page: this.page().toString(),\n        pageSize: this.pageSize().toString(),\n        ...queryParams, // Th√™m c√°c tham s·ªë kh√°c n·∫øu c·∫ßn\n      };\n      // T·∫°o query string t·ª´ queryParams, ch·ªâ th√™m c√°c gi√° tr·ªã c√≥ n·ªôi dung\n      const query = new URLSearchParams();\n      Object.entries(queryParams).forEach(([key, value]) => {\n        if (value) {\n          query.append(key, String(value));\n        }\n      });\n\n      // N·∫øu forceRefresh = true th√¨ b·ªè qua cache v√† t·∫£i d·ªØ li·ªáu m·ªõi lu√¥n\n      const response = await fetch(`${environment.APIURL}/khachhang?${query}`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      // L∆∞u d·ªØ li·ªáu m·ªõi v√†o cache\n      const data = await response.json();\n\n      // C·∫≠p nh·∫≠t th·ªùi gian cache: v·ªõi forceRefresh, s·ª≠ d·ª•ng th·ªùi gian hi·ªán t·∫°i\n      this.ListKhachhang.set(data.data);\n      this.page.set(data.page || 1);\n      this.totalPages.set(data.totalPages || 1);\n      this.total.set(data.total || data.data.length);\n      this.pageSize.set(this.pageSize());\n      return data.data;\n\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n\n  async getUpdatedCodeIds() {\n    try {\n      const options = {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n      };\n      const response = await fetch(`${environment.APIURL}/khachhang/updateCodeIds`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      const data = await response.json();\n      this.getAllKhachhang(this.pageSize());\n      return data.data;\n    } catch (error) {\n      this._ErrorLogService.logError('Failed to getUpdatedCodeIds', error);\n      console.error(error);\n    }\n  }\n\n  listenKhachhangUpdates() {\n    this.socket.off('khachhang-updated'); // ƒë·∫£m b·∫£o kh√¥ng ƒëƒÉng k√Ω nhi·ªÅu l·∫ßn\n    this.socket.on('khachhang-updated', async () => {\n      console.log('üîÑ D·ªØ li·ªáu s·∫£n ph·∫©m thay ƒë·ªïi, c·∫≠p nh·∫≠t l·∫°i cache...');\n      this._StorageService.removeItem('khachhangs_updatedAt');\n      await this.getAllKhachhang();\n    });\n  }\n\n  async getKhachhangBy(param: any) {\n    try {\n      const options = {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n        body: JSON.stringify(param),\n      };\n      const response = await fetch(`${environment.APIURL}/khachhang/findby`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      const data = await response.json();\n      \n      if (param.isOne === true) {\n        this.DetailKhachhang.set(data);        \n        return data;\n      } else {\n        this._StorageService.setItem('khachhangs_updatedAt', new Date().toISOString());\n        this.ListKhachhang.set(data.data);\n        this.page.set(data.page || 1);\n        this.totalPages.set(data.totalPages || 1);\n        this.total.set(data.total || data.data.length);\n        this.pageSize.set(this.pageSize());\n        return data.data;\n      }\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async updateKhachhang(dulieu: any) {\n    try {\n      const options = {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n        body: JSON.stringify(dulieu),\n      };\n      const response = await fetch(`${environment.APIURL}/khachhang/${dulieu.id}`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      const data = await response.json();\n      this.getAllKhachhang(this.pageSize());\n      this.getKhachhangBy({ id: data.id, isOne: true });\n    } catch (error) {\n      this._ErrorLogService.logError('Failed to updateKhachhang', error);\n      console.error(error);\n    }\n  }\n\n  async DeleteKhachhang(item: any) {\n    try {\n      const options = {\n        method: 'DELETE',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n      };\n      const response = await fetch(`${environment.APIURL}/khachhang/${item.id}`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      this.getAllKhachhang(this.pageSize());\n    } catch (error) {\n      this._ErrorLogService.logError('Failed to DeleteKhachhang', error);\n      console.error(error);\n    }\n  }\n\n  private handleError(status: number) {\n    let message = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';\n    switch (status) {\n      case 400:\n        message = 'Th√¥ng tin ƒë√£ t·ªìn t·∫°i';\n        break;\n      case 401:\n      case 404:\n        message = 'Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i';\n        break;\n      case 403:\n        message = 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p';\n        break;\n      case 500:\n        message = 'L·ªói m√°y ch·ªß, vui l√≤ng th·ª≠ l·∫°i sau';\n        break;\n    }\n    this._snackBar.open(message, '', {\n      duration: 1000,\n      horizontalPosition: 'end',\n      verticalPosition: 'top',\n      panelClass: ['snackbar-error'],\n    });\n  }\n}"],
  "mappings": "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",
  "names": []
}
