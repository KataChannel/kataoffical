import{a as f}from"./chunk-G5IIQAME.js";import{a as L}from"./chunk-MXRERSWW.js";import{a as G}from"./chunk-JNVUT6FC.js";import{a as m}from"./chunk-IXY23C6B.js";import{c as y}from"./chunk-PWU56VV4.js";import{a as v}from"./chunk-RQQ6YENK.js";import{a as S}from"./chunk-VXBHOSYZ.js";import{a as k}from"./chunk-RHYJKD3I.js";import{Ra as i,ja as p,pa as o}from"./chunk-WYL4U5YK.js";import{a as g,b as c,g as b,j as s}from"./chunk-6DYNGEAS.js";var u=b(G());var D=class l{_GraphqlService=o(k);_StorageService=o(v);_router=o(y);_snackBar=o(S);_ErrorLogService=o(m);_sharedSocketService=o(L);_donhangService=o(f);socket;ListDonhang=i([]);ListVandon=i([]);DetailDonhang=i({});page=i(1);totalPages=i(1);total=i(0);pageSize=i(50);donhangId=i(null);loading=i(!1);error=i(null);constructor(){this.socket=this._sharedSocketService.getSocket(),this.socket?.on("donhang:updated",a=>{this.refreshDonhangData()})}setDonhangId(a){this.donhangId.set(a),a&&this.getOneDonhang(a)}searchDonhang(a){return s(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t={};a.Batdau&&a.Ketthuc&&(t.ngaygiao={gte:(0,u.default)(a.Batdau).startOf("day").toISOString(),lte:(0,u.default)(a.Ketthuc).endOf("day").toISOString()}),a.Status&&(t.status=a.Status);let r=yield this._GraphqlService.findMany("donhang",{where:t,include:{khachhang:{select:{id:!0,name:!0,sdt:!0,diachi:!0}},sanpham:{select:{id:!0,idSP:!0,sldat:!0,slgiao:!0,slnhan:!0,slhuy:!0,ttdat:!0,ttgiao:!0,ttnhan:!0,ghichu:!0,order:!0,isActive:!0,giaban:!0,ttsauvat:!0,vat:!0,sanpham:{select:{id:!0,masp:!0,title:!0,giagoc:!0,dvt:!0}}}}},orderBy:{createdAt:"desc"},take:a.pageSize||9999});this.ListDonhang.set(r||[]);let n=this.createVandonList(r||[]);return this.ListVandon.set(n),this.loading.set(!1),r}catch(t){throw this.error.set(t.message||"L\u1ED7i khi t\u1EA3i d\u1EEF li\u1EC7u \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i t\xECm ki\u1EBFm \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),t}})}createVandonList(a){return a.flatMap((t,r)=>(t.sanpham||[]).map(n=>({id:n.id,idSP:n.idSP,sldat:n.sldat,slgiao:n.slgiao,slnhan:n.slnhan,slhuy:n.slhuy,ttdat:n.ttdat,ttgiao:n.ttgiao,ttnhan:n.ttnhan,ghichu:n.ghichu,order:n.order,isActive:n.isActive,giaban:n.giaban,ttsauvat:n.ttsauvat,vat:n.vat,masp:n.sanpham?.masp,title:n.sanpham?.title,giagoc:n.sanpham?.giagoc,dvt:n.sanpham?.dvt,madonhang:t.madonhang,khachhang:t.khachhang?.name,sdt:t.khachhang?.sdt,diachi:t.khachhang?.diachi,createdAt:t.createdAt,ngaygiao:t.ngaygiao,status:t.status}))).map((t,r)=>c(g({},t),{stt:r+1}))}getOneDonhang(a){return s(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t=yield this._GraphqlService.findUnique("donhang",{id:a},{include:{khachhang:{select:{id:!0,name:!0,sdt:!0,diachi:!0,email:!0}},sanpham:{select:{id:!0,idSP:!0,sldat:!0,slgiao:!0,slnhan:!0,slhuy:!0,ttdat:!0,ttgiao:!0,ttnhan:!0,ghichu:!0,order:!0,isActive:!0,giaban:!0,ttsauvat:!0,vat:!0,sanpham:{select:{id:!0,masp:!0,title:!0,giagoc:!0,dvt:!0}}}},user:{select:{id:!0,email:!0,profile:{select:{name:!0}}}}}});return this.DetailDonhang.set(t||{}),this.loading.set(!1),t}catch(t){throw this.error.set(t.message||"L\u1ED7i khi t\u1EA3i chi ti\u1EBFt \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i l\u1EA5y chi ti\u1EBFt \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),t}})}CreateDonhang(a){return s(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t={madonhang:a.madonhang||this.generateMaDonhang(),status:a.status||"dadat",tongtien:a.tongtien||0,khachhangId:a.khachhangId,ngaygiao:a.ngaygiao?new Date(a.ngaygiao).toISOString():null,ghichu:a.ghichu||"",order:a.order||1,isActive:a.isActive!==void 0?a.isActive:!0},r=yield this._GraphqlService.createOne("donhang",t);return yield this.refreshDonhangData(),this._snackBar.open("T\u1EA1o \u0111\u01A1n h\xE0ng th\xE0nh c\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.loading.set(!1),r}catch(t){throw this.error.set(t.message||"L\u1ED7i khi t\u1EA1o \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i t\u1EA1o \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),this._snackBar.open("L\u1ED7i khi t\u1EA1o \u0111\u01A1n h\xE0ng: "+t.message,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}})}updateDonhang(a){return s(this,null,function*(){try{this.loading.set(!0),this.error.set(null);let t={madonhang:a.madonhang,status:a.status,tongtien:a.tongtien,khachhangId:a.khachhangId,ngaygiao:a.ngaygiao?new Date(a.ngaygiao).toISOString():null,ghichu:a.ghichu,order:a.order,isActive:a.isActive},r=yield this._GraphqlService.updateOne("donhang",{id:a.id},t);return yield this.refreshDonhangData(),this._snackBar.open("C\u1EADp nh\u1EADt \u0111\u01A1n h\xE0ng th\xE0nh c\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.loading.set(!1),r}catch(t){throw this.error.set(t.message||"L\u1ED7i khi c\u1EADp nh\u1EADt \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i c\u1EADp nh\u1EADt \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),this._snackBar.open("L\u1ED7i khi c\u1EADp nh\u1EADt \u0111\u01A1n h\xE0ng: "+t.message,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}})}deleteDonhang(a){return s(this,null,function*(){try{this.loading.set(!0),this.error.set(null),yield this._GraphqlService.deleteOne("donhang",{id:a}),yield this.refreshDonhangData(),this._snackBar.open("X\xF3a \u0111\u01A1n h\xE0ng th\xE0nh c\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.loading.set(!1)}catch(t){throw this.error.set(t.message||"L\u1ED7i khi x\xF3a \u0111\u01A1n h\xE0ng"),this.loading.set(!1),yield this._ErrorLogService.logError(`L\u1ED7i x\xF3a \u0111\u01A1n h\xE0ng GraphQL: ${t.message||t}`),this._snackBar.open("L\u1ED7i khi x\xF3a \u0111\u01A1n h\xE0ng: "+t.message,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]}),t}})}refreshDonhangData(){return s(this,null,function*(){this.ListDonhang().length>0&&(yield this.searchDonhang({pageSize:9999}))})}generateMaDonhang(){let a=new Date().getTime(),t=Math.floor(Math.random()*1e3);return`DH${a}${t}`}exportVandonToExcel(a){return s(this,null,function*(){try{let t=a||this.ListVandon(),r=this._donhangService.ListDonhang();if(t.length===0&&r.length===0){this._snackBar.open("Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u \u0111\u1EC3 xu\u1EA5t","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-warning"]});return}let n=t.map((e,d)=>({STT:d+1,"M\xE3 \u0110\u01A1n H\xE0ng":e.madonhang||"","Kh\xE1ch H\xE0ng":e.khachhang||"","T\xEAn S\u1EA3n Ph\u1EA9m":e.title||"","\u0110\u01A1n V\u1ECB T\xEDnh":e.dvt||"","SL \u0110\u1EB7t":Number(e.sldat)||0,"SL Giao":Number(e.slgiao)||0,"SL Nh\u1EADn":Number(e.slnhan)||0,"Ng\xE0y Giao":e.ngaygiao?new Date(e.ngaygiao).toLocaleDateString("vi-VN"):"","Tr\u1EA1ng Th\xE1i":this.getStatusLabel(e.status)||""})),h=r.map((e,d)=>({STT:d+1,"Ng\xE0y Giao":e.ngaygiao?new Date(e.ngaygiao).toLocaleString("vi-VN"):"","T\xEAn Kh\xE1ch H\xE0ng":e.name||"","S\u1ED1 L\u01B0\u1EE3ng":e.soluongtt||0,Chuy\u1EBFn:e.chuyen||"","\u0110\u1ECBa Ch\u1EC9":e.diachi||"","Li\xEAn H\u1EC7":"","S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i":e.sdt||"","Gi\u1EDD Nh\u1EADn H\xE0ng":e.gionhanhang||"","T\u1ED5ng S\u1ED1 M\xF3n":e.tongsomon||0,"S\u1ED1 L\u01B0\u1EE3ng TT":e.loadpoint||0,Shipper:e.shipper||"","Gi\u1EDD \u0110i":e.giodi||"","Gi\u1EDD V\u1EC1":e.giove||"","K\xFD Nh\u1EADn":e.kynhan||""})),{writeExcelFileSheets:w}=yield import("./chunk-VGXD64E4.js"),_=`VanDon_PhieuChuyen_${new Date().toISOString().slice(0,10)}`;w({"V\u1EADn \u0110\u01A1n":{data:n},"Phi\u1EBFu Chuy\u1EC3n":{data:h}},_),this._snackBar.open("Xu\u1EA5t Excel th\xE0nh c\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(t){yield this._ErrorLogService.logError(`L\u1ED7i xu\u1EA5t Excel v\u1EADn \u0111\u01A1n: ${t.message||t}`),this._snackBar.open("L\u1ED7i khi xu\u1EA5t Excel: "+t.message,"",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}})}getStatusLabel(a){return{dadat:"\u0110\xE3 \u0110\u1EB7t",dagiao:"\u0110\xE3 Giao",danhan:"\u0110\xE3 Nh\u1EADn",hoanthanh:"Ho\xE0n Th\xE0nh",huy:"H\u1EE7y"}[a]||a}getStatistics(a){return s(this,null,function*(){try{let t={};a?.Batdau&&a?.Ketthuc&&(t.createdAt={gte:new Date(a.Batdau).toISOString(),lte:new Date(a.Ketthuc).toISOString()});let r=yield this._GraphqlService.findMany("donhang",{where:t,select:{id:!0}}),n=yield this._GraphqlService.findMany("donhang",{where:c(g({},t),{status:"hoanthanh"}),select:{id:!0}}),h=yield this._GraphqlService.findMany("donhang",{where:c(g({},t),{status:"huy"}),select:{id:!0}});return{total:r?.length||0,completed:n?.length||0,cancelled:h?.length||0,pending:(r?.length||0)-(n?.length||0)-(h?.length||0)}}catch(t){return console.error("Error getting statistics:",t),{total:0,completed:0,cancelled:0,pending:0}}})}quickSearch(a){return s(this,null,function*(){try{this.loading.set(!0);let t=yield this._GraphqlService.findMany("donhang",{where:{OR:[{madonhang:{contains:a,mode:"insensitive"}},{khachhang:{name:{contains:a,mode:"insensitive"}}},{khachhang:{sdt:{contains:a}}}]},include:{khachhang:{select:{id:!0,name:!0,sdt:!0,diachi:!0}},sanpham:{select:{id:!0,idSP:!0,sldat:!0,slgiao:!0,slnhan:!0,slhuy:!0,ttdat:!0,ttgiao:!0,ttnhan:!0,ghichu:!0,order:!0,isActive:!0,giaban:!0,ttsauvat:!0,vat:!0,sanpham:{select:{id:!0,masp:!0,title:!0,giagoc:!0,dvt:!0}}}}},orderBy:{createdAt:"desc"},take:100});this.ListDonhang.set(t||[]);let r=this.createVandonList(t||[]);return this.ListVandon.set(r),this.loading.set(!1),t}catch(t){throw this.error.set(t.message||"L\u1ED7i khi t\xECm ki\u1EBFm"),this.loading.set(!1),t}})}static \u0275fac=function(t){return new(t||l)};static \u0275prov=p({token:l,factory:l.\u0275fac,providedIn:"root"})};export{D as a};
