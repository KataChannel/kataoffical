import{a as fe,b as Re}from"./chunk-CFAGZINW.js";import{a as _e}from"./chunk-JUWCSASC.js";import"./chunk-5E4WHKC4.js";import{a as he,b as ge}from"./chunk-62OL67U4.js";import"./chunk-MRBSEOP3.js";import{d as me,e as pe}from"./chunk-6FM7CICS.js";import{h as se}from"./chunk-MUXLIOTO.js";import"./chunk-ZW44ZSN2.js";import"./chunk-MGORUWWK.js";import{a as Y,b as Z,c as $,d as ee}from"./chunk-HQSQA26E.js";import"./chunk-H7UDLENL.js";import{a as H,b as K}from"./chunk-OAFQYKWM.js";import"./chunk-MN5KTOWK.js";import"./chunk-IHZF43U3.js";import"./chunk-EK5OIXPS.js";import{b as ue}from"./chunk-KC2JAF6W.js";import{b as te,g as ie,j as re,n as ne,p as oe,v as ae,w as le,y as ce,z as de}from"./chunk-6K5ZWVAI.js";import"./chunk-P7TAF5VE.js";import"./chunk-DLQCLWBK.js";import"./chunk-V4FVBF4X.js";import"./chunk-2PPFUFFT.js";import{a as X,b as J}from"./chunk-T32LGCQW.js";import{a as j,c as O,e as N}from"./chunk-W4JKNNWY.js";import"./chunk-KEABJZ6V.js";import{a as W,c as q}from"./chunk-QARTICIP.js";import"./chunk-U2MVCEOQ.js";import{m as z,v as Q}from"./chunk-4ACAQHLL.js";import{Cc as L,Db as G,Dc as l,Ec as w,Ic as S,Jc as C,Kb as E,Kc as x,Ra as u,Ub as f,ac as I,cc as P,dc as M,ec as s,fc as o,hc as k,ic as T,ja as V,jd as D,kc as v,oa as A,pa as y,pc as g,rb as d,rc as _,ya as m,za as p}from"./chunk-52B2MLDA.js";import"./chunk-LWLSKGAV.js";import{a as F,b as B,j as c}from"./chunk-6DYNGEAS.js";var U=class a{constructor(e){this.storageService=e}_allRoles=u([]);_searchTerm=u("");_currentPage=u(1);_pageSize=u(50);_isLoading=u(!1);_selectedRoles=u(new Set);_statusFilter=u("all");searchResults=D(()=>{let e=this._allRoles(),t=this._searchTerm().toLowerCase();return t&&(e=e.filter(i=>i.name.toLowerCase().includes(t))),e});allRoles=this._allRoles.asReadonly();filteredRoles=this.searchResults;searchTerm=this._searchTerm.asReadonly();currentPage=this._currentPage.asReadonly();pageSize=this._pageSize.asReadonly();isLoading=this._isLoading.asReadonly();selectedRoles=this._selectedRoles.asReadonly();statusFilter=this._statusFilter.asReadonly();totalItems=D(()=>this.searchResults().length);totalPages=D(()=>Math.ceil(this.totalItems()/this._pageSize()));paginatedRoles=D(()=>{let e=(this._currentPage()-1)*this._pageSize(),t=e+this._pageSize();return this.searchResults().slice(e,t)});graphqlService=y(_e);loadAllRoles(e=!1){return c(this,null,function*(){if(!e&&this._allRoles().length>0)return this._allRoles();this._isLoading.set(!0);try{let t={orderBy:{name:"asc"},include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}},i=yield this.graphqlService.findMany("role",t);return this._allRoles.set(i),this._currentPage.set(1),i}catch(t){throw console.error("Error loading roles:",t),t}finally{this._isLoading.set(!1)}})}createRole(e){return c(this,null,function*(){this._isLoading.set(!0);try{let t={name:e.name},i=yield this.graphqlService.createOne("role",{data:t,include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}});if(e.permissionIds&&e.permissionIds.length>0){yield this.assignPermissionsToRole(i.id,e.permissionIds);let n=yield this.getRoleById(i.id);if(n){let h=this._allRoles();return this._allRoles.set([n,...h.filter(R=>R.id!==i.id)]),n}}let r=this._allRoles();return this._allRoles.set([i,...r]),i}catch(t){throw console.error("Error creating role:",t),t}finally{this._isLoading.set(!1)}})}updateRole(e,t){return c(this,null,function*(){this._isLoading.set(!0);try{let i=yield this.graphqlService.updateOne("role",{id:e},t,{include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}}),r=this._allRoles(),n=r.findIndex(h=>h.id===e);if(n!==-1){let h=[...r];h[n]=i,this._allRoles.set(h)}return i}catch(i){throw console.error("Error updating role:",i),i}finally{this._isLoading.set(!1)}})}deleteRole(e){return c(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("role",{id:e});let i=this._allRoles().filter(n=>n.id!==e);this._allRoles.set(i);let r=new Set(this._selectedRoles());r.delete(e),this._selectedRoles.set(r)}catch(t){throw console.error("Error deleting role:",t),t}finally{this._isLoading.set(!1)}})}getRoleById(e){return c(this,null,function*(){try{return yield this.graphqlService.findUnique("role",{id:e},{include:{permissions:{include:{permission:{select:{id:!0,name:!0,codeId:!0}}}},users:{include:{user:{include:{profile:{select:{name:!0,avatar:!0,bio:!0}}}}}}}})}catch(t){return console.error("Error getting role by id:",t),null}})}assignPermissionsToRole(e,t){return c(this,null,function*(){this._isLoading.set(!0);try{let i=t.map(n=>({roleId:e,permissionId:n}));yield this.graphqlService.batchCreate("rolePermission",i);let r=yield this.getRoleById(e);if(r){let n=this._allRoles(),h=n.findIndex(R=>R.id===e);if(h!==-1){let R=[...n];R[h]=r,this._allRoles.set(R)}}}catch(i){throw console.error("Error assigning permissions to role:",i),i}finally{this._isLoading.set(!1)}})}removePermissionFromRole(e,t){return c(this,null,function*(){this._isLoading.set(!0);try{let r=(yield this.getRoleById(e))?.permissions?.find(n=>n.permissionId===t);if(r){yield this.graphqlService.deleteOne("rolePermission",{id:r.id});let n=yield this.getRoleById(e);if(n){let h=this._allRoles(),R=h.findIndex(b=>b.id===e);if(R!==-1){let b=[...h];b[R]=n,this._allRoles.set(b)}}}}catch(i){throw console.error("Error removing permission from role:",i),i}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setStatusFilter(e){this._statusFilter.set(e),this._currentPage.set(1)}setPage(e){e>=1&&e<=this.totalPages()&&this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}nextPage(){this._currentPage()<this.totalPages()&&this._currentPage.set(this._currentPage()+1)}previousPage(){this._currentPage()>1&&this._currentPage.set(this._currentPage()-1)}toggleRoleSelection(e){let t=new Set(this._selectedRoles());t.has(e)?t.delete(e):t.add(e),this._selectedRoles.set(t)}selectAllCurrentPage(){let e=new Set(this._selectedRoles());this.paginatedRoles().forEach(t=>{e.add(t.id)}),this._selectedRoles.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedRoles());this.paginatedRoles().forEach(t=>{e.delete(t.id)}),this._selectedRoles.set(e)}clearSelection(){this._selectedRoles.set(new Set)}isSelected(e){return this._selectedRoles().has(e)}get selectedCount(){return this._selectedRoles().size}get selectedIds(){return Array.from(this._selectedRoles())}findRoleById(e){return this._allRoles().find(t=>t.id===e)}getRolesByPermission(e){return this._allRoles().filter(t=>t.permissions?.some(i=>i.permissionId===e))}getRolePermissions(e){let t=this.findRoleById(e);return!t||!t.permissions?[]:t.permissions.map(i=>i.permission)}hasPermission(e,t){return this.getRolePermissions(e).some(r=>r.codeId===t)}getRolesByGroup(e){return this._allRoles().filter(t=>t.permissions?.some(i=>i.permission.group===e))}getUsersInRole(e){let t=this.findRoleById(e);return!t||!t.users?[]:t.users.map(i=>i.user)}clearCache(){this._allRoles.set([]),this._searchTerm.set(""),this._currentPage.set(1),this.clearSelection()}refreshData(){return this.loadAllRoles(!0)}static \u0275fac=function(t){return new(t||a)(A(K))};static \u0275prov=V({token:a,factory:a.\u0275fac,providedIn:"root"})};function we(a,e){if(a&1){let t=v();s(0,"button",3),g("click",function(){m(t);let r=_();return p(r.handleUserAction())}),s(1,"mat-icon"),l(2,"save"),o()()}}function Se(a,e){if(a&1){let t=v();s(0,"button",3),g("click",function(){m(t);let r=_();return p(r.toggleEdit())}),s(1,"mat-icon"),l(2,"edit"),o()()}}function Ce(a,e){if(a&1){let t=v();k(0),s(1,"div",11)(2,"div",12),l(3,"B\u1EA1n ch\u1EAFc ch\u1EAFn mu\u1ED1n xo\xE1 kh\xF4ng?"),o(),s(4,"div",13)(5,"button",14),g("click",function(){m(t);let r=_();return p(r.DeleteData())}),l(6,"\u0110\u1ED3ng \xDD"),o(),s(7,"button",15),g("click",function(){m(t);let r=_();return p(r.toggleDelete())}),l(8,"Hu\u1EF7 B\u1ECF"),o()()(),T()}}function xe(a,e){if(a&1){let t=v();s(0,"div",23)(1,"div",4),l(2),o(),s(3,"mat-icon",32),g("click",function(){let r=m(t).$implicit,n=_(2);return p(n.handleRemoveRole(r))}),l(4,"close"),o()()}if(a&2){let t=e.$implicit;d(2),w(t==null?null:t.name)}}function De(a,e){if(a&1){let t=v();s(0,"button",33),g("click",function(){let r=m(t).$implicit,n=_(2);return p(n.handleAddRole(r))}),l(1),o()}if(a&2){let t=e.$implicit;d(),w(t.name)}}function be(a,e){if(a&1){let t=v();k(0),s(1,"div",16)(2,"mat-form-field",17)(3,"mat-label"),l(4,"Email"),o(),s(5,"input",18),x("ngModelChange",function(r){m(t);let n=_();return C(n.DetailUser().email,r)||(n.DetailUser().email=r),p(r)}),o()(),s(6,"mat-form-field",17)(7,"mat-label"),l(8,"S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i"),o(),s(9,"input",19),x("ngModelChange",function(r){m(t);let n=_();return C(n.DetailUser().SDT,r)||(n.DetailUser().SDT=r),p(r)}),o()(),s(10,"mat-form-field",17)(11,"mat-label"),l(12,"M\u1EADt Kh\u1EA9u "),o(),s(13,"input",20),x("ngModelChange",function(r){m(t);let n=_();return C(n.DetailUser().password,r)||(n.DetailUser().password=r),p(r)}),o()(),s(14,"div",21)(15,"button",22,0),l(17," Th\xEAm Nh\xF3m "),o(),s(18,"div",5),P(19,xe,5,1,"div",23,I),o()(),s(21,"mat-menu",null,1)(23,"div",24),g("click",function(r){return m(t),p(r.stopPropagation())}),s(24,"div",25)(25,"input",26),g("keyup",function(r){m(t);let n=_();return p(n.doFilterHederColumn(r))}),o(),s(26,"div",27)(27,"span",28),l(28,"search"),o()()(),s(29,"div",29),P(30,De,2,1,"button",30,I),o(),s(32,"div",31)(33,"button",15),g("click",function(){m(t);let r=L(16);return p(r.closeMenu())}),l(34,"\u0110\xF3ng"),o()()()()(),T()}if(a&2){let t=L(22),i=_();d(5),S("ngModel",i.DetailUser().email),f("disabled",!i.isEdit()),d(4),S("ngModel",i.DetailUser().SDT),f("disabled",!i.isEdit()),d(4),S("ngModel",i.DetailUser().password),f("disabled",!i.isEdit()),d(2),f("disabled",!i.isEdit())("matMenuTriggerFor",t),d(4),M(i.DetailUser().roles),d(11),M(i.FilterRole())}}var ye=class a{_ListuserComponent=y(Re);_UserGraphQLService=y(fe);_RoleGraphQLService=y(U);_route=y(W);_router=y(q);_snackBar=y(H);constructor(){this._route.paramMap.subscribe(e=>{let t=e.get("id");t==="new"?this.userId.set(t):t&&!this._UserGraphQLService.currentUser()&&this.userId.set(t)})}DetailUser=u({});isEdit=u(!1);isDelete=u(!1);userId=u(null);ListRole=u([]);FilterRole=u([]);getUserById(e){return c(this,null,function*(){try{let t=yield this._UserGraphQLService.getUserById(e);t&&this.DetailUser.set(B(F({},t),{SDT:t.SDT||""}))}catch(t){console.error("Error loading user:",t),this._snackBar.open("L\u1ED7i khi t\u1EA3i th\xF4ng tin ng\u01B0\u1EDDi d\xF9ng","\u0110\xF3ng",{duration:3e3})}})}ngOnInit(){return c(this,null,function*(){let e=this.userId();if(!e){this._router.navigate(["/admin/user"]),this._ListuserComponent.drawer.close();return}e==="new"?(this.DetailUser.set({email:"",password:"",SDT:"",isActive:!0,roles:[],profile:{name:"",avatar:"",bio:""}}),this._ListuserComponent?.drawer?.open(),this.isEdit.update(t=>!t)):e&&(yield this.getUserById(e),this._ListuserComponent?.drawer?.open(),this._router.navigate(["/admin/user",e])),yield this._RoleGraphQLService.loadAllRoles(),this.ListRole.set(this._RoleGraphQLService.allRoles()),this.updateFilterRole()})}updateFilterRole(){let e=this.ListRole(),t=this.DetailUser()?.roles||[];this.FilterRole.set(e.filter(i=>!t.some(r=>r.roleId===i.id||r.role?.id===i.id)))}handleUserAction(){return c(this,null,function*(){this.userId()==="new"?yield this.createUser():yield this.updateUser()})}createUser(){return c(this,null,function*(){try{if(!this.DetailUser().password||this.DetailUser().password.trim()===""){this._snackBar.open("Vui l\xF2ng nh\u1EADp password","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}if(!this.DetailUser().SDT||this.DetailUser().SDT.trim()===""){this._snackBar.open("Vui l\xF2ng nh\u1EADp SDT","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]});return}yield this._UserGraphQLService.createUser(this.DetailUser()),this._snackBar.open("T\u1EA1o M\u1EDBi Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.update(e=>!e)}catch(e){console.error("L\u1ED7i khi t\u1EA1o user:",e)}})}updateUser(){return c(this,null,function*(){try{yield this._UserGraphQLService.updateUser(this.DetailUser().id,this.DetailUser()),this._snackBar.open("C\u1EADp Nh\u1EADt Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.update(e=>!e)}catch(e){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt user:",e)}})}DeleteData(){return c(this,null,function*(){try{yield this._UserGraphQLService.deleteUser(this.DetailUser().id),this._snackBar.open("X\xF3a Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this._router.navigate(["/admin/user"])}catch(e){console.error("L\u1ED7i khi x\xF3a user:",e)}})}FillSlug(){this.DetailUser.update(e=>(e.slug=me(e.title),e))}doFilterHederColumn(e){let t=this.ListRole();this.FilterRole.set(t.filter(i=>i.name.toLowerCase().includes(e.target.value.toLowerCase())))}handleAddRole(e){return c(this,null,function*(){try{yield this._UserGraphQLService.assignRolesToUser(this.DetailUser().id,[e.id]),this.DetailUser.update(t=>(t.roles.find(r=>r.role?.id===e.id||r.roleId===e.id)||t.roles.push({id:pe(8,!1),userId:this.DetailUser().id,roleId:e.id,role:e}),t)),this.updateFilterRole(),this._snackBar.open("Th\xEAm Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(t){console.error("Error adding role:",t),this._snackBar.open("L\u1ED7i khi th\xEAm vai tr\xF2","\u0110\xF3ng",{duration:3e3})}})}handleRemoveRole(e){return c(this,null,function*(){try{yield this._UserGraphQLService.removeRoleFromUser(this.DetailUser().id,e.role?.id||e.roleId),this.DetailUser.update(t=>(t.roles=t.roles.filter(i=>(i.role?.id||i.roleId)!==(e.role?.id||e.roleId)),t)),this.updateFilterRole(),this._snackBar.open("X\xF3a Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]})}catch(t){console.error("Error removing role:",t),this._snackBar.open("L\u1ED7i khi x\xF3a vai tr\xF2","\u0110\xF3ng",{duration:3e3})}})}goBack(){this._UserGraphQLService.clearCurrentUser(),this._ListuserComponent.drawer.close(),this._router.navigate(["/admin/user"])}trackByFn(e,t){return t.id}toggleEdit(){this.isEdit.update(e=>!e)}toggleDelete(){this.isDelete.update(e=>!e)}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=G({type:a,selectors:[["app-detailuser"]],decls:17,vars:8,consts:[["menuTrigger","matMenuTrigger"],["menu","matMenu"],[1,"flex","flex-row","justify-between","items-center","space-x-2","p-2"],["mat-icon-button","","color","primary",3,"click"],[1,"font-bold"],[1,"flex","flex-row","space-x-2","items-center"],[3,"ngModelChange","ngModel","disabled"],["mat-icon-button","","color","primary",3,"click",4,"ngIf"],["mat-icon-button","","color","warn",3,"click"],[1,"relative","flex","flex-col","w-full","p-4","overflow-auto"],[4,"ngIf"],[1,"flex","flex-col","space-y-4","items-center","justify-center"],[1,"font-bold","text-2xl"],[1,"flex","flex-row","space-x-2","items-center","justify-center"],["mat-flat-button","","color","primary",3,"click"],["mat-flat-button","","color","warn",3,"click"],[1,"w-full","flex","flex-col","space-y-2"],["appearance","outline"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp Email",3,"ngModelChange","ngModel","disabled"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i",3,"ngModelChange","ngModel","disabled"],["matInput","","type","password","placeholder","Vui l\xF2ng nh\u1EADp S\u1ED1 \u0110i\u1EC7n Tho\u1EA1i",3,"ngModelChange","ngModel","disabled"],[1,"w-full","flex","flex-wrap","gap-2","space-x-2"],["mat-flat-button","","color","primary",3,"disabled","matMenuTriggerFor"],[1,"cursor-pointer","flex","flex-row","space-x-2","items-center","p-2","rounded-lg","bg-gray-100"],[1,"cursor-pointer","flex","flex-col","space-y-4","p-3",3,"click"],[1,"relative","w-full"],["type","text","placeholder","T\xECm Ki\u1EBFm...",1,"block","w-full","pl-10","pr-4","py-2","text-gray-700","bg-white","border","border-gray-300","rounded-lg","focus:border-blue-400","focus:ring-blue-400","focus:outline-none","focus:ring","focus:ring-opacity-40",3,"keyup"],[1,"absolute","inset-y-0","left-0","flex","items-center","pl-3","pointer-events-none"],[1,"material-symbols-outlined","text-gray-500"],[1,"w-full","flex","flex-col","space-y-2","max-h-44","overflow-auto"],["mat-menu-item",""],[1,"flex","flex-row","space-x-2","items-center","justify-end"],["color","warn",3,"click"],["mat-menu-item","",3,"click"]],template:function(t,i){if(t&1&&(s(0,"div",2)(1,"button",3),g("click",function(){return i.goBack()}),s(2,"mat-icon"),l(3,"arrow_back"),o()(),s(4,"div",4),l(5),o(),s(6,"div",5)(7,"mat-slide-toggle",6),x("ngModelChange",function(n){return C(i.DetailUser().isActive,n)||(i.DetailUser().isActive=n),n}),l(8),o(),E(9,we,3,0,"button",7)(10,Se,3,0,"button",7),s(11,"button",8),g("click",function(){return i.toggleDelete()}),s(12,"mat-icon"),l(13,"delete"),o()()()(),s(14,"div",9),E(15,Ce,9,0,"ng-container",10)(16,be,35,8,"ng-container",10),o()),t&2){let r;d(5),w(((r=i.DetailUser())==null?null:r.email)||"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"),d(2),S("ngModel",i.DetailUser().isActive),f("disabled",!i.isEdit()),d(),w(i.DetailUser().isActive?"Hi\u1EC3n Th\u1ECB":"\u1EA8n"),d(),f("ngIf",i.isEdit()),d(),f("ngIf",!i.isEdit()),d(5),f("ngIf",i.isDelete()),d(),f("ngIf",!i.isDelete())}},dependencies:[le,ae,oe,de,ce,ne,te,ie,re,J,X,N,j,O,ue,se,Q,z,ge,he,ee,Z,Y,$],encapsulation:2})};export{ye as DetailUserComponent};
