import{a as w}from"./chunk-RD6TAKIE.js";import{a as f}from"./chunk-KDLSUHPH.js";import{b as A}from"./chunk-DBWHEJBK.js";import{a as i,b as P}from"./chunk-42KLW5LA.js";import{Ma as n,ea as y,ja as k,ka as m}from"./chunk-5F46NTIF.js";import{a as u,j as s}from"./chunk-47CWAPKR.js";var v=class l{constructor(e,a){this._StorageService=e;this._sharedSocketService=a;this.socket=this._sharedSocketService.getSocket(),this.listenKhoahocUpdates()}socket;_snackBar=m(A);ListKhoahoc=n([]);DetailKhoahoc=n({});page=n(1);totalPages=n(1);total=n(0);pageSize=n(50);khoahocId=n(null);initDB(){return s(this,null,function*(){return yield f("KhoahocDB",4,{upgrade(e,a){a<1&&e.createObjectStore("khoahocs",{keyPath:"id"}),a<3&&(e.objectStoreNames.contains("khoahocs")&&e.deleteObjectStore("khoahocs"),e.objectStoreNames.contains("pagination")&&e.deleteObjectStore("pagination"),e.createObjectStore("khoahocs",{keyPath:"id"})),a<4}})})}saveKhoahocs(e,a){return s(this,null,function*(){let o=(yield this.initDB()).transaction("khoahocs","readwrite"),r=o.objectStore("khoahocs");yield r.clear(),yield r.put({id:"data",khoahocs:e,pagination:a}),yield o.done})}getCachedData(){return s(this,null,function*(){let a=yield(yield this.initDB()).get("khoahocs","data");return a&&a.khoahocs?{khoahocs:a.khoahocs,pagination:a.pagination||{page:1,totalPages:1,total:a.khoahocs.length,pageSize:10}}:{khoahocs:[],pagination:{page:1,totalPages:1,total:0,pageSize:10}}})}setKhoahocId(e){this.khoahocId.set(e)}ImportKhoahoc(e){return s(this,null,function*(){try{let a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},t=yield fetch(`${i.ACADEMY_APIURL}/khoahoc/import`,a);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let o=yield t.json();t.ok||this.handleError(t.status),this.getAllKhoahoc()}catch(a){return console.error(a)}})}getSyncsKhoahoc(e){return s(this,null,function*(){try{let a={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(e)},t=yield fetch(`${i.ACADEMY_APIURL}/khoahoc/syncskhoahoc`,a);t.ok||this.handleError(t.status);let o=yield t.json();console.log("Syncs Khoahoc Data:",o)}catch(a){console.error(a)}})}getTotalKhoahocByUserId(e){return s(this,null,function*(){try{let a={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},t=yield fetch(`${i.ACADEMY_APIURL}/khoahoc/total?userId=${e}`,a);return t.ok?(yield t.json()).total||0:(this.handleError(t.status),0)}catch(a){return console.error(a),0}})}CreateKhoahoc(e){return s(this,null,function*(){try{let a={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(e)},t=yield fetch(`${i.ACADEMY_APIURL}/khoahoc`,a);if(!t.ok){this.handleError(t.status);return}let o=yield t.json();this.getAllKhoahoc(),this.khoahocId.set(o.id)}catch(a){console.error(a)}})}getAllKhoahoc(){return s(this,arguments,function*(e={},a=!1){let t=yield this.getCachedData(),o=this._StorageService.getItem("khoahocs_updatedAt")||"0",r=new Date(o).getTime();if(!a&&t.khoahocs.length>0&&Date.now()-r<5*60*1e3)return this.ListKhoahoc.set(t.khoahocs),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize),t.khoahocs;try{let c={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}};e=u({page:this.page().toString(),pageSize:this.pageSize().toString()},e);let g=new URLSearchParams;Object.entries(e).forEach(([S,p])=>{p&&g.append(S,String(p))});let d=yield fetch(`${i.ACADEMY_APIURL}/khoahoc?${g}`,c);if(!d.ok)return this.handleError(d.status),this.ListKhoahoc.set(t.khoahocs),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize),t.khoahocs;let h=yield d.json();if(yield this.saveKhoahocs(h.data,{page:h.page||1,totalPages:h.totalPages||1,total:h.total||h.data.length,pageSize:this.pageSize()}),a)this._StorageService.setItem("khoahocs_updatedAt",new Date().toISOString());else{let S=yield fetch(`${i.ACADEMY_APIURL}/khoahoc/lastupdated`,c),{updatedAt:p}=yield S.json();this._StorageService.setItem("khoahocs_updatedAt",p)}return this.ListKhoahoc.set(h.data),this.page.set(h.page||1),this.totalPages.set(h.totalPages||1),this.total.set(h.total||h.data.length),this.pageSize.set(this.pageSize()),h.data}catch(c){return console.error(c),this.ListKhoahoc.set(t.khoahocs),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize),t.khoahocs}})}getUpdatedCodeIds(){return s(this,null,function*(){try{let e={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},a=yield fetch(`${i.ACADEMY_APIURL}/khoahoc/updateCodeIds`,e);a.ok||this.handleError(a.status);let t=yield a.json();return this.getAllKhoahoc(this.pageSize()),t.data}catch(e){console.error(e)}})}listenKhoahocUpdates(){this.socket.off("khoahoc-updated"),this.socket.on("khoahoc-updated",()=>s(this,null,function*(){console.log("\u{1F504} D\u1EEF li\u1EC7u s\u1EA3n ph\u1EA9m thay \u0111\u1ED5i, c\u1EADp nh\u1EADt l\u1EA1i cache..."),this._StorageService.removeItem("khoahocs_updatedAt"),yield this.getAllKhoahoc()}))}getKhoahocBy(){return s(this,arguments,function*(e={}){try{let a={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},t=new URLSearchParams;Object.entries(e).forEach(([c,g])=>{g&&t.append(c,String(g))});let o=yield fetch(`${i.ACADEMY_APIURL}/khoahoc?${t}`,a);o.ok||this.handleError(o.status);let r=yield o.json();this.DetailKhoahoc.set(r)}catch(a){console.error(a);let t=yield this.getCachedData();e.isOne||(this.ListKhoahoc.set(t.khoahocs),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize))}})}SearchBy(e){return s(this,null,function*(){try{let a={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(e)},t=yield fetch(`${i.ACADEMY_APIURL}/khoahoc/findby`,a);t.ok||this.handleError(t.status);let o=yield t.json();return e.isOne===!0?this.DetailKhoahoc.set(o):(yield this.saveKhoahocs(o.data,{page:o.page||1,totalPages:o.totalPages||1,total:o.total||o.data.length,pageSize:this.pageSize()}),this._StorageService.setItem("khoahocs_updatedAt",new Date().toISOString()),this.ListKhoahoc.set(o.data),this.page.set(o.page||1),this.totalPages.set(o.totalPages||1),this.total.set(o.total||o.data.length),this.pageSize.set(this.pageSize())),o}catch(a){console.error(a);let t=yield this.getCachedData();e.isOne||(this.ListKhoahoc.set(t.khoahocs),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize))}})}updateKhoahoc(e){return s(this,null,function*(){try{let a={method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(e)},t=yield fetch(`${i.ACADEMY_APIURL}/khoahoc/${e.id}`,a);t.ok||this.handleError(t.status);let o=yield t.json();this.getAllKhoahoc(this.pageSize()),this.getKhoahocBy({id:o.id,isOne:!0})}catch(a){console.error(a)}})}DeleteKhoahoc(e){return s(this,null,function*(){try{let a={method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},t=yield fetch(`${i.ACADEMY_APIURL}/khoahoc/${e.id}`,a);t.ok||this.handleError(t.status),this.getAllKhoahoc(this.pageSize())}catch(a){console.error(a)}})}handleError(e){let a="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh",t="snackbar-error";switch(e){case 400:a="Th\xF4ng tin \u0111\xE3 t\u1ED3n t\u1EA1i ho\u1EB7c kh\xF4ng h\u1EE3p l\u1EC7";break;case 401:a="Phi\xEAn \u0111\u0103ng nh\u1EADp \u0111\xE3 h\u1EBFt h\u1EA1n, vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:a="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n th\u1EF1c hi\u1EC7n thao t\xE1c n\xE0y";break;case 404:a="Kh\xF4ng t\xECm th\u1EA5y d\u1EEF li\u1EC7u y\xEAu c\u1EA7u";break;case 422:a="D\u1EEF li\u1EC7u kh\xF4ng h\u1EE3p l\u1EC7";break;case 500:a="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break;case 503:a="D\u1ECBch v\u1EE5 t\u1EA1m th\u1EDDi kh\xF4ng kh\u1EA3 d\u1EE5ng";break;default:a=`L\u1ED7i HTTP ${e}`}this._snackBar.open(a,"\u0110\xF3ng",{duration:4e3,horizontalPosition:"end",verticalPosition:"top",panelClass:[t]})}static \u0275fac=function(a){return new(a||l)(k(P),k(w))};static \u0275prov=y({token:l,factory:l.\u0275fac,providedIn:"root"})};export{v as a};
