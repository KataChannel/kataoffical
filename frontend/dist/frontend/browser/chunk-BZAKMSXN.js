import{b as k}from"./chunk-ASU7WRMJ.js";import{a as I}from"./chunk-3NK5WJGJ.js";import{a as p}from"./chunk-H7UDLENL.js";import{a as w}from"./chunk-RQQ6YENK.js";import{a as C}from"./chunk-VXBHOSYZ.js";import{a as b}from"./chunk-RHYJKD3I.js";import{f as S,g}from"./chunk-KZMYTDV6.js";import{d as f}from"./chunk-3QZHTKAG.js";import{Ra as n,ja as y,pa as a,u as l}from"./chunk-WYL4U5YK.js";import{a as c,b as u,j as o}from"./chunk-6DYNGEAS.js";var v=class d{graphqlService=a(b);storageService=a(w);userService=a(I);snackBar=a(C);http=a(f);apollo=a(S);apiUrl=p.APIURL;modelName="chotkho";detailModelName="chotkhodetail";chotkhos=n([]);isLoading=n(!1);selectedChotkho=n(null);ListChotkho=n([]);DetailChotkho=n(null);page=n(1);totalPages=n(1);total=n(0);pageSize=n(50);chotkhoId=n(null);isRefreshing=n(!1);lastUpdated=n(null);ChotkhoCodeId(){return o(this,null,function*(){try{let r=((yield this.graphqlService.aggregate("chotkho",{_max:{order:!0}}))._max?.order||0)+1,s=k("Chotkho",r,!1),i=yield this.graphqlService.findFirst("chotkho",{where:{codeId:s},select:{codeId:!0}});for(;i&&i.codeId;)r++,s=k("Chotkho",r,!1),i=yield this.graphqlService.findFirst("chotkho",{where:{codeId:s},select:{codeId:!0}});return{codeId:s,newOrder:r}}catch(t){console.error("Error generating chotkho code ID:",t),this.showErrorMessage("L\u1ED7i khi t\u1EA1o m\xE3 ch\u1ED1t kho");let e=Date.now().toString().slice(-6),i=((yield this.graphqlService.aggregate("chotkho",{_max:{order:!0}}))._max?.order||0)+1;return{codeId:`CK-${e}`,newOrder:i}}})}createChotkhoWithDetails(t){return o(this,null,function*(){try{this.isLoading.set(!0);let e=yield this.ChotkhoCodeId(),r=t.userId||(yield this.getCurrentUserId()),s={ngaychot:t.ngaychot,title:t.title,ghichu:t.ghichu,userId:r,codeId:e.codeId,order:e.newOrder,details:{create:t.details&&t.details.length>0?t.details.map(h=>({sanphamId:h.sanphamId,userId:r,sltonhethong:h.sltonhethong||0,sltonthucte:h.sltonthucte||0,slhuy:h.slhuy||0,chenhlech:this.calculateChenhLech(h.sltonhethong||0,h.sltonthucte||0,h.slhuy||0),ghichu:h.ghichu||""})):[]}},i=yield this.graphqlService.createOne(this.modelName,s,{select:{id:!0,ngaychot:!0,title:!0,ghichu:!0,userId:!0,codeId:!0,order:!0,details:{select:{id:!0,sanphamId:!0,sltonhethong:!0,sltonthucte:!0,slhuy:!0,chenhlech:!0,ghichu:!0}}}});return!i||!i.id?(this.showErrorMessage("L\u1ED7i khi t\u1EA1o ch\u1ED1t kho"),!1):(i.details.map(h=>o(this,null,function*(){yield this.graphqlService.updateOne("tonkho",{sanphamId:h.sanphamId},{slton:h.sltonthucte||0,sltontt:h.sltonthucte||0})})),console.log("Ch\u1ED1t kho \u0111\xE3 \u0111\u01B0\u1EE3c t\u1EA1o th\xE0nh c\xF4ng:",i),this.showSuccessMessage(`T\u1EA1o ch\u1ED1t kho th\xE0nh c\xF4ng v\u1EDBi ${i.details?.length||0} chi ti\u1EBFt`),yield this.getAllChotkho(),i)}catch(e){return console.error("Error creating chotkho with details:",e),this.showErrorMessage("L\u1ED7i khi t\u1EA1o ch\u1ED1t kho"),!1}finally{this.isLoading.set(!1)}})}getAllChotkho(t){return o(this,null,function*(){try{this.isLoading.set(!0);let e="isActive: true";if(t){let s=[];t.khoId&&s.push(`khoId: "${t.khoId}"`),t.userId&&s.push(`userId: "${t.userId}"`),t.startDate&&t.endDate&&s.push(`ngaychot: { gte: "${t.startDate}", lte: "${t.endDate}" }`),t.searchText&&s.push(`OR: [
            { title: { contains: "${t.searchText}" } },
            { ghichu: { contains: "${t.searchText}" } },
            { codeId: { contains: "${t.searchText}" } }
          ]`),s.length>0&&(e=`AND: [{ isActive: true }, { ${s.join(", ")} }]`)}let r=yield this.graphqlService.findMany(this.modelName,{where:e,orderBy:{ngaychot:"desc"},skip:((t?.page||1)-1)*(t?.limit||50),take:t?.limit||50,include:{kho:{select:{id:!0,name:!0}},user:{select:{id:!0,email:!0,profile:{select:{name:!0}}}}}});r&&(this.ListChotkho.set(r||[]),this.chotkhos.set(r||[]),this.total.set(r.length||0),this.totalPages.set(Math.ceil((r.length||0)/(t?.limit||50))),this.page.set(t?.page||1))}catch(e){console.error("Error getting chotkho data:",e),this.showErrorMessage("L\u1ED7i khi t\u1EA3i d\u1EEF li\u1EC7u ch\u1ED1t kho")}finally{this.isLoading.set(!1)}})}getChotkhoById(t){return o(this,null,function*(){try{this.isLoading.set(!0);let e=yield this.graphqlService.findUnique(this.modelName,{id:t},{include:{user:{select:{id:!0,email:!0,profile:{select:{name:!0}}}},details:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}}}}});if(e){let r=u(c({},e),{details:e.details?.map(s=>u(c({},s),{title:s.sanpham?.title,masp:s.sanpham?.masp,dvt:s.sanpham?.dvt,sanpham:s.sanpham}))||[]});return this.selectedChotkho.set(r),this.DetailChotkho.set(r),r}return null}catch(e){return console.error("Error getting chotkho by id:",e),this.showErrorMessage("L\u1ED7i khi l\u1EA5y th\xF4ng tin ch\u1ED1t kho"),null}finally{this.isLoading.set(!1)}})}updateChotkho(t,e){return o(this,null,function*(){try{this.isLoading.set(!0);let r={ngaychot:e.ngaychot,title:e.title,ghichu:e.ghichu,isActive:e.isActive};return(yield this.graphqlService.updateOne(this.modelName,{id:t},r,{select:{id:!0,ngaychot:!0,title:!0,ghichu:!0,khoId:!0}}))?(this.showSuccessMessage("C\u1EADp nh\u1EADt ch\u1ED1t kho th\xE0nh c\xF4ng"),yield this.getAllChotkho(),!0):!1}catch(r){return console.error("Error updating chotkho:",r),this.showErrorMessage("L\u1ED7i khi c\u1EADp nh\u1EADt ch\u1ED1t kho"),!1}finally{this.isLoading.set(!1)}})}updateChotkhoWithDetails(t,e){return o(this,null,function*(){try{this.isLoading.set(!0);let r={ngaychot:e.ngaychot,title:e.title,ghichu:e.ghichu,isActive:e.isActive,details:e.details?.map(i=>({sanphamId:i.sanphamId,sltonhethong:i.sltonhethong||0,sltonthucte:i.sltonthucte||0,slhuy:i.slhuy||0,ghichu:i.ghichu||""}))};return(yield l(this.http.patch(`${p.APIURL}/chotkho/${t}/with-details`,r,{headers:{Authorization:`Bearer ${this.storageService.getItem("token")}`}})))?(this.showSuccessMessage("C\u1EADp nh\u1EADt ch\u1ED1t kho v\xE0 chi ti\u1EBFt th\xE0nh c\xF4ng"),yield this.getAllChotkho(),yield this.getChotkhoById(t),!0):!1}catch(r){return console.error("Error updating chotkho with details:",r),this.showErrorMessage("L\u1ED7i khi c\u1EADp nh\u1EADt ch\u1ED1t kho"),!1}finally{this.isLoading.set(!1)}})}deleteChotkho(t){return o(this,null,function*(){try{this.isLoading.set(!0);let e=yield this.graphqlService.findUnique(this.modelName,{id:t},{include:{details:{include:{sanpham:{select:{title:!0,masp:!0}}}}}});if(!e)return this.showErrorMessage("Kh\xF4ng t\xECm th\u1EA5y ch\u1ED1t kho c\u1EA7n x\xF3a"),!1;let r=e.details?.length||0,s=`
        B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a ch\u1ED1t kho n\xE0y kh\xF4ng?
        
        \u{1F4CB} M\xE3 ch\u1ED1t kho: ${e.codeId||"N/A"}
        \u{1F4DD} Ti\xEAu \u0111\u1EC1: ${e.title||"N/A"}
        \u{1F4E6} S\u1ED1 l\u01B0\u1EE3ng s\u1EA3n ph\u1EA9m: ${r}
        
        \u26A0\uFE0F Thao t\xE1c n\xE0y s\u1EBD x\xF3a v\u0129nh vi\u1EC5n:
        \u2022 Ch\u1ED1t kho ch\xEDnh
        \u2022 T\u1EA5t c\u1EA3 ${r} chi ti\u1EBFt s\u1EA3n ph\u1EA9m
        
        Kh\xF4ng th\u1EC3 kh\xF4i ph\u1EE5c sau khi x\xF3a!
      `.trim();if(!window.confirm(s))return console.log("User cancelled deletion"),!1;if(e.details&&e.details.length>0){console.log(`\u{1F5D1}\uFE0F \u0110ang x\xF3a ${e.details.length} chi ti\u1EBFt ch\u1ED1t kho...`);for(let m of e.details)try{yield this.graphqlService.deleteOne(this.detailModelName,{id:m.id}),console.log(`\u2705 \u0110\xE3 x\xF3a detail ID: ${m.id}`)}catch(D){console.error(`\u274C L\u1ED7i x\xF3a detail ${m.id}:`,D)}}return console.log(`\u{1F5D1}\uFE0F \u0110ang x\xF3a ch\u1ED1t kho ch\xEDnh ID: ${t}...`),(yield this.graphqlService.deleteOne(this.modelName,{id:t}))?(this.showSuccessMessage(`X\xF3a ch\u1ED1t kho v\xE0 ${r} chi ti\u1EBFt th\xE0nh c\xF4ng`),yield this.getAllChotkho(),this.selectedChotkho()?.id===t&&(this.selectedChotkho.set(null),this.DetailChotkho.set(null)),!0):!1}catch(e){return console.error("Error deleting chotkho with details:",e),this.showErrorMessage("L\u1ED7i khi x\xF3a ch\u1ED1t kho v\xE0 chi ti\u1EBFt"),!1}finally{this.isLoading.set(!1)}})}addChotkhoDetail(t,e){return o(this,null,function*(){try{let r=u(c({},e),{chotkhoId:t,userId:yield this.getCurrentUserId(),chenhlech:this.calculateChenhLech(e.sltonhethong||0,e.sltonthucte||0,e.slhuy||0)});return(yield this.graphqlService.createOne(this.detailModelName,r,{select:{id:!0,sanphamId:!0,sltonhethong:!0,sltonthucte:!0,slhuy:!0,chenhlech:!0,ghichu:!0,chotkhoId:!0}}))?(this.showSuccessMessage("Th\xEAm chi ti\u1EBFt th\xE0nh c\xF4ng"),yield this.getChotkhoById(t),!0):!1}catch(r){return console.error("Error adding chotkho detail:",r),this.showErrorMessage("L\u1ED7i khi th\xEAm chi ti\u1EBFt ch\u1ED1t kho"),!1}})}deleteChotkhoDetail(t,e){return o(this,null,function*(){try{let r=yield this.graphqlService.findUnique(this.detailModelName,{id:t},{include:{sanpham:{select:{title:!0,masp:!0}}}});if(!r)return this.showErrorMessage("Kh\xF4ng t\xECm th\u1EA5y chi ti\u1EBFt c\u1EA7n x\xF3a"),!1;let s=`
        B\u1EA1n c\xF3 ch\u1EAFc mu\u1ED1n x\xF3a chi ti\u1EBFt n\xE0y kh\xF4ng?
        
        \u{1F4E6} S\u1EA3n ph\u1EA9m: ${r.sanpham?.title||"N/A"}
        \u{1F522} M\xE3 SP: ${r.sanpham?.masp||"N/A"}
        \u{1F4CA} SL t\u1ED3n h\u1EC7 th\u1ED1ng: ${r.sltonhethong||0}
        \u{1F4CA} SL t\u1ED3n th\u1EF1c t\u1EBF: ${r.sltonthucte||0}
        \u{1F4CA} SL h\u1EE7y: ${r.slhuy||0}
        
        \u26A0\uFE0F Kh\xF4ng th\u1EC3 kh\xF4i ph\u1EE5c sau khi x\xF3a!
      `.trim();return window.confirm(s)&&(yield this.graphqlService.deleteOne(this.detailModelName,{id:t}))?(this.showSuccessMessage("X\xF3a chi ti\u1EBFt th\xE0nh c\xF4ng"),yield this.getChotkhoById(e),!0):!1}catch(r){return console.error("Error deleting chotkho detail:",r),this.showErrorMessage("L\u1ED7i khi x\xF3a chi ti\u1EBFt ch\u1ED1t kho"),!1}})}calculateChenhLech(t,e,r){return t-e-r}generateChotkhoCode(){let t=new Date,e=t.getFullYear().toString().substr(-2)+(t.getMonth()+1).toString().padStart(2,"0")+t.getDate().toString().padStart(2,"0"),r=t.getHours().toString().padStart(2,"0")+t.getMinutes().toString().padStart(2,"0");return`CK${e}${r}`}setChotkhoId(t){this.chotkhoId.set(t)}getCurrentUserId(){return o(this,null,function*(){try{return(yield this.userService.getProfile())?.id||null}catch(t){return console.error("Error getting current user:",t),null}})}showSuccessMessage(t){this.snackBar.open(t,"\u0110\xF3ng",{duration:3e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["snackbar-success"]})}showErrorMessage(t){this.snackBar.open(t,"\u0110\xF3ng",{duration:5e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["snackbar-error"]})}getUpdatedCodeIds(){return o(this,null,function*(){console.log("getUpdatedCodeIds - implement if needed")})}DeleteChotkho(t){return o(this,null,function*(){t?.id&&(yield this.deleteChotkho(t.id))})}getStatistics(){return o(this,null,function*(){return{total:this.ListChotkho().length,active:this.ListChotkho().filter(t=>t.isActive).length}})}generateReport(t){return o(this,null,function*(){return console.log("generateReport - implement if needed",t),{success:!0,message:"Report placeholder"}})}bulkUpdateStatus(t,e){return o(this,null,function*(){return console.log("bulkUpdateStatus - implement if needed",t,e),!0})}importFromExcel(t,e){return o(this,null,function*(){return console.log("importFromExcel - implement if needed",t,e),{success:!0,message:"Import placeholder"}})}backupData(t){return o(this,null,function*(){return console.log("backupData - implement if needed",t),!0})}optimizePerformance(){return o(this,null,function*(){return console.log("optimizePerformance - implement if needed"),{success:!0}})}getSystemHealth(){return o(this,null,function*(){return console.log("getSystemHealth - implement if needed"),{status:"healthy"}})}generateImportTemplate(t){return o(this,null,function*(){return console.log("generateImportTemplate - implement if needed",t),!0})}exportData(t,e){return o(this,null,function*(){return console.log("exportData - implement if needed",t,e),!0})}smartCheckChenhLech(t){return o(this,null,function*(){return console.log("smartCheckChenhLech - implement if needed",t),{success:!0}})}restoreFromBackup(t){return o(this,null,function*(){return console.log("restoreFromBackup - implement if needed",t),!0})}getAllWarehouses(){return o(this,null,function*(){let t=g`
      query chotkhoGetAllWarehouses {
        chotkhoGetAllWarehouses
      }
    `;try{return(yield l(this.apollo.query({query:t,fetchPolicy:"cache-first"}))).data.chotkhoGetAllWarehouses||[]}catch(e){throw console.error("Error getting warehouses:",e),e}})}getProductsByWarehouse(t){return o(this,null,function*(){let e=g`
      query chotkhoGetProductsByWarehouse($khoId: String!) {
        chotkhoGetProductsByWarehouse(khoId: $khoId)
      }
    `;try{return(yield l(this.apollo.query({query:e,variables:{khoId:t},fetchPolicy:"cache-first"}))).data.chotkhoGetProductsByWarehouse||[]}catch(r){throw console.error("Error getting products by warehouse:",r),r}})}getAllProducts(){return o(this,null,function*(){let t=g`
      query chotkhoGetAllProducts {
        chotkhoGetAllProducts
      }
    `;try{return(yield l(this.apollo.query({query:t,fetchPolicy:"cache-first"}))).data.chotkhoGetAllProducts||[]}catch(e){throw console.error("Error getting all products:",e),e}})}static \u0275fac=function(e){return new(e||d)};static \u0275prov=y({token:d,factory:d.\u0275fac,providedIn:"root"})};export{v as a};
