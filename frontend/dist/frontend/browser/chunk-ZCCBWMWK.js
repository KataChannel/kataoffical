import{a as k}from"./chunk-MC2RAUNI.js";import{a as b}from"./chunk-4ZVJO4SQ.js";import{a as i}from"./chunk-VUZTNYK4.js";import{a as w,b as P}from"./chunk-REAWTH4A.js";import{c as f}from"./chunk-CESPK7AW.js";import{Ra as r,ia as y,na as g}from"./chunk-PRJD77D5.js";import{a as u,j as n}from"./chunk-6DYNGEAS.js";var j=class m{constructor(e,a,t){this._StorageService=e;this.router=a;this._snackBar=t}ListSanpham=r([]);DetailSanpham=r({});sanphamId=r(null);page=r(1);totalPages=r(1);total=r(0);pageSize=r(50);setSanphamId(e){this.sanphamId.set(e)}socket=k(`${i.APIURL}`,{transports:["websocket","polling"],reconnectionAttempts:5,timeout:5e3});Banggiamacdinh(e){return n(this,null,function*(){try{let a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},t=yield fetch(`${i.APIURL}/sanpham/banggiamacdinh`,a);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();return t.ok||this.handleError(t.status),this.getAllSanpham(),s}catch(a){return console.error(a)}})}ImportSanpham(e){return n(this,null,function*(){try{let a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},t=yield fetch(`${i.APIURL}/sanpham/import`,a);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();t.ok||this.handleError(t.status),this.getAllSanpham()}catch(a){return console.error(a)}})}CreateSanpham(e){return n(this,null,function*(){try{let a={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},t=yield fetch(`${i.APIURL}/sanpham`,a);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();t.ok||this.handleError(t.status),this.getAllSanpham(),this.sanphamId.set(s.id)}catch(a){return console.error(a)}})}getNhucau(){return n(this,null,function*(){try{let e={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},a=yield fetch(`${i.APIURL}/sanpham/nhucaudathang`,e);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);let t=yield a.json();return a.ok||this.handleError(a.status),this.ListSanpham.set(t),t}catch(e){return console.error(e)}})}getAllSanpham(){return n(this,arguments,function*(e={},a=!1){let t=yield this.getCachedData(),s=this._StorageService.getItem("sanphams_updatedAt")||"0",h=new Date(s).getTime();if(!a&&t.sanphams.length>0&&Date.now()-h<5*60*1e3)return this.ListSanpham.set(t.sanphams),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize),t.sanphams;try{let p={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}};e=u({page:this.page().toString(),pageSize:this.pageSize().toString()},e);let S=new URLSearchParams;Object.entries(e).forEach(([d,c])=>{c&&S.append(d,String(c))});let l=yield fetch(`${i.APIURL}/sanpham?${S}`,p);if(!l.ok)return this.handleError(l.status),this.ListSanpham.set(t.sanphams),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize),t.sanphams;let o=yield l.json();if(yield this.saveSanphams(o.data,{page:o.page||1,totalPages:o.totalPages||1,total:o.total||o.data.length,pageSize:this.pageSize()}),a)this._StorageService.setItem("sanphams_updatedAt",new Date().toISOString());else{let d=yield fetch(`${i.APIURL}/sanpham/lastupdated`,p),{updatedAt:c}=yield d.json();this._StorageService.setItem("sanphams_updatedAt",c)}return this.ListSanpham.set(o.data),this.page.set(o.page||1),this.totalPages.set(o.totalPages||1),this.total.set(o.total||o.data.length),this.pageSize.set(this.pageSize()),o.data}catch(p){return console.error(p),this.ListSanpham.set(t.sanphams),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize),t.sanphams}})}handleError(e){let a="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(e){case 401:a="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:a="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp";break;case 500:a="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break}this._snackBar.open("C\u1EADp Nh\u1EADt Th\xE0nh C\xF4ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-warning"]})}listenSanphamUpdates(){this.socket.on("sanpham-updated",()=>n(this,null,function*(){console.log("\u{1F504} D\u1EEF li\u1EC7u s\u1EA3n ph\u1EA9m thay \u0111\u1ED5i, c\u1EADp nh\u1EADt l\u1EA1i cache..."),yield this.getAllSanpham()}))}initDB(){return n(this,null,function*(){return yield b("SanphamDB",4,{upgrade(e,a){a<1&&e.createObjectStore("sanphams",{keyPath:"id"}),a<3&&(e.objectStoreNames.contains("sanphams")&&e.deleteObjectStore("sanphams"),e.objectStoreNames.contains("pagination")&&e.deleteObjectStore("pagination"),e.createObjectStore("sanphams",{keyPath:"id"})),a<4}})})}saveSanphams(e,a){return n(this,null,function*(){let s=(yield this.initDB()).transaction("sanphams","readwrite"),h=s.objectStore("sanphams");yield h.clear(),yield h.put({id:"data",sanphams:e,pagination:a}),yield s.done})}getCachedData(){return n(this,null,function*(){let a=yield(yield this.initDB()).get("sanphams","data");return a&&a.sanphams?{sanphams:a.sanphams,pagination:a.pagination||{page:1,totalPages:1,total:a.sanphams.length,pageSize:10}}:{sanphams:[],pagination:{page:1,totalPages:1,total:0,pageSize:10}}})}getSanphamByid(e){return n(this,null,function*(){try{let a={method:"GET",headers:{"Content-Type":"application/json"}},t=yield fetch(`${i.APIURL}/sanpham/findid/${e}`,a);t.ok||this.handleError(t.status);let s=yield t.json();this.DetailSanpham.set(s)}catch(a){return console.error(a)}})}getSanphamBy(e){return n(this,null,function*(){try{let a={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(e)},t=yield fetch(`${i.APIURL}/sanpham/findby`,a);t.ok||this.handleError(t.status);let s=yield t.json();return e.isOne===!0?(this.DetailSanpham.set(s),s):(yield this.saveSanphams(s.data,{page:s.page||1,totalPages:s.totalPages||1,total:s.total||s?.data?.length,pageSize:this.pageSize()}),this._StorageService.setItem("sanphams_updatedAt",new Date().toISOString()),this.ListSanpham.set(s.data),this.page.set(s.page||1),this.totalPages.set(s.totalPages||1),this.total.set(s.total||s.data.length),this.pageSize.set(this.pageSize()),s.data)}catch{let t=yield this.getCachedData();e.isOne||(this.ListSanpham.set(t.sanphams),this.page.set(t.pagination.page),this.totalPages.set(t.pagination.totalPages),this.total.set(t.pagination.total),this.pageSize.set(t.pagination.pageSize))}})}updateSanpham(e){return n(this,null,function*(){try{let a={method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},t=yield fetch(`${i.APIURL}/sanpham/${e.id}`,a);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();t.ok||this.handleError(t.status),this.getAllSanpham(),this.getSanphamByid(e.id)}catch(a){return console.error(a)}})}DeleteSanpham(e){return n(this,null,function*(){try{let a={method:"DELETE",headers:{"Content-Type":"application/json"}},t=yield fetch(`${i.APIURL}/sanpham/${e.id}`,a);t.ok||this.handleError(t.status),this.getAllSanpham()}catch(a){return console.error(a)}})}static \u0275fac=function(a){return new(a||m)(g(P),g(f),g(w))};static \u0275prov=y({token:m,factory:m.\u0275fac,providedIn:"root"})};export{j as a};
