import './polyfills.server.mjs';
import{d as S}from"./chunk-OSDT3VMP.mjs";import{a as k}from"./chunk-JGIKJIHL.mjs";import{a as f}from"./chunk-GS6F3HBF.mjs";import{a as h}from"./chunk-6EFOJMAD.mjs";import{Ra as g,ja as b,oa as u,pa as y}from"./chunk-LL6B6DB7.mjs";import{a as p,b as m,j as o}from"./chunk-RIAI3ORJ.mjs";var B=class l{constructor(a,t){this._StorageService=a;this.router=t}_GraphqlService=y(k);ListBanggia=g([]);DetailBanggia=g({});banggiaId=g(null);isLoading=g(!1);currentLoadId=null;lastSetId=null;setBanggiaId(a){this.lastSetId!==a?(console.log("[SERVICE] setBanggiaId from",this.lastSetId,"to",a),this.lastSetId=a,this.banggiaId.set(a)):console.log("[SERVICE] setBanggiaId called with same ID, skipping:",a)}checkBanggiaExists(a,t,e,r){return o(this,null,function*(){try{let n={AND:[{mabanggia:{equals:a}},{batdau:{equals:t.toISOString()}},{ketthuc:{equals:e.toISOString()}}]};r&&n.AND.push({id:{not:r}});let i=yield this._GraphqlService.findMany("banggia",{where:n,take:1});return i&&i.length>0}catch(n){return console.error("[VALIDATE] Error checking banggia exists:",n),!1}})}CreateBanggia(a){return o(this,null,function*(){try{let t=a.mabanggia||this.generateMaBanggia(),e=a.batdau?new Date(a.batdau):new Date,r=a.ketthuc?new Date(a.ketthuc):new Date(Date.now()+30*24*60*60*1e3);if(yield this.checkBanggiaExists(t,e,r))throw new Error(`B\u1EA3ng gi\xE1 v\u1EDBi m\xE3 "${t}" v\xE0 kho\u1EA3ng th\u1EDDi gian t\u1EEB ${e.toLocaleDateString()} \u0111\u1EBFn ${r.toLocaleDateString()} \u0111\xE3 t\u1ED3n t\u1EA1i!`);let i={title:a.title,mabanggia:t,type:a.type||"bansi",batdau:e.toISOString(),ketthuc:r.toISOString(),order:a.order||1,ghichu:a.ghichu||"",status:a.status||"baogia",isActive:a.isActive!==!1,isDefault:a.isDefault||!1,sanpham:a.sanpham?{create:a.sanpham.map(s=>({sanphamId:s.sanphamId||s.id,giaban:Number(s.giaban)||0,order:s.order||1,isActive:s.isActive!==!1}))}:void 0,khachhang:a.khachhang?{connect:a.khachhang.map(s=>({id:s.id||s}))}:void 0},c={sanpham:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}}},khachhang:{select:{id:!0,name:!0,makh:!0}}},d=yield this._GraphqlService.createOne("banggia",i,{include:c});return this.banggiaId.set(d.id),this.DetailBanggia.set(d),yield this.getAllBanggia(),d}catch(t){throw console.error("L\u1ED7i t\u1EA1o b\u1EA3ng gi\xE1:",t),t}})}updateBanggia(a){return o(this,null,function*(){try{if(console.log("[UPDATE-BG] ========== START UPDATE =========="),console.log("[UPDATE-BG] Input dulieu:",JSON.stringify(a,null,2)),a.mabanggia&&a.batdau&&a.ketthuc){let n=new Date(a.batdau),i=new Date(a.ketthuc);if(yield this.checkBanggiaExists(a.mabanggia,n,i,a.id))throw new Error(`B\u1EA3ng gi\xE1 v\u1EDBi m\xE3 "${a.mabanggia}" v\xE0 kho\u1EA3ng th\u1EDDi gian t\u1EEB ${n.toLocaleDateString()} \u0111\u1EBFn ${i.toLocaleDateString()} \u0111\xE3 t\u1ED3n t\u1EA1i!`)}let t={title:a.title,mabanggia:a.mabanggia,type:a.type,batdau:a.batdau?new Date(a.batdau).toISOString():void 0,ketthuc:a.ketthuc?new Date(a.ketthuc).toISOString():void 0,order:a.order,ghichu:a.ghichu,status:a.status,isActive:a.isActive,isDefault:a.isDefault,sanpham:a.sanpham?{deleteMany:{},create:a.sanpham.map(n=>({sanphamId:n.sanphamId||n.id,giaban:Number(n.giaban)||0,order:n.order||1,isActive:n.isActive!==!1}))}:void 0,khachhang:a.khachhang?(()=>{if(console.log("[UPDATE-BG] Processing khachhang:",a.khachhang),Array.isArray(a.khachhang)){let i={set:a.khachhang.map(c=>({id:c.id||c}))};return console.log("[UPDATE-BG] khachhang is array, converted to set:",i),i}if(a.khachhang.disconnect!==void 0||a.khachhang.connect!==void 0){let i={disconnect:a.khachhang.disconnect||[],connect:a.khachhang.connect||[]};return console.log("[UPDATE-BG] khachhang is Prisma structure:",i),console.log("[UPDATE-BG] Disconnect count:",i.disconnect.length),console.log("[UPDATE-BG] Connect count:",i.connect.length),i}let n={set:[{id:a.khachhang.id||a.khachhang}]};return console.log("[UPDATE-BG] khachhang fallback to set:",n),n})():void 0};console.log("[UPDATE-BG] updateData before cleanup:",JSON.stringify(t,null,2)),Object.keys(t).forEach(n=>{t[n]===void 0&&delete t[n]}),console.log("[UPDATE-BG] updateData after cleanup:",JSON.stringify(t,null,2));let e={sanpham:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}}},khachhang:{select:{id:!0,name:!0,makh:!0,diachi:!0,sdt:!0,email:!0}}};console.log("[UPDATE-BG] Calling GraphQL updateOne with ID:",a.id);let r=yield this._GraphqlService.updateOne("banggia",{id:a.id},t,{include:e});console.log("[UPDATE-BG] GraphQL response khachhang count:",r?.khachhang?.length||0),console.log("[UPDATE-BG] GraphQL response khachhang:",r?.khachhang),console.log("[UPDATE-BG] Invalidating cache for banggia...");try{let n=yield fetch(`${h.APIURL}/cache/invalidate/banggia`,{method:"POST",headers:{Authorization:`Bearer ${this._StorageService.getItem("token")}`,"Content-Type":"application/json"}});n.ok?console.log("[UPDATE-BG] \u2705 Cache invalidated successfully"):console.warn("[UPDATE-BG] \u26A0\uFE0F Cache invalidation returned:",n.status)}catch(n){console.warn("[UPDATE-BG] \u26A0\uFE0F Cache invalidation error:",n)}return this.DetailBanggia.set(r),yield this.getAllBanggia(),console.log("[UPDATE-BG] ========== END UPDATE SUCCESS =========="),r}catch(t){throw console.error("[UPDATE-BG] ========== END UPDATE FAILED =========="),console.error("[UPDATE-BG] L\u1ED7i c\u1EADp nh\u1EADt b\u1EA3ng gi\xE1:",t),t}})}getAllBanggia(){return o(this,null,function*(){try{let a={where:{},orderBy:{order:"asc"},include:{sanpham:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}}},khachhang:{select:{id:!0,name:!0,makh:!0}},_count:{select:{sanpham:!0,khachhang:!0}}}},t=yield this._GraphqlService.findMany("banggia",a);return this.ListBanggia.set(t),t}catch(a){throw console.error("L\u1ED7i l\u1EA5y danh s\xE1ch b\u1EA3ng gi\xE1:",a),a}})}getBanggiaByid(a){return o(this,null,function*(){if(console.log(`[SERVICE] getBanggiaByid called with ID: ${a}`),console.log(`[SERVICE] Current state - isLoading: ${this.isLoading()}, currentLoadId: ${this.currentLoadId}`),this.isLoading()&&this.currentLoadId!==a){console.log(`[SERVICE] Skipping load for ${a}, already loading ${this.currentLoadId}`);return}if(this.isLoading()&&this.currentLoadId===a){console.log(`[SERVICE] Already loading ${a}, skipping duplicate call`);return}console.log(`[SERVICE] Setting loading state to true for ${a}`),this.isLoading.set(!0),this.currentLoadId=a;try{let t={include:{sanpham:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0,giagoc:!0}}},orderBy:{order:"asc"},take:99999},khachhang:{select:{id:!0,name:!0,makh:!0,diachi:!0,sdt:!0,email:!0,loaikh:!0,isActive:!0},take:99999}}};console.log(`[SERVICE] Fetching banggia data from API for ${a}...`);let e=yield this._GraphqlService.findUnique("banggia",{id:a},t);if(console.log(`[SERVICE] API returned data for ${a}`),this.currentLoadId===a){console.log("[SERVICE] Transforming data...");let r=this.transformDetailBanggia(e);console.log("[SERVICE] Updating DetailBanggia signal..."),this.DetailBanggia.set(r),console.log(`[SERVICE] DetailBanggia updated for ${a}`)}else console.log(`[SERVICE] Load completed for ${a}, but current ID is now ${this.currentLoadId}. Skipping update.`);return e}catch(t){throw console.error("[SERVICE] Error fetching banggia:",t),t}finally{console.log(`[SERVICE] Resetting isLoading to false for ${a}`),this.isLoading.set(!1)}})}transformDetailBanggia(a){console.log(a);let t=a.sanpham?.map(e=>m(p({},e),{giaban:Number(e.giaban)||0,title:e.sanpham.title,masp:e.sanpham.masp,dvt:e.sanpham.dvt}))||[];return m(p({},a),{sanpham:t})}DeleteBanggia(a){return o(this,null,function*(){try{let t=yield fetch(`${h.APIURL}/banggia/${a.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${this._StorageService.getItem("token")}`,"Content-Type":"application/json"}});if(!t.ok){let e=yield t.json().catch(()=>({}));throw new Error(e.message||`Failed to delete banggia: ${t.statusText}`)}yield this.getAllBanggia()}catch(t){throw console.error("L\u1ED7i x\xF3a b\u1EA3ng gi\xE1:",t),t}})}DeleteBulkBanggia(a){return o(this,null,function*(){try{let t=a.map(n=>n.id),e=yield fetch(`${h.APIURL}/banggia/bulk-delete`,{method:"POST",headers:{Authorization:`Bearer ${this._StorageService.getItem("token")}`,"Content-Type":"application/json"},body:JSON.stringify({ids:t})});if(!e.ok){let n=yield e.json().catch(()=>({}));throw new Error(n.message||`Failed to bulk delete banggia: ${e.statusText}`)}let r=yield e.json();return yield this.getAllBanggia(),r}catch(t){throw console.error("L\u1ED7i bulk delete b\u1EA3ng gi\xE1:",t),t}})}addKHtoBG(a){return o(this,null,function*(){try{let t={khachhang:{connect:a.khachhangIds.map(e=>({id:e}))}};yield this._GraphqlService.updateOne("banggia",{id:a.banggiaId},t),yield this.getBanggiaByid(a.banggiaId)}catch(t){throw console.error("L\u1ED7i th\xEAm kh\xE1ch h\xE0ng v\xE0o b\u1EA3ng gi\xE1:",t),t}})}removeKHfromBG(a){return o(this,null,function*(){try{let t={khachhang:{disconnect:a.khachhangIds.map(e=>({id:e}))}};yield this._GraphqlService.updateOne("banggia",{id:a.banggiaId},t),yield this.getBanggiaByid(a.banggiaId)}catch(t){throw console.error("L\u1ED7i x\xF3a kh\xE1ch h\xE0ng kh\u1ECFi b\u1EA3ng gi\xE1:",t),t}})}getAllBGSP(){return o(this,null,function*(){try{let a={include:{banggia:{select:{id:!0,title:!0,mabanggia:!0,status:!0}},sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}},orderBy:{order:"asc"}};return yield this._GraphqlService.findMany("banggiasanpham",a)}catch(a){throw console.error("L\u1ED7i l\u1EA5y b\u1EA3ng gi\xE1 s\u1EA3n ph\u1EA9m:",a),a}})}getAllBGKH(){return o(this,null,function*(){try{let a={where:{banggiaId:{not:null}},include:{banggia:{select:{id:!0,title:!0,mabanggia:!0,status:!0}}},orderBy:{name:"asc"}};return yield this._GraphqlService.findMany("khachhang",a)}catch(a){throw console.error("L\u1ED7i l\u1EA5y kh\xE1ch h\xE0ng theo b\u1EA3ng gi\xE1:",a),a}})}ImportBanggia(a){return o(this,null,function*(){try{let e=[];for(let r=0;r<a.length;r+=10)e.push(a.slice(r,r+10));for(let r of e){let n=r.map(i=>this._GraphqlService.createOne("banggia",{title:i.title,mabanggia:i.mabanggia||this.generateMaBanggia(),type:i.type||"bansi",status:i.status||"baogia",isActive:i.isActive!==!1}));yield Promise.all(n)}yield this.getAllBanggia()}catch(t){throw console.error("L\u1ED7i import b\u1EA3ng gi\xE1:",t),t}})}importSPBG(a){return o(this,null,function*(){try{let e=[];for(let r=0;r<a.length;r+=10)e.push(a.slice(r,r+10));for(let r of e){let n=r.map(i=>this._GraphqlService.createOne("banggiasanpham",{banggiaId:i.banggiaId,sanphamId:i.sanphamId,giaban:Number(i.giaban)||0,order:i.order||1,isActive:i.isActive!==!1}));yield Promise.all(n)}yield this.getAllBanggia()}catch(t){throw console.error("L\u1ED7i import s\u1EA3n ph\u1EA9m b\u1EA3ng gi\xE1:",t),t}})}importBGKH(a){return o(this,null,function*(){try{let t=a.map(e=>this._GraphqlService.updateOne("khachhang",{id:e.khachhangId},{banggiaId:e.banggiaId}));yield Promise.all(t),yield this.getAllBanggia()}catch(t){throw console.error("L\u1ED7i import b\u1EA3ng gi\xE1 kh\xE1ch h\xE0ng:",t),t}})}generateMaBanggia(){let a=new Date,t=a.getFullYear().toString().slice(-2),e=(a.getMonth()+1).toString().padStart(2,"0"),r=a.getDate().toString().padStart(2,"0"),n=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`BG${t}${e}${r}${n}`}handleError(a){let t="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(a){case 401:t="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:t="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp";break;case 500:t="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break}let e=JSON.stringify({code:a,title:t});this.router.navigate(["/errorserver"],{queryParams:{data:e}})}static \u0275fac=function(t){return new(t||l)(u(f),u(S))};static \u0275prov=b({token:l,factory:l.\u0275fac,providedIn:"root"})};export{B as a};
