import './polyfills.server.mjs';
import{a as b}from"./chunk-YDNZ5SI3.mjs";import{a as I}from"./chunk-5Z34U3BE.mjs";import{a as m}from"./chunk-6EFOJMAD.mjs";import{a as l,d as u}from"./chunk-X2AKCL2B.mjs";import{ja as d,pa as o,u as a}from"./chunk-J2JCPQ23.mjs";import{a as h,b as p,j as n}from"./chunk-RIAI3ORJ.mjs";var P=class c{http=o(u);storageService=o(I);graphqlService=o(b);baseUrl=m.APIURL;getHeaders(){return new l({"Content-Type":"application/json",Authorization:"Bearer "+this.storageService.getItem("token")})}getCurrentUserId(){try{let t=this.storageService.getItem("token");if(!t)return console.warn("[PRICE-HISTORY] No token found"),null;let r=JSON.parse(atob(t.split(".")[1])),e=r.id||null;return e?console.log("[PRICE-HISTORY] Got userId from token:",e):console.warn("[PRICE-HISTORY] No userId in token payload:",r),e}catch(t){return console.error("[PRICE-HISTORY] Failed to decode token:",t),null}}getPriceHistory(t,r){return n(this,null,function*(){try{let e=`${this.baseUrl}/banggia/${t}/sanpham/${r}/price-history`;return yield a(this.http.get(e,{headers:this.getHeaders()}))}catch(e){throw console.error("Error fetching price history:",e),e}})}getCurrentPrice(t,r){return n(this,null,function*(){try{let e=`${this.baseUrl}/banggia/${t}/sanpham/${r}/current-price`;return yield a(this.http.get(e,{headers:this.getHeaders()}))}catch(e){throw console.error("Error fetching current price:",e),e}})}updateSinglePrice(t,r,e,i,g){return n(this,null,function*(){try{let s=`${this.baseUrl}/banggia/bulk-update-prices`,f=g||this.getCurrentUserId()||"system",y=yield a(this.http.post(s,{updates:[{banggiaId:t,sanphamId:r,newPrice:e,reason:i||"C\u1EADp nh\u1EADt gi\xE1 t\u1EEB b\u1EA3ng gi\xE1"}],userId:f},{headers:this.getHeaders()}));return console.log("[PRICE-HISTORY] Invalidating cache for banggia..."),this.graphqlService.clearCache("banggia"),this.graphqlService.clearCache("banggiasanpham"),y}catch(s){throw console.error("Error updating single price:",s),s}})}bulkUpdatePrices(t){return n(this,null,function*(){try{let r=t.userId||this.getCurrentUserId()||"system",e=`${this.baseUrl}/banggia/bulk-update-prices`,i=yield a(this.http.post(e,p(h({},t),{userId:r}),{headers:this.getHeaders()}));return console.log("[PRICE-HISTORY] Invalidating cache for banggia (bulk)..."),this.graphqlService.clearCache("banggia"),this.graphqlService.clearCache("banggiasanpham"),i}catch(r){throw console.error("Error bulk updating prices:",r),r}})}verifyOrderPrices(t){return n(this,null,function*(){try{let r=`${this.baseUrl}/donhang/verify-prices/${t}`;return yield a(this.http.get(r,{headers:this.getHeaders()}))}catch(r){throw console.error("Error verifying order prices:",r),r}})}getPriceAtDate(t,r,e){return n(this,null,function*(){try{let i=e.toISOString(),g=`${this.baseUrl}/donhang/price-at-date?banggiaId=${t}&sanphamId=${r}&date=${i}`;return yield a(this.http.get(g,{headers:this.getHeaders()}))}catch(i){throw console.error("Error fetching price at date:",i),i}})}static \u0275fac=function(r){return new(r||c)};static \u0275prov=d({token:c,factory:c.\u0275fac,providedIn:"root"})};export{P as a};
