{
  "version": 3,
  "sources": ["src/app/admin/permission/permission.service.ts"],
  "sourcesContent": ["import { inject, Injectable, signal, Signal } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { environment } from '../../../environments/environment.development';\nimport { StorageService } from '../../shared/utils/storage.service';\nimport { io } from 'socket.io-client';\nimport { openDB } from 'idb';\nimport { ErrorLogService } from '../../shared/services/errorlog.service';\nimport { MatSnackBar } from '@angular/material/snack-bar';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class PermissionService {\n  constructor(\n    private _StorageService: StorageService,\n    private router: Router,\n    private _ErrorLogService: ErrorLogService,\n  ) { }\n\n  private _snackBar: MatSnackBar = inject(MatSnackBar);\n  ListPermission = signal<any[]>([]);\n  DetailPermission = signal<any>({});\n  page = signal<number>(1);\n  pageCount = signal<number>(1);\n  total = signal<number>(0);\n  pageSize = signal<number>(10); // Mặc định 10 mục mỗi trang\n  permissionId = signal<string | null>(null);\n\n\n  setPermissionId(id: string | null) {\n    this.permissionId.set(id);\n  }\n\n  async CreatePermission(dulieu: any) {\n    try {\n      const options = {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n        body: JSON.stringify(dulieu),\n      };\n      const response = await fetch(`${environment.APIURL}/permission`, options);\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      const data = await response.json();\n      this.getAllPermission(this.pageSize());\n      this.permissionId.set(data.id);\n    } catch (error) {\n      this._ErrorLogService.logError('Failed to CreatePermission', error);\n      console.error(error);\n    }\n  }\n\n  async getAllPermission(pageSize: number = this.pageSize(), forceRefresh: boolean = false) {\n    this.pageSize.set(pageSize);\n    try {\n      const options = {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n      };\n      // Tải dữ liệu mới từ server\n      const query = new URLSearchParams({\n        page: this.page().toString(),\n        limit: pageSize.toString()\n      });\n      const response = await fetch(`${environment.APIURL}/permission?${query}`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n\n      const data = await response.json();\n      // Với forceRefresh, cập nhật luôn với thời gian mới từ server, nếu không thì sử dụng thời gian lấy từ lastUpdatedResponse\n      this.ListPermission.set(data.data);\n      this.page.set(data.page || 1);\n      this.pageCount.set(data.pageCount || 1);\n      this.total.set(data.total || data.data.length);\n      this.pageSize.set(pageSize);\n      return data.data;\n    } catch (error) {\n\n      console.error(error);\n    }\n  }\n\n  async getUpdatedCodeIds() {\n    try {\n      const options = {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n      };\n      const response = await fetch(`${environment.APIURL}/permission/updateCodeIds`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      const data = await response.json();\n      this.getAllPermission(this.pageSize());\n      return data.data;\n    } catch (error) {\n      this._ErrorLogService.logError('Failed to getUpdatedCodeIds', error);\n      console.error(error);\n    }\n  }\n\n  async getPermissionBy(param: any, pageSize: number = this.pageSize()) {\n    this.pageSize.set(pageSize); // Cập nhật pageSize\n    try {\n      const options = {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n        body: JSON.stringify({ ...param, page: this.page(), limit: pageSize }),\n      };\n      const response = await fetch(`${environment.APIURL}/permission/findby`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      const data = await response.json();\n      if (param.isOne === true) {\n        this.DetailPermission.set(data);\n      } else {\n        this._StorageService.setItem('permissions_updatedAt', new Date().toISOString());\n        this.ListPermission.set(data.data);\n        this.page.set(data.page || 1);\n        this.pageCount.set(data.pageCount || 1);\n        this.total.set(data.total || data.data.length);\n        this.pageSize.set(pageSize);\n      }\n    } catch (error) {\n      console.error(error);\n    }\n  }\n\n  async updatePermission(dulieu: any) {\n    try {\n      const options = {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n        body: JSON.stringify(dulieu),\n      };\n      const response = await fetch(`${environment.APIURL}/permission/${dulieu.id}`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      const data = await response.json();\n      this.getAllPermission(this.pageSize());\n      this.getPermissionBy({ id: data.id, isOne: true }, this.pageSize());\n    } catch (error) {\n      this._ErrorLogService.logError('Failed to updatePermission', error);\n      console.error(error);\n    }\n  }\n\n  async DeletePermission(item: any) {\n    try {\n      const options = {\n        method: 'DELETE',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this._StorageService.getItem('token')}`\n        },\n      };\n      const response = await fetch(`${environment.APIURL}/permission/${item.id}`, options);\n      if (!response.ok) {\n        this.handleError(response.status);\n      }\n      this.getAllPermission(this.pageSize());\n    } catch (error) {\n      this._ErrorLogService.logError('Failed to DeletePermission', error);\n      console.error(error);\n    }\n  }\n\n  private handleError(status: number) {\n    let message = 'Lỗi không xác định';\n    switch (status) {\n      case 400:\n        message = 'Thông tin đã tồn tại';\n        break;\n      case 401:\n      case 404:\n        message = 'Vui lòng đăng nhập lại';\n        break;\n      case 403:\n        message = 'Bạn không có quyền truy cập';\n        break;\n      case 500:\n        message = 'Lỗi máy chủ, vui lòng thử lại sau';\n        break;\n    }\n    this._snackBar.open(message, '', {\n      duration: 1000,\n      horizontalPosition: 'end',\n      verticalPosition: 'top',\n      panelClass: ['snackbar-error'],\n    });\n  }\n}"],
  "mappings": "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",
  "names": []
}
