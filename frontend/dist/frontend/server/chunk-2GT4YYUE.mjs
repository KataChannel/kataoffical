import './polyfills.server.mjs';
import{a as b}from"./chunk-RSUWHIIG.mjs";import{a as c}from"./chunk-6EFOJMAD.mjs";import{b as m}from"./chunk-GECPKQOY.mjs";import{d}from"./chunk-E3IZRHWW.mjs";import{Ra as o,ja as l,oa as h,pa as p}from"./chunk-HL4PWCFI.mjs";import{j as s}from"./chunk-RIAI3ORJ.mjs";var y=class g{constructor(a,t){this._StorageService=a;this.router=t}_GraphqlService=p(b);ListBanggia=o([]);DetailBanggia=o({});banggiaId=o(null);setBanggiaId(a){this.banggiaId.set(a)}importBGKH(a){return s(this,null,function*(){try{let t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)},e=yield fetch(`${c.APIURL}/banggia/importbgkh`,t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);let r=yield e.json();e.ok||this.handleError(e.status),this.getAllBanggia()}catch(t){return console.error(t)}})}importSPBG(a){return s(this,null,function*(){try{let e=[];for(let r=0;r<a.length;r+=10)e.push(a.slice(r,r+10));for(let r of e){let n={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},i=yield fetch(`${c.APIURL}/banggia/importspbg`,n);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);let u=yield i.json();i.ok||this.handleError(i.status)}this.getAllBanggia()}catch(t){return console.error(t)}})}ImportBanggia(a){return s(this,null,function*(){console.log("bg",a);try{let t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)},e=yield fetch(`${c.APIURL}/banggia/import`,t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);let r=yield e.json();e.ok||this.handleError(e.status),this.getAllBanggia()}catch(t){return console.error(t)}})}CreateBanggia(a){return s(this,null,function*(){try{let t={title:a.title,mabanggia:a.mabanggia||this.generateMaBanggia(),type:a.type||"bansi",batdau:a.batdau?new Date(a.batdau).toISOString():new Date().toISOString(),ketthuc:a.ketthuc?new Date(a.ketthuc).toISOString():new Date(Date.now()+2592e6).toISOString(),order:a.order||1,ghichu:a.ghichu||"",status:a.status||"baogia",isActive:a.isActive!==!1,isDefault:a.isDefault||!1,sanpham:a.sanpham?{create:a.sanpham.map(n=>({sanphamId:n.sanphamId||n.id,giaban:Number(n.giaban)||0,order:n.order||1,isActive:n.isActive!==!1}))}:void 0,khachhang:a.khachhang?{connect:a.khachhang.map(n=>({id:n.id||n}))}:void 0},e={sanpham:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}}},khachhang:{select:{id:!0,name:!0,makh:!0}}},r=yield this._GraphqlService.createOne("banggia",t,{include:e});return this.banggiaId.set(r.id),this.DetailBanggia.set(r),yield this.getAllBanggia(),r}catch(t){throw console.error("L\u1ED7i t\u1EA1o b\u1EA3ng gi\xE1:",t),t}})}updateBanggiaWithGraphQL(a){return s(this,null,function*(){try{let t={title:a.title,mabanggia:a.mabanggia,type:a.type,batdau:a.batdau?new Date(a.batdau).toISOString():void 0,ketthuc:a.ketthuc?new Date(a.ketthuc).toISOString():void 0,order:a.order,ghichu:a.ghichu,status:a.status,isActive:a.isActive,isDefault:a.isDefault,sanpham:a.sanpham?{deleteMany:{},create:a.sanpham.map(n=>({sanphamId:n.sanphamId||n.id,giaban:Number(n.giaban)||0,order:n.order||1,isActive:n.isActive!==!1}))}:void 0,khachhang:a.khachhang?{set:a.khachhang.map(n=>({id:n.id||n}))}:void 0};Object.keys(t).forEach(n=>{t[n]===void 0&&delete t[n]});let e={sanpham:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}}},khachhang:{select:{id:!0,name:!0,makh:!0,diachi:!0,sdt:!0,email:!0}}},r=yield this._GraphqlService.updateOne("banggia",{id:a.id},t,{include:e});return this.DetailBanggia.set(r),yield this.getAllBanggia(),r}catch(t){throw console.error("L\u1ED7i c\u1EADp nh\u1EADt b\u1EA3ng gi\xE1:",t),t}})}generateMaBanggia(){let a=new Date,t=a.getFullYear().toString().slice(-2),e=(a.getMonth()+1).toString().padStart(2,"0"),r=a.getDate().toString().padStart(2,"0"),n=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`BG${t}${e}${r}${n}`}getAllBanggia(){return s(this,null,function*(){try{let a={where:{},orderBy:{order:"asc"},include:{sanpham:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}}},khachhang:{select:{id:!0,name:!0,makh:!0}},_count:{select:{sanpham:!0,khachhang:!0}}}},t=yield this._GraphqlService.findMany("banggia",a);return this.ListBanggia.set(t),t}catch(a){throw console.error("L\u1ED7i l\u1EA5y danh s\xE1ch b\u1EA3ng gi\xE1:",a),a}})}getBanggiaByid(a){return s(this,null,function*(){try{let t={include:{sanpham:{include:{sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0,giagoc:!0}}},orderBy:{order:"asc"}},khachhang:{select:{id:!0,name:!0,makh:!0,diachi:!0,sdt:!0,email:!0,loaikh:!0,isActive:!0}}}},e=yield this._GraphqlService.findUnique("banggia",{id:a},t);return this.DetailBanggia.set(e),e}catch(t){throw console.error("L\u1ED7i l\u1EA5y chi ti\u1EBFt b\u1EA3ng gi\xE1:",t),t}})}DeleteBanggia(a){return s(this,null,function*(){try{yield this._GraphqlService.deleteOne("banggia",{id:a.id}),yield this.getAllBanggia()}catch(t){throw console.error("L\u1ED7i x\xF3a b\u1EA3ng gi\xE1:",t),t}})}addKHtoBG(a){return s(this,null,function*(){try{let t=yield this._GraphqlService.findUnique("banggia",{id:a.banggiaId},{include:{khachhang:!0}}),e={khachhang:{connect:a.khachhangIds.map(r=>({id:r}))}};yield this._GraphqlService.updateOne("banggia",{id:a.banggiaId},e),yield this.getBanggiaByid(a.banggiaId)}catch(t){throw console.error("L\u1ED7i th\xEAm kh\xE1ch h\xE0ng v\xE0o b\u1EA3ng gi\xE1:",t),t}})}removeKHfromBG(a){return s(this,null,function*(){try{let t={khachhang:{disconnect:a.khachhangIds.map(e=>({id:e}))}};yield this._GraphqlService.updateOne("banggia",{id:a.banggiaId},t),yield this.getBanggiaByid(a.banggiaId)}catch(t){throw console.error("L\u1ED7i x\xF3a kh\xE1ch h\xE0ng kh\u1ECFi b\u1EA3ng gi\xE1:",t),t}})}getAllBGSP(){return s(this,null,function*(){try{let a={include:{banggia:{select:{id:!0,title:!0,mabanggia:!0,status:!0}},sanpham:{select:{id:!0,title:!0,masp:!0,dvt:!0}}},orderBy:{order:"asc"}};return yield this._GraphqlService.findMany("banggiasanpham",a)}catch(a){throw console.error("L\u1ED7i l\u1EA5y b\u1EA3ng gi\xE1 s\u1EA3n ph\u1EA9m:",a),a}})}getAllBGKH(){return s(this,null,function*(){try{let a={where:{banggiaId:{not:null}},include:{banggia:{select:{id:!0,title:!0,mabanggia:!0,status:!0}}},orderBy:{name:"asc"}};return yield this._GraphqlService.findMany("khachhang",a)}catch(a){throw console.error("L\u1ED7i l\u1EA5y kh\xE1ch h\xE0ng theo b\u1EA3ng gi\xE1:",a),a}})}ImportBanggiaGraphQL(a){return s(this,null,function*(){try{let e=[];for(let r=0;r<a.length;r+=10)e.push(a.slice(r,r+10));for(let r of e){let n=r.map(i=>this._GraphqlService.createOne("banggia",{title:i.title,mabanggia:i.mabanggia||this.generateMaBanggia(),type:i.type||"bansi",status:i.status||"baogia",isActive:i.isActive!==!1}));yield Promise.all(n)}yield this.getAllBanggia()}catch(t){throw console.error("L\u1ED7i import b\u1EA3ng gi\xE1:",t),t}})}importSPBGGrahQL(a){return s(this,null,function*(){try{let e=[];for(let r=0;r<a.length;r+=10)e.push(a.slice(r,r+10));for(let r of e){let n=r.map(i=>this._GraphqlService.createOne("banggiasanpham",{banggiaId:i.banggiaId,sanphamId:i.sanphamId,giaban:Number(i.giaban)||0,order:i.order||1,isActive:i.isActive!==!1}));yield Promise.all(n)}yield this.getAllBanggia()}catch(t){throw console.error("L\u1ED7i import s\u1EA3n ph\u1EA9m b\u1EA3ng gi\xE1:",t),t}})}importBGKHGrahQL(a){return s(this,null,function*(){try{let t=a.map(e=>this._GraphqlService.updateOne("khachhang",{id:e.khachhangId},{banggiaId:e.banggiaId}));yield Promise.all(t),yield this.getAllBanggia()}catch(t){throw console.error("L\u1ED7i import b\u1EA3ng gi\xE1 kh\xE1ch h\xE0ng:",t),t}})}handleError(a){let t="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(a){case 401:t="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:t="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp";break;case 500:t="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break}let e=JSON.stringify({code:a,title:t});this.router.navigate(["/errorserver"],{queryParams:{data:e}})}static \u0275fac=function(t){return new(t||g)(h(m),h(d))};static \u0275prov=l({token:g,factory:g.\u0275fac,providedIn:"root"})};export{y as a};
