import './polyfills.server.mjs';
import{a as P}from"./chunk-DHMJTHFT.mjs";import{a as u}from"./chunk-ZYIPHREZ.mjs";import{Ra as o,ja as h,oa as _,pa as m,xd as n,zd as f}from"./chunk-TKMPR5S6.mjs";import{a as p,j as a}from"./chunk-RIAI3ORJ.mjs";var U=class c{graphqlService=m(P);storageService=m(u);_allUserPermissions=o([]);_selectedUserPermissions=o(new Set);_searchTerm=o("");_userFilter=o("all");_permissionFilter=o("all");_grantedFilter=o("all");_expiredFilter=o("all");_currentPage=o(1);_pageSize=o(50);_isLoading=o(!1);_currentUserPermission=o(null);allUserPermissions=n(()=>this._allUserPermissions());selectedUserPermissions=n(()=>this._selectedUserPermissions());searchTerm=n(()=>this._searchTerm());userFilter=n(()=>this._userFilter());permissionFilter=n(()=>this._permissionFilter());grantedFilter=n(()=>this._grantedFilter());expiredFilter=n(()=>this._expiredFilter());currentPage=n(()=>this._currentPage());pageSize=n(()=>this._pageSize());isLoading=n(()=>this._isLoading());currentUserPermission=n(()=>this._currentUserPermission());filteredUserPermissions=n(()=>{let e=this._allUserPermissions(),s=this._searchTerm().toLowerCase(),r=this._userFilter(),t=this._permissionFilter(),d=this._grantedFilter(),l=this._expiredFilter();return s&&(e=e.filter(i=>i.user?.name?.toLowerCase().includes(s)||i.user?.email?.toLowerCase().includes(s)||i.permission?.name?.toLowerCase().includes(s)||i.permission?.description?.toLowerCase().includes(s)||i.reason?.toLowerCase().includes(s))),r!=="all"&&(e=e.filter(i=>i.userId===r)),t!=="all"&&(e=e.filter(i=>i.permissionId===t)),d==="granted"?e=e.filter(i=>i.isGranted):d==="denied"&&(e=e.filter(i=>!i.isGranted)),l==="active"?e=e.filter(i=>!i.expiresAt||i.expiresAt>new Date):l==="expired"&&(e=e.filter(i=>i.expiresAt&&i.expiresAt<=new Date)),e.sort((i,g)=>i.isGranted!==g.isGranted?i.isGranted?-1:1:new Date(g.createdAt).getTime()-new Date(i.createdAt).getTime())});paginatedUserPermissions=n(()=>{let e=this.filteredUserPermissions(),s=this._currentPage(),r=this._pageSize(),t=(s-1)*r;return e.slice(t,t+r)});totalPages=n(()=>{let e=this.filteredUserPermissions().length,s=this._pageSize();return Math.ceil(e/s)});totalCount=n(()=>this.filteredUserPermissions().length);loadUserPermissions(e){return a(this,null,function*(){this._isLoading.set(!0);try{let s=yield this.graphqlService.findMany("userPermission",p({include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}},orderBy:[{isGranted:"desc"},{createdAt:"desc"}]},e));return this._allUserPermissions.set(s),s}catch(s){throw console.error("Error loading user permissions:",s),s}finally{this._isLoading.set(!1)}})}getUserPermissionById(e){return a(this,null,function*(){try{let s=yield this.graphqlService.findUnique("userPermission",{id:e},{include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}});return this._currentUserPermission.set(s),s}catch(s){return console.error("Error getting user permission by id:",s),null}})}getUserPermissions(e){return a(this,null,function*(){try{return yield this.graphqlService.findMany("userPermission",{where:{userId:e},include:{permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}},orderBy:[{isGranted:"desc"},{permission:{name:"asc"}}]})}catch(s){return console.error("Error getting user permissions:",s),[]}})}assignPermissionToUser(e){return a(this,null,function*(){this._isLoading.set(!0),console.log("Assigning permission to user with data:",e);try{let s=yield this.graphqlService.createOne("userPermission",{userId:e.userId,permissionId:e.permissionId,isGranted:e.isGranted,grantedBy:e.grantedBy,reason:e.reason,expiresAt:e.expiresAt},{include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}}),r=this._allUserPermissions();return this._allUserPermissions.set([s,...r]),s}catch(s){throw console.error("Error assigning permission to user:",s),s}finally{this._isLoading.set(!1)}})}updateUserPermission(e,s){return a(this,null,function*(){this._isLoading.set(!0);try{let r=yield this.graphqlService.updateOne("userPermission",{id:e},s,{include:{user:{select:{id:!0,name:!0,email:!0}},permission:{select:{id:!0,name:!0,codeId:!0,description:!0,group:!0}}}}),t=this._allUserPermissions(),d=t.findIndex(l=>l.id===e);if(d!==-1){let l=[...t];l[d]=r,this._allUserPermissions.set(l)}return this._currentUserPermission()?.id===e&&this._currentUserPermission.set(r),r}catch(r){throw console.error("Error updating user permission:",r),r}finally{this._isLoading.set(!1)}})}deleteUserPermission(e){return a(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("userPermission",{id:e});let s=this._allUserPermissions();this._allUserPermissions.set(s.filter(t=>t.id!==e)),this._currentUserPermission()?.id===e&&this._currentUserPermission.set(null);let r=this._selectedUserPermissions();return r.has(e)&&(r.delete(e),this._selectedUserPermissions.set(new Set(r))),!0}catch(s){return console.error("Error deleting user permission:",s),!1}finally{this._isLoading.set(!1)}})}deleteUserPermissions(e){return a(this,null,function*(){this._isLoading.set(!0);try{let s=e.map(t=>this.graphqlService.deleteOne("userPermission",{id:t}));yield Promise.all(s);let r=this._allUserPermissions();return this._allUserPermissions.set(r.filter(t=>!e.includes(t.id))),this._selectedUserPermissions.set(new Set),!0}catch(s){return console.error("Error deleting user permissions:",s),!1}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setUserFilter(e){this._userFilter.set(e),this._currentPage.set(1)}setPermissionFilter(e){this._permissionFilter.set(e),this._currentPage.set(1)}setGrantedFilter(e){this._grantedFilter.set(e),this._currentPage.set(1)}setExpiredFilter(e){this._expiredFilter.set(e),this._currentPage.set(1)}setCurrentPage(e){this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}clearFilters(){this._searchTerm.set(""),this._userFilter.set("all"),this._permissionFilter.set("all"),this._grantedFilter.set("all"),this._expiredFilter.set("all"),this._currentPage.set(1)}toggleUserPermissionSelection(e){let s=new Set(this._selectedUserPermissions());s.has(e)?s.delete(e):s.add(e),this._selectedUserPermissions.set(s)}selectAllCurrentPage(){let e=new Set(this._selectedUserPermissions());this.paginatedUserPermissions().forEach(s=>{e.add(s.id)}),this._selectedUserPermissions.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedUserPermissions());this.paginatedUserPermissions().forEach(s=>{e.delete(s.id)}),this._selectedUserPermissions.set(e)}clearSelection(){this._selectedUserPermissions.set(new Set)}isSelected(e){return this._selectedUserPermissions().has(e)}get selectedCount(){return this._selectedUserPermissions().size}get selectedIds(){return Array.from(this._selectedUserPermissions())}findUserPermissionById(e){return this._allUserPermissions().find(s=>s.id===e)}getUserPermissionsByUser(e){return this._allUserPermissions().filter(s=>s.userId===e)}getUserPermissionsByPermission(e){return this._allUserPermissions().filter(s=>s.permissionId===e)}getActiveUserPermissions(){return this._allUserPermissions().filter(e=>!e.expiresAt||e.expiresAt>new Date)}getExpiredUserPermissions(){return this._allUserPermissions().filter(e=>e.expiresAt&&e.expiresAt<=new Date)}getGrantedUserPermissions(){return this._allUserPermissions().filter(e=>e.isGranted)}getDeniedUserPermissions(){return this._allUserPermissions().filter(e=>!e.isGranted)}clearCache(){this._allUserPermissions.set([]),this._searchTerm.set(""),this._userFilter.set("all"),this._permissionFilter.set("all"),this._grantedFilter.set("all"),this._expiredFilter.set("all"),this._currentPage.set(1),this.clearSelection(),this._currentUserPermission.set(null)}refreshData(){return this.loadUserPermissions()}static \u0275fac=function(s){return new(s||c)};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};var y=class c{constructor(e){this.storageService=e;f(()=>{let s=this.searchResults();this._filteredPermissions.set(s)})}_allPermissions=o([]);_filteredPermissions=o([]);_searchTerm=o("");_currentPage=o(1);_pageSize=o(50);_isLoading=o(!1);_selectedPermissions=o(new Set);allPermissions=this._allPermissions.asReadonly();filteredPermissions=this._filteredPermissions.asReadonly();searchTerm=this._searchTerm.asReadonly();currentPage=this._currentPage.asReadonly();pageSize=this._pageSize.asReadonly();isLoading=this._isLoading.asReadonly();selectedPermissions=this._selectedPermissions.asReadonly();totalItems=n(()=>this._filteredPermissions().length);totalPages=n(()=>Math.ceil(this.totalItems()/this._pageSize()));paginatedPermissions=n(()=>{let e=(this._currentPage()-1)*this._pageSize(),s=e+this._pageSize();return this._filteredPermissions().slice(e,s)});searchResults=n(()=>{let e=this._searchTerm().toLowerCase();return e?this._allPermissions().filter(r=>r.name.toLowerCase().includes(e)||r.code.toLowerCase().includes(e)||r.description?.toLowerCase().includes(e)):this._allPermissions()});graphqlService=m(P);loadAllPermissions(e=!1){return a(this,null,function*(){if(!e&&this._allPermissions().length>0)return this._allPermissions();this._isLoading.set(!0);try{let s={orderBy:{createdAt:"desc"},include:{roles:{select:{role:{select:{id:!0,name:!0,createdAt:!0,updatedAt:!0}}}}}},r=yield this.graphqlService.findMany("permission",s);return this._allPermissions.set(r),this._currentPage.set(1),r}catch(s){throw console.error("Error loading permissions:",s),s}finally{this._isLoading.set(!1)}})}createPermission(e){return a(this,null,function*(){this._isLoading.set(!0);try{let s=yield this.graphqlService.createOne("permission",{data:{name:e.name,code:e.code,description:e.description,isActive:e.isActive??!0},include:{roles:{select:{role:{select:{id:!0,name:!0,createdAt:!0,updatedAt:!0}}}}}}),r=this._allPermissions();return this._allPermissions.set([s,...r]),s}catch(s){throw console.error("Error creating permission:",s),s}finally{this._isLoading.set(!1)}})}updatePermission(e,s){return a(this,null,function*(){this._isLoading.set(!0);try{let r=yield this.graphqlService.updateOne("permission",{id:e},s,{include:{role:{select:{id:!0,name:!0,createdAt:!0,updatedAt:!0}}}}),t=this._allPermissions(),d=t.findIndex(l=>l.id===e);if(d!==-1){let l=[...t];l[d]=r,this._allPermissions.set(l)}return r}catch(r){throw console.error("Error updating permission:",r),r}finally{this._isLoading.set(!1)}})}deletePermission(e){return a(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.deleteOne("permission",{id:e});let r=this._allPermissions().filter(d=>d.id!==e);this._allPermissions.set(r);let t=new Set(this._selectedPermissions());t.delete(e),this._selectedPermissions.set(t)}catch(s){throw console.error("Error deleting permission:",s),s}finally{this._isLoading.set(!1)}})}batchDeletePermissions(e){return a(this,null,function*(){this._isLoading.set(!0);try{yield this.graphqlService.batchDelete("permission",e);let r=this._allPermissions().filter(t=>!e.includes(t.id));this._allPermissions.set(r),this._selectedPermissions.set(new Set)}catch(s){throw console.error("Error batch deleting permissions:",s),s}finally{this._isLoading.set(!1)}})}setSearchTerm(e){this._searchTerm.set(e),this._currentPage.set(1)}setPage(e){e>=1&&e<=this.totalPages()&&this._currentPage.set(e)}setPageSize(e){this._pageSize.set(e),this._currentPage.set(1)}nextPage(){this._currentPage()<this.totalPages()&&this._currentPage.set(this._currentPage()+1)}previousPage(){this._currentPage()>1&&this._currentPage.set(this._currentPage()-1)}togglePermissionSelection(e){let s=new Set(this._selectedPermissions());s.has(e)?s.delete(e):s.add(e),this._selectedPermissions.set(s)}selectAllCurrentPage(){let e=new Set(this._selectedPermissions());this.paginatedPermissions().forEach(s=>{e.add(s.id)}),this._selectedPermissions.set(e)}deselectAllCurrentPage(){let e=new Set(this._selectedPermissions());this.paginatedPermissions().forEach(s=>{e.delete(s.id)}),this._selectedPermissions.set(e)}clearSelection(){this._selectedPermissions.set(new Set)}isSelected(e){return this._selectedPermissions().has(e)}get selectedCount(){return this._selectedPermissions().size}get selectedIds(){return Array.from(this._selectedPermissions())}findPermissionById(e){return this._allPermissions().find(s=>s.id===e)}getPermissionsByCode(e){return this._allPermissions().filter(s=>e.includes(s.code))}getActivePermissions(){return this._allPermissions().filter(e=>e.isActive)}clearCache(){this._allPermissions.set([]),this._searchTerm.set(""),this._currentPage.set(1),this.clearSelection()}refreshData(){return this.loadAllPermissions(!0)}static \u0275fac=function(s){return new(s||c)(_(u))};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};export{U as a,y as b};
