import './polyfills.server.mjs';
import{d as g}from"./chunk-BH2HSQOL.mjs";import{a as f}from"./chunk-YDNZ5SI3.mjs";import{a as m}from"./chunk-5Z34U3BE.mjs";import{f as p}from"./chunk-TCSF6YHO.mjs";import{a as d}from"./chunk-3KXFP7XD.mjs";import{Ra as a,ja as h,pa as i}from"./chunk-J2JCPQ23.mjs";import{a as n,j as s}from"./chunk-RIAI3ORJ.mjs";var y=class l{graphqlService=i(f);storageService=i(m);snackBar=i(d);apollo=i(p);router=i(g);modelName="Role";ListRole=a([]);DetailRole=a(null);roleId=a(null);isLoading=a(!1);constructor(){}setRoleId(e){this.roleId.set(e)}CreateRole(e){return s(this,null,function*(){try{this.isLoading.set(!0);let r=yield this.graphqlService.createOne(this.modelName,e,{select:{id:!0,name:!0,createdAt:!0,updatedAt:!0}});if(console.log(r),r){this.showSuccessMessage("T\u1EA1o role th\xE0nh c\xF4ng");let t=this.ListRole();return this.ListRole.set([r,...t]),this.roleId.set(r.id),!0}return!1}catch(r){return console.error("Error creating role:",r),this.handleCreateUpdateError(r,"t\u1EA1o"),!1}finally{this.isLoading.set(!1)}})}getAllRole(){return s(this,null,function*(){try{this.isLoading.set(!0);let e=yield this.graphqlService.findMany(this.modelName,{orderBy:{createdAt:"desc"},include:{permissions:{include:{permission:{select:{id:!0,name:!0,description:!0,group:!0}}}}}});return e?(this.ListRole.set(e),e):[]}catch(e){return console.error("Error getting roles:",e),this.showErrorMessage("L\u1ED7i khi t\u1EA3i danh s\xE1ch role"),[]}finally{this.isLoading.set(!1)}})}getRoleByid(e){return s(this,null,function*(){try{this.isLoading.set(!0);let r=yield this.graphqlService.findUnique(this.modelName,{id:e},{include:{permissions:{include:{permission:{select:{id:!0,name:!0,description:!0,group:!0,codeId:!0}}}}}});return r?(this.DetailRole.set(r),r):null}catch(r){return console.error("Error getting role by id:",r),this.handleError(r),null}finally{this.isLoading.set(!1)}})}updateRole(e){return s(this,null,function*(){try{this.isLoading.set(!0);let r=yield this.graphqlService.updateOne(this.modelName,{id:e.id},{name:e.name},{select:{id:!0,name:!0,createdAt:!0,updatedAt:!0}});if(r){this.showSuccessMessage("C\u1EADp nh\u1EADt role th\xE0nh c\xF4ng");let u=this.ListRole().map(c=>c.id===r.id?n(n({},c),r):c);this.ListRole.set(u);let o=this.DetailRole();return o?.id===r.id&&this.DetailRole.set(n(n({},o),r)),!0}return!1}catch(r){return console.error("Error updating role:",r),this.handleCreateUpdateError(r,"c\u1EADp nh\u1EADt"),!1}finally{this.isLoading.set(!1)}})}assignPermissionToRole(e){return s(this,null,function*(){try{return(yield this.graphqlService.createOne("RolePermission",{roleId:e.roleId,permissionId:e.permissionId}))?(this.showSuccessMessage("G\xE1n quy\u1EC1n th\xE0nh c\xF4ng"),this.DetailRole()?.id===e.roleId&&(yield this.getRoleByid(e.roleId)),!0):!1}catch(r){return console.error("Error assigning permission:",r),this.handlePermissionError(r,"g\xE1n"),!1}})}removePermissionFromRole(e){return s(this,null,function*(){try{return(yield this.graphqlService.deleteOne("RolePermission",{roleId:e.roleId,permissionId:e.permissionId}))?(this.showSuccessMessage("X\xF3a quy\u1EC1n th\xE0nh c\xF4ng"),this.DetailRole()?.id===e.roleId&&(yield this.getRoleByid(e.roleId)),!0):!1}catch(r){return console.error("Error removing permission:",r),this.handlePermissionError(r,"x\xF3a"),!1}})}DeleteRole(e){return s(this,null,function*(){try{return this.isLoading.set(!0),(yield this.graphqlService.deleteOne(this.modelName,{id:e.id}))?(this.showSuccessMessage("X\xF3a role th\xE0nh c\xF4ng"),yield this.getAllRole(),!0):!1}catch(r){return console.error("Error deleting role:",r),this.handleError(r),!1}finally{this.isLoading.set(!1)}})}showSuccessMessage(e){this.snackBar.open(e,"\u0110\xF3ng",{duration:3e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["snackbar-success"]})}showErrorMessage(e){this.snackBar.open(e,"\u0110\xF3ng",{duration:5e3,horizontalPosition:"center",verticalPosition:"top",panelClass:["snackbar-error"]})}handleCreateUpdateError(e,r){console.error(`Error ${r} role:`,e);let t="";if(e?.message?t=e.message:e?.error?.message?t=e.error.message:e?.graphQLErrors?.[0]?.message?t=e.graphQLErrors[0].message:typeof e=="string"&&(t=e),console.log("Processed error message:",t),this.showErrorMessage("T\xEAn role n\xE0y \u0111\xE3 t\u1ED3n t\u1EA1i. Vui l\xF2ng ch\u1ECDn t\xEAn kh\xE1c."),this.isUniqueConstraintError(t,"name")){this.showErrorMessage("T\xEAn role n\xE0y \u0111\xE3 t\u1ED3n t\u1EA1i. Vui l\xF2ng ch\u1ECDn t\xEAn kh\xE1c.");return}if(this.isUniqueConstraintError(t)){this.showErrorMessage("Th\xF4ng tin n\xE0y \u0111\xE3 t\u1ED3n t\u1EA1i trong h\u1EC7 th\u1ED1ng. Vui l\xF2ng ki\u1EC3m tra l\u1EA1i.");return}if(this.isValidationError(t)){this.showErrorMessage("D\u1EEF li\u1EC7u kh\xF4ng h\u1EE3p l\u1EC7. Vui l\xF2ng ki\u1EC3m tra l\u1EA1i th\xF4ng tin.");return}this.showErrorMessage(`L\u1ED7i khi ${r} role. Vui l\xF2ng th\u1EED l\u1EA1i.`)}isUniqueConstraintError(e,r){return["Unique constraint failed","unique constraint","UNIQUE constraint","duplicate key","already exists"].some(o=>e.toLowerCase().includes(o.toLowerCase()))?r?new RegExp(`\\(\`${r}\`\\)|${r}`,"i").test(e):!0:!1}isValidationError(e){return["validation failed","invalid input","required field","field is required","invalid value"].some(t=>e.toLowerCase().includes(t.toLowerCase()))}handlePermissionError(e,r){console.error(`Error ${r} permission:`,e);let t="";if(e?.message?t=e.message:e?.error?.message?t=e.error.message:e?.graphQLErrors?.[0]?.message?t=e.graphQLErrors[0].message:typeof e=="string"&&(t=e),console.log("Permission error message:",t),this.isUniqueConstraintError(t)){r==="g\xE1n"?this.showErrorMessage("Quy\u1EC1n n\xE0y \u0111\xE3 \u0111\u01B0\u1EE3c g\xE1n cho role. Kh\xF4ng th\u1EC3 g\xE1n l\u1EA1i."):this.showErrorMessage("L\u1ED7i tr\xF9ng l\u1EB7p khi thao t\xE1c v\u1EDBi quy\u1EC1n.");return}if(this.isForeignKeyError(t)){this.showErrorMessage("Role ho\u1EB7c Permission kh\xF4ng t\u1ED3n t\u1EA1i. Vui l\xF2ng ki\u1EC3m tra l\u1EA1i.");return}if(this.isNotFoundError(t)){r==="x\xF3a"?this.showErrorMessage("Quy\u1EC1n n\xE0y ch\u01B0a \u0111\u01B0\u1EE3c g\xE1n cho role."):this.showErrorMessage("Kh\xF4ng t\xECm th\u1EA5y th\xF4ng tin c\u1EA7n thi\u1EBFt.");return}this.showErrorMessage(`L\u1ED7i khi ${r} quy\u1EC1n. Vui l\xF2ng th\u1EED l\u1EA1i.`)}isForeignKeyError(e){return["foreign key constraint","foreign key","reference constraint","violates foreign key"].some(t=>e.toLowerCase().includes(t.toLowerCase()))}isNotFoundError(e){return["not found","does not exist","record not found","no record found"].some(t=>e.toLowerCase().includes(t.toLowerCase()))}handleError(e){if(console.error("Service error:",e),e.status===401){let r=JSON.stringify({code:e.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:r}})}else if(e.status===403){let r=JSON.stringify({code:e.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:r}})}else if(e.status===500){let r=JSON.stringify({code:e.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:r}})}else this.showErrorMessage("L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh")}static \u0275fac=function(r){return new(r||l)};static \u0275prov=h({token:l,factory:l.\u0275fac,providedIn:"root"})};export{y as a};
