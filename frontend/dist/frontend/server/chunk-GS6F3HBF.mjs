import './polyfills.server.mjs';
import{a as p}from"./chunk-AKVYLSG6.mjs";import{C as a}from"./chunk-EYW3XZCQ.mjs";import{Wa as u,ja as d,oa as m,pa as h}from"./chunk-LL6B6DB7.mjs";import{j as i}from"./chunk-RIAI3ORJ.mjs";var b=class c{constructor(e){this.platformId=e}dbName="PermissionDB";storeName="permissions";db=null;openConnections=[];snackBar=h(p);setItem(e,t){a(this.platformId)&&localStorage.setItem(e,JSON.stringify(t))}getItem(e){if(a(this.platformId)){let t=localStorage.getItem(e);return t?JSON.parse(t):null}return null}removeItem(e){a(this.platformId)&&localStorage.removeItem(e)}clear(){a(this.platformId)&&localStorage.clear()}openDB(){return i(this,null,function*(){if(!a(this.platformId))throw new Error("IndexedDB is not available in this environment");return this.db?this.db:new Promise((e,t)=>{let r=indexedDB.open(this.dbName,1);this.openConnections.push(r),r.onupgradeneeded=()=>{let o=r.result;o.objectStoreNames.contains(this.storeName)||o.createObjectStore(this.storeName,{keyPath:"id"})},r.onsuccess=()=>{this.db=r.result,e(this.db)},r.onerror=()=>{t(new Error("Failed to open PermissionDB"))},r.onblocked=()=>{this.snackBar.open("Cannot access PermissionDB: Database is blocked by another connection","Close",{duration:5e3,panelClass:["snackbar-error"]}),t(new Error("PermissionDB blocked"))}})})}saveData(e,t){return i(this,null,function*(){if(a(this.platformId))try{let n=(yield this.openDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName).put({id:e,data:t});return this.openConnections.push(n),new Promise((l,f)=>{n.onsuccess=()=>l(),n.onerror=()=>f(new Error("Failed to save data"))})}catch(r){throw console.error("Failed to save data:",r),r}})}getData(e){return i(this,null,function*(){if(!a(this.platformId))return null;try{let s=(yield this.openDB()).transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);return this.openConnections.push(s),new Promise((n,l)=>{s.onsuccess=()=>n(s.result?.data),s.onerror=()=>l(new Error("Failed to retrieve data"))})}catch(t){return console.error("Failed to retrieve data:",t),null}})}clearStore(){return i(this,null,function*(){if(a(this.platformId))try{let o=(yield this.openDB()).transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();return this.openConnections.push(o),new Promise((s,n)=>{o.onsuccess=()=>s(),o.onerror=()=>n(new Error("Failed to clear store"))})}catch(e){throw console.error("Failed to clear store:",e),e}})}deleteDB(e=3,t=1e3){return i(this,null,function*(){if(a(this.platformId))for(let r=0;r<e;r++)try{return this.db&&(this.db.close(),this.db=null),this.openConnections=[],yield new Promise((o,s)=>{let n=indexedDB.deleteDatabase(this.dbName);n.onsuccess=()=>{this.snackBar.open("PermissionDB deleted successfully","",{duration:1e3,panelClass:["snackbar-success"]}),o()},n.onerror=()=>{s(new Error("Failed to delete PermissionDB"))},n.onblocked=()=>{this.snackBar.open("Cannot delete PermissionDB: Please close other tabs or refresh","Retry",{duration:5e3,panelClass:["snackbar-error"]}).onAction().subscribe(()=>{}),s(new Error("Deletion of PermissionDB blocked"))}})}catch(o){if(r===e-1)throw console.error("Failed to delete PermissionDB after retries:",o),o;yield new Promise(s=>setTimeout(s,t))}})}deleteAllIndexedDBs(){indexedDB.databases().then(e=>{if(e.length===0){console.log("Kh\xF4ng c\xF3 c\u01A1 s\u1EDF d\u1EEF li\u1EC7u IndexedDB n\xE0o \u0111\u1EC3 x\xF3a.");return}e.forEach(t=>{indexedDB.deleteDatabase(t.name).onsuccess=()=>{console.log(`\u0110\xE3 x\xF3a c\u01A1 s\u1EDF d\u1EEF li\u1EC7u: ${t.name}`)},indexedDB.deleteDatabase(t.name).onerror=r=>{console.error(`L\u1ED7i khi x\xF3a c\u01A1 s\u1EDF d\u1EEF li\u1EC7u ${t.name}:`,r.target.error)}})}).catch(e=>{console.error("L\u1ED7i khi l\u1EA5y danh s\xE1ch c\u01A1 s\u1EDF d\u1EEF li\u1EC7u:",e)})}closeDB(){a(this.platformId)&&this.db&&(this.db.close(),this.db=null,this.openConnections=[])}static \u0275fac=function(t){return new(t||c)(m(u))};static \u0275prov=d({token:c,factory:c.\u0275fac,providedIn:"root"})};export{b as a};
