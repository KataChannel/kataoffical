import './polyfills.server.mjs';
import{a as ue,b as fe}from"./chunk-QAW3JIRX.mjs";import{a as pe}from"./chunk-3VPM3BR4.mjs";import"./chunk-X5ER6TJU.mjs";import{a as de}from"./chunk-HQHIE7DO.mjs";import{a as ge,b as me}from"./chunk-HZUVE6S4.mjs";import"./chunk-IZQHBKKJ.mjs";import"./chunk-73IBRO6I.mjs";import"./chunk-USXY5IAF.mjs";import{a as le,b as se}from"./chunk-UG4NV5SZ.mjs";import"./chunk-M4J2MUAR.mjs";import"./chunk-VWZQI7JC.mjs";import"./chunk-MHRJZXQL.mjs";import{d as ce}from"./chunk-GH5POH7R.mjs";import{h as te}from"./chunk-QQBP4AU2.mjs";import"./chunk-26NM6QMQ.mjs";import"./chunk-QB764O3U.mjs";import{b as H,c as X,d as Q}from"./chunk-Q2TTBLPO.mjs";import{b as re}from"./chunk-I2TU747W.mjs";import{b as Y,g as Z,j as $,n as ee,p as ne,v as ie,w as ae,y as oe,z as he}from"./chunk-K5JBZREZ.mjs";import"./chunk-YHY2PH7R.mjs";import{a as j,b as J}from"./chunk-VSF3PFK7.mjs";import"./chunk-6EFOJMAD.mjs";import{a as W}from"./chunk-MIPBML43.mjs";import"./chunk-XS2QDODU.mjs";import"./chunk-3KDPKSHC.mjs";import{a as G,c as q,e as U}from"./chunk-7EPSYLRI.mjs";import"./chunk-QKIZLTPN.mjs";import"./chunk-7T6LZHUD.mjs";import{a as O,d as z}from"./chunk-NES7BRLR.mjs";import"./chunk-EFFACMZL.mjs";import{n as R,o as P,x as A}from"./chunk-XQ6Z6XLV.mjs";import{Fb as I,Gc as D,Hc as s,Ic as L,Jc as N,Mb as C,Mc as w,Nc as b,Oc as E,Ra as x,Yb as m,ec as T,gc as K,hc as F,ic as h,jc as r,kc as B,lc as S,mc as M,oc as v,pa as y,tb as l,tc as f,vc as d,xd as V,ya as p,za as u}from"./chunk-5IMI5WTE.mjs";import"./chunk-XAZRL6IZ.mjs";import"./chunk-CX6TF4UI.mjs";import"./chunk-MGIVCIKU.mjs";import{j as _}from"./chunk-RIAI3ORJ.mjs";function _e(c,t){c&1&&B(0,"mat-spinner",12)}function ye(c,t){if(c&1){let n=v();h(0,"button",13),f("click",function(){p(n);let i=d();return u(i.handleNhomkhachhangAction())}),h(1,"mat-icon"),s(2,"save"),r()()}if(c&2){let n=d();m("disabled",n.isLoading())}}function Ce(c,t){if(c&1){let n=v();h(0,"button",13),f("click",function(){p(n);let i=d();return u(i.toggleEdit())}),h(1,"mat-icon"),s(2,"edit"),r()()}if(c&2){let n=d();m("disabled",n.isLoading())}}function ve(c,t){if(c&1){let n=v();S(0),h(1,"div",14)(2,"div",15),s(3,"B\u1EA1n ch\u1EAFc ch\u1EAFn mu\u1ED1n xo\xE1 kh\xF4ng?"),r(),h(4,"div",16)(5,"button",17),f("click",function(){p(n);let i=d();return u(i.DeleteData())}),s(6,"\u0110\u1ED3ng \xDD"),r(),h(7,"button",18),f("click",function(){p(n);let i=d();return u(i.toggleDelete())}),s(8,"Hu\u1EF7 B\u1ECF"),r()()(),M()}}function xe(c,t){c&1&&(h(0,"span",36),s(1,"check"),r())}function De(c,t){if(c&1){let n=v();h(0,"div",34),f("click",function(){let i=p(n).$implicit,o=d(2);return u(o.ChosenKhachhang(i))}),C(1,xe,2,0,"span",35),s(2),r()}if(c&2){let n=t.$implicit,e=d(2);l(),m("ngIf",e.CheckKhachhang(n)),l(),N(" ",n.name," ")}}function Ne(c,t){if(c&1&&(h(0,"span",33),s(1),r()),c&2){let n=t.$implicit;l(),L(n.name)}}function we(c,t){if(c&1){let n=v();S(0)(1),h(2,"div",19)(3,"mat-form-field",20)(4,"mat-label"),s(5,"Nh\xF3m Kh\xE1ch h\xE0ng"),r(),h(6,"input",21),E("ngModelChange",function(i){p(n);let o=d();return b(o.DetailNhomkhachhang().name,i)||(o.DetailNhomkhachhang().name=i),u(i)}),r()(),h(7,"mat-form-field",20)(8,"mat-label"),s(9,"M\xF4 T\u1EA3"),r(),h(10,"input",22),E("ngModelChange",function(i){p(n);let o=d();return b(o.DetailNhomkhachhang().description,i)||(o.DetailNhomkhachhang().description=i),u(i)}),r()(),h(11,"div",23)(12,"button",24,0),s(14),r(),h(15,"mat-menu",null,1)(17,"div",25),f("click",function(i){return p(n),u(i.stopPropagation())}),h(18,"div",26)(19,"input",27),f("keyup",function(i){p(n);let o=d();return u(o.doFilterKhachhang(i))}),r(),h(20,"div",28)(21,"span",29),s(22,"search"),r()()(),h(23,"div",30),C(24,De,3,2,"div",31),r(),h(25,"div",32)(26,"button",18),f("click",function(){p(n);let i=D(13);return u(i.closeMenu())}),s(27,"\u0110\xF3ng"),r(),h(28,"button",17),f("click",function(){p(n);let i=D(13),o=d();return u(o.ApplyKhachhang(i))}),s(29,"\xC1p D\u1EE5ng"),r()()()(),K(30,Ne,2,1,"span",33,T),r()(),M()()}if(c&2){let n=D(16),e=d();l(6),w("ngModel",e.DetailNhomkhachhang().name),m("disabled",!e.isEdit()||e.isLoading()),l(4),w("ngModel",e.DetailNhomkhachhang().description),m("disabled",!e.isEdit()||e.isLoading()),l(2),m("disabled",!e.isEdit()||e.isLoading())("matMenuTriggerFor",n),l(2),N(" ",e.CheckListKhachhang.length," Kh\xE1ch H\xE0ng "),l(10),m("ngForOf",e.ListKhachhang)("ngForTrackBy",e.trackByFn),l(6),F(e.CheckListKhachhang)}}var ke=class c{_ListnhomkhachhangComponent=y(fe);_NhomkhachhangService=y(ue);_KhachhangService=y(pe);_GraphqlService=y(de);_route=y(O);_router=y(z);_snackBar=y(W);DetailNhomkhachhang=this._NhomkhachhangService.DetailNhomkhachhang;isEdit=x(!1);isDelete=x(!1);isLoading=x(!1);nhomkhachhangId=this._NhomkhachhangService.nhomkhachhangId;ListKhachhang=[];FilterKhachhang=[];CheckListKhachhang=[];effectRef;constructor(){this.initializeRouteSubscription(),this.initializeEffect()}ngOnInit(){return _(this,null,function*(){this.GetListKhachhang()})}ngOnDestroy(){this.effectRef&&this.effectRef.destroy()}initializeRouteSubscription(){this._route.paramMap.subscribe(t=>{let n=t.get("id");this._NhomkhachhangService.setNhomkhachhangId(n)})}initializeEffect(){this.effectRef=V(()=>_(this,null,function*(){let t=this._NhomkhachhangService.nhomkhachhangId();this.isLoading.set(!0);try{if(!t){this.handleEmptyId();return}t==="new"?this.handleNewRecord():yield this.handleExistingRecord(t)}catch(n){console.error("Error in effect:",n),this._snackBar.open("C\xF3 l\u1ED7i x\u1EA3y ra khi t\u1EA3i d\u1EEF li\u1EC7u","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}finally{this.isLoading.set(!1)}}))}handleEmptyId(){this._router.navigate(["/admin/nhomkhachhang"]),this._ListnhomkhachhangComponent.drawer.close()}handleNewRecord(){this.DetailNhomkhachhang.update(()=>({name:"",description:"",isActive:!0})),this._ListnhomkhachhangComponent.drawer.open(),this.isEdit.set(!0),this._router.navigate(["/admin/nhomkhachhang","new"])}GetListKhachhang(){return _(this,null,function*(){let t=yield this._GraphqlService.findAll("khachhang",{select:{id:!0,name:!0},take:99999,aggressiveCache:!0,enableParallelFetch:!0});this.ListKhachhang=t.data})}handleExistingRecord(t){return _(this,null,function*(){yield this._NhomkhachhangService.getNhomkhachhangByid(t),this.CheckListKhachhang=this.DetailNhomkhachhang()?.khachhang||[],this._ListnhomkhachhangComponent.drawer.open(),this._router.navigate(["/admin/nhomkhachhang",t])})}handleNhomkhachhangAction(){return _(this,null,function*(){this.nhomkhachhangId()==="new"?yield this.createNhomkhachhang():yield this.updateNhomkhachhang()})}createNhomkhachhang(){return _(this,null,function*(){this.isLoading.set(!0);try{let t={name:this.DetailNhomkhachhang().name?.trim(),description:this.DetailNhomkhachhang().description?.trim()||""};if(!t.name)throw new Error("T\xEAn nh\xF3m kh\xE1ch h\xE0ng kh\xF4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng");console.log("Creating nhomkhachhang with data:",t);let n=yield this._GraphqlService.createOne("nhomkhachhang",t,{include:{khachhang:!0}});if(console.log("Created nhomkhachhang result:",n),n&&n.id){if(this.CheckListKhachhang.length>0){console.log("Connecting khachhang to nhomkhachhang...");let e=this.CheckListKhachhang.map(i=>i.id).filter(i=>i&&typeof i=="string"&&i.trim()!=="");if(e.length>0){let i={khachhang:{connect:e.map(a=>({id:a.trim()}))}};console.log("Relation update data:",i);let o=yield this._GraphqlService.updateOne("nhomkhachhang",{id:n.id},i);console.log("Relation update result:",o)}}this._snackBar.open("T\u1EA1o M\u1EDBi Th\xE0nh C\xF4ng","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this._router.navigate(["/admin/nhomkhachhang",n.id]),this.isEdit.set(!1),yield this._NhomkhachhangService.getNhomkhachhangByid(n.id),this.CheckListKhachhang=this.DetailNhomkhachhang()?.khachhang||[]}}catch(t){console.error("L\u1ED7i khi t\u1EA1o nhomkhachhang:",t),this._snackBar.open(t.message||"C\xF3 l\u1ED7i x\u1EA3y ra khi t\u1EA1o nh\xF3m kh\xE1ch h\xE0ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}finally{this.isLoading.set(!1)}})}updateNhomkhachhang(){return _(this,null,function*(){this.isLoading.set(!0);try{let t={name:this.DetailNhomkhachhang().name?.trim(),description:this.DetailNhomkhachhang().description?.trim()||""};if(!t.name)throw new Error("T\xEAn nh\xF3m kh\xE1ch h\xE0ng kh\xF4ng \u0111\u01B0\u1EE3c \u0111\u1EC3 tr\u1ED1ng");let n=this.buildNestedRelationData();n&&(t.khachhang=n),console.log("Updating nhomkhachhang with data (including nested relations):",t);let e=yield this._GraphqlService.updateOne("nhomkhachhang",{id:this.nhomkhachhangId()},t,{include:{khachhang:!0}});console.log("Update result with nested relations:",e),this._snackBar.open("C\u1EADp Nh\u1EADt Th\xE0nh C\xF4ng","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this.isEdit.set(!1),yield this._NhomkhachhangService.getNhomkhachhangByid(this.nhomkhachhangId()),this.CheckListKhachhang=this.DetailNhomkhachhang()?.khachhang||[]}catch(t){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt nhomkhachhang:",t),this._snackBar.open(t.message||"C\xF3 l\u1ED7i x\u1EA3y ra khi c\u1EADp nh\u1EADt nh\xF3m kh\xE1ch h\xE0ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}finally{this.isLoading.set(!1)}})}buildNestedRelationData(){try{let t=this.DetailNhomkhachhang()?.khachhang?.map(a=>a.id).filter(a=>a&&typeof a=="string")||[],n=this.CheckListKhachhang.map(a=>a.id).filter(a=>a&&typeof a=="string");if(console.log("Building nested relation data..."),console.log("Current khachhang IDs:",t),console.log("New khachhang IDs:",n),JSON.stringify(t.sort())===JSON.stringify(n.sort()))return console.log("No relation changes detected for nested update"),null;let e=n.filter(a=>!t.includes(a)),i=t.filter(a=>!n.includes(a));console.log("To connect (nested):",e),console.log("To disconnect (nested):",i);let o={};if(i.length>0){let a=i.filter(g=>g&&typeof g=="string"&&g.trim()!==""&&g.length>=36);a.length>0&&(o.disconnect=a.map(g=>({id:g.trim()})))}if(e.length>0){let a=e.filter(g=>g&&typeof g=="string"&&g.trim()!==""&&g.length>=36);a.length>0&&(o.connect=a.map(g=>({id:g.trim()})))}return console.log("Built nested relation data:",o),Object.keys(o).length>0?o:null}catch(t){return console.error("L\u1ED7i khi build nested relation data:",t),null}}updateKhachhangRelations(){return _(this,null,function*(){try{let t=this.DetailNhomkhachhang()?.khachhang?.map(e=>e.id).filter(e=>e&&typeof e=="string")||[],n=this.CheckListKhachhang.map(e=>e.id).filter(e=>e&&typeof e=="string");if(console.log("Current khachhang IDs:",t),console.log("New khachhang IDs:",n),JSON.stringify(t.sort())!==JSON.stringify(n.sort())){let e=n.filter(a=>!t.includes(a)),i=t.filter(a=>!n.includes(a));console.log("To connect:",e),console.log("To disconnect:",i);let o=this.buildRelationUpdateData(e,i);if(o){console.log("Updating relations with data:",o);let a=yield this._GraphqlService.updateOne("nhomkhachhang",{id:this.nhomkhachhangId()},o);console.log("Relation update result:",a)}}else console.log("No relation changes detected")}catch(t){throw console.error("L\u1ED7i khi c\u1EADp nh\u1EADt relations:",t),t}})}DeleteData(){return _(this,null,function*(){try{yield this._NhomkhachhangService.DeleteNhomkhachhang(this.DetailNhomkhachhang()),this._snackBar.open("X\xF3a Th\xE0nh C\xF4ng","",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),this._router.navigate(["/admin/nhomkhachhang"])}catch(t){console.error("L\u1ED7i khi x\xF3a nhomkhachhang:",t)}})}goBack(){this._router.navigate(["/admin/nhomkhachhang"]),this._ListnhomkhachhangComponent.drawer.close()}trackByFn(t,n){return n.id}toggleEdit(){this.isEdit.update(t=>!t)}toggleDelete(){this.isDelete.update(t=>!t)}FillSlug(){this.DetailNhomkhachhang.update(t=>(t.slug=ce(t.title),t))}doFilterKhachhang(t){let n=t.target.value.toLowerCase();n.length<2&&n.length>0||(this.ListKhachhang=this._KhachhangService.ListKhachhang().filter(e=>e.name.toLowerCase().includes(n)))}ChosenKhachhang(t){this.CheckListKhachhang.find(e=>e.id===t.id)?this.CheckListKhachhang=this.CheckListKhachhang.filter(e=>e.id!==t.id):this.CheckListKhachhang.push(t)}ApplyKhachhang(t){return _(this,null,function*(){this.isLoading.set(!0);try{let n=this.DetailNhomkhachhang()?.khachhang?.map(k=>k.id).filter(k=>k)||[],e=this.CheckListKhachhang.map(k=>k.id).filter(k=>k),i=this.nhomkhachhangId();if(!i)throw new Error("Kh\xF4ng t\xECm th\u1EA5y ID nh\xF3m kh\xE1ch h\xE0ng");if(console.log(this.DetailNhomkhachhang()),console.log(n),JSON.stringify(n.sort())===JSON.stringify(e.sort())){t.closeMenu(),this.isLoading.set(!1);return}let o=e.filter(k=>!n.includes(k)),a=n.filter(k=>!e.includes(k)),g=this.buildRelationUpdateData(o,a);g&&(yield this._GraphqlService.updateOne("nhomkhachhang",{id:i},g)),this._snackBar.open("C\u1EADp nh\u1EADt kh\xE1ch h\xE0ng th\xE0nh c\xF4ng","",{duration:2e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-success"]}),yield this._NhomkhachhangService.getNhomkhachhangByid(this.nhomkhachhangId()),t.closeMenu()}catch(n){console.error("L\u1ED7i khi c\u1EADp nh\u1EADt kh\xE1ch h\xE0ng:",n),this._snackBar.open("C\xF3 l\u1ED7i x\u1EA3y ra khi c\u1EADp nh\u1EADt kh\xE1ch h\xE0ng","",{duration:3e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}finally{this.isLoading.set(!1)}})}buildRelationUpdateData(t,n){let e=t.filter(a=>a&&typeof a=="string"&&a.trim()!==""&&a.length>=36),i=n.filter(a=>a&&typeof a=="string"&&a.trim()!==""&&a.length>=36);if(console.log("Validated to connect:",e),console.log("Validated to disconnect:",i),e.length===0&&i.length===0)return console.log("No valid relation changes found"),null;let o={khachhang:{}};return i.length>0&&(o.khachhang.disconnect=i.map(a=>({id:a.trim()}))),e.length>0&&(o.khachhang.connect=e.map(a=>({id:a.trim()}))),console.log("Built relation update data:",o),o}CheckKhachhang(t){return!!this.CheckListKhachhang.find(n=>n.id===t.id)}static \u0275fac=function(n){return new(n||c)};static \u0275cmp=I({type:c,selectors:[["app-detailnhomkhachhang"]],decls:18,vars:10,consts:[["menuTrigger","matMenuTrigger"],["menu","matMenu"],[1,"flex","flex-row","justify-between","items-center","space-x-2","p-2"],["mat-icon-button","","color","primary",3,"click"],[1,"font-bold"],[1,"flex","flex-row","space-x-2","items-center"],["diameter","20",4,"ngIf"],[3,"ngModelChange","ngModel","disabled"],["mat-icon-button","","color","primary",3,"disabled","click",4,"ngIf"],["mat-icon-button","","color","warn",3,"click","disabled"],[1,"relative","flex","flex-col","w-full","p-4","overflow-auto"],[4,"ngIf"],["diameter","20"],["mat-icon-button","","color","primary",3,"click","disabled"],[1,"flex","flex-col","space-y-4","items-center","justify-center"],[1,"font-bold","text-2xl"],[1,"flex","flex-row","space-x-2","items-center","justify-center"],["mat-flat-button","","color","primary",3,"click"],["mat-flat-button","","color","warn",3,"click"],[1,"w-full","flex","flex-col","space-y-2"],["appearance","outline"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp Nh\xF3m Kh\xE1ch h\xE0ng",3,"ngModelChange","ngModel","disabled"],["matInput","","placeholder","Vui l\xF2ng nh\u1EADp M\xF4 T\u1EA3",3,"ngModelChange","ngModel","disabled"],[1,"flex","flex-row","flex-wrap","gap-2"],["mat-flat-button","","color","primary",3,"disabled","matMenuTriggerFor"],[1,"cursor-pointer","flex","flex-col","space-y-4","p-3",3,"click"],[1,"relative","w-full"],["type","text","placeholder","T\xECm Ki\u1EBFm...",1,"block","w-full","pl-10","pr-4","py-2","text-gray-700","bg-white","border","border-gray-300","rounded-lg","focus:border-blue-400","focus:ring-blue-400","focus:outline-none","focus:ring","focus:ring-opacity-40",3,"keyup"],[1,"absolute","inset-y-0","left-0","flex","items-center","pl-3","pointer-events-none"],[1,"material-symbols-outlined","text-gray-500"],[1,"w-full","flex","flex-col","space-y-2","max-h-44","overflow-auto"],["class","flex flex-row space-x-2 items-center p-2 rounded-lg hover:bg-slate-100",3,"click",4,"ngFor","ngForOf","ngForTrackBy"],[1,"flex","flex-row","space-x-2","items-end","justify-end"],[1,"whitespace-nowrap","p-2","rounded-lg","bg-slate-200"],[1,"flex","flex-row","space-x-2","items-center","p-2","rounded-lg","hover:bg-slate-100",3,"click"],["class","material-symbols-outlined text-blue-600",4,"ngIf"],[1,"material-symbols-outlined","text-blue-600"]],template:function(n,e){if(n&1&&(h(0,"div",2)(1,"button",3),f("click",function(){return e.goBack()}),h(2,"mat-icon"),s(3,"arrow_back"),r()(),h(4,"div",4),s(5),r(),h(6,"div",5),C(7,_e,1,0,"mat-spinner",6),h(8,"mat-slide-toggle",7),E("ngModelChange",function(o){return b(e.DetailNhomkhachhang().isActive,o)||(e.DetailNhomkhachhang().isActive=o),o}),s(9),r(),C(10,ye,3,1,"button",8)(11,Ce,3,1,"button",8),h(12,"button",9),f("click",function(){return e.toggleDelete()}),h(13,"mat-icon"),s(14,"delete"),r()()()(),h(15,"div",10),C(16,ve,9,0,"ng-container",11)(17,we,32,9,"ng-container",11),r()),n&2){let i;l(5),L(((i=e.DetailNhomkhachhang())==null?null:i.name)||"Kh\xF4ng c\xF3 d\u1EEF li\u1EC7u"),l(2),m("ngIf",e.isLoading()),l(),w("ngModel",e.DetailNhomkhachhang().isActive),m("disabled",!e.isEdit()||e.isLoading()),l(),N(" ",e.DetailNhomkhachhang().isActive?"Hi\u1EC3n Th\u1ECB":"\u1EA8n"," "),l(),m("ngIf",e.isEdit()),l(),m("ngIf",!e.isEdit()),l(),m("disabled",e.isLoading()),l(4),m("ngIf",e.isDelete()),l(),m("ngIf",!e.isDelete())}},dependencies:[ae,ie,ne,he,oe,ee,Y,Z,$,J,j,U,G,q,re,te,A,R,P,se,le,Q,H,X,me,ge],encapsulation:2,changeDetection:0})};export{ke as DetailNhomkhachhangComponent};
