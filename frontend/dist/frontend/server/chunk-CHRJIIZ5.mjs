import './polyfills.server.mjs';
import{a as i}from"./chunk-7ZQLLCLM.mjs";import{a as v}from"./chunk-KIASK6XJ.mjs";import{d as m}from"./chunk-RGSHHE6M.mjs";import{v as f}from"./chunk-X6Q6E4R3.mjs";import{Na as u,Sa as p,fa as d,g as y,ka as h,o as n}from"./chunk-5UNID2CD.mjs";import{j as a}from"./chunk-RIAI3ORJ.mjs";var g=class{constructor(){}static isTokenExpired(r,e){if(!r||r==="")return!0;let t=this._getTokenExpirationDate(r);return e=e||0,t===null?!0:!(t.valueOf()>new Date().valueOf()+e*1e3)}static _b64decode(r){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="";if(r=String(r).replace(/=+$/,""),r.length%4===1)throw new Error("The string to be decoded is not correctly encoded.");for(let s=0,o,c,P=0;c=r.charAt(P++);~c&&(o=s%4?o*64+c:c,s++%4)?t+=String.fromCharCode(255&o>>(-2*s&6)):0)c=e.indexOf(c);return t}static _b64DecodeUnicode(r){return decodeURIComponent(Array.prototype.map.call(this._b64decode(r),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(e)}static _decodeToken(r){if(!r)return null;let e=r.split(".");if(e.length!==3)throw new Error("Invalid JWT. Check for three parts and refer to https://jwt.io.");let t=this._urlBase64Decode(e[1]);if(!t)throw new Error("Cannot decode the token.");return JSON.parse(t)}static _getTokenExpirationDate(r){let e=this._decodeToken(r);if(!e.hasOwnProperty("exp"))return null;let t=new Date(0);return t.setUTCSeconds(e.exp),t}static removeDuplicatePermissions(r){let e=new Map;return r.roles.forEach(t=>{t.role.permissions.forEach(s=>{e.has(s.permissionId)||e.set(s.permissionId,s)})}),r.permissions=Array.from(e.values()),r}};var S=class l{constructor(r,e,t){this._StorageService=r;this.platformId=e;this.router=t;this.isBrowser=f(this.platformId)}_secret;_authenticated=!1;APIURL=i.APIURL;isBrowser;BASE_URL=`${i.APIURL}/auth`;profile=u({});ListUser=u([]);DetailUser=u({});userId=u(null);setUserId(r){this.userId.set(r)}permissionsSubject=new y([]);permissions$=this.permissionsSubject.asObservable();getAdmin(){return a(this,null,function*(){try{let r={method:"GET",headers:{"Content-Type":"application/json"}};return yield(yield fetch(`${i.APIURL}/users/get/admin`,r)).json()}catch(r){return console.error(r)}})}CreateUser(r){return a(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/users`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();if(!t.ok)if(t.status===401){let o=JSON.stringify({code:t.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else if(t.status===403){let o=JSON.stringify({code:t.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else if(t.status===500){let o=JSON.stringify({code:t.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else{let o=JSON.stringify({code:t.status,title:"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}this.getAllUser(),this.userId.set(s.id)}catch(e){return console.error(e)}})}getAllUser(){return a(this,null,function*(){try{let r={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this._StorageService.getItem("token")}},e=yield fetch(`${i.APIURL}/users`,r);if(!e.ok)if(e.status===401){let s=JSON.stringify({code:e.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else if(e.status===403){let s=JSON.stringify({code:e.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else if(e.status===500){let s=JSON.stringify({code:e.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else{let s=JSON.stringify({code:e.status,title:"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}let t=yield e.json();this.ListUser.set(t)}catch(r){return console.error(r)}})}getUserByid(r){return a(this,null,function*(){try{let e={method:"GET",headers:{"Content-Type":"application/json"}},t=yield fetch(`${i.APIURL}/users/findid/${r}`,e);if(!t.ok)if(t.status===401){let o=JSON.stringify({code:t.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else if(t.status===403){let o=JSON.stringify({code:t.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else if(t.status===500){let o=JSON.stringify({code:t.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else{let o=JSON.stringify({code:t.status,title:"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}let s=yield t.json();this.DetailUser.set(s)}catch(e){return console.error(e)}})}updateUser(r){return a(this,null,function*(){try{let e={method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/users/${r.id}`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();if(!t.ok)if(t.status===401){let o=JSON.stringify({code:t.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else if(t.status===403){let o=JSON.stringify({code:t.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else if(t.status===500){let o=JSON.stringify({code:t.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else{let o=JSON.stringify({code:t.status,title:"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}this.getAllUser(),this.getUserByid(r.id)}catch(e){return console.error(e)}})}assignRoleToUser(r){return a(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/users/assign`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();if(!t.ok)if(t.status===401){let o=JSON.stringify({code:t.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else if(t.status===403){let o=JSON.stringify({code:t.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else if(t.status===500){let o=JSON.stringify({code:t.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else{let o=JSON.stringify({code:t.status,title:"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}this.getUserByid(r.userId)}catch(e){return console.error(e)}})}removeRoleFromUser(r){return a(this,null,function*(){try{let e={method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/users/remove`,e);if(!t.ok)if(t.status===401){let s=JSON.stringify({code:t.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else if(t.status===403){let s=JSON.stringify({code:t.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else if(t.status===500){let s=JSON.stringify({code:t.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else{let s=JSON.stringify({code:t.status,title:"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}this.getUserByid(r.userId)}catch(e){return console.error(e)}})}DeleteUser(r){return a(this,null,function*(){try{let e={method:"DELETE",headers:{"Content-Type":"application/json"}},t=yield fetch(`${i.APIURL}/users/${r.id}`,e);if(!t.ok)if(t.status===401){let s=JSON.stringify({code:t.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else if(t.status===403){let s=JSON.stringify({code:t.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else if(t.status===500){let s=JSON.stringify({code:t.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}else{let s=JSON.stringify({code:t.status,title:"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh"});this.router.navigate(["/errorserver"],{queryParams:{data:s}})}this.getAllUser()}catch(e){return console.error(e)}})}changepass(r){return a(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/users/changepass`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return yield t.json()}catch(e){return console.error(e)}})}Randompass(r){return a(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/auth/randompass`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return console.log(r),r}catch(e){return console.error(e)}})}getProfile(){return a(this,null,function*(){try{let r={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this._StorageService.getItem("token")}},e=yield fetch(`${i.APIURL}/users/profile`,r);e.ok||(console.log(e.status),this.handleError(e.status));let t=yield e.json(),s=t.permissions.map(o=>o.name);return console.log(JSON.stringify(s||[])),this._StorageService.setItem("permissions",JSON.stringify(s||[])),t}catch(r){return console.error(r)}})}handleError(r){let e="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(r){case 401:e="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i",this.router.navigate(["/login"]);break;case 403:e="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp";break;case 500:e="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break}let t=JSON.stringify({code:r,title:e})}set accessToken(r){this.isBrowser&&this._StorageService.setItem("token",r)}get accessToken(){return this.isBrowser?this._StorageService.getItem("token")??"":""}login(r){return a(this,null,function*(){if(this._authenticated)return n([!1,"User \u0110\xE3 \u0110\u0103ng Nh\u1EADp"]);try{let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/auth/login`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();return s?(this._authenticated=!0,this.accessToken=s.access_token,this._StorageService.setItem("permissions",JSON.stringify(s?.user?.permissions||[])),this.permissionsSubject.next(s?.user?.permissions),[!0,s]):[!1,"\u0110\u0103ng Nh\u1EADp Th\u1EA5t B\u1EA1i"]}catch(e){return console.error(e)}})}loadPermissions(){let r=this._StorageService.getItem("permissions");this.permissionsSubject.next(r)}hasPermission(r){return this.permissionsSubject.getValue()||this.logout(),this.permissionsSubject.getValue().includes(r)}register(r){return a(this,null,function*(){try{let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/users/register`,e);if(!t.ok)if(t.status===401){let o=JSON.stringify({code:t.status,title:"Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i"});this.router.navigate(["/errorserver"],{queryParams:{data:o}}),this.logout()}else if(t.status===403){let o=JSON.stringify({code:t.status,title:"B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp"});this.router.navigate(["/errorserver"],{queryParams:{data:o}}),this.logout()}else if(t.status===500){let o=JSON.stringify({code:t.status,title:"L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}else{let o=JSON.stringify({code:t.status,title:"L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh"});this.router.navigate(["/errorserver"],{queryParams:{data:o}})}let s=yield t.json();return console.log(s),s}catch(e){return console.error(e)}})}LoginByGoogle(r){return a(this,null,function*(){if(this._authenticated)return n([!1,"User \u0110\xE3 \u0110\u0103ng Nh\u1EADp"]);try{let e={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)},t=yield fetch(`${i.APIURL}/users/loginbygoogle`,e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);let s=yield t.json();return this._authenticated=!0,this.accessToken=s[1].access_token,console.log(s),[!0,this.accessToken]}catch(e){return console.error(e)}})}checkDangnhap(){return this._authenticated?n(!0):!this.accessToken||this.accessToken==="undefined"?(this.isBrowser&&this._StorageService.removeItem("token"),n(!1)):g.isTokenExpired(this.accessToken)?n(!1):n(!0)}loginWithGoogle(){window.location.href=`${this.BASE_URL}/google`}loginWithFacebook(){window.location.href=`${this.BASE_URL}/facebook`}loginWithZalo(){window.location.href=`${this.BASE_URL}/zalo`}handleOAuthCallback(r){localStorage.setItem("access_token",r),this.router.navigate(["/dashboard"])}getToken(){return this._StorageService.getItem("token")}logout(){return a(this,null,function*(){return this._StorageService.removeItem("token"),this._StorageService.removeItem("permissions"),this.permissionsSubject.next([]),this.router.navigate(["/"]),!0})}static \u0275fac=function(e){return new(e||l)(h(v),h(p),h(m))};static \u0275prov=d({token:l,factory:l.\u0275fac,providedIn:"root"})};export{S as a};
