import './polyfills.server.mjs';
import{a as w}from"./chunk-7BHYQM75.mjs";import{a as A}from"./chunk-73IBRO6I.mjs";import{a as I}from"./chunk-4E5KT4OO.mjs";import{a as p}from"./chunk-7ZQLLCLM.mjs";import{a as v,b as C}from"./chunk-LBZM5ZJB.mjs";import{d as f}from"./chunk-QPVY4VVM.mjs";import{Ra as g,ia as P,na as h,oa as y}from"./chunk-KEAQD3JS.mjs";import{a as u,b as S,j as n}from"./chunk-RIAI3ORJ.mjs";var L=class m{constructor(i,t,e){this._StorageService=i;this.router=t;this._ErrorLogService=e}_snackBar=y(v);ListPermission=g([]);DetailPermission=g({});page=g(1);pageCount=g(1);total=g(0);pageSize=g(10);permissionId=g(null);socket=w(`${p.APIURL}`,{transports:["websocket"],reconnectionAttempts:5,timeout:5e3});initDB(){return n(this,null,function*(){return yield A("PermissionDB",4,{upgrade(i,t){t<1&&i.createObjectStore("permissions",{keyPath:"id"}),t<3&&(i.objectStoreNames.contains("permissions")&&i.deleteObjectStore("permissions"),i.objectStoreNames.contains("pagination")&&i.deleteObjectStore("pagination"),i.createObjectStore("permissions",{keyPath:"id"})),t<4}})})}savePermissions(i,t){return n(this,null,function*(){let a=(yield this.initDB()).transaction("permissions","readwrite"),s=a.objectStore("permissions");yield s.clear(),yield s.put({id:"data",permissions:i,pagination:t}),yield a.done})}getCachedData(){return n(this,null,function*(){let t=yield(yield this.initDB()).get("permissions","data");return t&&t.permissions?{permissions:t.permissions,pagination:t.pagination||{page:1,pageCount:1,total:t.permissions.length,pageSize:10}}:{permissions:[],pagination:{page:1,pageCount:1,total:0,pageSize:10}}})}setPermissionId(i){this.permissionId.set(i)}CreatePermission(i){return n(this,null,function*(){try{let t={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(i)},e=yield fetch(`${p.APIURL}/permission`,t);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);let a=yield e.json();this.getAllPermission(this.pageSize()),this.permissionId.set(a.id)}catch(t){this._ErrorLogService.logError("Failed to CreatePermission",t),console.error(t)}})}getAllPermission(){return n(this,arguments,function*(i=this.pageSize(),t=!1){this.pageSize.set(i),console.log("getAllPermission",i);let e=yield this.getCachedData(),a=this._StorageService.getItem("permissions_updatedAt")||"0";if(!t&&e.permissions.length>0&&Date.now()-new Date(a).getTime()<5*60*1e3)return this.ListPermission.set(e.permissions),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.permissions;try{let s={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}};if(!t){let c=yield fetch(`${p.APIURL}/permission/lastupdated`,s);if(!c.ok)return this.handleError(c.status),this.ListPermission.set(e.permissions),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.permissions;let{updatedAt:d}=yield c.json();if(d<=a)return this.ListPermission.set(e.permissions),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.permissions}let o=new URLSearchParams({page:this.page().toString(),limit:i.toString()}),l=yield fetch(`${p.APIURL}/permission?${o}`,s);if(!l.ok)return this.handleError(l.status),this.ListPermission.set(e.permissions),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.permissions;let r=yield l.json();if(yield this.savePermissions(r.data,{page:r.page||1,pageCount:r.pageCount||1,total:r.total||r.data.length,pageSize:i}),t)this._StorageService.setItem("permissions_updatedAt",new Date().toISOString());else{let c=yield fetch(`${p.APIURL}/permission/lastupdated`,s),{updatedAt:d}=yield c.json();this._StorageService.setItem("permissions_updatedAt",d)}return this.ListPermission.set(r.data),this.page.set(r.page||1),this.pageCount.set(r.pageCount||1),this.total.set(r.total||r.data.length),this.pageSize.set(i),r.data}catch(s){return this._ErrorLogService.logError("Failed to getAllPermission",s),console.error(s),this.ListPermission.set(e.permissions),this.page.set(e.pagination.page),this.pageCount.set(e.pagination.pageCount),this.total.set(e.pagination.total),this.pageSize.set(e.pagination.pageSize),e.permissions}})}getUpdatedCodeIds(){return n(this,null,function*(){try{let i={method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},t=yield fetch(`${p.APIURL}/permission/updateCodeIds`,i);t.ok||this.handleError(t.status);let e=yield t.json();return this.getAllPermission(this.pageSize()),e.data}catch(i){this._ErrorLogService.logError("Failed to getUpdatedCodeIds",i),console.error(i)}})}listenPermissionUpdates(){this.socket.on("permission-updated",()=>n(this,null,function*(){console.log("\u{1F504} D\u1EEF li\u1EC7u s\u1EA3n ph\u1EA9m thay \u0111\u1ED5i, c\u1EADp nh\u1EADt l\u1EA1i cache..."),this._StorageService.removeItem("permissions_updatedAt"),yield this.getAllPermission(this.pageSize())}))}getPermissionBy(e){return n(this,arguments,function*(i,t=this.pageSize()){this.pageSize.set(t);try{let a={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(S(u({},i),{page:this.page(),limit:t}))},s=yield fetch(`${p.APIURL}/permission/findby`,a);s.ok||this.handleError(s.status);let o=yield s.json();i.isOne===!0?this.DetailPermission.set(o):(yield this.savePermissions(o.data,{page:o.page||1,pageCount:o.pageCount||1,total:o.total||o.data.length,pageSize:t}),this._StorageService.setItem("permissions_updatedAt",new Date().toISOString()),this.ListPermission.set(o.data),this.page.set(o.page||1),this.pageCount.set(o.pageCount||1),this.total.set(o.total||o.data.length),this.pageSize.set(t))}catch(a){this._ErrorLogService.logError("Failed to getPermissionBy",a),console.error(a);let s=yield this.getCachedData();i.isOne||(this.ListPermission.set(s.permissions),this.page.set(s.pagination.page),this.pageCount.set(s.pagination.pageCount),this.total.set(s.pagination.total),this.pageSize.set(s.pagination.pageSize))}})}updatePermission(i){return n(this,null,function*(){try{let t={method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`},body:JSON.stringify(i)},e=yield fetch(`${p.APIURL}/permission/${i.id}`,t);e.ok||this.handleError(e.status);let a=yield e.json();this.getAllPermission(this.pageSize()),this.getPermissionBy({id:a.id,isOne:!0},this.pageSize())}catch(t){this._ErrorLogService.logError("Failed to updatePermission",t),console.error(t)}})}DeletePermission(i){return n(this,null,function*(){try{let t={method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this._StorageService.getItem("token")}`}},e=yield fetch(`${p.APIURL}/permission/${i.id}`,t);e.ok||this.handleError(e.status),this.getAllPermission(this.pageSize())}catch(t){this._ErrorLogService.logError("Failed to DeletePermission",t),console.error(t)}})}handleError(i){let t="L\u1ED7i kh\xF4ng x\xE1c \u0111\u1ECBnh";switch(i){case 400:t="Th\xF4ng tin \u0111\xE3 t\u1ED3n t\u1EA1i";break;case 401:case 404:t="Vui l\xF2ng \u0111\u0103ng nh\u1EADp l\u1EA1i";break;case 403:t="B\u1EA1n kh\xF4ng c\xF3 quy\u1EC1n truy c\u1EADp";break;case 500:t="L\u1ED7i m\xE1y ch\u1EE7, vui l\xF2ng th\u1EED l\u1EA1i sau";break}this._snackBar.open(t,"",{duration:1e3,horizontalPosition:"end",verticalPosition:"top",panelClass:["snackbar-error"]})}static \u0275fac=function(t){return new(t||m)(h(C),h(f),h(I))};static \u0275prov=P({token:m,factory:m.\u0275fac,providedIn:"root"})};export{L as a};
