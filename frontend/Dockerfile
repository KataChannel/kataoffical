# Stage 1: Build Angular SSR
FROM node:18-alpine AS build

WORKDIR /app

# Copy chỉ những file cần thiết để cache tốt hơn
COPY package.json package-lock.json ./

# Cài đặt dependencies ở chế độ production
RUN npm ci --production

# Copy toàn bộ source code vào container
COPY . .

# Tăng giới hạn bộ nhớ để tránh lỗi out of memory khi build
ENV NODE_OPTIONS="--max-old-space-size=2048"

# Build Angular Universal (SSR)
RUN npm run build:ssr

# Stage 2: Chạy SSR trên Node.js
FROM node:18-alpine AS runtime

WORKDIR /app

# Copy build từ stage trước
COPY --from=build /app/dist/frontend /app/dist/frontend
COPY --from=build /app/node_modules /app/node_modules
COPY --from=build /app/package.json /app/package.json

# Chạy ứng dụng
EXPOSE 4301
CMD ["node", "dist/frontend/server/main.js"]
