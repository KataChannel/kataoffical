<div class="flex flex-row justify-between items-center space-x-2 p-2">
  <button mat-icon-button color="primary" (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <div class="font-bold">{{ DetailDathang()?.title || 'Không có dữ liệu' }}</div>
  <div class="flex flex-row space-x-2 items-center">
    <mat-slide-toggle [(ngModel)]="DetailDathang().isActive" [disabled]="!isEdit()">{{DetailDathang().isActive?'Hiển Thị':'Ẩn'}}</mat-slide-toggle>
    <button mat-icon-button color="primary" *ngIf="isEdit()" (click)="handleDathangAction()">
      <mat-icon>save</mat-icon>
    </button>
    <button mat-icon-button color="primary" *ngIf="!isEdit()" (click)="toggleEdit()">
      <mat-icon>edit</mat-icon>
    </button>
    <button mat-icon-button color="warn" (click)="toggleDelete()">
      <mat-icon>delete</mat-icon>
    </button>
  </div>
</div>

<div class="relative flex flex-col w-full p-4 overflow-auto">
  <!-- Xác nhận Xóa -->
  <ng-container *ngIf="isDelete()">
    <div class="flex flex-col space-y-4 items-center justify-center">
      <div class="font-bold text-2xl">Bạn chắc chắn muốn xoá không?</div>
      <div class="flex flex-row space-x-2 items-center justify-center">
        <button mat-flat-button color="primary" (click)="DeleteData()">Đồng Ý</button>
        <button mat-flat-button color="warn" (click)="toggleDelete()">Huỷ Bỏ</button>
      </div>
    </div>
  </ng-container>

  <!-- Chi tiết Dathang -->
  <ng-container *ngIf="!isDelete()">
    <!-- <div *ngIf="!isEdit()" class="flex flex-col space-y-2 justify-center items-center border p-4 rounded-lg">
      <div class="font-bold p-2 rounded-lg border">{{ DetailDathang()?.Nhacungcap?.Title }}</div>
      <div>{{ DetailDathang()?.CreateAt | date: 'dd/MM/yyyy' }}</div>
      <table class="min-w-full divide-y divide-gray-200 border">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">STT</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sản Phẩm</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số Lượng</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ghi Chú</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let item of DetailDathang()?.Dathang; let i = index; trackBy: trackByFn">
            <td class="px-6 py-4 text-sm text-gray-500">{{ i + 1 }}</td>
            <td class="px-6 py-4 text-sm text-gray-500">{{ GetInfoDathang(item.idSP)?.Title }}</td>
            <td class="px-6 py-4 text-sm text-gray-500">
              {{ item.Soluong }} {{ GetInfoDathang(item.idSP)?.dvt }}
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">{{ item.Ghichu }}</td>
          </tr>
        </tbody>
      </table>
    </div>
 -->
    <ng-container>
      <div class="flex flex-col space-y-2"> 

          <div class="w-full flex flex-row space-x-2 items-center">
            <mat-form-field class="w-full" appearance="outline" subscriptSizing="dynamic">
              <mat-label>Tiêu Đề</mat-label>
              <input matInput [(ngModel)]="DetailDathang().title" [disabled]="!isEdit()" placeholder="Vui lòng nhập Tiêu Đề"/>
            </mat-form-field>
            <mat-form-field class="w-full" appearance="outline" subscriptSizing="dynamic">
              <mat-label>Mã Đặt Hàng</mat-label>
              <input matInput [(ngModel)]="DetailDathang().madncc" [disabled]="!isEdit()" placeholder="Vui lòng nhập Mã Đặt Hàng"/>
            </mat-form-field>
            <mat-form-field class="w-full" [appearance]="'outline'" [subscriptSizing]="'dynamic'">
              <mat-label>Ngày Nhận Hàng</mat-label>
              <input matInput [matDatepicker]="datepicker" [disabled]="!isEdit()" [(ngModel)]="DetailDathang().ngaynhan" [ngModelOptions]="{ standalone: true }" />
              <mat-datepicker-toggle matIconSuffix [for]="datepicker"></mat-datepicker-toggle>
              <mat-datepicker #datepicker></mat-datepicker>
            </mat-form-field>
            <mat-form-field class="w-full" appearance="outline" subscriptSizing="dynamic">
              <mat-label>Nhà Cung Cấp</mat-label>
              <mat-select [(ngModel)]="DetailDathang().nhacungcapId" [disabled]="!isEdit()" [ngModelOptions]="{ standalone: true }"
                (selectionChange)="SelectNCC($event)">
                <div class="w-full flex flex-col">
                  <mat-form-field appearance="outline" class="w-full p-2" subscriptSizing="dynamic">
                    <input matInput (input)="DoFindNCC($event)" placeholder="Tìm Kiếm" />
                  </mat-form-field>
                  <div class="overflow-y-auto max-h-44">
                    @for (item of filterNCC; track item.id) {
                    <mat-option [value]="item.id">{{item.name}} - {{item.mancc}}</mat-option>
                    }
                  </div>
                </div>
              </mat-select>
            </mat-form-field>
          </div>

 
          <mat-form-field appearance="outline" subscriptSizing="dynamic">
            <mat-label>Ghi Chú</mat-label>
            <textarea matInput [(ngModel)]="DetailDathang().ghichu" [disabled]="!isEdit()" placeholder="Vui lòng nhập Ghi Chú"></textarea> 
          </mat-form-field>     

          <div class="w-full flex flex-col space-y-2 items-center">
            @for (item of DetailDathang().sanpham; track item.id; let idx = $index) {

              <div class="w-full flex flex-row space-x-2 items-center">
              <mat-form-field class="w-full" appearance="outline" subscriptSizing="dynamic">
                <mat-label>Sản Phẩm</mat-label>
                <mat-select [disabled]="!isEdit" [disabled]="!isEdit()" [(ngModel)]="DetailDathang().sanpham[idx].idSP" [ngModelOptions]="{ standalone: true }">
                  <div class="w-full flex flex-col px-4">
                    <div class="flex flex-row space-x-2 items-center">
                      <mat-form-field appearance="outline" class="w-full p-2" subscriptSizing="dynamic">
                        <input matInput (input)="DoFindSanpham($event)" placeholder="Tìm Kiếm" />
                      </mat-form-field>
                      <button mat-icon-button color="primary">
                        <mat-icon>add_circle</mat-icon>
                      </button>
                    </div>
                    <div class="overflow-y-auto max-h-44">
                      @for (item of filterSP; track item.id) {
                      <mat-option [value]="item.id">{{item.title}} [SL : {{item.soluong}}{{item.dvt}}][SL Tồn : {{item.soluongkho}}{{item.dvt}}]</mat-option>
                      }
                    </div>
                  </div>
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="outline" class="w-60" subscriptSizing="dynamic">
                <mat-label>SL</mat-label>
                <input matInput type="number" [disabled]="!isEdit()" [(ngModel)]="DetailDathang().sanpham[idx].sldat" (change)="onChangeSoluong(item,$event)"  [ngModelOptions]="{ standalone: true }" placeholder="Vui lòng Nhập Số Điện Thoại" />
            </mat-form-field> 
              <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <mat-label>Ghi Chú</mat-label>
                <input matInput [disabled]="!isEdit()" [(ngModel)]="DetailDathang().sanpham[idx].ghichu"  [ngModelOptions]="{ standalone: true }" placeholder="Vui lòng Nhập Ghi Chú" />
            </mat-form-field> 
            </div>
          }
          </div>
          <div>
            <button [disabled]="!isEdit()" mat-flat-button color="primary" (click)="AddSanpham()"><span>Thêm</span><mat-icon>add</mat-icon></button>
          </div>
    </div>
    
    </ng-container>
  </ng-container>
</div>