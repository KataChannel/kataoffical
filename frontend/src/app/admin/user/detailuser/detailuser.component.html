<div class="flex flex-row justify-between items-center space-x-2 p-2">
  <button mat-icon-button color="primary" (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <div class="font-bold">{{ DetailUser()?.email || 'Không có dữ liệu' }}</div>
  <div class="flex flex-row space-x-2 items-center">
    <mat-slide-toggle [(ngModel)]="DetailUser().isActive" [disabled]="!isEdit()">{{DetailUser().isActive?'Hiển Thị':'Ẩn'}}</mat-slide-toggle>
    <button mat-icon-button color="primary" *ngIf="isEdit()" (click)="handleUserAction()">
      <mat-icon>save</mat-icon>
    </button>
    <button mat-icon-button color="primary" *ngIf="!isEdit()" (click)="toggleEdit()">
      <mat-icon>edit</mat-icon>
    </button>
    <button mat-icon-button color="warn" (click)="toggleDelete()">
      <mat-icon>delete</mat-icon>
    </button>
  </div>
</div>

<div class="relative flex flex-col w-full p-4 overflow-auto">
  <!-- Xác nhận Xóa -->
  <ng-container *ngIf="isDelete()">
    <div class="flex flex-col space-y-4 items-center justify-center">
      <div class="font-bold text-2xl">Bạn chắc chắn muốn xoá không?</div>
      <div class="flex flex-row space-x-2 items-center justify-center">
        <button mat-flat-button color="primary" (click)="DeleteData()">Đồng Ý</button>
        <button mat-flat-button color="warn" (click)="toggleDelete()">Huỷ Bỏ</button>
      </div>
    </div>
  </ng-container>

  <!-- Chi tiết User -->
  <ng-container *ngIf="!isDelete()">
    <div class="w-full flex flex-col space-y-2">
      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput [(ngModel)]="DetailUser().email" [disabled]="!isEdit()" placeholder="Vui lòng nhập Email" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Họ Và Tên</mat-label>
        <input matInput [(ngModel)]="DetailUser().name" [disabled]="!isEdit()" placeholder="Vui lòng nhập Họ Và Tên" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Số Điện Thoại</mat-label>
        <input matInput [(ngModel)]="DetailUser().SDT" [disabled]="!isEdit()" placeholder="Vui lòng nhập Số Điện Thoại" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>Mật Khẩu </mat-label>
        <input matInput type="password" [(ngModel)]="DetailUser().password" [disabled]="!isEdit()" placeholder="Vui lòng nhập Số Điện Thoại" />
      </mat-form-field>
      <div class="w-full flex flex-wrap gap-2 space-x-2 ">
        <button mat-flat-button [disabled]="!isEdit() || isAddingRole()" color="primary" [matMenuTriggerFor]="menu" #menuTrigger="matMenuTrigger">
          @if (isAddingRole()) {
            <ng-container>
              <mat-icon class="animate-spin">refresh</mat-icon>
              Đang thêm...
            </ng-container>
          } @else {
            <ng-container>
              <mat-icon>add</mat-icon>
              Thêm Nhóm
            </ng-container>
          }
        </button>
      </div>

      <!-- Role Summary Card -->
      <div class="mb-4">
        <mat-card class="bg-blue-50">
          <mat-card-header>
            <mat-card-title class="text-sm font-medium flex items-center">
              <mat-icon class="mr-2 text-blue-500">groups</mat-icon>
              Nhóm Quyền ({{ DetailUser().roles?.length || 0 }})
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            @if (DetailUser().roles && DetailUser().roles.length > 0) {
              <div class="flex flex-row flex-wrap gap-2">
                @for (item of DetailUser().roles; track $index) {
                  <mat-chip-listbox>
                    <mat-chip-option class="bg-blue-100" [class.opacity-50]="isRemovingRole()">
                      <div class="flex items-center">
                        <span class="mr-2">{{item?.role?.name || item?.name}}</span>
                        @if (isRemovingRole()) {
                          <mat-icon class="animate-spin text-gray-500 text-sm">refresh</mat-icon>
                        } @else if (isEdit()) {
                          <mat-icon 
                            color="warn" 
                            (click)="handleRemoveRole(item)" 
                            [style.cursor]="'pointer'"
                            class="text-sm hover:text-red-600">
                            close
                          </mat-icon>
                        }
                      </div>
                    </mat-chip-option>
                  </mat-chip-listbox>
                }
              </div>
            } @else {
              <div class="text-center text-gray-500 py-4">
                <mat-icon class="text-gray-400">group_off</mat-icon>
                <p class="text-sm mt-1">Chưa có nhóm quyền nào</p>
                @if (isEdit()) {
                  <button mat-stroked-button color="primary" [matMenuTriggerFor]="menu" class="mt-2">
                    <ng-container>
                      <mat-icon>add</mat-icon>
                      Thêm nhóm đầu tiên
                    </ng-container>
                  </button>
                }
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>
        <mat-menu  #menu="matMenu">
           <div (click)="$event.stopPropagation()"  class="cursor-pointer flex flex-col space-y-4 p-3">                                        
               <div class="relative w-full">
                   <input type="text"
                       placeholder="Tìm Kiếm..." (keyup)="doFilterHederColumn($event)"
                       class="block w-full pl-10 pr-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-400 focus:ring-blue-400 focus:outline-none focus:ring focus:ring-opacity-40">
                   <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                       <span class="material-symbols-outlined text-gray-500">search</span>
                   </div>
               </div>
               <div class="w-full flex flex-col space-y-2 max-h-44 overflow-auto">
                    @for (item of FilterRole(); track $index) {
                      <button mat-menu-item (click)="handleAddRole(item)">{{item.name}}</button>
                    }
               </div>
               <div class="flex flex-row space-x-2 items-center justify-end">
                   <button mat-flat-button color="warn" (click)="menuTrigger.closeMenu()">Đóng</button>
               </div>
               </div>
           </mat-menu>

      <!-- User Permission Management Section -->
      <div class="mt-8" *ngIf="DetailUser().id && DetailUser().id !== 'new'">
        <div class="border-t pt-6">
          <!-- Permission Summary and Management Grid -->
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Roles Information -->
            <div class="xl:col-span-1">
              <app-user-roles-info [user]="DetailUser()"></app-user-roles-info>
            </div>
            
            <!-- Permission Summary -->
            <div class="xl:col-span-1">
              <app-user-permission-summary 
                [userId]="DetailUser().id"
                [user]="DetailUser()">
              </app-user-permission-summary>
            </div>
            
            <!-- Permission Management -->
            <div class="xl:col-span-1">
              <mat-card class="permission-management">
                <mat-card-header>
                  <mat-card-title class="text-sm font-medium flex items-center">
                    <mat-icon class="mr-2 text-green-500">settings</mat-icon>
                    Quyền Đặc Biệt
                  </mat-card-title>
                  <mat-card-subtitle class="text-xs">
                    Override quyền từ roles
                  </mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <app-user-permission-management [userId]="DetailUser().id"></app-user-permission-management>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </div>
      </div>

      <!-- User đang tạo mới -->
      <div class="mt-8" *ngIf="DetailUser().id === 'new'">
        <div class="border-t pt-6">
          <div class="text-center text-gray-500 py-8">
            <mat-icon class="text-4xl text-gray-400">info</mat-icon>
            <p class="mt-2">Lưu user trước để quản lý quyền đặc biệt</p>
            <p class="text-xs">Sau khi tạo user, bạn có thể cấp/thu hồi quyền riêng</p>
          </div>
        </div>
      </div>

    </div>
  </ng-container>
</div>