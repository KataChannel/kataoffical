import { inject, Injectable, signal, Signal } from '@angular/core';
import { environment } from '../../../environments/environment.development';
import { StorageService } from '../../shared/utils/storage.service';
import { MatSnackBar } from '@angular/material/snack-bar';
import { SharedSocketService } from '../../shared/services/sharedsocket.service';

@Injectable({
  providedIn: 'root'
})
export class ChotkhoService {
  private socket: any;
  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5 ph√∫t cache cho performance
  
  constructor(
    private _StorageService: StorageService,
    private _sharedSocketService: SharedSocketService,
  ) {
    this.socket = this._sharedSocketService.getSocket();
  }

  private _snackBar: MatSnackBar = inject(MatSnackBar);
  
  // Signals for state management
  ListChotkho = signal<any[]>([]);
  DetailChotkho = signal<any>({});
  page = signal<number>(1);
  totalPages = signal<number>(1);
  total = signal<number>(0);
  pageSize = signal<number>(50);
  chotkhoId = signal<string | null>(null);
  
  // Loading states for better UX
  isLoading = signal<boolean>(false);
  isRefreshing = signal<boolean>(false);
  lastUpdated = signal<Date | null>(null);

  setChotkhoId(id: string | null) {
    this.chotkhoId.set(id);
  }
  async getListSanphamTonKho(maspList: any) {
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
        },
        body: JSON.stringify(maspList),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/tonkhobylist`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const data = await response.json();
      return data || [];
    } catch (error) {
      console.error('L·ªói l·∫•y danh s√°ch s·∫£n ph·∫©m t·ªìn kho:', error);
      this.handleError(500);
      return [];
    }
  }
  async CreateChotkho(dulieu: any) {
    this.isLoading.set(true);
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
        },
        body: JSON.stringify(dulieu),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/create`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const data = await response.json();
      
      // T·ª± ƒë·ªông refresh danh s√°ch v√† set ID m·ªõi
      await this.getAllChotkho();
      this.chotkhoId.set(data.id);      
      this._snackBar.open('T·∫°o ch·ªët kho th√†nh c√¥ng', '', {
        duration: 2000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
      
      return data;
    } catch (error) {
      console.error('L·ªói t·∫°o ch·ªët kho:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }

  // T·∫°o ch·ªët kho h√†ng lo·∫°t cho nhi·ªÅu s·∫£n ph·∫©m
  async bulkCreateChotkho(dataList: any[]) {
    this.isLoading.set(true);
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
        },
        body: JSON.stringify(dataList),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/bulk-create`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const data = await response.json();
      
      // T·ª± ƒë·ªông refresh danh s√°ch
      await this.getAllChotkho();      
      this._snackBar.open(`T·∫°o th√†nh c√¥ng ${data?.data?.length || 0} b·∫£n ghi ch·ªët kho`, '', {
        duration: 3000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
      
      return data;
    } catch (error) {
      console.error('L·ªói t·∫°o ch·ªët kho h√†ng lo·∫°t:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }

  async getChotkhoByDateRange(params: any) {
    this.isLoading.set(true);
    try {
      const { startDate, endDate, page = 1, limit = this.pageSize() } = params;
      
      const query = new URLSearchParams({
        startDate: startDate || '',
        endDate: endDate || '',
        page: page.toString(),
        limit: limit.toString()
      });

      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        },
      };

      const response = await fetch(`${environment.APIURL}/chotkho/bydate?${query}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }

      const data = await response.json();
      
      // Update state with the returned data
      this.ListChotkho.set(data.data || []);
      this.page.set(data.page || page);
      this.totalPages.set(data.totalPages || 1);
      this.total.set(data.total || 0);
      this.pageSize.set(limit);
      this.lastUpdated.set(new Date());
      
      return data;
    } catch (error) {
      console.error('L·ªói l·∫•y ch·ªët kho theo kho·∫£ng th·ªùi gian:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }

  async getAllChotkho(queryParams: any = {}) {
    try {
      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        },
      };

      queryParams = {
        page: this.page().toString(),
        pageSize: this.pageSize().toString(),
        ...queryParams,
      };

      // Build query string
      const query = new URLSearchParams();
      Object.entries(queryParams).forEach(([key, value]) => {
        if (value !== null && value !== undefined && value !== '') {
          query.append(key, String(value));
        }
      });

      // Always fetch fresh data from server
      const response = await fetch(`${environment.APIURL}/chotkho?${query}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return [];
      }

      const data = await response.json();
      
      // Update state immediately
      this.ListChotkho.set(data.data || []);
      this.page.set(data.page || 1);
      this.totalPages.set(data.totalPages || 1);
      this.total.set(data.total || 0);
      this.pageSize.set(data.pageSize || this.pageSize());
      this.lastUpdated.set(new Date());
      
      return data.data || [];

    } catch (error) {
      console.error('L·ªói t·∫£i d·ªØ li·ªáu ch·ªët kho:', error);
      this.handleError(500);
      return [];
    } finally {
      this.isRefreshing.set(false);
    }
  }

  async getUpdatedCodeIds() {
    try {
      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
      };
      const response = await fetch(`${environment.APIURL}/chotkho/updateCodeIds`, options);
      if (!response.ok) {
        this.handleError(response.status);
      }
      const data = await response.json();
      this.getAllChotkho(this.pageSize());
      return data.data;
    } catch (error) {
      console.error(error);
    }
  }

  async getChotkhoBy(param: any, pageSize: number = this.pageSize()) {
    this.pageSize.set(pageSize);
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        },
        body: JSON.stringify({ 
          ...param, 
          page: this.page(), 
          limit: pageSize,
        }),
      };

      const response = await fetch(`${environment.APIURL}/chotkho/findby`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return;
      }

      const data = await response.json();
      
      if (param.isOne === true) {
        this.DetailChotkho.set(data);
      } else {
        // C·∫≠p nh·∫≠t state ngay l·∫≠p t·ª©c kh√¥ng c·∫ßn cache
        this.ListChotkho.set(data.data || []);
        this.page.set(data.page || 1);
        this.totalPages.set(data.totalPages || 1);
        this.total.set(data.total || 0);
        this.pageSize.set(pageSize);
      }
    } catch (error) {
      console.error('L·ªói t√¨m ki·∫øm ch·ªët kho:', error);
      this.handleError(500);
    }
  }

  async updateChotkho(dulieu: any) {
    try {
      const options = {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
          'Cache-Control': 'no-cache'
        },
        body: JSON.stringify({
          ...dulieu
        }),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/update/${dulieu.id}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const data = await response.json();
      
      // Refresh c·∫£ danh s√°ch v√† chi ti·∫øt
      await this.getAllChotkho();
      if (data?.id) {
        await this.getChotkhoBy({ id: data.id, isOne: true });
      }
      
      return data;
    } catch (error) {
      console.error('L·ªói c·∫≠p nh·∫≠t ch·ªët kho:', error);
      this.handleError(500);
      return null;
    }
  }

  async DeleteChotkho(id: any) {
    try {
      const options = {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
          'Cache-Control': 'no-cache'
        },
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/delete/${id}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return false;
      }
      
      // Refresh danh s√°ch ngay l·∫≠p t·ª©c
      // await this.getAllChotkho();
      return true;
    } catch (error) {
      console.error('L·ªói x√≥a ch·ªët kho:', error);
      this.handleError(500);
      return false;
    }
  }

  // üéØ NEW: Bulk delete chotkho records
  async bulkDeleteChotkho(ids: string[]) {
    this.isLoading.set(true);
    try {
      const options = {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
          'Cache-Control': 'no-cache'
        },
        body: JSON.stringify({ ids }),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/bulk-delete`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const result = await response.json();
      
      // Enhanced success message
      if (result.status === 'success') {
        this._snackBar.open(`‚úÖ ƒê√£ x√≥a th√†nh c√¥ng ${result.deleted} b·∫£n ghi`, '', {
          duration: 3000,
          horizontalPosition: 'end',
          verticalPosition: 'top',
          panelClass: ['snackbar-success'],
        });
      } else if (result.status === 'partial') {
        this._snackBar.open(`‚ö†Ô∏è X√≥a m·ªôt ph·∫ßn th√†nh c√¥ng: ${result.deleted} th√†nh c√¥ng, ${result.failed} l·ªói`, '', {
          duration: 4000,
          horizontalPosition: 'end',
          verticalPosition: 'top',
          panelClass: ['snackbar-warning'],
        });
      } else {
        this._snackBar.open(`‚ùå X√≥a th·∫•t b·∫°i: ${result.failed} l·ªói`, '', {
          duration: 3000,
          horizontalPosition: 'end',
          verticalPosition: 'top',
          panelClass: ['snackbar-error'],
        });
      }
      
      return result;
    } catch (error) {
      console.error('L·ªói x√≥a h√†ng lo·∫°t ch·ªët kho:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }

  // Ph∆∞∆°ng th·ª©c t·∫°o b√°o c√°o ch·ªët kho
  async generateReport(queryParams: any = {}) {
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: JSON.stringify(queryParams),
      };
      const response = await fetch(`${environment.APIURL}/chotkho/report`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      return await response.json();
    } catch (error) {
      console.error('L·ªói t·∫°o b√°o c√°o:', error);
      return null;
    }
  }

  // Ph∆∞∆°ng th·ª©c c·∫≠p nh·∫≠t h√†ng lo·∫°t tr·∫°ng th√°i ch·ªët kho
  async bulkUpdateStatus(ids: string[], status: string) {
    try {
      const options = {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: JSON.stringify({ ids, status }),
      };
      const response = await fetch(`${environment.APIURL}/chotkho/bulk-update-status`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return false;
      }
      await this.getAllChotkho();
      return true;
    } catch (error) {
      console.error('L·ªói c·∫≠p nh·∫≠t h√†ng lo·∫°t:', error);
      return false;
    }
  }

  // Ph∆∞∆°ng th·ª©c l·∫•y th·ªëng k√™ ch·ªët kho
  async getStatistics() {
    try {
      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
      };
      const response = await fetch(`${environment.APIURL}/chotkho/statistics`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      return await response.json();
    } catch (error) {
      console.error('L·ªói l·∫•y th·ªëng k√™:', error);
      return null;
    }
  }

  // Ph∆∞∆°ng th·ª©c t√¨m ch·ªët kho theo s·∫£n ph·∫©m
  async findBySanpham(sanphamId: string, page: number = 1, limit: number = 20) {
    try {
      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
      };
      const response = await fetch(`${environment.APIURL}/chotkho/by-sanpham/${sanphamId}?page=${page}&limit=${limit}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      return await response.json();
    } catch (error) {
      console.error('L·ªói t√¨m ch·ªët kho theo s·∫£n ph·∫©m:', error);
      return null;
    }
  }

  // Ph∆∞∆°ng th·ª©c t√¨m ch·ªët kho theo kho
  async findByKho(khoId: string, page: number = 1, limit: number = 20) {
    try {
      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
      };
      const response = await fetch(`${environment.APIURL}/chotkho/by-kho/${khoId}?page=${page}&limit=${limit}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      return await response.json();
    } catch (error) {
      console.error('L·ªói t√¨m ch·ªët kho theo kho:', error);
      return null;
    }
  }

  // Ph∆∞∆°ng th·ª©c t√¨m ki·∫øm n√¢ng cao v·ªõi t·ªëi ∆∞u h√≥a
  async advancedSearch(criteria: any) {
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
          'Cache-Control': 'no-cache'
        },
        body: JSON.stringify({
          ...criteria,
        }),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/advanced-search`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return [];
      }
      
      const data = await response.json();
      this.ListChotkho.set(data.data || []);
      this.page.set(data.page || 1);
      this.totalPages.set(data.totalPages || 1);
      this.total.set(data.total || 0);
      
      return data.data || [];
    } catch (error) {
      console.error('L·ªói t√¨m ki·∫øm n√¢ng cao:', error);
      return [];
    }
  }

  // Ph∆∞∆°ng th·ª©c refresh d·ªØ li·ªáu nhanh
  async quickRefresh() {
    try {
      await this.getAllChotkho();
      this._snackBar.open('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t', '', {
        duration: 1000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
    } catch (error) {
      console.error('L·ªói refresh:', error);
    }
  }

  // Ph∆∞∆°ng th·ª©c validate d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i
  validateChotkhoData(data: any): { isValid: boolean; errors: string[] } {
    const errors: string[] = [];
    
    if (!data.title || data.title.trim() === '') {
      errors.push('Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
    }
    
    if (!data.ngayChot) {
      errors.push('Ng√†y ch·ªët kho kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
    }
    
    if (data.slThucTe && data.slThucTe < 0) {
      errors.push('S·ªë l∆∞·ª£ng th·ª±c t·∫ø kh√¥ng ƒë∆∞·ª£c √¢m');
    }
    
    return {
      isValid: errors.length === 0,
      errors
    };
  }

  // Ph∆∞∆°ng th·ª©c t√≠nh to√°n ch√™nh l·ªách t·ª± ƒë·ªông
  calculateChenhLech(slHeThong: number, slThucTe: number): number {
    return (slThucTe || 0) - (slHeThong || 0);
  }

  // Ph∆∞∆°ng th·ª©c export d·ªØ li·ªáu
  async exportData(format: 'excel' | 'pdf' | 'csv' = 'excel', filters: any = {}) {
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: JSON.stringify({
          format,
          filters,
        }),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/export`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chot-kho-${new Date().toISOString().split('T')[0]}.${format}`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      return true;
    } catch (error) {
      console.error('L·ªói export d·ªØ li·ªáu:', error);
      return false;
    }
  }

  // Ph∆∞∆°ng th·ª©c th√¥ng minh ki·ªÉm tra ch√™nh l·ªách
  async smartCheckChenhLech(chotKhoId: string) {
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: JSON.stringify({ 
          chotKhoId,
          autoCorrect: true 
        }),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/smart-check-chenhlech`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      return await response.json();
    } catch (error) {
      console.error('L·ªói ki·ªÉm tra ch√™nh l·ªách th√¥ng minh:', error);
      return null;
    }
  }

  // Ph∆∞∆°ng th·ª©c t·∫°o m·∫´u import
  async generateImportTemplate(templateType: 'standard' | 'advanced' = 'standard') {
    try {
      const response = await fetch(`${environment.APIURL}/chotkho/import-template?type=${templateType}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        }
      });
      
      if (!response.ok) {
        this.handleError(response.status);
        return false;
      }
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mau-import-chot-kho-${templateType}.xlsx`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      return true;
    } catch (error) {
      console.error('L·ªói t·∫°o m·∫´u import:', error);
      return false;
    }
  }

  // Ph∆∞∆°ng th·ª©c import t·ª´ Excel
  async importFromExcel(file: File, options: any = {}) {
    try {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('options', JSON.stringify(options));
      
      const response = await fetch(`${environment.APIURL}/chotkho/import`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: formData
      });
      
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const result = await response.json();
      
      // Refresh data after import
      await this.getAllChotkho();
      
      this._snackBar.open(`Import th√†nh c√¥ng ${result.successCount} m·ª•c`, '', {
        duration: 3000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
      
      return result;
    } catch (error) {
      console.error('L·ªói import:', error);
      return null;
    }
  }

  // Ph∆∞∆°ng th·ª©c sao l∆∞u d·ªØ li·ªáu
  async backupData(backupType: 'full' | 'incremental' = 'full') {
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: JSON.stringify({ 
          type: backupType,
        }),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/backup`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return false;
      }
      
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `backup-chot-kho-${backupType}-${new Date().toISOString().split('T')[0]}.zip`;
      a.click();
      window.URL.revokeObjectURL(url);
      
      return true;
    } catch (error) {
      console.error('L·ªói sao l∆∞u:', error);
      return false;
    }
  }

  // Ph∆∞∆°ng th·ª©c ph·ª•c h·ªìi t·ª´ backup
  async restoreFromBackup(file: File) {
    try {
      const formData = new FormData();
      formData.append('backup', file);
      
      const response = await fetch(`${environment.APIURL}/chotkho/restore`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: formData
      });
      
      if (!response.ok) {
        this.handleError(response.status);
        return false;
      }
      
      // Refresh all data after restore
      await this.getAllChotkho();
      
      this._snackBar.open('Ph·ª•c h·ªìi d·ªØ li·ªáu th√†nh c√¥ng', '', {
        duration: 3000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
      
      return true;
    } catch (error) {
      console.error('L·ªói ph·ª•c h·ªìi:', error);
      return false;
    }
  }

  // Ph∆∞∆°ng th·ª©c ki·ªÉm tra tr√πng l·∫∑p
  async checkDuplicates(data: any) {
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: JSON.stringify(data),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/check-duplicates`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      return await response.json();
    } catch (error) {
      console.error('L·ªói ki·ªÉm tra tr√πng l·∫∑p:', error);
      return null;
    }
  }

  // Ph∆∞∆°ng th·ª©c t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t
  async optimizePerformance() {
    try {
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
        body: JSON.stringify({ 
          action: 'optimize',
        }),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/optimize`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return false;
      }
      
      const result = await response.json();
      
      this._snackBar.open('T·ªëi ∆∞u h√≥a th√†nh c√¥ng', '', {
        duration: 2000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
      
      return result;
    } catch (error) {
      console.error('L·ªói t·ªëi ∆∞u h√≥a:', error);
      return false;
    }
  }

        // Ph∆∞∆°ng th·ª©c debug v√† monitoring
  async getSystemHealth() {
    try {
      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`
        },
      };
      const response = await fetch(`${environment.APIURL}/chotkho/health`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      return await response.json();
    } catch (error) {
      console.error('L·ªói ki·ªÉm tra s·ª©c kh·ªèe h·ªá th·ªëng:', error);
      return null;
    }
  }

  // üéØ NEW: Update single chotkho record
  async updateChotkho(id: string, data: any) {
    this.isLoading.set(true);
    try {
      const options = {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
        },
        body: JSON.stringify(data),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/update/${id}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const result = await response.json();
      this.DetailChotkho.set(result);
      
      this._snackBar.open('‚úÖ C·∫≠p nh·∫≠t ch·ªët kho th√†nh c√¥ng', '', {
        duration: 2000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
      
      return result;
    } catch (error) {
      console.error('L·ªói c·∫≠p nh·∫≠t ch·ªët kho:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }

  // Error handling
  private handleError(status: number): void {
    let message = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
    let panelClass = 'snackbar-error';
    switch (status) {
      case 400:
        message = 'Th√¥ng tin ƒë√£ t·ªìn t·∫°i ho·∫∑c kh√¥ng h·ª£p l·ªá';
        break;
      case 401:
        message = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i';
        break;
      case 403:
        message = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y';
        break;
      case 404:
        message = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu';
        break;
      case 500:
        message = 'L·ªói h·ªá th·ªëng, vui l√≤ng th·ª≠ l·∫°i sau';
        break;
      default:
        message = `L·ªói h·ªá th·ªëng (${status})`;
    }
    
    this._snackBar.open(message, '', {
      duration: 3000,
      horizontalPosition: 'end',
      verticalPosition: 'top',
      panelClass: [panelClass],
    });
  }
}

  // üéØ NEW: Update single chotkho record
  async updateChotkho(id: string, data: any) {
    this.isLoading.set(true);
    try {
      const options = {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
        },
        body: JSON.stringify(data),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/update/${id}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const result = await response.json();
      
      // Update local state if needed
      this.DetailChotkho.set(result);
      
      this._snackBar.open('‚úÖ C·∫≠p nh·∫≠t ch·ªët kho th√†nh c√¥ng', '', {
        duration: 2000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
      
      return result;
    } catch (error) {
      console.error('L·ªói c·∫≠p nh·∫≠t ch·ªët kho:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }

  // üéØ NEW: Bulk update chotkho records
  async bulkUpdateChotkho(updates: { id: string; data: any }[]) {
    this.isLoading.set(true);
    try {
      const updatePromises = updates.map(({ id, data }) => 
        this.updateChotkho(id, data)
      );
      
      const results = await Promise.allSettled(updatePromises);
      
      const successful = results.filter(r => r.status === 'fulfilled').length;
      const failed = results.filter(r => r.status === 'rejected').length;
      
      if (failed === 0) {
        this._snackBar.open(`‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng ${successful} b·∫£n ghi`, '', {
          duration: 3000,
          horizontalPosition: 'end',
          verticalPosition: 'top',
          panelClass: ['snackbar-success'],
        });
      } else {
        this._snackBar.open(`‚ö†Ô∏è C·∫≠p nh·∫≠t m·ªôt ph·∫ßn: ${successful} th√†nh c√¥ng, ${failed} l·ªói`, '', {
          duration: 4000,
          horizontalPosition: 'end',
          verticalPosition: 'top',
          panelClass: ['snackbar-warning'],
        });
      }
      
      return { successful, failed, results };
    } catch (error) {
      console.error('L·ªói c·∫≠p nh·∫≠t h√†ng lo·∫°t:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }

  // Error handling
  private handleError(status: number): void {
    let message = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
    let panelClass = 'snackbar-error';
    switch (status) {
      case 400:
        message = 'Th√¥ng tin ƒë√£ t·ªìn t·∫°i ho·∫∑c kh√¥ng h·ª£p l·ªá';
        break;
      case 401:
        message = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i';
        break;
      case 403:
        message = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y';
        break;
      case 404:
        message = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu';
        break;
      case 500:
        message = 'L·ªói h·ªá th·ªëng, vui l√≤ng th·ª≠ l·∫°i sau';
        break;
      default:
        message = `L·ªói h·ªá th·ªëng (${status})`;
    }
    
    this._snackBar.open(message, '', {
      duration: 3000,
      horizontalPosition: 'end',
      verticalPosition: 'top',
      panelClass: [panelClass],
    });
  }
}

  // üéØ NEW: Update single chotkho record
  async updateChotkho(id: string, data: any) {
    this.isLoading.set(true);
    try {
      const options = {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this._StorageService.getItem('token')}`,
        },
        body: JSON.stringify(data),
      };
      
      const response = await fetch(`${environment.APIURL}/chotkho/update/${id}`, options);
      if (!response.ok) {
        this.handleError(response.status);
        return null;
      }
      
      const result = await response.json();
      
      // Update local state if needed
      this.DetailChotkho.set(result);
      
      this._snackBar.open('‚úÖ C·∫≠p nh·∫≠t ch·ªët kho th√†nh c√¥ng', '', {
        duration: 2000,
        horizontalPosition: 'end',
        verticalPosition: 'top',
        panelClass: ['snackbar-success'],
      });
      
      return result;
    } catch (error) {
      console.error('L·ªói c·∫≠p nh·∫≠t ch·ªët kho:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }

  // üéØ NEW: Bulk update chotkho records
  async bulkUpdateChotkho(updates: { id: string; data: any }[]) {
    this.isLoading.set(true);
    try {
      const updatePromises = updates.map(({ id, data }) => 
        this.updateChotkho(id, data)
      );
      
      const results = await Promise.allSettled(updatePromises);
      
      const successful = results.filter(r => r.status === 'fulfilled').length;
      const failed = results.filter(r => r.status === 'rejected').length;
      
      if (failed === 0) {
        this._snackBar.open(`‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng ${successful} b·∫£n ghi`, '', {
          duration: 3000,
          horizontalPosition: 'end',
          verticalPosition: 'top',
          panelClass: ['snackbar-success'],
        });
      } else {
        this._snackBar.open(`‚ö†Ô∏è C·∫≠p nh·∫≠t m·ªôt ph·∫ßn: ${successful} th√†nh c√¥ng, ${failed} l·ªói`, '', {
          duration: 4000,
          horizontalPosition: 'end',
          verticalPosition: 'top',
          panelClass: ['snackbar-warning'],
        });
      }
      
      return { successful, failed, results };
    } catch (error) {
      console.error('L·ªói c·∫≠p nh·∫≠t h√†ng lo·∫°t:', error);
      this.handleError(500);
      return null;
    } finally {
      this.isLoading.set(false);
    }
  }
}

  private handleError(status: number): void {
    let message = 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
    let panelClass = 'snackbar-error';
    switch (status) {
      case 400:
        message = 'Th√¥ng tin ƒë√£ t·ªìn t·∫°i ho·∫∑c kh√¥ng h·ª£p l·ªá';
        break;
      case 401:
        message = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i';
        break;
      case 403:
        message = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y';
        break;
      case 404:
        message = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu y√™u c·∫ßu';
        break;
      case 422:
        message = 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá';
        break;
      case 500:
        message = 'L·ªói m√°y ch·ªß, vui l√≤ng th·ª≠ l·∫°i sau';
        break;
      case 503:
        message = 'D·ªãch v·ª• t·∫°m th·ªùi kh√¥ng kh·∫£ d·ª•ng';
        break;
      default:
        message = `L·ªói HTTP ${status}`;
    }

    this._snackBar.open(message, 'ƒê√≥ng', {
      duration: 4000,
      horizontalPosition: 'end',
      verticalPosition: 'top',
      panelClass: [panelClass],
    });
  }
}