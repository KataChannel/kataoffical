<div class="flex flex-row justify-between items-center space-x-2 p-2">
  <button mat-icon-button color="primary" (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <!-- Cập nhật input title ở header -->
  <div
    class="flex items-center space-x-2 p-2 min-w-28 font-bold focus:border focus:rounded-lg focus:border-blue-600 focus:bg-slate-100 focus:outline-none transition-colors duration-200">
    {{ DetailPhieugiaohang()?.madonhang || 'Không có dữ liệu' }}
<button color="primary" mat-icon-button [matMenuTriggerFor]="menu">
  <mat-icon>info</mat-icon>
</button>
<mat-menu #menu="matMenu">
  <div class="flex flex-col">
    <a class="p-4 hover:bg-slate-100" target="_blank" href="admin/khachhang/{{DetailPhieugiaohang()?.khachhang?.id}}">{{DetailPhieugiaohang()?.khachhang?.name}} - {{DetailPhieugiaohang()?.khachhang?.makh}}</a>
     <a class="p-4 hover:bg-slate-100" target="_blank" href="admin/banggia/{{DetailPhieugiaohang()?.banggia?.id}}">{{DetailPhieugiaohang()?.banggia?.mabanggia}} - {{DetailPhieugiaohang()?.banggia?.title}}</a>
  </div>
</mat-menu>
  </div>
  <div class="flex flex-row space-x-2 items-center">
    <!-- <button *ngIf="DetailPhieugiaohang().status!=='danhan'" mat-flat-button color="primary"
      [disabled]="DetailPhieugiaohang().status=='dagiao'" (click)="GiaoDonhang()"> Đã Giao</button> -->
    <button mat-flat-button color="primary" [disabled]="DetailPhieugiaohang().status=='danhan'" (click)="Danhanhang()">
      Đã Nhận
    </button>

    <!-- <button mat-icon-button color="primary" (click)="CoppyDon()">
      <mat-icon>content_copy</mat-icon>
    </button> -->
    <button *ngIf="!isEdit()" mat-icon-button color="primary" (click)="printContent()">
      <mat-icon>print</mat-icon>
    </button>
    <button mat-icon-button color="primary" *ngIf="isEdit()" (click)="handlePhieugiaohangAction()">
      <mat-icon>save</mat-icon>
    </button>
    <!-- @if(this.DetailPhieugiaohang().status !=='danhan' || this.profile().roles.includes('Admin')){ -->
    <button mat-icon-button color="primary" *ngIf="!isEdit()" (click)="toggleEdit()">
      <mat-icon>edit</mat-icon>
    </button>
    <!-- } -->
  </div>
</div>

<div class="relative flex flex-col w-full p-4 overflow-auto">
  <ng-container *ngIf="isDelete()">
    <div class="flex flex-col space-y-4 items-center justify-center">
      <div class="font-bold text-2xl">Bạn chắc chắn muốn xoá không?</div>
      <div class="flex flex-row space-x-2 items-center justify-center">
        <button mat-flat-button color="primary" (click)="DeleteData()">Đồng Ý</button>
        <button mat-flat-button color="warn" (click)="toggleDelete()">Huỷ Bỏ</button>
      </div>
    </div>
  </ng-container>
  <ng-container *ngIf="!isDelete()">
    <div id="printContent" class="font-times min-w-[800px] flex flex-col space-y-6 items-center p-2 rounded-lg">
      <div class="w-full flex flex-col items-center justify-center">
        <div *ngIf="!isEdit()" class="w-full flex flex-row space-x-2 items-center justify-between">
          <img src="/images/logo-full.png" class="h-14 mx-auto">
          <div class="w-2/3 flex flex-col">
            <div class="font-bold text-[18px]">CÔNG TY TNHH NÔNG SẢN THỰC PHẨM TRẦN GIA</div>
            <div>Hợp tác xã: Ấp Lộc Tiến, Xã Mỹ Lộc, Huyện Cần Giuộc, Tỉnh Long An</div>
            <div>Văn phòng: Tòa nhà An Phú Plaza, 117-119 Lý Chính Thắng, P.7, Q.3, TP.HCM</div>
            <div>Kho sơ chế: 30 Kha Vạn Cân, P. Hiệp Bình Chánh, TP. Thủ Đức, TP.HCM</div>
            <div>Website: http://rausachtrangia.com - Hotline: 090.245.8081</div>
          </div>
          <img src="/images/qrcodedonhang.svg" class="h-32 ml-auto p-4">
        </div>
        <div class="font-bold text-[18px] uppercase">BẢNG KÊ GIAO HÀNG NGÀY
          {{DetailPhieugiaohang().ngaygiao|date:'dd/MM/yyyy'}}</div>
        <div class="font-bold text-[18px] uppercase {{DetailPhieugiaohang()?.khachhangId?'':'text-red-700 italic'}}">
          {{DetailPhieugiaohang()?.khachhang?.name||"Chưa Chọn Khách Hàng"}}</div>
        <div *ngIf="isEdit() && DetailPhieugiaohang()?.khachhang?.ghichu" class="p-2 rounded-lg border text-red-600"
          [innerHTML]="DetailPhieugiaohang().khachhang.ghichu"></div>

        <div class="w-full flex flex-row items-center mb-2">
          <div class="w-full flex flex-col space-y-1 divide-y divide-gray-300">
            <div class="w-full flex items-start"><strong>Địa Chỉ : </strong>
              {{DetailPhieugiaohang()?.khachhang?.diachi}}</div>
            <div class="w-full flex items-start"><strong>Ghi Chú : </strong> {{DetailPhieugiaohang()?.ghichu}}</div>
            <div class="w-full flex items-start"><strong>Số Điện Thoại : </strong>
              {{DetailPhieugiaohang()?.khachhang?.sdt}}</div>
            <div class="w-full flex items-start">
              <strong>Tổng khối lượng - Đơn Vị Tính : {{GetDVT(DetailPhieugiaohang())}}
                ({{TinhTong(DetailPhieugiaohang()?.sanpham,'slgiao')|number:'1.0-2'}})
              </strong>
            </div>
          </div>
        </div>
        <div *ngIf="isEdit()" class="w-full flex flex-col overflow-y-auto">
          @defer () {
          <div class="w-full overflow-auto">
            <!-- Filter input -->
            <div class="flex flex-row space-x-2 items-center">
                <mat-slide-toggle [(ngModel)]="DetailPhieugiaohang().isshowvat" [ngModelOptions]="{standalone: true}" (toggleChange)="onChangeVat()">
                <span class="font-medium">VAT</span>
                </mat-slide-toggle>
              
              <div class="relative w-full py-2">
                <input type="text" placeholder="Tìm Kiếm..." (keyup)="applyFilter($event)"
                  class="block w-full pl-10 pr-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-400 focus:ring-blue-400 focus:outline-none focus:ring focus:ring-opacity-40">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                  <span class="material-symbols-outlined text-gray-500">search</span>
                </div>
              </div>

            </div>
            <table class="!border w-full cursor-pointer" mat-table [dataSource]="dataSource" matSort>
              @for (column of displayedColumns; track column) {
              <ng-container [matColumnDef]="column">
                <th class="whitespace-nowrap" mat-header-cell *matHeaderCellDef mat-sort-header>
                  <span class="max-w-40 line-clamp-4">
                    {{ ColumnName[column] }}
                  </span>
                </th>
                <td mat-cell *matCellDef="let row; let idx = index">
                  @switch (column) {
                  @case ('STT') {
                  <span class="max-w-20 line-clamp-4 flex flex-row items-center">
                    <span>{{ idx + 1 }} </span>
                    <button mat-icon-button color="warn"
                      (click)="RemoveSanpham(row)"><mat-icon>delete</mat-icon></button>
                  </span>
                  }
                  @case ('sldat') {
                  <div class="text-end">
                    {{ row[column]||0|number:'1.0-2' }}
                  </div>
                  }
                  @case ('giaban') {
                  <div class="text-end">
                    {{ row[column]||0|number:'1.0-2' }}
                  </div>
                  }
                  @case ('ttgiao') {
                  <div class="text-end">
                    {{ row[column]||0|number:'1.0-2' }}
                  </div>
                  }
                  @case ('slgiao') {

                  <!-- @if(DetailPhieugiaohang().status!='dagiao') { -->
                  <div [contentEditable]="true" (focus)="onInputFocus($event)"
                    (blur)="updateBlurValue($event,idx, row, 'slgiao','number')"
                    (keydown.enter)="updateValue($event,idx, row, 'slgiao','number')"
                    (keydown)="validateKeyInput($event, 'number')"
                    class="slgiao-input p-2 min-w-28 bg-slate-200 focus:border text-end rounded-lg focus:border-blue-600 focus:bg-slate-100 focus:outline-none transition-colors duration-200"
                    [attr.data-index]="idx" [attr.data-id]="row.id">
                    {{ row[column]||0|number:'1.0-2' }}
                  </div>
                  <!-- }

                  @else {
                  <div class="text-end">
                    {{ row[column]||0|number:'1.0-2' }}
                  </div>
                  } -->
                  }
                  @case ('slnhan') {
                  <div [contentEditable]="true" (focus)="onInputFocus($event)"
                    (blur)="updateBlurValue($event,idx, row, 'slnhan','number')"
                    (keydown.enter)="updateValue($event,idx, row, 'slnhan','number')"
                    (keydown)="validateKeyInput($event, 'number')"
                    class="slnhan-input p-2 min-w-28 bg-slate-200 focus:border rounded-lg focus:border-blue-600 focus:bg-slate-100 focus:outline-none transition-colors duration-200"
                    [attr.data-index]="idx" [attr.data-id]="row.id">
                    {{ row[column]||0|number:'1.0-2' }}
                  </div>
                  }
                  @case ('ghichu') {
                  <div [contentEditable]="true" (focus)="onInputFocus($event)"
                    (blur)="updateBlurValue($event,idx, row, 'ghichu','string')"
                    (keydown.enter)="updateValue($event,idx, row, 'ghichu','string')"
                    (keydown)="validateKeyInput($event, 'string')"
                    class="ghichu-input p-2 min-w-28 bg-slate-200 focus:border text-end rounded-lg focus:border-blue-600 focus:bg-slate-100 focus:outline-none transition-colors duration-200"
                    [attr.data-index]="idx" [attr.data-id]="row.id">
                    {{ row[column]||'' }}
                  </div>
                  }
                  @default {
                  <span class="max-w-40 line-clamp-4">
                    {{ row[column] }}
                  </span>
                  }
                  }
                </td>
              </ng-container>
              }
              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell p-4" [attr.colspan]="displayedColumns.length">Không tìm thấy</td>
              </tr>
            </table>
            <!-- <mat-paginator #paginator="matPaginator" [pageSizeOptions]="[50, 100]"></mat-paginator> -->
          </div>
          }
        </div>

        <table *ngIf="!isEdit()" class="w-full border-collapse border mt-4">
          <thead>
            <tr class="border">
              <th class="border px-2 max-w-10 text-center">STT</th>
              <th class="border px-2 text-center">Tên sản phẩm</th>
              <th class="border px-2 text-center">ĐVT</th>
              <th class="border px-2 text-center max-w-10 whitespace-nowrap">SL</th>
              <th class="border px-2 text-center max-w-15 whitespace-nowrap"
                *ngIf="DetailPhieugiaohang()?.khachhang?.hiengia">Đơn giá</th>
              <th class="border px-2 text-center max-w-15 whitespace-nowrap"
                *ngIf="DetailPhieugiaohang()?.khachhang?.hiengia">Thành Tiền</th>
              <th class="border px-2 text-center max-w-15 whitespace-nowrap">SL Nhận</th>
              <th class="border px-2 text-center">Ghi chú</th>
            </tr>
          </thead>
          <tbody>
            @for (item of dataSource.data; track item.id; let idx = $index) {
            <tr class="border">
              <td class="border px-2 text-center max-w-10">{{idx+1}}</td>
              <td class="border px-2">{{DetailPhieugiaohang()?.khachhang?.istitle2?item.title2:item.title}}</td>
              <td class="border px-2 text-center">{{item.dvt}}</td>
              <td class="border px-2 text-end max-w-10">{{item.slgiao|number:'1.0-2'}}</td>
              <td class="border px-2 text-end max-w-15" *ngIf="DetailPhieugiaohang()?.khachhang?.hiengia">
                {{item.giaban|number:'1.0-2'}}</td>
              <td class="border px-2 text-end max-w-15" *ngIf="DetailPhieugiaohang()?.khachhang?.hiengia">
                {{item.ttgiao|number:'1.0-2'}}</td>
              <td class="border px-2 text-end max-w-15">{{DetailPhieugiaohang()?.status=== 'danhan'?
                (item.slnhan|number:'1.0-2':''):''}}</td>
              <td class="border px-2">{{item.ghichu}}</td>
            </tr>
            }
            <tr class="border">
              <td colspan="3" class="border px-2 text-start">Tổng:</td>
              <td class="border px-2 text-end font-bold">
                {{TinhTong(DetailPhieugiaohang().sanpham,'slgiao')|number:'1.0-2'}}</td>
              <td class="border px-2 text-end font-bold" *ngIf="DetailPhieugiaohang()?.khachhang?.hiengia"></td>
              <td class="border px-2 text-end font-bold" *ngIf="DetailPhieugiaohang()?.khachhang?.hiengia">
                {{TinhTong(DetailPhieugiaohang().sanpham,'ttgiao')|number:'1.0-2'}}</td>
              <td class="border px-2 text-end font-bold">{{DetailPhieugiaohang()?.status=== 'danhan'?
                (TinhTong(DetailPhieugiaohang().sanpham,'slnhan')|number:'1.0-2'):''}}</td>
              <td class="border px-2 text-end"></td>
            </tr>
           @if(DetailPhieugiaohang().isshowvat){
            <tr class="border">
              <td colspan="5" class="border px-2 text-start">Vat:</td>
              <td class="border px-2 text-end font-bold">{{DetailPhieugiaohang()?.tongvat|number:'1.0-2'}}</td>
              <td class="border px-2 text-end"></td>
              <td class="border px-2 text-end"></td>
            </tr>
           <tr class="border">
              <td colspan="5" class="border px-2 text-start">Tổng Tiền:</td>
              <td class="border px-2 text-end font-bold">{{DetailPhieugiaohang()?.tongtien|number:'1.0-2'}}</td>
              <td class="border px-2 text-end"></td>
              <td class="border px-2 text-end"></td>
            </tr>
            }
          </tbody>
        </table>
        <!-- <div class="w-full text-end font-bold p-2">Ngày In:</div> -->
        <div class="w-full flex justify-between items-center text-center mt-6 p-2 px-16">
          <p><strong>Người vận chuyển</strong></p>
          <p><strong>Người nhận hàng</strong></p>
          <p><strong>Người lập</strong></p>
        </div>
        <!-- <div class="w-full flex justify-between items-center text-center !mt-20 p-2">
        <p><strong>Nguyễn Văn A</strong></p>
        <p><strong>Nguyễn Thị B</strong></p>
        <p><strong>Lê Văn C</strong></p>
        <p><strong>Ngô Thị D</strong></p>
      </div> -->

      </div>
    </div>
  </ng-container>
</div>

<ng-template #confirmRemoveDialog>
  <mat-dialog-content class="!relative !flex flex-col space-y-6 items-center justify-center p-6">
    <div class="flex flex-row space-x-3 items-center">
      <mat-icon class="text-amber-500 text-3xl">warning</mat-icon>
      <div class="text-lg font-medium">Xác nhận xóa sản phẩm</div>
    </div>
    
    <div class="text-center">
      <div class="text-gray-700">Bạn có chắc chắn muốn xóa sản phẩm</div>
      <div class="font-bold text-blue-600 mt-2" *ngIf="itemToRemove">
        "{{ itemToRemove?.title || 'Không có tên' }}"
      </div>
      <div class="text-gray-700 mt-2">khỏi phiếu giao hàng này?</div>
    </div>
    
    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
      <div class="text-sm text-yellow-800">
        <mat-icon class="text-yellow-600 text-sm mr-1">info</mat-icon>
        Hành động này sẽ xóa sản phẩm khỏi phiếu giao hàng hiện tại và có thể được hoàn tác bằng cách thêm lại sản phẩm.
      </div>
    </div>
    
    <div class="flex flex-row space-x-3 items-center justify-center">
      <button mat-flat-button color="warn" mat-dialog-close="confirm">
        <mat-icon>delete</mat-icon>
        Xóa sản phẩm
      </button>
      <button mat-flat-button mat-dialog-close="cancel">
        <mat-icon>cancel</mat-icon>
        Hủy bỏ
      </button>
    </div>
  </mat-dialog-content>
</ng-template>