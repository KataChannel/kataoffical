<div class="price-comparison-container">
  <!-- Header -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>compare</mat-icon>
        So Sánh Giá & Dự Đoán Xu Hướng
      </mat-card-title>
      <button mat-raised-button color="primary" (click)="exportComparison()">
        <mat-icon>file_download</mat-icon>
        Xuất báo cáo
      </button>
    </mat-card-header>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filter-section">
        <h3>
          <mat-icon>list</mat-icon>
          Chọn bảng giá để so sánh
        </h3>
        <div class="banggia-selection">
          <mat-checkbox 
            *ngFor="let banggia of banggiaList()" 
            [checked]="selectedBanggiaIds().includes(banggia.id)"
            (change)="toggleBanggiaSelection(banggia.id, $event.checked)">
            <span class="banggia-checkbox-label" [style.color]="banggia.color">
              {{ banggia.title }}
            </span>
          </mat-checkbox>
        </div>
      </div>

      <div class="filter-section">
        <h3>
          <mat-icon>inventory</mat-icon>
          Chọn sản phẩm
        </h3>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Sản phẩm</mat-label>
          <mat-select [(ngModel)]="selectedSanphamIds" multiple (ngModelChange)="onSanphamSelectionChange()">
            <mat-option *ngFor="let sanpham of sanphamList()" [value]="sanpham.id">
              {{ sanpham.title }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabs -->
  <mat-tab-group>
    <!-- Price Comparison Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>compare_arrows</mat-icon>
        So Sánh Giá
      </ng-template>

      <mat-card class="table-card">
        <mat-card-content>
          <div class="table-container">
            <table mat-table [dataSource]="priceComparisons()" class="comparison-table">
              <!-- Product Name -->
              <ng-container matColumnDef="sanphamTitle">
                <th mat-header-cell *matHeaderCellDef>Sản phẩm</th>
                <td mat-cell *matCellDef="let row">
                  <strong>{{ row.sanphamTitle }}</strong>
                </td>
              </ng-container>

              <!-- Dynamic Banggia Columns -->
              <ng-container *ngFor="let banggiaId of selectedBanggiaIds()" [matColumnDef]="'price_' + banggiaId">
                <th mat-header-cell *matHeaderCellDef [style.color]="getBanggiaColor(banggiaId)">
                  {{ getBanggiaTitle(banggiaId) }}
                </th>
                <td mat-cell *matCellDef="let row">
                  <span [class]="getPriceComparisonClass(row.banggiaPrice[banggiaId], row)">
                    {{ formatCurrency(row.banggiaPrice[banggiaId] || 0) }}
                  </span>
                </td>
              </ng-container>

              <!-- Min Price -->
              <ng-container matColumnDef="minPrice">
                <th mat-header-cell *matHeaderCellDef>Giá thấp nhất</th>
                <td mat-cell *matCellDef="let row">
                  <mat-chip class="min-chip">{{ formatCurrency(row.minPrice) }}</mat-chip>
                </td>
              </ng-container>

              <!-- Max Price -->
              <ng-container matColumnDef="maxPrice">
                <th mat-header-cell *matHeaderCellDef>Giá cao nhất</th>
                <td mat-cell *matCellDef="let row">
                  <mat-chip class="max-chip">{{ formatCurrency(row.maxPrice) }}</mat-chip>
                </td>
              </ng-container>

              <!-- Average Price -->
              <ng-container matColumnDef="avgPrice">
                <th mat-header-cell *matHeaderCellDef>Giá trung bình</th>
                <td mat-cell *matCellDef="let row">
                  {{ formatCurrency(row.avgPrice) }}
                </td>
              </ng-container>

              <!-- Price Range -->
              <ng-container matColumnDef="priceRange">
                <th mat-header-cell *matHeaderCellDef>Chênh lệch</th>
                <td mat-cell *matCellDef="let row">
                  <div class="price-range-cell">
                    <span class="range-amount">{{ formatCurrency(row.priceRange) }}</span>
                    <mat-chip [class]="row.priceRangePercent > 20 ? 'high-range' : row.priceRangePercent > 10 ? 'medium-range' : 'low-range'">
                      {{ formatPercent(row.priceRangePercent) }}
                    </mat-chip>
                  </div>
                </td>
              </ng-container>

              <!-- Actions -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Thao tác</th>
                <td mat-cell *matCellDef="let row">
                  <button mat-icon-button (click)="showHistoricalChart(row.sanphamId)" matTooltip="Xem biểu đồ lịch sử">
                    <mat-icon>timeline</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns();"></tr>
            </table>
          </div>

          <div class="legend">
            <span class="legend-item">
              <span class="color-box lowest"></span>
              Giá thấp nhất
            </span>
            <span class="legend-item">
              <span class="color-box highest"></span>
              Giá cao nhất
            </span>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-tab>

    <!-- Trend Predictions Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon>trending_up</mat-icon>
        Dự Đoán Xu Hướng
      </ng-template>

      <mat-card class="table-card">
        <mat-card-content>
          <div class="info-box">
            <mat-icon>info</mat-icon>
            <span>Dự đoán dựa trên phân tích dữ liệu lịch sử và xu hướng thị trường. Độ tin cậy được tính toán dựa trên độ ổn định của giá trong quá khứ.</span>
          </div>

          <div class="table-container">
            <table mat-table [dataSource]="trendPredictions()" class="trend-table">
              <!-- Product Name -->
              <ng-container matColumnDef="sanphamTitle">
                <th mat-header-cell *matHeaderCellDef>Sản phẩm</th>
                <td mat-cell *matCellDef="let row">
                  <strong>{{ row.sanphamTitle }}</strong>
                </td>
              </ng-container>

              <!-- Current Price -->
              <ng-container matColumnDef="currentPrice">
                <th mat-header-cell *matHeaderCellDef>Giá hiện tại</th>
                <td mat-cell *matCellDef="let row">
                  <strong>{{ formatCurrency(row.currentPrice) }}</strong>
                </td>
              </ng-container>

              <!-- 30 Days Prediction -->
              <ng-container matColumnDef="predicted30">
                <th mat-header-cell *matHeaderCellDef>Dự đoán 30 ngày</th>
                <td mat-cell *matCellDef="let row">
                  <span [class.price-up]="row.predictedPrice30Days > row.currentPrice" [class.price-down]="row.predictedPrice30Days < row.currentPrice">
                    {{ formatCurrency(row.predictedPrice30Days) }}
                  </span>
                </td>
              </ng-container>

              <!-- 60 Days Prediction -->
              <ng-container matColumnDef="predicted60">
                <th mat-header-cell *matHeaderCellDef>Dự đoán 60 ngày</th>
                <td mat-cell *matCellDef="let row">
                  <span [class.price-up]="row.predictedPrice60Days > row.currentPrice" [class.price-down]="row.predictedPrice60Days < row.currentPrice">
                    {{ formatCurrency(row.predictedPrice60Days) }}
                  </span>
                </td>
              </ng-container>

              <!-- 90 Days Prediction -->
              <ng-container matColumnDef="predicted90">
                <th mat-header-cell *matHeaderCellDef>Dự đoán 90 ngày</th>
                <td mat-cell *matCellDef="let row">
                  <span [class.price-up]="row.predictedPrice90Days > row.currentPrice" [class.price-down]="row.predictedPrice90Days < row.currentPrice">
                    {{ formatCurrency(row.predictedPrice90Days) }}
                  </span>
                </td>
              </ng-container>

              <!-- Trend -->
              <ng-container matColumnDef="trend">
                <th mat-header-cell *matHeaderCellDef>Xu hướng</th>
                <td mat-cell *matCellDef="let row">
                  <mat-chip [class]="getTrendClass(row.trend)">
                    <mat-icon>{{ getTrendIcon(row.trend) }}</mat-icon>
                    {{ row.trend === 'increasing' ? 'Tăng' : row.trend === 'decreasing' ? 'Giảm' : 'Ổn định' }}
                  </mat-chip>
                </td>
              </ng-container>

              <!-- Confidence -->
              <ng-container matColumnDef="confidence">
                <th mat-header-cell *matHeaderCellDef>Độ tin cậy</th>
                <td mat-cell *matCellDef="let row">
                  <div class="confidence-bar">
                    <div class="confidence-fill" [style.width.%]="row.confidence" [class.high]="row.confidence >= 80" [class.medium]="row.confidence >= 60 && row.confidence < 80" [class.low]="row.confidence < 60"></div>
                    <span class="confidence-text">{{ row.confidence }}%</span>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['sanphamTitle', 'currentPrice', 'predicted30', 'predicted60', 'predicted90', 'trend', 'confidence']"></tr>
              <tr mat-row *matRowDef="let row; columns: ['sanphamTitle', 'currentPrice', 'predicted30', 'predicted60', 'predicted90', 'trend', 'confidence'];"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-tab>
  </mat-tab-group>
</div>
