<div class="price-analytics-container">
  <!-- Header -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>analytics</mat-icon>
        Phân Tích Giá & Doanh Thu
      </mat-card-title>
      <div class="header-actions">
        <button mat-raised-button (click)="exportToExcel()">
          <mat-icon>file_download</mat-icon>
          Xuất Excel
        </button>
        <button mat-raised-button color="primary" (click)="downloadReport()">
          <mat-icon>picture_as_pdf</mat-icon>
          Tải báo cáo
        </button>
      </div>
    </mat-card-header>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-row">
        <mat-form-field appearance="outline">
          <mat-label>Bảng giá</mat-label>
          <mat-select [(ngModel)]="selectedBanggiaId" (ngModelChange)="loadAnalytics()">
            <mat-option *ngFor="let banggia of banggiaList()" [value]="banggia.id">
              {{ banggia.title }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>list</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Khoảng thời gian</mat-label>
          <mat-select [(ngModel)]="selectedPeriod" (ngModelChange)="onPeriodChange()">
            <mat-option value="7days">7 ngày qua</mat-option>
            <mat-option value="30days">30 ngày qua</mat-option>
            <mat-option value="90days">90 ngày qua</mat-option>
            <mat-option value="1year">1 năm qua</mat-option>
            <mat-option value="custom">Tùy chỉnh</mat-option>
          </mat-select>
          <mat-icon matPrefix>date_range</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="selectedPeriod() === 'custom'">
          <mat-label>Từ ngày</mat-label>
          <input matInput [matDatepicker]="pickerFrom" [(ngModel)]="dateFrom" (ngModelChange)="onCustomDateChange()">
          <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
          <mat-datepicker #pickerFrom></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="selectedPeriod() === 'custom'">
          <mat-label>Đến ngày</mat-label>
          <input matInput [matDatepicker]="pickerTo" [(ngModel)]="dateTo" (ngModelChange)="onCustomDateChange()">
          <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
          <mat-datepicker #pickerTo></mat-datepicker>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Summary Stats -->
  <div class="summary-grid">
    <mat-card class="stat-card">
      <mat-icon>trending_up</mat-icon>
      <div class="stat-value">{{ summaryStats().totalPriceChanges }}</div>
      <div class="stat-label">Tổng thay đổi giá</div>
    </mat-card>

    <mat-card class="stat-card">
      <mat-icon>show_chart</mat-icon>
      <div class="stat-value">{{ summaryStats().avgVolatility }}%</div>
      <div class="stat-label">Độ biến động TB</div>
    </mat-card>

    <mat-card class="stat-card">
      <mat-icon>shopping_cart</mat-icon>
      <div class="stat-value">{{ summaryStats().ordersAffected }}</div>
      <div class="stat-label">Đơn hàng bị ảnh hưởng</div>
    </mat-card>

    <mat-card class="stat-card" [class.positive]="summaryStats().revenueImpact > 0" [class.negative]="summaryStats().revenueImpact < 0">
      <mat-icon>{{ summaryStats().revenueImpact >= 0 ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
      <div class="stat-value">{{ formatCurrency(summaryStats().revenueImpact) }}</div>
      <div class="stat-label">Ảnh hưởng doanh thu</div>
    </mat-card>
  </div>

  <!-- Price Volatility -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>timeline</mat-icon>
        Độ Biến Động Giá Sản Phẩm
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="insights-box" *ngIf="summaryStats().mostVolatileProduct">
        <mat-icon>lightbulb</mat-icon>
        <span>Sản phẩm biến động nhất: <strong>{{ summaryStats().mostVolatileProduct }}</strong></span>
      </div>

      <div class="table-container">
        <table mat-table [dataSource]="volatilityData()" class="analytics-table">
          <!-- Product Name -->
          <ng-container matColumnDef="sanphamTitle">
            <th mat-header-cell *matHeaderCellDef>Sản phẩm</th>
            <td mat-cell *matCellDef="let row">
              <strong>{{ row.sanphamTitle }}</strong>
            </td>
          </ng-container>

          <!-- Average Price -->
          <ng-container matColumnDef="avgPrice">
            <th mat-header-cell *matHeaderCellDef>Giá TB</th>
            <td mat-cell *matCellDef="let row">{{ formatCurrency(row.avgPrice) }}</td>
          </ng-container>

          <!-- Min Price -->
          <ng-container matColumnDef="minPrice">
            <th mat-header-cell *matHeaderCellDef>Giá thấp nhất</th>
            <td mat-cell *matCellDef="let row">
              <span class="price-min">{{ formatCurrency(row.minPrice) }}</span>
            </td>
          </ng-container>

          <!-- Max Price -->
          <ng-container matColumnDef="maxPrice">
            <th mat-header-cell *matHeaderCellDef>Giá cao nhất</th>
            <td mat-cell *matCellDef="let row">
              <span class="price-max">{{ formatCurrency(row.maxPrice) }}</span>
            </td>
          </ng-container>

          <!-- Volatility -->
          <ng-container matColumnDef="volatility">
            <th mat-header-cell *matHeaderCellDef>Độ biến động</th>
            <td mat-cell *matCellDef="let row">
              <mat-chip [class]="getVolatilityClass(row.volatility)">
                {{ row.volatility.toFixed(1) }}%
              </mat-chip>
            </td>
          </ng-container>

          <!-- Change Count -->
          <ng-container matColumnDef="changeCount">
            <th mat-header-cell *matHeaderCellDef>Số lần thay đổi</th>
            <td mat-cell *matCellDef="let row">
              <mat-chip class="count-chip">{{ row.changeCount }}</mat-chip>
            </td>
          </ng-container>

          <!-- Last Change -->
          <ng-container matColumnDef="lastChange">
            <th mat-header-cell *matHeaderCellDef>Thay đổi gần nhất</th>
            <td mat-cell *matCellDef="let row">{{ formatDate(row.lastChange) }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="volatilityColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: volatilityColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Order Impacts -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>receipt_long</mat-icon>
        Đơn Hàng Bị Ảnh Hưởng Bởi Thay Đổi Giá
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="insights-box" *ngIf="summaryStats().highestImpactOrder">
        <mat-icon>lightbulb</mat-icon>
        <span>Đơn hàng ảnh hưởng lớn nhất: <strong>{{ summaryStats().highestImpactOrder }}</strong></span>
      </div>

      <div class="table-container">
        <table mat-table [dataSource]="orderImpacts()" class="analytics-table">
          <!-- Order Code -->
          <ng-container matColumnDef="donhangCode">
            <th mat-header-cell *matHeaderCellDef>Mã đơn hàng</th>
            <td mat-cell *matCellDef="let row">
              <strong>{{ row.donhangCode }}</strong>
            </td>
          </ng-container>

          <!-- Order Date -->
          <ng-container matColumnDef="orderDate">
            <th mat-header-cell *matHeaderCellDef>Ngày đặt</th>
            <td mat-cell *matCellDef="let row">{{ formatDate(row.orderDate) }}</td>
          </ng-container>

          <!-- Total Before -->
          <ng-container matColumnDef="totalBefore">
            <th mat-header-cell *matHeaderCellDef>Giá trước</th>
            <td mat-cell *matCellDef="let row">{{ formatCurrency(row.totalBefore) }}</td>
          </ng-container>

          <!-- Total After -->
          <ng-container matColumnDef="totalAfter">
            <th mat-header-cell *matHeaderCellDef>Giá sau</th>
            <td mat-cell *matCellDef="let row">{{ formatCurrency(row.totalAfter) }}</td>
          </ng-container>

          <!-- Difference -->
          <ng-container matColumnDef="difference">
            <th mat-header-cell *matHeaderCellDef>Chênh lệch</th>
            <td mat-cell *matCellDef="let row">
              <span class="difference" [class.positive]="row.difference > 0" [class.negative]="row.difference < 0">
                {{ row.difference > 0 ? '+' : '' }}{{ formatCurrency(row.difference) }}
              </span>
            </td>
          </ng-container>

          <!-- Difference Percent -->
          <ng-container matColumnDef="differencePercent">
            <th mat-header-cell *matHeaderCellDef>%</th>
            <td mat-cell *matCellDef="let row">
              <mat-chip [class.increase]="row.differencePercent > 0" [class.decrease]="row.differencePercent < 0">
                {{ row.differencePercent > 0 ? '+' : '' }}{{ row.differencePercent }}%
              </mat-chip>
            </td>
          </ng-container>

          <!-- Items Affected -->
          <ng-container matColumnDef="itemsAffected">
            <th mat-header-cell *matHeaderCellDef>SP ảnh hưởng</th>
            <td mat-cell *matCellDef="let row">{{ row.itemsAffected }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="orderImpactColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: orderImpactColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Revenue Impact -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>attach_money</mat-icon>
        Ảnh Hưởng Doanh Thu Theo Tháng
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="revenueImpacts()" class="analytics-table">
          <!-- Month -->
          <ng-container matColumnDef="month">
            <th mat-header-cell *matHeaderCellDef>Tháng</th>
            <td mat-cell *matCellDef="let row">
              <strong>{{ row.month }}</strong>
            </td>
          </ng-container>

          <!-- Actual Revenue -->
          <ng-container matColumnDef="actualRevenue">
            <th mat-header-cell *matHeaderCellDef>Doanh thu thực tế</th>
            <td mat-cell *matCellDef="let row">{{ formatCurrency(row.actualRevenue) }}</td>
          </ng-container>

          <!-- Projected Revenue -->
          <ng-container matColumnDef="projectedRevenue">
            <th mat-header-cell *matHeaderCellDef>Dự kiến (không đổi giá)</th>
            <td mat-cell *matCellDef="let row">{{ formatCurrency(row.projectedRevenue) }}</td>
          </ng-container>

          <!-- Difference -->
          <ng-container matColumnDef="difference">
            <th mat-header-cell *matHeaderCellDef>Chênh lệch</th>
            <td mat-cell *matCellDef="let row">
              <span class="difference" [class.positive]="row.difference > 0" [class.negative]="row.difference < 0">
                {{ row.difference > 0 ? '+' : '' }}{{ formatCurrency(row.difference) }}
              </span>
            </td>
          </ng-container>

          <!-- Price Increases -->
          <ng-container matColumnDef="priceIncreases">
            <th mat-header-cell *matHeaderCellDef>Lần tăng giá</th>
            <td mat-cell *matCellDef="let row">
              <mat-chip class="increase">↗️ {{ row.priceIncreases }}</mat-chip>
            </td>
          </ng-container>

          <!-- Price Decreases -->
          <ng-container matColumnDef="priceDecreases">
            <th mat-header-cell *matHeaderCellDef>Lần giảm giá</th>
            <td mat-cell *matCellDef="let row">
              <mat-chip class="decrease">↘️ {{ row.priceDecreases }}</mat-chip>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="revenueImpactColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: revenueImpactColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>
</div>
