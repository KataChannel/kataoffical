<!-- Filter Icon Button -->
<span 
  class="z-10 material-symbols-outlined text-gray-500 cursor-pointer hover:text-blue-600 transition-colors"
  [matMenuTriggerFor]="filterMenu"
  (menuOpened)="onMenuOpened()"
  #menuTrigger="matMenuTrigger">
  filter_alt
</span>

<!-- Filter Menu -->
<mat-menu #filterMenu="matMenu" class="filter-menu">
  <div 
    (click)="$event.stopPropagation()" 
    class="flex flex-col space-y-4 p-3 min-w-[280px] max-w-[400px]">
    
    <!-- Search Input -->
    <div class="relative w-full">
      <input 
        type="text" 
        placeholder="Tìm kiếm..."
        (keyup)="onSearch($event)"
        [value]="searchQuery()"
        class="block w-full pl-10 pr-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg 
               focus:border-blue-400 focus:ring-2 focus:ring-blue-400 focus:ring-opacity-40 focus:outline-none
               transition-all duration-200">
      <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
        <span class="material-symbols-outlined text-gray-400 text-base">search</span>
      </div>
      
      <!-- Clear search button -->
      @if (searchQuery()) {
      <button
        type="button"
        (click)="searchQuery.set('')"
        class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
        <span class="material-symbols-outlined text-base">close</span>
      </button>
      }
    </div>
    
    <!-- Actions Row -->
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <!-- Select All -->
        <button
          type="button"
          (click)="selectAll()"
          class="text-xs text-blue-600 hover:text-blue-700 underline font-medium transition-colors">
          Chọn tất cả ({{filteredValues().length}})
        </button>
        
        <!-- Clear Selection -->
        <span class="text-gray-300">|</span>
        <button
          type="button"
          (click)="clearSelection()"
          [disabled]="selectedCount() === 0"
          class="text-xs text-blue-600 hover:text-blue-700 underline font-medium transition-colors
                 disabled:text-gray-400 disabled:no-underline disabled:cursor-not-allowed">
          Xóa ({{selectedCount()}})
        </button>
      </div>
      
      <!-- Reset Button -->
      <button
        type="button"
        (click)="resetFilter()"
        class="text-xs text-blue-600 hover:text-blue-700 underline font-medium transition-colors">
        Reset
      </button>
    </div>
    
    <!-- Filter Items List -->
    <div class="w-full flex flex-col space-y-1 max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
      @if (filteredValues().length === 0) {
        <!-- Empty State -->
        <div class="flex flex-col items-center justify-center py-8 text-gray-500">
          <span class="material-symbols-outlined text-4xl mb-2">search_off</span>
          <span class="text-sm">Không tìm thấy kết quả</span>
        </div>
      } @else {
        <!-- Filter Items -->
        @for (item of filteredValues(); track trackByFn($index, item)) {
          <div
            (click)="toggleItem(item)"
            class="flex items-center space-x-2 px-3 py-2 cursor-pointer hover:bg-gray-50 transition-colors
                   border-b border-gray-100 last:border-b-0">
            
            <!-- Checkbox Icon -->
            <span 
              class="material-symbols-outlined text-base transition-all"
              [ngClass]="isItemSelected(item) ? 'text-blue-600' : 'text-gray-300'">
              {{ isItemSelected(item) ? 'check_box' : 'check_box_outline_blank' }}
            </span>
            
            <!-- Value Display with Custom Formatting -->
            <span class="flex-1 text-sm text-gray-700 truncate">
              @switch (column) {
                @case ('createdAt') {
                  <span>{{ item[column] | date:'dd/MM/yyyy HH:mm' }}</span>
                }
                @case ('updatedAt') {
                  <span>{{ item[column] | date:'dd/MM/yyyy HH:mm' }}</span>
                }
                @case ('ngaygiao') {
                  <span>{{ item[column] | date:'dd/MM/yyyy HH:mm' }}</span>
                }
                @case ('haohut') {
                  <span>{{ item[column] }}%</span>
                }
                @default {
                  <span [title]="formatValue(item[column])">
                    {{ formatValue(item[column]) }}
                  </span>
                }
              }
            </span>
          </div>
        }
      }
    </div>
    
    <!-- Summary Info -->
    <div class="flex items-center justify-between text-xs text-gray-500 pt-2 border-t border-gray-200">
      <span>
        Đã chọn: <span class="font-semibold text-blue-600">{{ selectedCount() }}</span>
      </span>
      <span>
        Tổng: <span class="font-semibold">{{ uniqueValues().length }}</span>
      </span>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex items-center justify-end space-x-2 pt-2 border-t border-gray-200">
      <button 
        mat-flat-button 
        color="warn"
        (click)="menuTrigger.closeMenu()"
        class="!text-sm">
        Đóng
      </button>
      <button 
        mat-flat-button 
        color="primary"
        (click)="applyFilter(menuTrigger)"
        [disabled]="selectedCount() === 0"
        class="!text-sm">
        <span class="flex items-center space-x-1">
          <span class="material-symbols-outlined text-base">check</span>
          <span>Áp dụng</span>
        </span>
      </button>
    </div>
  </div>
</mat-menu>
