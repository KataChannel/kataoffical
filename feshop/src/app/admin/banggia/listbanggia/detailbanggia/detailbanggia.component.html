<div class="flex flex-row justify-between items-center space-x-2 p-2">
  <button mat-icon-button color="primary" (click)="goBack()">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <div class="font-bold text-lg">
    @if(idBanggia==0){
    Thêm Bảng Giá
    }@else {
    {{Detail()?.Title||'Chưa Đặt Tên'}}
    }
  </div>
  <div class="flex flex-row space-x-2 items-center">
    <button mat-icon-button color="primary" (click)="CoppyBanggia()">
      <mat-icon>content_copy</mat-icon>
  </button>
    <button mat-icon-button color="primary" (click)="SaveData()">
      <mat-icon>save</mat-icon>
    </button>
    @if(idBanggia!='0'){
    <button mat-icon-button color="warn" (click)="isDelete=true">
      <mat-icon>delete</mat-icon>
    </button>
    }
  </div>
</div>
<div class="relative flex flex-col w-full p-4 overflow-auto">
  @if(isDelete==true){
    <div class="flex flex-col space-y-4 items-center justify-center">
      <div class="font-bold text-lg">Bạn chắc chắn muốn xoá không?</div>
      <div class="flex flex-row space-x-2 items-center justify-center">
        <button mat-flat-button color="primary" (click)="DeleteData()">
          Đồng Ý
        </button>
        <button mat-flat-button color="warn" (click)="isDelete=false">
          Huỷ Bỏ
        </button>
      </div>
    </div>

  }
  @else {
  <div class="w-full flex flex-col space-y-6 items-center p-2">
    <div class="w-full flex lg:flex-row flex-col lg:space-x-2 lg:space-y-0 space-y-4 items-center">
      <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
        <mat-label>Tiêu Đề</mat-label>
        <input matInput [(ngModel)]="Detail().Title" [ngModelOptions]="{ standalone: true }"
          placeholder="Vui lòng Nhập Tiêu Đề" />
      </mat-form-field>

      <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
        <mat-label>Loại</mat-label>
        <mat-select [(ngModel)]="Detail().Type" [ngModelOptions]="{ standalone: true }">
          @for (item of [
            {key:'bansi',value:'Bán Sỉ'},
            {key:'banle',value:'Bán Lẻ'},
          ]; track item.key) {
          <mat-option [value]="item.key">{{item.value}}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field class="w-full" [appearance]="'outline'" [subscriptSizing]="'dynamic'">
             <mat-label>Khoảng Thời Gian</mat-label>
             <mat-date-range-input [rangePicker]="picker">
               <input matStartDate  [(ngModel)]="Detail().Batdau" [ngModelOptions]="{standalone: true}" placeholder="Ngày Bắt Đầu">
               <input matEndDate [(ngModel)]="Detail().Ketthuc" [ngModelOptions]="{standalone: true}" placeholder="Ngày Kết Thúc">
             </mat-date-range-input>
             <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
             <mat-date-range-picker touchUi #picker>
                 <mat-date-range-picker-actions>
                     <button mat-stroked-button color="warn" matDateRangePickerCancel>Huỷ Bỏ</button>
                     <button mat-stroked-button color="primary" matDateRangePickerApply (click)="ApplyDate()">Đồng Ý</button>
                   </mat-date-range-picker-actions>
             </mat-date-range-picker>
           </mat-form-field>
    </div>
    <div class="w-full flex flex-row flex-wrap gap-2 space-x-2 items-center cursor-pointer">
      <span>Nhà hàng đang sử dụng bảng giá này : </span> 
      <button [matMenuTriggerFor]="menu" mat-flat-button color="primary">
        <span>Thêm</span>
        <mat-icon>add_circle</mat-icon>
      </button>
      <mat-menu #menu="matMenu">
        <div class="p-4">
            <mat-form-field appearance="outline" class="w-full" subscriptSizing="dynamic">
                <input (input)="doFilterKhachhang($event)" (click)="$event.stopPropagation()" matInput placeholder="Tìm Kiếm" />
                <mat-icon matPrefix>search</mat-icon>
             </mat-form-field> 
        </div>
        <div class="flex flex-col max-h-80 overflow-auto">
        @for (item of FilterKhachhang; track item.key) {
            <button mat-menu-item (click)="ChosenKhachhang(item);$event.stopPropagation()">
                <span>{{item.TenKH||item.Hoten||'Chưa Đặt Tên'}}</span>
            </button>
         }
        </div>
      </mat-menu> 
      @for (item of ExistsKhachhang; track item.id; let idx = $index) {
        <div class="flex flex-row space-x-2 items-center cursor-pointer rounded-lg bg-slate-200 hover:bg-slate-50 p-2">
          <span>
            {{item.TenKH||item.Hoten||'Chưa Đặt Tên'}}
          </span>
            <mat-icon color="warn" (click)="RemoveKhachhang(item)">cancel</mat-icon>
        </div>
 
      }

    </div>

    <div class="w-full flex flex-col space-y-2 items-center">
      <div class="flex flex-row space-x-2 items-center cursor-pointer">
        <span class="font-bold">Danh Sách Sản Phẩm ({{Detail()?.ListSP?.length}})</span>
        <div class="relative">
          <input type="text" placeholder="Tìm Kiếm..." #input (keyup)="applyFilter($event)"
              class="block pl-10 pr-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg focus:border-blue-400 focus:ring-blue-400 focus:outline-none focus:ring focus:ring-opacity-40">
          <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <span class="material-symbols-outlined text-gray-500">search</span>
          </div>
      </div>
      <button (click)="writeExcelFile()" color="primary"  mat-icon-button><mat-icon>file_download</mat-icon></button>
      <button (click)="uploadfile.click()" color="primary"  mat-icon-button><mat-icon>file_upload</mat-icon></button>
      <input class="hidden" (change)="readExcelFile($event)" type="file" #uploadfile>
        <button (click)="LoadDrive()" color="primary" mat-icon-button><mat-icon>cloud_download</mat-icon></button>
      
        <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>
      </div>

      <div class="w-full overflow-auto">
        <table class="!border cursor-pointer" mat-table [dataSource]="dataSource" matSort>
            @for (column of displayedColumns; track column) {
                <ng-container [matColumnDef]="column">
                    <th class="whitespace-nowrap" mat-header-cell *matHeaderCellDef mat-sort-header>
                        <span class="max-w-40 line-clamp-4">
                            {{ ColumnName[column] }}
                        </span>
                    </th>
                    <td  mat-cell *matCellDef="let row;let idx = index">
                      @switch (column) {
                      @case ('STT') {
                          <span class="max-w-40 line-clamp-4">
                              {{ idx + 1 }}
                          </span>
                          }
                     @case ('giaban') {
                        <mat-form-field appearance="outline" subscriptSizing="dynamic">
                        <mat-label>Giá Bán</mat-label>
                        <input matInput [(ngModel)]="row[column]" type="number" (change)="updateGiaBan(row, $event)" [ngModelOptions]="{ standalone: true }"
                          placeholder="Vui lòng Nhập Tiêu Đề" />
                      </mat-form-field>
                      }    
                      @default
                      {
                        <span class="max-w-40 line-clamp-4">
                          {{ row[column] }}
                        </span>
                      }
                      }
                    </td>
                 </ng-container>
            }
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            <tr class="mat-row" *matNoDataRow>
                <!-- <td class="mat-cell" colspan="4">Không tìm thấy "{{input.value}}"</td> -->
            </tr>
        </table>
        <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]"></mat-paginator>
    </div>
    </div>

  </div>

  }
</div>