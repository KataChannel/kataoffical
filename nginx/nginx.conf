# nginx/nginx.conf

# Backend Upstreams
upstream shared_api { server shared-core-api:3000; }
upstream academy_api { server academy-api:3000; }
upstream cosmetics_api { server cosmetics-api:3000; }
upstream spa_api { server spa-api:3000; }

# Frontend Upstreams
upstream admin_fe_app { server admin-ui:4200; } # <<<--- Upstream MỚI
upstream academy_fe_app { server academy-ui:4200; }
upstream cosmetics_fe_app { server cosmetics-ui:4200; }
upstream spa_fe_app { server spa-ui:4200; }

server {
    listen 80;
    server_name localhost;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss application/atom+xml image/svg+xml;

    # API Routing (Giữ nguyên)
    location /api/shared/ { proxy_pass http://shared_api/; include /etc/nginx/includes/proxy_params; }
    location /api/academy/ { proxy_pass http://academy_api/; include /etc/nginx/includes/proxy_params; }
    location /api/cosmetics/ { proxy_pass http://cosmetics_api/; include /etc/nginx/includes/proxy_params; }
    location /api/spa/ { proxy_pass http://spa_api/; include /etc/nginx/includes/proxy_params; }

    # Frontend Routing (Thêm /admin/)
    # QUAN TRỌNG: Đảm bảo cấu hình baseHref đúng trong từng Angular app

    location /admin/ { # <<<--- Location MỚI cho Admin Portal
        proxy_pass http://admin_fe_app/;
        include /etc/nginx/includes/proxy_params_angular_dev;
    }
    location /academy/ {
        proxy_pass http://academy_fe_app/;
        include /etc/nginx/includes/proxy_params_angular_dev;
    }
    location /cosmetics/ {
        proxy_pass http://cosmetics_fe_app/;
        include /etc/nginx/includes/proxy_params_angular_dev;
    }
    location /spa/ {
        proxy_pass http://spa_fe_app/;
        include /etc/nginx/includes/proxy_params_angular_dev;
    }

    # Root Location (Sửa lại để trỏ đến Admin Portal làm mặc định)
    location = / {
        return 301 /admin/; # <<<--- Redirect đến Admin Portal
        # Hoặc bạn có thể phục vụ một trang login tĩnh chung ở đây
    }
}